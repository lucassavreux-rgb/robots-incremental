<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,Arial;background:#111;color:#eee;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center}
  button{padding:.6rem 1.2rem;font-size:1.2rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer}
  button:disabled{background:#555;cursor:not-allowed}
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%;max-width:800px}
  .card{background:#222;padding:1rem;border-radius:8px;flex:1 1 220px;margin:.5rem 0}
  #log{height:120px;overflow-y:auto;background:#000;padding:.5rem;border-radius:6px;font-size:.85rem;margin-top:.5rem}
  #cpsDisp{font-size:1rem;color:#ffa}
</style>
</head>
<body>

<h1>üí∞ Pi√®ces : <span id="coins">0</span></h1>
<div id="cpsDisp">Pi√®ces/sec : <span id="cps">0</span></div>
<button id="clickBtn">Clic +1</button>

<div class="row">
  <div class="card"><h3>G√©n√©rateurs</h3><div id="gens"></div></div>
  <div class="card"><h3>Upgrades</h3><div id="ups"></div></div>
  <div class="card">
    <h3>Prestige</h3>
    <button id="prestigeBtn" disabled>Reset pour <span id="prestigeGain">0</span> ‚≠ê</button>
    <div>‚≠ê Prestige : <span id="stars">0</span> (√ó<span id="bonus">1</span> production)</div>
  </div>
</div>

<!-- TRADE -->
<div class="card"><h3>March√© du Fer</h3>
  <div>Fer : <span id="iron">0</span> ‚Äì Cours : <span id="ironPrice">10</span> üí∞</div>
  <button onclick="buyIron()">Acheter max</button>
  <button onclick="sellIron()">Vendre tout</button><br>
  <button id="botBtn" onclick="toggleBot()">Bot : OFF</button>
  <div id="botStatus"></div><small>Frais 5 %</small>
</div>

<!-- SAVE -->
<div class="card">
  <h3>Sauvegarde</h3>
  <button id="exportBtn">Exporter save</button>
  <button id="importBtn">Importer save</button>
  <input id="importInput" type="file" accept=".txt" style="display:none">
  <div id="log"></div>
</div>

<script>
const SAVE_KEY = "idleTrade_v1";
const FPS = 20;

let state = {
  coins: 0, totalCoins: 0, stars: 0,
  generators: [
    {name:"Robot", base:0.5, count:0, price:10, mult:1},
    {name:"Usine", base:3,   count:0, price:120,mult:1},
    {name:"Port",  base:15,  count:0, price:1300,mult:1},
    {name:"Labo",  base:80,  count:0, price:1.2e4,mult:1},
    {name:"Satellite", base:500, count:0, price:1.4e5,mult:1}
  ],
  upgrades: [
    {id:"click2", name:"Clic √ó2", price:200, effect:2, bought:false, type:"click"},
    {id:"gen2",   name:"Tous les gen √ó2", price:5e3, effect:2, bought:false, type:"gen"}
  ]
};
let trade = { iron:0, price:10, history:[10], fee:0.05, botActive:false };

const $ = id => document.getElementById(id);
function log(txt){ $("log").insertAdjacentHTML("beforeend",`<div>${txt}</div>`); $("log").scrollTop=1e9; }

function price(g){ return Math.floor(g.price * Math.pow(1.15, g.count)); }
function cps(){ return state.generators.reduce((a,g)=>a+g.count*g.base*g.mult,0)*(1+state.stars*0.05); }
function clickVal(){ return (state.upgrades.find(u=>u.id==="click2")?.bought?2:1)*(1+state.stars*0.05);}

function refresh(){
  const cd = state.coins < 1000 ? state.coins.toFixed(2) : Math.floor(state.coins);
  $("coins").textContent = cd;
  $("cps").textContent = cps().toFixed(2);
  $("bonus").textContent = (1 + state.stars*0.05).toFixed(2);
  $("stars").textContent = state.stars;
  $("prestigeGain").textContent = Math.floor(state.totalCoins * 0.05);
  $("prestigeBtn").disabled = state.coins < 1000;

  $("gens").innerHTML = state.generators.map(g=>`
    <div style="display:flex;justify-content:space-between;margin:.4rem 0">
      <span>${g.name} √ó${g.count}</span>
      <button onclick="buyGen('${g.name}')" ${state.coins<price(g)?"disabled":""}>
        Acheter ${price(g)}üí∞
      </button>
    </div>`).join("");

  $("ups").innerHTML = state.upgrades.filter(u=>!u.bought).map(u=>`
    <div style="display:flex;justify-content:space-between;margin:.4rem 0">
      <span>${u.name}</span>
      <button onclick="buyUp('${u.id}')" ${state.coins<u.price?"disabled":""}>
        ${u.price}üí∞
      </button>
    </div>`).join("");

  $("iron").textContent = trade.iron;
  $("ironPrice").textContent = trade.price;
  $("botBtn").textContent = `Bot : ${trade.botActive?"ON":"OFF"}`;
  $("botStatus").textContent = trade.botActive?`Bot actif (moy ${trade.history.reduce((a,b)=>a+b,0)/trade.history.length||0}).`:"";
}
function clickBtn(){ state.coins += clickVal(); state.totalCoins += clickVal(); refresh(); }
function buyGen(name){
  const g = state.generators.find(x=>x.name===name);
  const p = price(g);
  if(state.coins < p) return;
  state.coins -= p; g.count += 1; state.totalCoins += p*0.5;
  refresh(); save();
}
function buyUp(id){
  const u = state.upgrades.find(x=>x.id===id);
  if(state.coins < u.price || u.bought) return;
  state.coins -= u.price; u.bought = true;
  if(u.type==="gen") state.generators.forEach(g=>g.mult *= u.effect);
  refresh(); save();
}
function prestige(){
  const gain = Math.floor(state.totalCoins * 0.05);
  if(gain < 1) return;
  state.stars += gain; resetCore(); save(); log(`Prestige +${gain} ‚≠ê`);
}
function resetCore(){
  state.coins = 0; state.totalCoins = 0;
  state.generators.forEach(g=>{g.count=0; g.mult=1;});
  state.upgrades.forEach(u=>u.bought=false);
  trade.iron=0; trade.price=10; trade.history=[10]; trade.botActive=false;
  refresh();
}
function tickMarket(){
  const change = (Math.random()-0.48)*0.08;
  trade.price = Math.max(2, Math.floor(trade.price*(1+change)));
  trade.history.push(trade.price);
  if(trade.history.length>20) trade.history.shift();
  if(trade.botActive) botTrade();
  refresh();
}
function buyIron(){
  const p = trade.price*(1+trade.fee);
  const qty = Math.max(1, Math.floor(state.coins/p));
  const cost = qty*p;
  if(state.coins<cost) return;
  state.coins -= cost; trade.iron += qty;
  refresh(); save();
}
function sellIron(){
  if(trade.iron<1) return;
  const gain = trade.iron*trade.price*(1-trade.fee);
  state.coins += gain; trade.iron=0;
  refresh(); save();
}
function toggleBot(){ trade.botActive=!trade.botActive; refresh(); }
function botTrade(){
  if(trade.history.length<3) return;
  const avg = trade.history.reduce((a,b)=>a+b,0)/trade.history.length;
  if(trade.price < avg*0.9) buyIron();
  if(trade.price > avg*1.15 && trade.iron>0) sellIron();
}
function save(){
  localStorage.setItem(SAVE_KEY, btoa(JSON.stringify({...state, trade})));
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw) try{
    const data = JSON.parse(atob(raw));
    state = data; if(data.trade) trade = data.trade;
  }catch(e){ log("Corrupted save"); }
  refresh();
}
function exportSave(){
  const blob = new Blob([btoa(JSON.stringify({...state, trade}))],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="idle_trade_save.txt"; a.click();
}
function importSave(){
  $("importInput").click();
}
$("importInput").addEventListener("change", e=>{
  const f = e.target.files[0]; if(!f) return;
  f.text().then(txt=>{ try{
    state=JSON.parse(atob(txt)); trade=state.trade||trade;
    save(); refresh(); log("Save imported");
  }catch(x){ log("Invalid file"); }});
});

$("clickBtn").addEventListener("click", clickBtn);
$("prestigeBtn").addEventListener("click", prestige);
$("exportBtn").addEventListener("click", exportSave);
$("importBtn").addEventListener("click", importSave);

load();
setInterval(()=>{ 
  state.coins += cps()/FPS; 
  state.totalCoins += cps()/FPS; 
  refresh(); // 20 FPS
}, 1000/FPS);
setInterval(tickMarket, 30000);
window.addEventListener("beforeunload", save);
</script>
</body>
</html>