<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,Arial;background:#111;color:#eee;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
  button{padding:.6rem 1.2rem;font-size:1.2rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  button:hover:not(:disabled){background:#0cf;transform:scale(1.05)}
  button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
  button:active{transform:scale(0.95)}
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%;max-width:1200px}
  .card{background:#222;padding:1rem;border-radius:8px;flex:1 1 220px;margin:.5rem;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
  .card h3{margin-top:0;color:#0af;border-bottom:2px solid #0af;padding-bottom:.5rem}
  #log{background:#1a1a1a;padding:.8rem;border-radius:8px;margin:.5rem 0;max-width:1200px;width:100%;border-left:4px solid #0af}
  .log-message{padding:.3rem 0;font-size:.9rem;animation:fadeIn 0.3s}
  .log-success{color:#0f0}
  .log-unlock{color:#0af}
  .log-event{color:#ffa}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  #cpsDisp{font-size:1rem;color:#ffa;margin-bottom:1rem}
  .gen-item,.up-item{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0;padding:.5rem;background:#333;border-radius:4px}
  .gen-item:hover,.up-item:hover{background:#444}
  .achievement{background:#2a2a00;padding:.5rem;margin:.3rem 0;border-left:4px solid #ffa;border-radius:4px;font-size:.9rem}
  .achievement.unlocked{background:#002a00;border-left-color:#0f0}
  .stat-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #333}
  #clickBtn{font-size:1.5rem;padding:1rem 2rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1rem;touch-action:manipulation;user-select:none;-webkit-user-select:none}
  .price{color:#ffa}
  .count{color:#0f0;font-weight:bold}
  .progress-bar{background:#333;height:20px;border-radius:10px;overflow:hidden;margin:.5rem 0}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf);height:100%;transition:width 0.3s}
  .buy-btn{padding:.5rem 1rem;font-size:1rem}
  .new-content{animation:glow 1s infinite}
  @keyframes glow{0%,100%{box-shadow:0 0 5px #0af}50%{box-shadow:0 0 20px #0af}}
  *{-webkit-touch-callout:none;-webkit-text-size-adjust:none}
</style>
</head>
<body>

<h1>ğŸ’° PiÃ¨ces : <span id="coins">0</span></h1>
<div id="cpsDisp">PiÃ¨ces/sec : <span id="cps">0</span></div>
<div id="log"></div>
<button id="clickBtn">ğŸ‘† Clic +<span id="clickValue">1</span></button>

<div class="row">
  <div class="card">
    <h3>ğŸ¤– GÃ©nÃ©rateurs</h3>
    <div id="gens"></div>
  </div>
  
  <div class="card">
    <h3>âš¡ Upgrades</h3>
    <div id="ups"></div>
  </div>
  
  <div class="card">
    <h3>âœ¨ Shop Ã‰toiles</h3>
    <div>Ã‰toiles : <span class="count" id="starsAvailable">0</span> â­</div>
    <div id="starShop" style="max-height:300px;overflow-y:auto;margin-top:.5rem"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>â­ Prestige</h3>
    <div class="stat-line"><span>Ã‰toiles</span><span class="count" id="stars">0</span></div>
    <div class="stat-line"><span>Bonus</span><span class="count">Ã—<span id="bonus">1</span></span></div>
    <div class="stat-line"><span>CoÃ»t</span><span class="price" id="prestigeCost">1000</span> ğŸ’°</div>
    <div class="progress-bar"><div class="progress-fill" id="prestigeProgress" style="width:0%"></div></div>
    <button id="prestigeBtn" disabled>Prestige +<span id="prestigeGain">0</span> â­</button>
    <button id="prestigeMaxBtn" disabled>MAX</button>
  </div>

  <div class="card">
    <h3>ğŸ“Š Trading</h3>
    <div id="tradeContent"></div>
  </div>

  <div class="card">
    <h3>ğŸ† SuccÃ¨s</h3>
    <div id="achievements" style="max-height:200px;overflow-y:auto"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>ğŸ“ˆ Stats</h3>
    <div class="stat-line"><span>Total</span><span class="count" id="totalCoins">0</span></div>
    <div class="stat-line"><span>Clics</span><span class="count" id="totalClicks">0</span></div>
    <div class="stat-line"><span>Temps</span><span class="count" id="playTime">0s</span></div>
    <div class="stat-line"><span>Prestiges</span><span class="count" id="prestigeCount">0</span></div>
  </div>
</div>

<div class="card" style="max-width:1200px">
  <h3>ğŸ’¾ Sauvegarde</h3>
  <button id="exportBtn">ğŸ“¤ Exporter</button>
  <button id="importBtn">ğŸ“¥ Importer</button>
  <button id="resetBtn" style="background:#c33">ğŸ—‘ï¸ Reset</button>
  <input id="importInput" type="file" accept=".txt" style="display:none">
</div>

<script>
const SAVE_KEY = "idleTrade_v4";
const FPS = 20;

let state = {
  coins: 0,
  totalCoins: 0,
  stars: 0,
  totalClicks: 0,
  prestigeCount: 0,
  playTime: 0,
  prestigeCost: 1000,
  logMessages: [],
  generators: [
    {id:"robot", name:"Robot", base:0.1, count:0, price:15, mult:1.15},
    {id:"usine", name:"Usine", base:0.8, count:0, price:250, mult:1.15},
    {id:"port", name:"Port", base:4, count:0, price:3500, mult:1.15},
    {id:"labo", name:"Labo", base:20, count:0, price:50000, mult:1.15},
    {id:"satellite", name:"Satellite", base:100, count:0, price:750000, mult:1.15},
    {id:"station", name:"Station", base:500, count:0, price:15e6, mult:1.15},
    {id:"dyson", name:"Dyson", base:3000, count:0, price:500e6, mult:1.15}
  ],
  upgrades: [
    {id:"click2", name:"Clic Ã—2", price:500, effect:2, bought:false, type:"click"},
    {id:"click5", name:"Clic Ã—5", price:25000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"gen2", name:"Gen Ã—2", price:15000, effect:2, bought:false, type:"gen"},
    {id:"gen3", name:"Gen Ã—3", price:250000, effect:3, bought:false, type:"gen", requires:"gen2"},
    {id:"robot10", name:"Robot Ã—10", price:5000, effect:10, bought:false, type:"robot"},
    {id:"usine10", name:"Usine Ã—10", price:75000, effect:10, bought:false, type:"usine"},
    {id:"autosave", name:"Sauvegarde auto", price:2000, bought:false, type:"feature"}
  ],
  starUpgrades: [
    {id:"star_prod1", name:"Prod Ã—2", cost:10, bought:false, effect:2, type:"production"},
    {id:"star_prod2", name:"Prod Ã—5", cost:35, bought:false, effect:5, type:"production", requires:"star_prod1"},
    {id:"star_click1", name:"Clic Ã—3", cost:20, bought:false, effect:3, type:"starclick"},
    {id:"star_gen1", name:"Robot Ã—50", cost:25, bought:false, effect:50, type:"robot"},
    {id:"star_auto1", name:"Auto-clic", cost:75, bought:false, type:"autoclick"}
  ],
  achievements: [
    {id:"first_coin", name:"PremiÃ¨re piÃ¨ce", desc:"Gagner 1 piÃ¨ce", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"100 piÃ¨ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"1000 piÃ¨ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"1er gÃ©nÃ©rateur", unlocked:false},
    {id:"first_prestige", name:"Renaissance", desc:"1er prestige", unlocked:false}
  ]
};

let trade = {
  iron: 0,
  price: 10,
  history: [10],
  botActive: false,
  totalTrades: 0
};

const $ = id => document.getElementById(id);

function log(txt, type) {
  type = type || "normal";
  const timestamp = new Date().toLocaleTimeString();
  const logEl = $("log");
  let cssClass = "";
  if (type === "success") cssClass = "log-success";
  if (type === "unlock") cssClass = "log-unlock";
  if (type === "event") cssClass = "log-event";
  state.logMessages.unshift({text: txt, time: timestamp, type: cssClass});
  if (state.logMessages.length > 5) state.logMessages.pop();
  logEl.innerHTML = state.logMessages.map(function(msg) {
    return '<div class="log-message ' + msg.type + '">[' + msg.time + '] ' + msg.text + '</div>';
  }).join("");
}

function formatNum(n) {
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  if (n < 1e12) return (n / 1e9).toFixed(2) + "B";
  return (n / 1e12).toFixed(2) + "T";
}

function price(gen) {
  return Math.floor(gen.price * Math.pow(gen.mult, gen.count));
}

function cps() {
  var genMult = 1;
  for (var i = 0; i < state.upgrades.length; i++) {
    if (state.upgrades[i].type === "gen" && state.upgrades[i].bought) genMult *= state.upgrades[i].effect;
  }
  var starMult = 1;
  for (var i = 0; i < state.starUpgrades.length; i++) {
    if (state.starUpgrades[i].type === "production" && state.starUpgrades[i].bought) starMult *= state.starUpgrades[i].effect;
  }
  var total = 0;
  for (var i = 0; i < state.generators.length; i++) {
    var g = state.generators[i];
    var eff = genMult * starMult;
    for (var j = 0; j < state.upgrades.length; j++) {
      if (state.upgrades[j].type === g.id && state.upgrades[j].bought) eff *= state.upgrades[j].effect;
    }
    for (var j = 0; j < state.starUpgrades.length; j++) {
      if (state.starUpgrades[j].type === g.id && state.starUpgrades[j].bought) eff *= state.starUpgrades[j].effect;
    }
    total += g.count * g.base * eff;
  }
  return total * Math.pow(1.5, state.stars);
}

function clickVal() {
  var clickMult = 1;
  for (var i = 0; i < state.upgrades.length; i++) {
    if (state.upgrades[i].type === "click" && state.upgrades[i].bought) clickMult *= state.upgrades[i].effect;
  }
  var starMult = 1;
  for (var i = 0; i < state.starUpgrades.length; i++) {
    if (state.starUpgrades[i].type === "starclick" && state.starUpgrades[i].bought) starMult *= state.starUpgrades[i].effect;
  }
  return clickMult * starMult * Math.pow(1.5, state.stars);
}

function clickBtn() {
  var val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  checkAchievements();
}

function buyGen(genId) {
  for (var i = 0; i < state.generators.length; i++) {
    if (state.generators[i].id === genId) {
      var gen = state.generators[i];
      var cost = price(gen);
      if (state.coins < cost) return;
      state.coins -= cost;
      gen.count++;
      state.totalCoins += cost * 0.1;
      checkAchievements();
      updateUI();
      save();
      return;
    }
  }
}

function buyUp(upId) {
  for (var i = 0; i < state.upgrades.length; i++) {
    if (state.upgrades[i].id === upId) {
      var up = state.upgrades[i];
      if (up.bought || state.coins < up.price) return;
      if (up.requires) {
        var reqFound = false;
        for (var j = 0; j < state.upgrades.length; j++) {
          if (state.upgrades[j].id === up.requires && state.upgrades[j].bought) {
            reqFound = true;
            break;
          }
        }
        if (!reqFound) return;
      }
      state.coins -= up.price;
      up.bought = true;
      log("âœ… " + up.name, "success");
      checkAchievements();
      updateUI();
      save();
      return;
    }
  }
}

function buyStarUpgrade(id) {
  for (var i = 0; i < state.starUpgrades.length; i++) {
    if (state.starUpgrades[i].id === id) {
      var up = state.starUpgrades[i];
      if (up.bought || state.stars < up.cost) return;
      if (up.requires) {
        var reqFound = false;
        for (var j = 0; j < state.starUpgrades.length; j++) {
          if (state.starUpgrades[j].id === up.requires && state.starUpgrades[j].bought) {
            reqFound = true;
            break;
          }
        }
        if (!reqFound) return;
      }
      state.stars -= up.cost;
      up.bought = true;
      log("âœ¨ " + up.name, "success");
      updateUI();
      save();
      return;
    }
  }
}

function prestige() {
  var gain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  if (gain < 1 || state.totalCoins < state.prestigeCost) return;
  state.stars += gain;
  state.prestigeCount++;
  state.prestigeCost = 1000;
  resetCore();
  log("â­ +" + gain + " Ã©toiles (Total: " + state.stars + ")", "success");
  checkAchievements();
  updateUI();
  save();
}

function prestigeMax() {
  var totalGain = 0;
  var done = 0;
  var tempCoins = state.totalCoins;
  while (tempCoins >= state.prestigeCost) {
    var gain = Math.floor(Math.sqrt(tempCoins / state.prestigeCost));
    if (gain < 1) break;
    totalGain += gain;
    done++;
    tempCoins = 0;
  }
  if (totalGain < 1) return;
  state.stars += totalGain;
  state.prestigeCount += done;
  state.prestigeCost = 1000;
  resetCore();
  log("â­ MULTI ! +" + totalGain + " Ã©toiles", "success");
  checkAchievements();
  updateUI();
  save();
}

function resetCore() {
  state.coins = 0;
  state.totalCoins = 0;
  for (var i = 0; i < state.generators.length; i++) {
    state.generators[i].count = 0;
  }
  for (var i = 0; i < state.upgrades.length; i++) {
    if (state.upgrades[i].id !== "autosave") state.upgrades[i].bought = false;
  }
  trade.iron = 0;
  trade.price = 10;
  trade.history = [10];
  trade.botActive = false;
}

function buyIron() {
  var cost = trade.price * 1.05;
  var qty = Math.max(1, Math.floor(state.coins / cost));
  var total = qty * cost;
  if (state.coins < total) return;
  state.coins -= total;
  trade.iron += qty;
  trade.totalTrades++;
  checkAchievements();
  updateUI();
  save();
}

function sellIron() {
  if (trade.iron < 1) return;
  var gain = trade.iron * trade.price * 0.95;
  state.coins += gain;
  state.totalCoins += gain * 0.5;
  trade.iron = 0;
  trade.totalTrades++;
  updateUI();
  save();
}

function toggleBot() {
  trade.botActive = !trade.botActive;
  log(trade.botActive ? "ğŸ¤– Bot ON" : "ğŸ¤– Bot OFF", "event");
  updateUI();
}

function botTrade() {
  if (trade.history.length < 3) return;
  var avg = 0;
  for (var i = 0; i < trade.history.length; i++) avg += trade.history[i];
  avg = avg / trade.history.length;
  if (trade.price < avg * 0.88 && state.coins > trade.price * 10) buyIron();
  if (trade.price > avg * 1.18 && trade.iron > 0) sellIron();
}

function tickMarket() {
  var change = (Math.random() - 0.48) * 0.08;
  trade.price = Math.max(2, Math.floor(trade.price * (1 + change)));
  trade.history.push(trade.price);
  if (trade.history.length > 20) trade.history.shift();
  if (trade.botActive) botTrade();
  updateUI();
}

function checkAchievements() {
  var checks = {
    first_coin: function(s) { return s.totalCoins >= 1; },
    hundred: function(s) { return s.coins >= 100; },
    thousand: function(s) { return s.coins >= 1000; },
    first_gen: function(s) { 
      for (var i = 0; i < s.generators.length; i++) {
        if (s.generators[i].count > 0) return true;
      }
      return false;
    },
    first_prestige: function(s) { return s.prestigeCount >= 1; }
  };
  
  for (var i = 0; i < state.achievements.length; i++) {
    var ach = state.achievements[i];
    if (!ach.unlocked && checks[ach.id] && checks[ach.id](state)) {
      ach.unlocked = true;
      log("ğŸ† " + ach.name, "success");
    }
  }
}

function updateUI() {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  $("bonus").textContent = formatNum(Math.pow(1.5, state.stars));
  $("stars").textContent = state.stars;
  $("starsAvailable").textContent = state.stars;
  
  var pGain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  $("prestigeGain").textContent = pGain;
  $("prestigeBtn").disabled = pGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeMaxBtn").disabled = pGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeCost").textContent = formatNum(state.prestigeCost);
  
  var pProgress = Math.min(100, (state.totalCoins / state.prestigeCost) * 100);
  $("prestigeProgress").style.width = pProgress + "%";

  var gensHTML = "";
  for (var i = 0; i < state.generators.length; i++) {
    var g = state.generators[i];
    var cost = price(g);
    var canBuy = state.coins >= cost;
    gensHTML += '<div class="gen-item"><div><strong>' + g.name + '</strong> <span class="count">Ã—' + g.count + '</span><br><small>' + formatNum(g.base * g.count * Math.pow(1.5, state.stars)) + '/s</small></div><button class="buy-btn" onclick="buyGen(\'' + g.id + '\')" ' + (canBuy ? '' : 'disabled') + '>' + formatNum(cost) + 'ğŸ’°</button></div>';
  }
  $("gens").innerHTML = gensHTML;

  var availUps = [];
  for (var i = 0; i < state.upgrades.length; i++) {
    var u = state.upgrades[i];
    if (u.bought) continue;
    if (u.requires) {
      var reqMet = false;
      for (var j = 0; j < state.upgrades.length; j++) {
        if (state.upgrades[j].id === u.requires && state.upgrades[j].bought) {
          reqMet = true;
          break;
        }
      }
      if (!reqMet) continue;
    }
    availUps.push(u);
  }
  
  var upsHTML = "";
  if (availUps.length > 0) {
    for (var i = 0; i < availUps.length; i++) {
      var u = availUps[i];
      var canBuy = state.coins >= u.price;
      upsHTML += '<div class="up-item"><div><strong>' + u.name + '</strong></div><button class="buy-btn" onclick="buyUp(\'' + u.id + '\')" ' + (canBuy ? '' : 'disabled') + '>' + formatNum(u.price) + 'ğŸ’°</button></div>';
    }
  } else {
    upsHTML = '<div style="color:#888;text-align:center">Tout achetÃ©!</div>';
  }
  $("ups").innerHTML = upsHTML;

  var availStar = [];
  for (var i = 0; i < state.starUpgrades.length; i++) {
    var u = state.starUpgrades[i];
    if (u.bought) continue;
    if (u.requires) {
      var reqMet = false;
      for (var j = 0; j < state.starUpgrades.length; j++) {
        if (state.starUpgrades[j].id === u.requires && state.starUpgrades[j].bought) {
          reqMet = true;
          break;
        }
      }
      if (!reqMet) continue;
    }
    availStar.push(u);
  }
  
  var starHTML = "";
  if (availStar.length > 0) {
    for (var i = 0; i < availStar.length; i++) {
      var u = availStar[i];
      var canBuy = state.stars >= u.cost;
      starHTML += '<div class="up-item"><div><strong>' + u.name + '</strong></div><button class="buy-btn" onclick="buyStarUpgrade(\'' + u.id + '\')" ' + (canBuy ? '' : 'disabled') + '>' + u.cost + 'â­</button></div>';
    }
  } else {
    starHTML = '<div style="color:#888;text-align:center">Tout achetÃ©!</div>';
  }
  $("starShop").innerHTML = starHTML;

  var avg = 0;
  for (var i = 0; i < trade.history.length; i++) avg += trade.history[i];
  avg = avg / trade.history.length;
  
  $("tradeContent").innerHTML = '<div class="stat-line"><span>Fer</span><span class="count">' + trade.iron + '</span></div><div class="stat-line"><span>Prix</span><span class="price">' + trade.price + '</span> ğŸ’°</div><div class="stat-line"><span>Moyenne</span><span>' + avg.toFixed(1) + '</span></div><button onclick="buyIron()">Acheter</button><button onclick="sellIron()">Vendre</button><button onclick="toggleBot()" style="background:' + (trade.botActive ? '#0a0' : '#0af') + '">ğŸ¤– ' + (trade.botActive ? 'ON' : 'OFF') + '</button>';

  var achHTML = "";
  for (var i = 0; i < state.achievements.length; i++) {
    var ach = state.achievements[i];
    achHTML += '<div class="achievement ' + (ach.unlocked ? 'unlocked' : '') + '">' + (ach.unlocked ? 'âœ…' : 'ğŸ”’') + ' <strong>' + ach.name + '</strong><br><small>' + ach.desc + '</small></div>';
  }
  $("achievements").innerHTML = achHTML;

  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  var playTimeStr = state.playTime < 60 ? state.playTime + "s" : state.playTime < 3600 ? Math.floor(state.playTime / 60) + "m" : (state.playTime / 3600).toFixed(1) + "h";
  $("playTime").textContent = playTimeStr;
  $("prestigeCount").textContent = state.prestigeCount;
}

function save() {
  try {
    var saveData = {state: state, trade: trade, v: 4, t: Date.now()};
    saveData.state.logMessages = [];
    localStorage.setItem(SAVE_KEY, btoa(JSON.stringify(saveData)));
  } catch (e) {
    console.error("Save error:", e);
  }
}

function load() {
  try {
    var raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      var data = JSON.parse(atob(raw));
      for (var key in data.state) {
        if (key !== "logMessages") state[key] = data.state[key];
      }
      for (var key in data.trade) {
        trade[key] = data.trade[key];
      }
      if (!state.logMessages) state.logMessages = [];
      log("ğŸ’¾ ChargÃ©", "success");
    }
  } catch (e) {
    log("âŒ Erreur chargement", "event");
  }
  updateUI();
}

function exportSave() {
  try {
    var saveData = {state: state, trade: trade, v: 4};
    saveData.state.logMessages = [];
    var blob = new Blob([btoa(JSON.stringify(saveData))], {type: "text/plain"});
    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "save_" + Date.now() + ".txt";
    a.click();
    log("ğŸ“¤ ExportÃ©", "success");
  } catch (e) {
    log("âŒ Erreur export", "event");
  }
}

function importSave() {
  $("importInput").click();
}

function resetGame() {
  if (confirm("Reset total ?")) {
    localStorage.removeItem(SAVE_KEY
