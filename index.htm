<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-text-size-adjust:none}
  body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);color:#eee;display:flex;flex-direction:column;align-items:center;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;padding:1rem;min-height:100vh}
  
  button{padding:.6rem 1.2rem;font-size:1rem;margin:.3rem;border:none;border-radius:8px;background:linear-gradient(135deg, #0af 0%, #08d 100%);color:#fff;cursor:pointer;transition:all 0.3s;touch-action:manipulation;-webkit-tap-highlight-color:transparent;font-weight:bold;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
  button:hover:not(:disabled){background:linear-gradient(135deg, #0cf 0%, #0ad 100%);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,170,255,0.5)}
  button:disabled{background:linear-gradient(135deg, #444 0%, #333 100%);cursor:not-allowed;opacity:0.5;box-shadow:none}
  button:active{transform:scale(0.98)}
  
  .container{width:100%;max-width:1600px}
  .tab-nav{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1.5rem;justify-content:center;background:rgba(0,0,0,0.5);padding:1rem;border-radius:12px;backdrop-filter:blur(10px);border:2px solid rgba(0,170,255,0.2)}
  .tab-btn{padding:0.7rem 1.2rem;font-size:0.95rem;background:rgba(51,51,51,0.8);color:#aaa;border:2px solid transparent;border-radius:8px;cursor:pointer;transition:all 0.3s;font-weight:bold}
  .tab-btn:hover{background:rgba(51,51,51,0.9);color:#0af}
  .tab-btn.active{background:linear-gradient(135deg, #0af 0%, #08d 100%);color:#fff;border-color:#0af;box-shadow:0 0 15px rgba(0,170,255,0.4)}
  .tab-content{display:none}
  .tab-content.active{display:block;animation:fadeIn 0.3s}
  
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,170,255,0.7)}50%{box-shadow:0 0 0 10px rgba(0,170,255,0)}}
  @keyframes glow{0%{text-shadow:0 0 10px rgba(0,170,255,0.5)}50%{text-shadow:0 0 20px rgba(0,170,255,0.8)}100%{text-shadow:0 0 10px rgba(0,170,255,0.5)}}
  
  .row{display:flex;gap:1.2rem;flex-wrap:wrap;justify-content:center;width:100%}
  .card{background:linear-gradient(135deg, rgba(26,26,26,0.9) 0%, rgba(30,15,30,0.9) 100%);padding:1.5rem;border-radius:12px;flex:1 1 300px;margin:.5rem;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:2px solid rgba(0,170,255,0.2);transition:all 0.3s;backdrop-filter:blur(10px)}
  .card:hover{border-color:rgba(0,170,255,0.4);box-shadow:0 12px 40px rgba(0,170,255,0.1)}
  .card h3{margin-top:0;color:#0cf;border-bottom:3px solid;border-image:linear-gradient(90deg, #0af, #08d) 1;padding-bottom:.8rem;margin-bottom:1rem;font-size:1.2rem;text-transform:uppercase;letter-spacing:1px}
  
  .header{text-align:center;margin-bottom:2.5rem;animation:glow 3s infinite}
  .header h1{font-size:2.5rem;background:linear-gradient(135deg, #0af, #0cf);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;font-weight:900;letter-spacing:2px}
  .header-stats{display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap;font-size:1rem}
  .stat-block{background:linear-gradient(135deg, rgba(34,34,34,0.8) 0%, rgba(44,24,44,0.8) 100%);padding:1.2rem;border-radius:10px;min-width:140px;text-align:center;border:2px solid rgba(0,170,255,0.2);transition:all 0.3s;backdrop-filter:blur(10px)}
  .stat-block:hover{border-color:rgba(0,170,255,0.4);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,170,255,0.1)}
  .stat-value{color:#0f0;font-weight:bold;font-size:1.4rem;text-shadow:0 0 10px rgba(0,255,0,0.3)}
  .stat-block > div:first-child{color:#aaa;font-size:0.9rem;margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:0.5px}
  
  #log{background:rgba(17,17,17,0.8);padding:1rem;border-radius:10px;margin:1rem 0;max-width:100%;border-left:5px solid #0af;max-height:120px;overflow-y:auto;font-size:0.9rem;backdrop-filter:blur(10px);border:1px solid rgba(0,170,255,0.1)}
  .log-message{padding:.4rem 0;animation:slideIn 0.3s;font-weight:500}
  .log-success{color:#0f0}.log-unlock{color:#0af}.log-event{color:#ffa}.log-warning{color:#f55}
  @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
  
  .gen-item,.up-item{display:flex;justify-content:space-between;align-items:center;margin:.5rem 0;padding:.6rem;background:linear-gradient(135deg, rgba(34,34,34,0.7) 0%, rgba(30,20,30,0.7) 100%);border-radius:8px;gap:0.5rem;flex-wrap:wrap;border:1px solid rgba(0,170,255,0.1);transition:all 0.2s}
  .gen-item:hover{border-color:rgba(0,170,255,0.3);background:linear-gradient(135deg, rgba(44,44,44,0.8) 0%, rgba(40,25,40,0.8) 100%)}
  .stat-line{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid rgba(0,170,255,0.1);font-size:0.95rem}
  
  #clickBtn{font-size:1.4rem;padding:1.5rem 3rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1.5rem;width:90%;max-width:450px;border-radius:15px;box-shadow:0 10px 40px rgba(0,170,255,0.3);transition:all 0.3s;font-weight:900;letter-spacing:2px;border:3px solid rgba(255,255,255,0.1)}
  #clickBtn:hover{box-shadow:0 15px 50px rgba(0,170,255,0.5);transform:scale(1.08)}
  #clickBtn:active{transform:scale(0.95)}
  
  .price{color:#ffa;font-weight:bold}.count{color:#0f0;font-weight:bold;font-size:1.1rem}
  .progress-bar{background:rgba(51,51,51,0.8);height:20px;border-radius:10px;overflow:hidden;margin:.5rem 0;border:1px solid rgba(0,170,255,0.2)}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf, #08d);height:100%;transition:width 0.2s;box-shadow:0 0 15px rgba(0,170,255,0.3);position:relative}
  .progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;animation:shimmer 2s infinite}
  @keyframes shimmer{0%{background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)}100%{background:linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent)}}
  
  .buy-btn{padding:.5rem 1rem;font-size:0.9rem;border-radius:6px}
  
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:0;backdrop-filter:blur(5px)}
  .modal-content{background:linear-gradient(135deg, #1a1a1a 0%, #2a0a2a 100%);padding:2.5rem;border-radius:15px;max-width:600px;max-height:80vh;overflow-y:auto;border:3px solid #0af;box-shadow:0 20px 60px rgba(0,0,0,0.8)}
  .modal-content h2{color:#0cf;margin-bottom:1.5rem;font-size:2rem;text-transform:uppercase;letter-spacing:1px}
  .modal-content p{margin:1rem 0;line-height:1.8;font-size:1.05rem}
  .modal-content button{width:100%;margin-top:1rem;padding:1rem}
  
  #upgradeClickSection{position:sticky;top:0;background:linear-gradient(135deg, #0a0a0a 0%, #1a0a1a 100%);padding:1.5rem;margin:-1.5rem -1.5rem 1.5rem -1.5rem;border-bottom:4px solid #0af;border-radius:12px 12px 0 0;backdrop-filter:blur(10px)}
  
  .skill-node{background:linear-gradient(135deg, rgba(34,34,34,0.8) 0%, rgba(30,20,30,0.8) 100%);padding:1rem;margin:0.6rem;border-radius:10px;border:3px solid rgba(0,170,255,0.3);text-align:center;cursor:pointer;transition:all 0.3s;min-width:150px}
  .skill-node:hover{border-color:#0af;box-shadow:0 8px 20px rgba(0,170,255,0.2);transform:translateY(-3px)}
  .skill-node.unlocked{background:linear-gradient(135deg, rgba(0,68,0,0.8) 0%, rgba(20,40,20,0.8) 100%);border-color:#0f0;box-shadow:0 0 20px rgba(0,255,0,0.2)}
  .skill-node.locked{opacity:0.5}
  
  .trade-item{background:linear-gradient(135deg, rgba(34,34,34,0.8) 0%, rgba(34,25,20,0.8) 100%);padding:1rem;margin:0.6rem 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;border-left:4px solid #f80}
  
  .challenge-item{background:linear-gradient(135deg, rgba(42,26,0,0.8) 0%, rgba(40,30,10,0.8) 100%);padding:1rem;margin:0.6rem 0;border-radius:10px;border-left:4px solid #ffa}
  .challenge-item.completed{background:linear-gradient(135deg, rgba(26,42,0,0.8) 0%, rgba(30,40,10,0.8) 100%);border-left-color:#0f0}
  
  .milestone-item{background:linear-gradient(135deg, rgba(26,26,42,0.8) 0%, rgba(30,20,40,0.8) 100%);padding:1rem;margin:0.6rem 0;border-radius:10px;border-left:4px solid #a0f}
  .milestone-item.completed{background:linear-gradient(135deg, rgba(26,42,26,0.8) 0%, rgba(20,40,20,0.8) 100%);border-left-color:#0f0}
  
  .corruption-item{background:linear-gradient(135deg, rgba(42,18,0,0.9) 0%, rgba(50,25,10,0.9) 100%);padding:0.8rem;margin:0.5rem 0;border-radius:8px;font-size:0.95rem;display:flex;justify-content:space-between;align-items:center;border:2px solid #f80}
  
  .research-item{background:linear-gradient(135deg, rgba(26,42,42,0.8) 0%, rgba(20,40,40,0.8) 100%);padding:1rem;margin:0.6rem 0;border-radius:10px;border-left:4px solid #0af}
  .research-item.completed{background:linear-gradient(135deg, rgba(26,42,26,0.8) 0%, rgba(20,40,20,0.8) 100%);border-left-color:#0f0}
  
  .achievement-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.8rem}
  .achievement-item{background:linear-gradient(135deg, rgba(42,42,0,0.8) 0%, rgba(40,40,10,0.8) 100%);padding:0.8rem;border-radius:8px;border:2px solid rgba(255,170,0,0.3);transition:all 0.3s}
  .achievement-item.unlocked{background:linear-gradient(135deg, rgba(0,68,0,0.8) 0%, rgba(0,100,0,0.8) 100%);border-color:#0f0;box-shadow:0 0 15px rgba(0,255,0,0.2)}
  
  .feature-box{background:linear-gradient(135deg, rgba(26,26,42,0.8) 0%, rgba(30,20,40,0.8) 100%);padding:1.2rem;border-radius:10px;margin:0.8rem 0;border:2px solid rgba(0,170,255,0.2);transition:all 0.3s}
  .feature-box:hover{border-color:rgba(0,170,255,0.4)}
  
  .bot-status{display:inline-block;width:12px;height:12px;border-radius:50%;margin:0 0.5rem;animation:pulse 2s infinite}
  .bot-status.active{background:#0f0}
  .bot-status.inactive{background:#555}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ’ INCREMENTAL TRADE ULTIMATE ğŸ’</h1>
    <div class="header-stats">
      <div class="stat-block"><div>PiÃ¨ces</div><div class="stat-value" id="coins">0</div></div>
      <div class="stat-block"><div>PiÃ¨ces/sec</div><div class="stat-value" id="cps">0</div></div>
      <div class="stat-block"><div>â­ Ã‰toiles</div><div class="stat-value" id="stars">0</div></div>
      <div class="stat-block"><div>ğŸŒ€ Galaxies</div><div class="stat-value" id="galaxies">0</div></div>
      <div class="stat-block"><div>âš¡ Prestige</div><div class="stat-value" id="prestigeCount">0</div></div>
    </div>
  </div>

  <div id="log"></div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('main')">ğŸ® JEU</button>
    <button class="tab-btn" onclick="switchTab('prestige')">â­ PRESTIGE</button>
    <button class="tab-btn" onclick="switchTab('trading')">ğŸ’¹ TRADING</button>
    <button class="tab-btn" onclick="switchTab('milestones')">ğŸ¯ OBJECTIFS</button>
    <button class="tab-btn" onclick="switchTab('challenges')">âš”ï¸ DÃ‰FIS</button>
    <button class="tab-btn" onclick="switchTab('skills')">ğŸŒ³ SKILLS</button>
    <button class="tab-btn" onclick="switchTab('research')">ğŸ“š RECHERCHE</button>
    <button class="tab-btn" onclick="switchTab('corruption')">ğŸ”¥ CORRUPTION</button>
    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š STATS</button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ MENU</button>
  </div>

  <!-- MAIN TAB -->
  <div id="main" class="tab-content active">
    <button id="clickBtn">ğŸ‘† CLIC +<span id="clickValue">1</span></button>
    
    <div id="upgradeClickSection" class="card">
      <h3>âš¡ Upgrades de Clics (Toujours Visible)</h3>
      <div id="clickUpgrades"></div>
    </div>

    <div class="row">
      <div class="card">
        <h3>ğŸ¤– GÃ©nÃ©rateurs</h3>
        <div id="gens"></div>
      </div>
      
      <div class="card">
        <h3>âš¡ Autres Upgrades</h3>
        <div id="ups"></div>
      </div>
      
      <div class="card">
        <h3>âœ¨ Shop Ã‰toiles</h3>
        <div class="stat-line"><span>Ã‰toiles Disponibles</span><span class="count" id="starsAvailable">0</span> â­</div>
        <div id="starShop"></div>
      </div>
    </div>
  </div>

  <!-- PRESTIGE TAB -->
  <div id="prestige" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>â­ Prestige Standard</h3>
        <div class="stat-line"><span>Ã‰toiles GagnÃ©es</span><span class="count" id="prestigeGain">0</span></div>
        <div class="stat-line"><span>CoÃ»t</span><span class="price">10,000</span> ğŸ’°</div>
        <div class="progress-bar"><div class="progress-fill" id="prestigeProgress" style="width:0%"></div></div>
        <button onclick="prestige()" id="prestigeBtn" disabled style="width:100%;margin-top:0.5rem">Prestige +<span id="prestigeGainDisplay">0</span> â­</button>
        <button onclick="prestigeMax()" id="prestigeMaxBtn" disabled style="width:100%;margin-top:0.5rem">MAX</button>
      </div>

      <div class="card">
        <h3>ğŸŒ€ Super Prestige (Galaxies)</h3>
        <div id="galaxyInfo"></div>
        <button onclick="superPrestige()" id="superPrestigeBtn" disabled style="width:100%;margin-top:1rem">Super Prestige</button>
      </div>
    </div>
  </div>

  <!-- TRADING TAB -->
  <div id="trading" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ’¹ MarchÃ©s Trading</h3>
        <div id="tradeContent"></div>
      </div>
    </div>
  </div>

  <!-- MILESTONES TAB -->
  <div id="milestones" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ¯ Objectifs et Milestones</h3>
        <div id="milestonesContent"></div>
      </div>
    </div>
  </div>

  <!-- CHALLENGES TAB -->
  <div id="challenges" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>âš”ï¸ Challenges de Prestige</h3>
        <button onclick="resetAllChallenges()" style="background:linear-gradient(135deg, #f55 0%, #c33 100%);width:100%">ğŸ”„ Reset Challenges</button>
        <div id="challengesContent" style="margin-top:1rem"></div>
      </div>
    </div>
  </div>

  <!-- SKILLS TAB -->
  <div id="skills" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸŒ³ Arbre de CompÃ©tences</h3>
        <div class="stat-line"><span>Points Disponibles</span><span class="count" id="skillPoints">0</span></div>
        <div id="skillTree" style="display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center"></div>
      </div>
    </div>
  </div>

  <!-- RESEARCH TAB -->
  <div id="research" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ“š SystÃ¨me de Recherches</h3>
        <div id="researchContent"></div>
      </div>
    </div>
  </div>

  <!-- CORRUPTION TAB -->
  <div id="corruption" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ”¥ SystÃ¨me de Corruption</h3>
        <div class="stat-line"><span>Corruptions Actives</span><span class="count" id="corruptionCount">0</span>/10</div>
        <button onclick="addRandomCorruption()" style="background:linear-gradient(135deg, #f80 0%, #d60 100%);width:100%;margin:0.8rem 0">â• Ajouter Corruption</button>
        <div id="corruptionList"></div>
      </div>
    </div>
  </div>

  <!-- STATS TAB -->
  <div id="stats" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>ğŸ“Š Statistiques</h3>
        <div class="stat-line"><span>Total PiÃ¨ces</span><span class="count" id="totalCoins">0</span></div>
        <div class="stat-line"><span>Total Clics</span><span class="count" id="totalClicks">0</span></div>
        <div class="stat-line"><span>Temps de Jeu</span><span class="count" id="playTime">0s</span></div>
        <div class="stat-line"><span>Prestiges</span><span class="count" id="prestigeCountStat">0</span></div>
        <div class="stat-line"><span>Trades Totaux</span><span class="count" id="totalTrades">0</span></div>
        <div class="stat-line"><span>Max PiÃ¨ces</span><span class="count" id="maxCoinsDisplay">0</span></div>
      </div>

      <div class="card">
        <h3>ğŸ† Achievements</h3>
        <div style="font-size:0.95rem;margin-bottom:1rem;font-weight:bold">
          <span class="count" id="achievementCount">0</span> / <span id="achievementTotal">0</span>
        </div>
        <div id="achievements" class="achievement-grid"></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="settings" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>ğŸ’¾ Sauvegarde & DonnÃ©es</h3>
        <button onclick="exportSave()" style="width:100%">ğŸ“¤ Exporter Sauvegarde</button>
        <button onclick="importSave()" style="width:100%;margin:0.5rem 0">ğŸ“¥ Importer Sauvegarde</button>
        <button onclick="resetGame()" style="background:linear-gradient(135deg, #f55 0%, #c33 100%);width:100%;margin-top:1rem">ğŸ—‘ï¸ RESET COMPLET</button>
        <input id="importInput" type="file" accept=".txt" style="display:none">
      </div>

      <div class="card">
        <h3>ğŸ“– Aide & Tutoriel</h3>
        <button onclick="showTutorial()" style="width:100%">ğŸ“– Afficher le Tutoriel</button>
        <button onclick="showHelp()" style="width:100%;margin:0.5rem 0">â“ Comment Jouer</button>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL MODAL -->
<div id="tutorialModal" class="modal" style="display:none">
  <div class="modal-content">
    <h2>ğŸ® Bienvenue dans Incremental Trade!</h2>
    <div id="tutorialContent"></div>
    <button onclick="closeTutorial()">Fermer le Tutoriel â†’</button>
  </div>
</div>

<script>
const SAVE_KEY = "idleTrade_v10_complete";
const FPS = 10;
const UPDATE_INTERVAL = 400;

let state = {
  coins: 0, totalCoins: 0, prestigeProgress: 0, stars: 0, galaxies: 0, totalClicks: 0, prestigeCount: 0,
  playTime: 0, difficulty: "normal", skillPoints: 0, maxCoins: 0, maxCps: 0,
  unlockedFeatures: ["basic"], logMessages: [],
  generators: [
    {id:"robot", name:"Robot", base:0.1, count:0, price:15, mult:1.15},
    {id:"usine", name:"Usine", base:0.5, count:0, price:100, mult:1.15, unlock_prestige:1},
    {id:"port", name:"Port", base:2, count:0, price:1100, mult:1.15, unlock_prestige:2},
    {id:"labo", name:"Laboratoire", base:8, count:0, price:12000, mult:1.15, unlock_prestige:3},
    {id:"satellite", name:"Satellite", base:50, count:0, price:130000, mult:1.15, unlock_prestige:4},
    {id:"station", name:"Station", base:300, count:0, price:1600000, mult:1.15, unlock_prestige:5},
    {id:"dyson", name:"Dyson Sphere", base:2100, count:0, price:20000000, mult:1.15, unlock_prestige:6},
    {id:"blackhole", name:"Trou Noir", base:16000, count:0, price:330000000, mult:1.15, unlock:"advanced"},
    {id:"multiverse", name:"Multivers", base:130000, count:0, price:5500000000, mult:1.15, unlock:"advanced"},
    {id:"quantum", name:"Ordinateur Quantique", base:1100000, count:0, price:100000000000, mult:1.15, unlock:"endgame"}
  ],
  upgrades: [
    {id:"click1", name:"Clic +50%", price:100, effect:1.5, bought:false, type:"click"},
    {id:"click2", name:"Clic Ã—2", price:500, effect:2, bought:false, type:"click", requires:"click1"},
    {id:"click3", name:"Clic Ã—5", price:25000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"click4", name:"Clic Ã—10", price:1000000, effect:10, bought:false, type:"click", requires:"click3"},
    {id:"gen1", name:"GÃ©nÃ©rateurs Ã—1.5", price:15000, effect:1.5, bought:false, type:"gen"},
    {id:"gen2", name:"GÃ©nÃ©rateurs Ã—2", price:150000, effect:2, bought:false, type:"gen", requires:"gen1"},
    {id:"robot1", name:"Robot Ã—10", price:1500, effect:10, bought:false, type:"robot"},
    {id:"robot2", name:"Robot Ã—100", price:15000, effect:100, bought:false, type:"robot", requires:"robot1"},
    {id:"usine1", name:"Usine Ã—10", price:5000, effect:10, bought:false, type:"usine"},
    {id:"usine2", name:"Usine Ã—50", price:50000, effect:50, bought:false, type:"usine", requires:"usine1"},
    {id:"autosave", name:"Sauvegarde auto", price:2000, bought:false, type:"feature"}
  ],
  starUpgrades: [
    {id:"star_prod1", name:"Production Ã—2", cost:30, bought:false, effect:2, type:"production"},
    {id:"star_prod2", name:"Production Ã—5", cost:150, bought:false, effect:5, type:"production", requires:"star_prod1"},
    {id:"star_click1", name:"Clic Ã—3", cost:50, bought:false, effect:3, type:"starclick"},
    {id:"star_click2", name:"Clic Ã—10", cost:250, bought:false, effect:10, type:"starclick", requires:"star_click1"},
    {id:"star_auto1", name:"Auto-clic faible", cost:200, bought:false, type:"autoclick"},
    {id:"star_auto2", name:"Auto-clic fort", cost:500, bought:false, type:"autoclick", requires:"star_auto1"}
  ],
  achievements: [
    {id:"first_coin", name:"PremiÃ¨re PiÃ¨ce", desc:"Gagner 1 piÃ¨ce", unlocked:false},
    {id:"ten_coins", name:"Ã‰conome", desc:"10 piÃ¨ces", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"100 piÃ¨ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"1,000 piÃ¨ces", unlocked:false},
    {id:"tenk", name:"Richissime", desc:"10,000 piÃ¨ces", unlocked:false},
    {id:"million", name:"Ultra-Millionnaire", desc:"1,000,000 piÃ¨ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"Acheter 1er gÃ©nÃ©rateur", unlocked:false},
    {id:"five_gens", name:"Industrialiste", desc:"5 gÃ©nÃ©rateurs", unlocked:false},
    {id:"ten_gens", name:"Magnat", desc:"10 gÃ©nÃ©rateurs", unlocked:false},
    {id:"fifty_gens", name:"MÃ©gacorporation", desc:"50 gÃ©nÃ©rateurs", unlocked:false},
    {id:"first_prestige", name:"Renaisseur", desc:"Faire 1er prestige", unlocked:false},
    {id:"five_prestige", name:"Renaisseur +", desc:"5 prestiges", unlocked:false},
    {id:"ten_prestige", name:"VÃ©teran", desc:"10 prestiges", unlocked:false},
    {id:"first_star", name:"Ã‰toile", desc:"Obtenir 1Ã¨re Ã©toile", unlocked:false},
    {id:"first_galaxy", name:"Explorateur", desc:"1Ã¨re Galaxie", unlocked:false},
    {id:"trader", name:"Marchand", desc:"100 trades", unlocked:false},
    {id:"big_trader", name:"Magnat du Trading", desc:"1000 trades", unlocked:false},
    {id:"corrupt", name:"Corrompu", desc:"5 corruptions actives", unlocked:false},
    {id:"completionist", name:"Perfectionniste", desc:"30 achievements", unlocked:false},
    {id:"speedrun", name:"Speedrunner", desc:"Prestige en moins de 5min", unlocked:false}
  ],
  skillTree: [
    {id:"sk_click", name:"Frappe RenforcÃ©e", desc:"+50% clics", cost:1, unlocked:false, effect:{type:"click", val:1.5}},
    {id:"sk_gen", name:"Usine OptimisÃ©e", desc:"+25% prod", cost:2, unlocked:false, requires:"sk_click", effect:{type:"gen", val:1.25}},
    {id:"sk_prestige", name:"MÃ©tamorphose", desc:"+15% Ã©toiles", cost:3, unlocked:false, requires:"sk_gen", effect:{type:"prestige", val:1.15}},
    {id:"sk_trader", name:"Trader d'Ã‰lite", desc:"+30% trading", cost:2, unlocked:false, effect:{type:"trading", val:1.3}},
    {id:"sk_researcher", name:"Scientifique", desc:"Ã—2 recherche", cost:3, unlocked:false, effect:{type:"research", val:2}},
    {id:"sk_galaxy", name:"Cosmonaute", desc:"+10% galaxies", cost:4, unlocked:false, requires:"sk_prestige", effect:{type:"galaxy", val:1.1}},
    {id:"sk_luck", name:"Chance", desc:"+20% jackpots trading", cost:3, unlocked:false, effect:{type:"luck", val:1.2}}
  ],
  research: [
    {id:"res1", name:"Tech de Base", desc:"DÃ©bloque les gÃ©nÃ©rateurs", cost:5000, progress:0, completed:false, duration:10},
    {id:"res2", name:"Ã‰nergie Stellaire", desc:"+1 Ã©toile par prestige", cost:50000, progress:0, completed:false, duration:30},
    {id:"res3", name:"Trading AvancÃ©", desc:"Prix +30% mieux", cost:200000, progress:0, completed:false, duration:60},
    {id:"res4", name:"Physique Quantique", desc:"DÃ©bloquer contenu final", cost:5000000, progress:0, completed:false, duration:120}
  ],
  corruption: [],
  corruptions_available: [
    {id:"c1", name:"Ralentissement", desc:"Production Ã·2", effect:{type:"divide", target:"production", val:2}},
    {id:"c2", name:"ImpÃ´t Lourd", desc:"PiÃ¨ces Ã·1.5", effect:{type:"divide", target:"coins", val:1.5}},
    {id:"c3", name:"Confusion", desc:"Clics mÃ©langÃ©s", effect:{type:"divide", target:"click", val:2}},
    {id:"c4", name:"Mutation GÃ©nÃ©rale", desc:"GÃ©nÃ©rateurs Ã·2", effect:{type:"divide", target:"generators", val:2}},
    {id:"c5", name:"MalÃ©diction", desc:"Prestige coÃ»te 2x", effect:{type:"multiply", target:"prestige_cost", val:2}},
    {id:"c6", name:"Chaos", desc:"Tout Ã·1.3", effect:{type:"divide", target:"everything", val:1.3}}
  ],
  challenges: [
    {id:"ch1", name:"AscÃ¨te", desc:"Prestige sans cliquer", reward:200, completed:false, active:false},
    {id:"ch2", name:"Ã‰clair", desc:"Prestige en 30s", reward:500, completed:false, active:false},
    {id:"ch3", name:"Minimaliste", desc:"Max 3 gÃ©nÃ©rateurs", reward:300, completed:false, active:false},
    {id:"ch4", name:"Riche Rapide", desc:"1M piÃ¨ces en 5min", reward:400, completed:false, active:false},
    {id:"ch5", name:"Trader Fou", desc:"50 trades d'affilÃ©e", reward:350, completed:false, active:false}
  ],
  milestones: [
    {id:"m1", name:"PremiÃ¨re PiÃ¨ce", desc:"Gagner 1 piÃ¨ce", reward:5, completed:false},
    {id:"m2", name:"Cent PiÃ¨ces", desc:"100 piÃ¨ces en poche", reward:10, completed:false},
    {id:"m3", name:"Millier", desc:"1,000 piÃ¨ces", reward:20, completed:false},
    {id:"m4", name:"Dizaine de Milliers", desc:"10,000 piÃ¨ces", reward:30, completed:false},
    {id:"m5", name:"Million", desc:"1,000,000 piÃ¨ces", reward:50, completed:false},
    {id:"m6", name:"Automatisation", desc:"Acheter 1er gÃ©nÃ©rateur", reward:15, completed:false},
    {id:"m7", name:"Cinq GÃ©nÃ©rateurs", desc:"5 gÃ©nÃ©rateurs achetÃ©s", reward:20, completed:false},
    {id:"m8", name:"Dix GÃ©nÃ©rateurs", desc:"10 gÃ©nÃ©rateurs", reward:25, completed:false},
    {id:"m9", name:"Prestige", desc:"Faire 1er prestige", reward:100, completed:false},
    {id:"m10", name:"Cinq Prestiges", desc:"5 prestiges", reward:150, completed:false},
    {id:"m11", name:"Dizaine de Prestiges", desc:"10 prestiges", reward:200, completed:false},
    {id:"m12", name:"Ã‰toile", desc:"Obtenir 1Ã¨re Ã©toile", reward:50, completed:false},
    {id:"m13", name:"Dix Ã‰toiles", desc:"10 Ã©toiles", reward:100, completed:false},
    {id:"m14", name:"Galaxie", desc:"1Ã¨re Galaxie", reward:500, completed:false},
    {id:"m15", name:"Trader", desc:"100 trades", reward:200, completed:false},
    {id:"m16", name:"Chercheur", desc:"3 recherches complÃ©tÃ©es", reward:150, completed:false},
    {id:"m17", name:"MaÃ®tre Skill", desc:"7 skills dÃ©bloquÃ©s", reward:200, completed:false},
    {id:"m18", name:"Anti-Corruption", desc:"Survivre 5min avec 10 corruptions", reward:300, completed:false}
  ]
};

let trade = {
  resources: {
    iron: {amount: 0, price: 10, history: [10], botActive: false, bot_buy_target: 15, bot_sell_target: 5},
    copper: {amount: 0, price: 8, history: [8], botActive: false, bot_buy_target: 12, bot_sell_target: 4},
    gold: {amount: 0, price: 50, history: [50], botActive: false, bot_buy_target: 75, bot_sell_target: 25},
    platinum: {amount: 0, price: 200, history: [200], botActive: false, bot_buy_target: 300, bot_sell_target: 100}
  },
  totalTrades: 0, jackpots: 0, lastUpdate: 0
};

const $ = id => document.getElementById(id);

function log(txt, type = "normal") {
  const timestamp = new Date().toLocaleTimeString();
  let cssClass = type === "success" ? "log-success" : type === "unlock" ? "log-unlock" : type === "event" ? "log-event" : type === "warning" ? "log-warning" : "";
  state.logMessages.unshift({text: txt, time: timestamp, type: cssClass});
  if (state.logMessages.length > 8) state.logMessages.pop();
  updateLogDisplay();
}

function formatNum(n) {
  if (!isFinite(n)) return "âˆ";
  if (n < 0) return "-" + formatNum(-n);
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  if (n < 1e12) return (n / 1e9).toFixed(2) + "B";
  if (n < 1e15) return (n / 1e12).toFixed(2) + "T";
  if (n < 1e18) return (n / 1e15).toFixed(2) + "Qa";
  return (n / 1e18).toFixed(2) + "Qn";
}

function isUnlocked(feature) {
  if (!feature) return true;
  return state.unlockedFeatures && state.unlockedFeatures.includes(feature);
}

function switchTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  $(tab).classList.add("active");
  event.target.classList.add("active");
}

function price(gen) {
  return Math.floor(gen.price * Math.pow(gen.mult, gen.count));
}

function cps() {
  let total = 0;
  let skillMult = 1;
  for (let s of state.skillTree) {
    if (s.unlocked && s.effect.type === "gen") skillMult *= s.effect.val;
  }
  
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock) || (g.unlock_prestige && state.prestigeCount < g.unlock_prestige)) continue;
    let eff = 1;
    for (let u of state.upgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    for (let u of state.starUpgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    let corruption_mult = 1;
    for (let c of state.corruption) {
      if (c.effect.target === "production" || c.effect.target === "everything") {
        corruption_mult *= (c.effect.type === "divide" ? 1/c.effect.val : c.effect.val);
      }
    }
    total += g.count * g.base * eff * skillMult * corruption_mult;
  }
  return total * Math.pow(1.25, state.stars) * Math.pow(1.6, state.galaxies);
}

function clickVal() {
  let mult = 1;
  let skillMult = 1;
  for (let s of state.skillTree) {
    if (s.unlocked && s.effect.type === "click") skillMult *= s.effect.val;
  }
  
  for (let u of state.upgrades) {
    if (u.type === "click" && u.bought) mult *= u.effect;
  }
  for (let u of state.starUpgrades) {
    if (u.type === "starclick" && u.bought) mult *= u.effect;
  }
  let corruption_mult = 1;
  for (let c of state.corruption) {
    if (c.effect.target === "click" || c.effect.target === "coins" || c.effect.target === "everything") {
      corruption_mult *= (c.effect.type === "divide" ? 1/c.effect.val : c.effect.val);
    }
  }
  return Math.max(1, mult * skillMult * Math.pow(1.25, state.stars) * Math.pow(1.6, state.galaxies) * corruption_mult);
}

function clickBtn() {
  let val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  state.maxCoins = Math.max(state.maxCoins, state.coins);
  
  // Update display immediately pour un feedback rapide
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  
  checkAchievements();
  updateUIPartial(); // Refresh complet mais throttled
}

function buyGen(genId) {
  for (let g of state.generators) {
    if (g.id === genId) {
      let cost = price(g);
      if (state.coins < cost) return;
      state.coins -= cost;
      g.count++;
      state.totalCoins += cost * 0.1;
      state.prestigeProgress += cost * 0.1;
      checkAchievements();
      checkMilestones();
      save();
      updateUIPartial();
      return;
    }
  }
}

function buyUp(upId) {
  for (let u of state.upgrades) {
    if (u.id === upId) {
      if (u.bought || state.coins < u.price) return;
      if (!isUnlocked(u.unlock)) return;
      if (u.requires) {
        let reqMet = state.upgrades.some(uu => uu.id === u.requires && uu.bought);
        if (!reqMet) return;
      }
      state.coins -= u.price;
      u.bought = true;
      log("âœ… " + u.name + " achetÃ©!", "success");
      checkAchievements();
      save();
      updateUIPartial();
      return;
    }
  }
}

function buyStarUpgrade(id) {
  for (let u of state.starUpgrades) {
    if (u.id === id) {
      if (u.bought || state.stars < u.cost) return;
      if (!isUnlocked(u.unlock)) return;
      state.stars -= u.cost;
      u.bought = true;
      log("âœ¨ " + u.name, "success");
      save();
      updateUIPartial();
      return;
    }
  }
}

function unlockSkill(skillId) {
  for (let s of state.skillTree) {
    if (s.id === skillId) {
      if (s.unlocked || state.skillPoints < s.cost) return;
      if (s.requires) {
        let req = state.skillTree.find(ss => ss.id === s.requires);
        if (!req || !req.unlocked) return;
      }
      state.skillPoints -= s.cost;
      s.unlocked = true;
      log("ğŸŒ³ " + s.name, "success");
      checkMilestones();
      save();
      updateUIPartial();
      return;
    }
  }
}

function prestige() {
  if (state.coins < 1000 || state.prestigeProgress < 10000) return;
  let gain = Math.floor(state.prestigeProgress / 10000);
  let skillMult = 1;
  for (let s of state.skillTree) {
    if (s.unlocked && s.effect.type === "prestige") skillMult *= s.effect.val;
  }
  gain = Math.floor(gain * skillMult);
  if (gain < 1) return;
  
  state.coins = 0;
  state.prestigeProgress = 0;
  state.stars += gain;
  state.prestigeCount++;
  state.skillPoints += 3;
  
  for (let g of state.generators) g.count = 0;
  for (let u of state.upgrades) if (u.id !== "autosave") u.bought = false;
  state.corruption = [];
  
  log("â­ +" + gain + " Ã©toiles!", "success");
  checkAchievements();
  checkMilestones();
  checkUnlocks();
  save();
  updateUI();
}

function superPrestige() {
  let cost = state.galaxies === 0 ? 100 : 100 * Math.pow(10, state.galaxies);
  if (state.coins < 1000 || state.stars < cost) return;
  
  state.stars -= cost;
  state.galaxies++;
  state.prestigeProgress = 0;
  state.skillPoints += 10;
  
  for (let g of state.generators) g.count = 0;
  for (let u of state.upgrades) if (u.id !== "autosave") u.bought = false;
  state.corruption = [];
  
  log("ğŸŒ€ Galaxie +1!", "unlock");
  checkAchievements();
  checkMilestones();
  save();
  updateUI();
}

function addRandomCorruption() {
  if (state.corruption.length >= 10) {
    log("âŒ Max 10 corruptions", "warning");
    return;
  }
  let available = state.corruptions_available.filter(c => !state.corruption.find(ac => ac.id === c.id));
  if (available.length === 0) return;
  let c = available[Math.floor(Math.random() * available.length)];
  state.corruption.push({...c});
  log("ğŸ”¥ " + c.name, "warning");
  checkAchievements();
  save();
  updateUIPartial();
}

function removeCorruption(id) {
  state.corruption = state.corruption.filter(c => c.id !== id);
  log("âœ… Corruption supprimÃ©e", "success");
  save();
  updateUIPartial();
}

function buyResearch(resId) {
  for (let r of state.research) {
    if (r.id === resId) {
      if (r.completed || state.coins < r.cost) return;
      state.coins -= r.cost;
      r.completed = true;
      log("ğŸ“š " + r.name + "!", "success");
      checkMilestones();
      save();
      updateUIPartial();
      return;
    }
  }
}

function startChallenge(chalId) {
  for (let c of state.challenges) {
    if (c.id === chalId) {
      if (c.active || c.completed) return;
      c.active = true;
      c.startCoins = state.totalCoins;
      log("âš”ï¸ " + c.name, "event");
      save();
      updateUIPartial();
      return;
    }
  }
}

function completeChallenge(chalId) {
  for (let c of state.challenges) {
    if (c.id === chalId) {
      c.completed = true;
      c.active = false;
      state.skillPoints += c.reward / 50;
      log("ğŸ† " + c.name + " complÃ©tÃ©!", "success");
      checkAchievements();
      save();
      updateUIPartial();
      return;
    }
  }
}

function resetAllChallenges() {
  if (!confirm("RÃ©initialiser TOUS les challenges?")) return;
  for (let c of state.challenges) {
    c.completed = false;
    c.active = false;
  }
  log("ğŸ”„ Challenges reset", "event");
  save();
  updateUIPartial();
}

function tradeResource(resource, action) {
  let r = trade.resources[resource];
  if (!r) return;
  
  if (action === "buy") {
    if (state.coins < r.price) return;
    state.coins -= r.price;
    r.amount += 1;
    r.price = Math.floor(r.price * (0.93 + Math.random() * 0.12));
  } else if (action === "sell") {
    if (r.amount < 1) return;
    r.amount -= 1;
    let jackpot = Math.random() < 0.05;
    let salePrice = jackpot ? r.price * 2 : r.price;
    state.coins += salePrice;
    if (jackpot) trade.jackpots++;
    r.price = Math.floor(r.price * (1 + (Math.random() - 0.2) * 0.2));
  }
  
  r.history.push(r.price);
  if (r.history.length > 20) r.history.shift();
  trade.totalTrades++;
  checkAchievements();
  checkMilestones();
  save();
  updateUIPartial();
}

function runTradingBots() {
  for (let res in trade.resources) {
    let r = trade.resources[res];
    if (!r.botActive) continue;
    
    if (r.price <= r.bot_buy_target && state.coins > r.price * 10) {
      state.coins -= r.price;
      r.amount += 5;
      r.history.push(r.price);
      trade.totalTrades++;
    } else if (r.price >= r.bot_sell_target && r.amount > 20) {
      r.amount -= 10;
      state.coins += r.price * 10;
      r.history.push(r.price);
      trade.totalTrades++;
    }
    if (r.history.length > 20) r.history.shift();
  }
}

function toggleBot(resource) {
  let r = trade.resources[resource];
  if (!r) return;
  r.botActive = !r.botActive;
  log(r.botActive ? "ğŸ¤– Bot " + resource + " activÃ©" : "ğŸ¤– Bot " + resource + " dÃ©sactivÃ©", "event");
  save();
  updateUIPartial();
}

function checkMilestones() {
  const checks = {
    m1: () => state.totalCoins >= 1,
    m2: () => state.coins >= 100,
    m3: () => state.coins >= 1000,
    m4: () => state.coins >= 10000,
    m5: () => state.coins >= 1000000,
    m6: () => state.generators.some(g => g.count > 0),
    m7: () => state.generators.reduce((a,g) => a + g.count, 0) >= 5,
    m8: () => state.generators.reduce((a,g) => a + g.count, 0) >= 10,
    m9: () => state.prestigeCount >= 1,
    m10: () => state.prestigeCount >= 5,
    m11: () => state.prestigeCount >= 10,
    m12: () => state.stars >= 1,
    m13: () => state.stars >= 10,
    m14: () => state.galaxies >= 1,
    m15: () => trade.totalTrades >= 100,
    m16: () => state.research.filter(r => r.completed).length >= 3,
    m17: () => state.skillTree.filter(s => s.unlocked).length >= 7,
    m18: () => state.corruption.length >= 10 && state.playTime % 300 === 0
  };
  
  for (let m of state.milestones) {
    if (!m.completed && checks[m.id]?.()){
      m.completed = true;
      state.skillPoints += m.reward / 10;
      log("ğŸ¯ " + m.name, "success");
    }
  }
}

function checkAchievements() {
  const checks = {
    first_coin: () => state.totalCoins >= 1,
    ten_coins: () => state.coins >= 10,
    hundred: () => state.coins >= 100,
    thousand: () => state.coins >= 1000,
    tenk: () => state.coins >= 10000,
    million: () => state.coins >= 1e6,
    first_gen: () => state.generators.some(g => g.count > 0),
    five_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 5,
    ten_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 10,
    fifty_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 50,
    first_prestige: () => state.prestigeCount >= 1,
    five_prestige: () => state.prestigeCount >= 5,
    ten_prestige: () => state.prestigeCount >= 10,
    first_star: () => state.stars >= 1,
    first_galaxy: () => state.galaxies >= 1,
    trader: () => trade.totalTrades >= 100,
    big_trader: () => trade.totalTrades >= 1000,
    corrupt: () => state.corruption.length >= 5,
    completionist: () => state.achievements.filter(a => a.unlocked).length >= 30,
    speedrun: () => state.prestigeCount >= 1 && state.playTime < 300
  };
  
  for (let a of state.achievements) {
    if (!a.unlocked && checks[a.id]?.()){
      a.unlocked = true;
      log("ğŸ† " + a.name, "success");
    }
  }
}

function checkUnlocks() {
  if (state.prestigeCount >= 2 && !state.unlockedFeatures.includes("midgame")) {
    state.unlockedFeatures.push("midgame");
    log("ğŸ‰ CONTENU MIDGAME!", "unlock");
  }
  if (state.prestigeCount >= 5 && !state.unlockedFeatures.includes("advanced")) {
    state.unlockedFeatures.push("advanced");
    log("ğŸ‰ CONTENU AVANCÃ‰!", "unlock");
  }
  if (state.prestigeCount >= 10 && !state.unlockedFeatures.includes("endgame")) {
    state.unlockedFeatures.push("endgame");
    log("ğŸ‰ CONTENU FINAL!", "unlock");
  }
}

function resetGame() {
  if (!confirm("RESET TOTAL? Tu perds TOUT!")) return;
  if (!confirm("VRAIMENT SÃ›RE? C'est irrÃ©versible!")) return;
  
  try {
    // Ã‰tape 1: Vider localStorage
    localStorage.clear();
    
    // Ã‰tape 2: Vider sessionStorage  
    sessionStorage.clear();
    
    // Ã‰tape 3: Vider tous les cookies aussi
    document.cookie.split(";").forEach(function(c) { 
      document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
    });
    
    log("ğŸ—‘ï¸ RÃ©initialisation...", "warning");
    
    // Ã‰tape 4: HARD REFRESH - Change l'URL pour forcer le cache Ã  se vider
    setTimeout(() => {
      let url = window.location.href.split('?')[0];
      window.location.href = url + '?reset=' + Date.now();
    }, 500);
  } catch (e) {
    alert("Erreur reset: " + e.message);
  }
}

function exportSave() {
  try {
    let data = JSON.stringify({state, trade, v: 10});
    let blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "save_ITU_" + Date.now() + ".txt";
    a.click();
    log("ğŸ“¤ Sauvegarde exportÃ©e!", "success");
  } catch (e) {
    log("âŒ Erreur export", "event");
  }
}

function importSave() {
  $("importInput").click();
}

function save() {
  try {
    let data = JSON.stringify({state, trade, v: 10});
    localStorage.setItem(SAVE_KEY, data);
  } catch (e) {
    console.error("Save error:", e);
    // Essayer avec encoding si erreur
    try {
      let data = JSON.stringify({state, trade, v: 10});
      let encoded = encodeURIComponent(data);
      localStorage.setItem(SAVE_KEY, encoded);
    } catch (e2) {
      console.error("Save error (encoded):", e2);
    }
  }
}

function load() {
  try {
    let raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return;
    
    let data;
    try {
      // Essayer d'abord le format non-encodÃ©
      data = JSON.parse(raw);
    } catch (e1) {
      try {
        // Sinon essayer encodÃ©
        data = JSON.parse(decodeURIComponent(raw));
      } catch (e2) {
        console.error("Load parse errors:", e1, e2);
        return;
      }
    }
    
    if (data && data.state) {
      Object.assign(state, data.state);
    }
    if (data && data.trade) {
      Object.assign(trade, data.trade);
    }
    log("ğŸ’¾ Sauvegarde chargÃ©e!", "success");
  } catch (e) {
    console.error("Load error:", e);
  }
}

function showTutorial() {
  $("tutorialContent").innerHTML = `
    <h3 style="color:#0cf;margin:1rem 0">ğŸ® BIENVENUE DANS INCREMENTAL TRADE ULTIMATE!</h3>
    
    <p style="background:#222;padding:1rem;border-radius:8px;border-left:4px solid #0af"><strong>ğŸ’¡ Tip:</strong> Ce jeu s'accÃ©lÃ¨re EXPONENTIELLEMENT - c'est normal si les nombres explosent! ğŸš€</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">1ï¸âƒ£ LES BASES - CLIC = ARGENT</h4>
    <p>Clique sur le gros bouton bleu <strong>"CLIC"</strong>! Chaque clic te donne des <strong>piÃ¨ces ğŸ’°</strong></p>
    <p>Plus tu cliques, plus tu gagnes. Simple! Commence par accumuler tes premiÃ¨res piÃ¨ces.</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">2ï¸âƒ£ GÃ‰NÃ‰RATEURS - PRODUCTION AUTOMATIQUE</h4>
    <p>Une fois que tu as assez de piÃ¨ces, achÃ¨te des <strong>gÃ©nÃ©rateurs</strong>:</p>
    <ul style="margin-left:2rem">
      <li><strong>Robot</strong> (0.1/sec) - 15 ğŸ’° - Le premier!</li>
      <li><strong>Usine</strong> (0.5/sec) - 100 ğŸ’°</li>
      <li><strong>Port</strong> (2/sec) - 1100 ğŸ’°</li>
      <li>... et bien d'autres!</li>
    </ul>
    <p>Ils produisent automatiquement sans que tu cliques. Plus tu en achÃ¨tes, plus tu gagnes!</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">3ï¸âƒ£ UPGRADES - DEVIENS SUPER PUISSANT</h4>
    <p><strong>Clic Upgrades:</strong> Augmente la valeur de chaque clic (Clic Ã—2, Ã—5, Ã—10)</p>
    <p><strong>Gen Upgrades:</strong> Boost ta production (GÃ©nÃ©rateurs Ã—2, Ã—5)</p>
    <p>ğŸ’¡ <strong>IMPORTANT:</strong> Les upgrades ne s'achÃ¨tent qu'UNE FOIS mais restent PERMANENTS mÃªme aprÃ¨s prestige!</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">4ï¸âƒ£ PRESTIGE - LES â­ Ã‰TOILES</h4>
    <p>Quand tu atteins <strong>10,000 piÃ¨ces AU TOTAL</strong>, tu peux faire un <strong>PRESTIGE</strong>!</p>
    <p>Le prestige:</p>
    <ul style="margin-left:2rem">
      <li>ğŸ”„ Reset tous tes gÃ©nÃ©rateurs Ã  0</li>
      <li>ğŸ”„ Reset tes piÃ¨ces actuelles</li>
      <li>â­ Te donne des Ã‰TOILES (formule: total coins Ã· 10,000)</li>
      <li>ğŸ“Š La barre de progression repart de 0!</li>
    </ul>
    <p>Exemple: Si tu as 50,000 piÃ¨ces au total â†’ tu gains 5 â­</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">5ï¸âƒ£ Ã‰TOILES - POWER-UPS PERMANENTS</h4>
    <p>Avec tes â­ Ã©toiles, tu peux acheter des upgrades SUPER puissants dans le SHOP Ã‰TOILES:</p>
    <ul style="margin-left:2rem">
      <li><strong>Production Ã—2</strong> (30 â­) - Double ta production PARTOUT!</li>
      <li><strong>Clic Ã—3</strong> (50 â­) - Triple tes clics!</li>
      <li><strong>Auto-clic</strong> (200 â­) - Le jeu clique pour toi!</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">6ï¸âƒ£ GALAXIES - LE SUPER PRESTIGE</h4>
    <p>AprÃ¨s plusieurs prestiges, tu peux dÃ©bloquer les <strong>GALAXIES ğŸŒ€</strong>!</p>
    <p>CoÃ»t: 100 â­ (premiÃ¨re), puis 1000, 10000, etc.</p>
    <p>Effet: <strong>Ã—1.6 multiplicateur SUR TOUT!</strong> (production, clics, Ã©toiles...)</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">7ï¸âƒ£ SKILLS - ARBRE DE COMPÃ‰TENCES</h4>
    <p>Gagne des <strong>SKILL POINTS</strong> quand tu fais prestige (+3 par prestige)</p>
    <p>DÃ©bloque des compÃ©tences permanentes:</p>
    <ul style="margin-left:2rem">
      <li>ğŸ”¥ <strong>Frappe RenforcÃ©e:</strong> +50% clics</li>
      <li>âš™ï¸ <strong>Usine OptimisÃ©e:</strong> +25% production</li>
      <li>ğŸ’« <strong>MÃ©tamorphose:</strong> +15% Ã©toiles au prestige</li>
      <li>ğŸ² <strong>Chance:</strong> +20% bonus au trading</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">8ï¸âƒ£ TRADING - COMMERCE & SPÃ‰CULATION</h4>
    <p>AchÃ¨te/vends des ressources (Iron, Copper, Gold, Platinum)</p>
    <p>Les prix fluctuent alÃ©atoirement!</p>
    <ul style="margin-left:2rem">
      <li>ğŸ“ˆ <strong>AchÃ¨te bas, vends haut</strong> = PROFIT!</li>
      <li>ğŸ¤– <strong>Active les bots</strong> pour trader automatiquement</li>
      <li>ğŸ’° 5% de chance de <strong>JACKPOT</strong> = Ã—2 le prix!</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">9ï¸âƒ£ CHALLENGES - DÃ‰FIS Ã‰PIQUES</h4>
    <p>RelÃ¨ve des dÃ©fis pour gagner des skill points:</p>
    <ul style="margin-left:2rem">
      <li>âš”ï¸ <strong>AscÃ¨te:</strong> Prestige sans cliquer (200pts)</li>
      <li>âš¡ <strong>Ã‰clair:</strong> Prestige en 30 secondes (500pts)</li>
      <li>ğŸ§  <strong>Minimaliste:</strong> Max 3 gÃ©nÃ©rateurs (300pts)</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">ğŸ”Ÿ RECHERCHE - TECHNOLOGIES</h4>
    <p>AchÃ¨te des technologies pour dÃ©bloquer des bonus:</p>
    <ul style="margin-left:2rem">
      <li>ğŸ“š <strong>Tech de Base</strong> (5K ğŸ’°) - DÃ©bloque gÃ©nÃ©rateurs</li>
      <li>âš¡ <strong>Ã‰nergie Stellaire</strong> (50K ğŸ’°) - +1 Ã©toile par prestige</li>
      <li>ğŸ’¹ <strong>Trading AvancÃ©</strong> (200K ğŸ’°) - Prix +30% mieux!</li>
    </ul>
    
    <h4 style="color:#f80;margin-top:1.5rem">ğŸ”¥ CORRUPTION - LE MODE HARDCORE</h4>
    <p><strong>ATTENTION:</strong> Les corruptions rendent le jeu PLUS DUR!</p>
    <p>Elles peuvent:</p>
    <ul style="margin-left:2rem">
      <li>âŒ Diviser ta production par 2</li>
      <li>ğŸ’¸ Prendre 33% de tes piÃ¨ces</li>
      <li>âš ï¸ Rendre le prestige 2x plus cher</li>
    </ul>
    <p>Tu peux les activer pour un dÃ©fi... mais tu peux aussi les supprimer! ğŸ˜…</p>
    
    <h4 style="color:#0af;margin-top:1.5rem">ğŸ“Š OBJECTIFS - MILESTONES</h4>
    <p>ComplÃ¨te 18+ objectifs pour dÃ©bloquer des rÃ©compenses!</p>
    <p>Exemples:</p>
    <ul style="margin-left:2rem">
      <li>100 piÃ¨ces, 1000 piÃ¨ces, 1M piÃ¨ces</li>
      <li>1er gÃ©nÃ©rateur, 10 gÃ©nÃ©rateurs, 50 gÃ©nÃ©rateurs</li>
      <li>1er prestige, 10 prestiges</li>
      <li>1Ã¨re galaxie, 100 trades</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">ğŸ† ACHIEVEMENTS - BADGES</h4>
    <p>Gagne 20+ achievements en jouant!</p>
    <p>Plus tu progresses, plus tu en dÃ©bloques.</p>
    <p>Le dernier: <strong>SPEEDRUNNER</strong> - Prestige en moins de 5min!</p>
    
    <h4 style="color:#ffa;margin-top:1.5rem">ğŸ’¡ STRATÃ‰GIE GAGNANTE</h4>
    <ol style="margin-left:2rem">
      <li><strong>Clique jusqu'Ã  10K</strong> pour le 1er prestige</li>
      <li><strong>AchÃ¨te upgrades de clics</strong> en prioritÃ© (permanent!)</li>
      <li><strong>Fais prestige rÃ©guliÃ¨rement</strong> pour accumules â­</li>
      <li><strong>AchÃ¨te Ã©toile-upgrades</strong> - elles sont TRÃˆS puissantes</li>
      <li><strong>DÃ©bloque skills</strong> progressivement (en arbre)</li>
      <li><strong>Trade un peu</strong> pour extra-coins</li>
      <li><strong>Augmente les galaxies</strong> = Ã—1.6 PARTOUT!</li>
    </ol>
    
    <h4 style="color:#0cf;margin-top:1.5rem">âš™ï¸ MÃ‰CANIQUES CLÃ‰S</h4>
    <ul style="margin-left:2rem">
      <li>âœ… <strong>Clics permanents</strong> - Les upgrades restent aprÃ¨s prestige</li>
      <li>âœ… <strong>Upgrades gÃ©nÃ©rateurs permanents</strong> aussi!</li>
      <li>âœ… <strong>Barre de progression</strong> repart Ã  0 Ã  chaque prestige</li>
      <li>âœ… <strong>Production exponentielle</strong> = Ã§a explose trÃ¨s vite ğŸ“ˆ</li>
      <li>âœ… <strong>Galaxies = Ã—1.6</strong> - C'est Ã‰NORME!</li>
    </ul>
    
    <h4 style="color:#0af;margin-top:1.5rem">ğŸ¯ OBJECTIF FINAL</h4>
    <p><strong>Il n'y a pas vraiment de FIN!</strong> ğŸŒŒ</p>
    <p>Le jeu continue indÃ©finiment - ton but c'est:</p>
    <ul style="margin-left:2rem">
      <li>Atteindre les plus hauts nombres possibles</li>
      <li>DÃ©bloquer tous les achievements</li>
      <li>Maximiser tes multiplicateurs</li>
      <li>Te dÃ©tendre et regarder les nombres augmenter ğŸ˜</li>
    </ul>
    
    <p style="background:#2a1a00;padding:1rem;border-radius:8px;border-left:4px solid #ffa;margin-top:1.5rem">
      <strong>ğŸš€ BON JEU!</strong> Amuse-toi bien et profite de l'expÃ©rience! Les nombres vont exploser, c'est normal! ğŸ’¥
    </p>
  `;
  $("tutorialModal").style.display = "flex";
}

function showHelp() {
  showTutorial();
}

function closeTutorial() {
  $("tutorialModal").style.display = "none";
}

let lastLogUpdate = 0;
let lastLogMessageCount = 0;

function updateLogDisplay() {
  if (state.logMessages.length !== lastLogMessageCount) {
    let logHTML = state.logMessages.map(m => `<div class="log-message ${m.type}">[${m.time}] ${m.text}</div>`).join("");
    $("log").innerHTML = logHTML;
    lastLogMessageCount = state.logMessages.length;
  }
}

let lastUIUpdate = 0;

function updateUIPartial() {
  let now = Date.now();
  if (now - lastUIUpdate < UPDATE_INTERVAL) return;
  lastUIUpdate = now;
  updateUI(false);
}

function updateUI(updateLog = true) {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  $("stars").textContent = state.stars;
  $("galaxies").textContent = state.galaxies;
  $("prestigeCount").textContent = state.prestigeCount;
  $("starsAvailable").textContent = state.stars;
  $("skillPoints").textContent = state.skillPoints;
  
  // Prestige display
  let pGain = Math.floor(state.prestigeProgress / 10000);
  $("prestigeGain").textContent = pGain;
  $("prestigeGainDisplay").textContent = pGain;
  $("prestigeBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeMaxBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeProgress").style.width = Math.min(100, (state.prestigeProgress / 10000) * 100) + "%";
  
  // Galaxy
  let galaxyCost = state.galaxies === 0 ? 100 : 100 * Math.pow(10, state.galaxies);
  $("superPrestigeBtn").disabled = state.stars < galaxyCost;
  $("galaxyInfo").innerHTML = `<div style="text-align:center;padding:1rem"><div style="font-size:2rem;font-weight:bold;color:#0cf">${state.galaxies} ğŸŒ€</div><div style="font-size:0.9rem;color:#aaa">CoÃ»t: ${formatNum(galaxyCost)} â­</div></div>`;
  
  // Generators
  let gensHTML = "";
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock) || (g.unlock_prestige && state.prestigeCount < g.unlock_prestige)) continue;
    let cost = price(g);
    let canBuy = state.coins >= cost;
    gensHTML += `<div class="gen-item">
      <div><strong>${g.name}</strong> <span class="count">Ã—${g.count}</span></div>
      <button class="buy-btn" onclick="buyGen('${g.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(cost)}</button>
    </div>`;
  }
  $("gens").innerHTML = gensHTML || "Aucun gÃ©nÃ©rateur dÃ©bloquÃ©";
  
  // Click Upgrades
  let clickUpsHTML = "";
  for (let u of state.upgrades) {
    if (u.type !== "click" || u.bought) continue;
    if (u.requires) {
      let req = state.upgrades.find(uu => uu.id === u.requires);
      if (!req || !req.bought) continue;
    }
    let canBuy = state.coins >= u.price;
    clickUpsHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong> Ã—${u.effect}</div>
      <button class="buy-btn" onclick="buyUp('${u.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(u.price)}</button>
    </div>`;
  }
  $("clickUpgrades").innerHTML = clickUpsHTML || "âœ… Tous achetÃ©s!";
  
  // Other Upgrades
  let upsHTML = "";
  for (let u of state.upgrades) {
    if (u.type === "click" || u.bought) continue;
    if (u.requires) {
      let req = state.upgrades.find(uu => uu.id === u.requires);
      if (!req || !req.bought) continue;
    }
    let canBuy = state.coins >= u.price;
    upsHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyUp('${u.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(u.price)}</button>
    </div>`;
  }
  $("ups").innerHTML = upsHTML || "âœ… Tous achetÃ©s!";
  
  // Star Upgrades
  let starHTML = "";
  for (let u of state.starUpgrades) {
    if (u.bought) continue;
    let canBuy = state.stars >= u.cost;
    starHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyStarUpgrade('${u.id}')" ${canBuy ? '' : 'disabled'}>${u.cost}â­</button>
    </div>`;
  }
  $("starShop").innerHTML = starHTML || "âœ… Tous achetÃ©s!";
  
  // TRADING
  let tradeHTML = "";
  for (let res in trade.resources) {
    let r = trade.resources[res];
    tradeHTML += `<div class="trade-item">
      <div>
        <strong>${res.toUpperCase()}</strong><br>
        Stock: ${r.amount} | Prix: ${formatNum(r.price)}<br>
        <span class="bot-status ${r.botActive ? 'active' : 'inactive'}"></span>
        <button class="buy-btn" onclick="toggleBot('${res}')" style="font-size:0.8rem;padding:0.3rem 0.6rem">${r.botActive ? 'ğŸ¤– ON' : 'âšª OFF'}</button>
      </div>
      <div style="display:flex;gap:0.3rem">
        <button class="buy-btn" onclick="tradeResource('${res}','buy')" ${state.coins >= r.price ? '' : 'disabled'}>Acheter</button>
        <button class="buy-btn" onclick="tradeResource('${res}','sell')" ${r.amount > 0 ? '' : 'disabled'}>Vendre</button>
      </div>
    </div>`;
  }
  $("tradeContent").innerHTML = tradeHTML;
  
  // MILESTONES
  let milestonesHTML = "";
  for (let m of state.milestones) {
    milestonesHTML += `<div class="milestone-item ${m.completed ? 'completed' : ''}">
      <strong>${m.completed ? 'âœ…' : 'ğŸ”’'} ${m.name}</strong><br>
      <small>${m.desc}</small>
    </div>`;
  }
  $("milestonesContent").innerHTML = milestonesHTML;
  
  // CHALLENGES
  let challengesHTML = "";
  for (let c of state.challenges) {
    challengesHTML += `<div class="challenge-item ${c.completed ? 'completed' : ''}">
      <div><strong>${c.completed ? 'âœ…' : c.active ? 'â–¶ï¸' : ''} ${c.name}</strong><br><small>${c.desc}</small></div>
      <button class="buy-btn" onclick="startChallenge('${c.id}')" ${c.completed || c.active ? 'disabled' : ''}>${c.reward}pts</button>
    </div>`;
  }
  $("challengesContent").innerHTML = challengesHTML;
  
  // SKILLS
  let skillHTML = "";
  for (let s of state.skillTree) {
    skillHTML += `<div class="skill-node ${s.unlocked ? 'unlocked' : s.requires && !state.skillTree.find(ss => ss.id === s.requires && ss.unlocked) ? 'locked' : ''}">
      <strong>${s.unlocked ? 'âœ… ' : ''}${s.name}</strong><br>
      <small>${s.desc}</small>
      ${!s.unlocked ? `<button class="buy-btn" onclick="unlockSkill('${s.id}')" style="margin-top:0.5rem;width:100%;font-size:0.8rem" ${state.skillPoints >= s.cost && (!s.requires || state.skillTree.find(ss => ss.id === s.requires && ss.unlocked)) ? '' : 'disabled'}>${s.cost}pts</button>` : ''}
    </div>`;
  }
  $("skillTree").innerHTML = skillHTML;
  
  // RESEARCH
  let researchHTML = "";
  for (let r of state.research) {
    researchHTML += `<div class="research-item ${r.completed ? 'completed' : ''}">
      <strong>${r.completed ? 'âœ…' : 'ğŸ“–'} ${r.name}</strong><br>
      <small>${r.desc}</small><br>
      CoÃ»t: ${formatNum(r.cost)} ğŸ’°
      <button class="buy-btn" onclick="buyResearch('${r.id}')" style="width:100%;margin-top:0.5rem" ${r.completed || state.coins < r.cost ? 'disabled' : ''}>Chercher</button>
    </div>`;
  }
  $("researchContent").innerHTML = researchHTML;
  
  // CORRUPTION
  let corruptionHTML = "";
  for (let c of state.corruption) {
    corruptionHTML += `<div class="corruption-item">
      <div><strong>${c.name}</strong> - ${c.desc}</div>
      <button class="buy-btn" onclick="removeCorruption('${c.id}')" style="background:linear-gradient(135deg, #f55 0%, #c33 100%);padding:0.4rem 0.8rem">âœ•</button>
    </div>`;
  }
  $("corruptionList").innerHTML = corruptionHTML || "Aucune corruption active";
  $("corruptionCount").textContent = state.corruption.length;
  
  // STATS
  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  let timeStr = state.playTime < 60 ? state.playTime + "s" : state.playTime < 3600 ? Math.floor(state.playTime/60) + "m" : (state.playTime/3600).toFixed(1) + "h";
  $("playTime").textContent = timeStr;
  $("prestigeCountStat").textContent = state.prestigeCount;
  $("totalTrades").textContent = trade.totalTrades;
  $("maxCoinsDisplay").textContent = formatNum(state.maxCoins);
  
  // Achievements
  let achHTML = state.achievements.map(a => `<div class="achievement-item ${a.unlocked ? 'unlocked' : ''}">
    <strong>${a.unlocked ? 'âœ…' : 'ğŸ”’'} ${a.name}</strong><br>
    <small>${a.desc}</small>
  </div>`).join("");
  $("achievements").innerHTML = achHTML;
  $("achievementCount").textContent = state.achievements.filter(a => a.unlocked).length;
  $("achievementTotal").textContent = state.achievements.length;
  
  if (updateLog) {
    updateLogDisplay();
  }
}

function init() {
  $("clickBtn").addEventListener("click", clickBtn);
  $("importInput").addEventListener("change", function(e) {
    let file = e.target.files[0];
    if (!file) return;
    file.text().then(txt => {
      try {
        let data = JSON.parse(txt);
        if (!data.state) data = JSON.parse(atob(txt));
        state = data.state;
        trade = data.trade;
        save();
        updateUI();
        log("ğŸ“¥ Sauvegarde importÃ©e!", "success");
      } catch (x) {
        log("âŒ Fichier invalide", "event");
      }
    });
  });

  load();
  
  setTimeout(() => {
    updateUI();
    log("ğŸ® Bienvenue!", "unlock");
    if (state.prestigeCount === 0) {
      showTutorial();
    }
  }, 100);
  
  // Game loop - MOINS FRÃ‰QUENT
  setInterval(() => {
    let gain = cps() / FPS;
    state.coins += gain;
    state.totalCoins += gain;
    state.prestigeProgress += gain;
    state.maxCps = Math.max(state.maxCps, cps());
    
    for (let u of state.starUpgrades) {
      if (u.id.includes("auto") && u.bought) {
        state.coins += clickVal() / FPS;
        state.totalCoins += clickVal() / FPS;
        state.prestigeProgress += clickVal() / FPS;
      }
    }
    
    updateUIPartial();
  }, 1000 / FPS);

  setInterval(() => {
    state.playTime++;
    checkAchievements();
    checkMilestones();
    
    // Mettre Ã  jour les prix du trading
    for (let res in trade.resources) {
      let r = trade.resources[res];
      let change = (Math.random() - 0.5) * 8;
      r.price = Math.max(1, Math.floor(r.price * (1 + change/100)));
      r.history.push(r.price);
      if (r.history.length > 20) r.history.shift();
    }
    
    // Run trading bots
    runTradingBots();
    
    save();
  }, 1000);

  window.addEventListener("beforeunload", save);
}

init();
</script>
</body>
</html>
