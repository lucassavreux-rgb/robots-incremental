function buyUp(upId) {
  const up = state.upgrades.find(u => u.id === upId);
  if (!up || up.bought || state.coins < up.price) return;
  
  if (up.requires) {
    const required = state.upgrades.find(u => u.id === up.requires);
    if (!required || !required.bought) return;
  }
  
  state.coins -= up.price;
  up.bought = true;
  
  if (up.type === "feature" && up.id === "reducefee") {
    trade.fee = 0.03;
  }
  
  log(`âœ… Upgrade achetÃ© : ${up.name}`);
  checkAchievements();
  refresh();
  save();
}

function buyStarUpgrade(id) {
  const up = state.starUpgrades.find(u => u.id === id);
  if (!up || up.bought || state.stars < up.cost) return;
  
  if (up.requires) {
    const required = state.starUpgrades.find(u => u.id === up.requires);
    if (!required || !required.bought) return;
  }
  
  state.stars -= up.cost;
  up.bought = true;
  
  log(`âœ¨ Upgrade Ã©toile achetÃ© : ${up.name}`);
  refresh();
  save();
}<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,Arial;background:#111;color:#eee;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center}
  button{padding:.6rem 1.2rem;font-size:1.2rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer;transition:all 0.2s}
  button:hover:not(:disabled){background:#0cf;transform:scale(1.05)}
  button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%;max-width:1200px}
  .card{background:#222;padding:1rem;border-radius:8px;flex:1 1 220px;margin:.5rem;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
  .card h3{margin-top:0;color:#0af;border-bottom:2px solid #0af;padding-bottom:.5rem}
  #log{height:120px;overflow-y:auto;background:#000;padding:.5rem;border-radius:6px;font-size:.85rem;margin-top:.5rem}
  #cpsDisp{font-size:1rem;color:#ffa;margin-bottom:1rem}
  .gen-item,.up-item{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0;padding:.5rem;background:#333;border-radius:4px}
  .gen-item:hover,.up-item:hover{background:#444}
  .achievement{background:#2a2a00;padding:.5rem;margin:.3rem 0;border-left:4px solid #ffa;border-radius:4px;font-size:.9rem}
  .achievement.unlocked{background:#002a00;border-left-color:#0f0}
  .stat-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #333}
  #clickBtn{font-size:1.5rem;padding:1rem 2rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1rem}
  .price{color:#ffa}
  .count{color:#0f0;font-weight:bold}
  .progress-bar{background:#333;height:20px;border-radius:10px;overflow:hidden;margin:.5rem 0}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf);height:100%;transition:width 0.3s}
  .buy-btn{padding:.5rem 1rem;font-size:1rem}
</style>
</head>
<body>

<h1>ğŸ’° PiÃ¨ces : <span id="coins">0</span></h1>
<div id="cpsDisp">PiÃ¨ces/sec : <span id="cps">0</span></div>
<button id="clickBtn">ğŸ‘† Clic +<span id="clickValue">1</span></button>

<div class="row">
  <div class="card">
    <h3>ğŸ¤– GÃ©nÃ©rateurs</h3>
    <div id="gens"></div>
  </div>
  
  <div class="card">
    <h3>âš¡ Upgrades</h3>
    <div id="ups"></div>
  </div>
  
  <div class="card">
    <h3>âœ¨ Shop Ã‰toiles</h3>
    <div>Ã‰toiles disponibles : <span class="count" id="starsAvailable">0</span> â­</div>
    <div id="starShop" style="max-height:300px;overflow-y:auto;margin-top:.5rem"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>â­ Prestige</h3>
    <div class="stat-line">
      <span>Ã‰toiles totales</span>
      <span class="count" id="stars">0</span>
    </div>
    <div class="stat-line">
      <span>Bonus production</span>
      <span class="count">Ã—<span id="bonus">1</span></span>
    </div>
    <div class="stat-line">
      <span>CoÃ»t prestige</span>
      <span class="price" id="prestigeCost">1000</span> ğŸ’°
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="prestigeProgress" style="width:0%"></div>
    </div>
    <button id="prestigeBtn" disabled>Prestige +<span id="prestigeGain">0</span> â­</button>
    <button id="prestigeMaxBtn" disabled>Prestige MAX</button>
    <small style="color:#888">Le coÃ»t Ã—10 Ã  chaque prestige</small>
  </div>
  <div class="card">
    <h3>ğŸ“Š MarchÃ© du Fer</h3>
    <div class="stat-line">
      <span>Fer possÃ©dÃ©</span>
      <span class="count" id="iron">0</span>
    </div>
    <div class="stat-line">
      <span>Cours actuel</span>
      <span class="price" id="ironPrice">10</span> ğŸ’°
    </div>
    <div class="stat-line">
      <span>Moyenne (20 ticks)</span>
      <span id="ironAvg">10</span> ğŸ’°
    </div>
    <button id="buyIronBtn">Acheter max</button>
    <button id="sellIronBtn">Vendre tout</button><br>
    <button id="botBtn">ğŸ¤– Bot : OFF</button>
    <div id="botStatus" style="margin-top:.5rem;color:#0f0;font-size:.9rem"></div>
    <small style="color:#888">Frais : 5% par transaction</small>
  </div>

  <div class="card">
    <h3>ğŸ† SuccÃ¨s</h3>
    <div id="achievements" style="max-height:200px;overflow-y:auto"></div>
  </div>

  <div class="card">
    <h3>ğŸ“ˆ Statistiques</h3>
    <div class="stat-line">
      <span>Total gagnÃ©</span>
      <span class="count" id="totalCoins">0</span> ğŸ’°
    </div>
    <div class="stat-line">
      <span>Clics effectuÃ©s</span>
      <span class="count" id="totalClicks">0</span>
    </div>
    <div class="stat-line">
      <span>Temps de jeu</span>
      <span class="count" id="playTime">0s</span>
    </div>
    <div class="stat-line">
      <span>Prestiges</span>
      <span class="count" id="prestigeCount">0</span>
    </div>
  </div>
</div>

<div class="card" style="max-width:1200px">
  <h3>ğŸ’¾ Sauvegarde</h3>
  <button id="exportBtn">ğŸ“¤ Exporter</button>
  <button id="importBtn">ğŸ“¥ Importer</button>
  <button id="resetBtn" style="background:#c33">ğŸ—‘ï¸ Reset Total</button>
  <input id="importInput" type="file" accept=".txt" style="display:none">
  <div id="log"></div>
</div>

<script>
const SAVE_KEY = "idleTrade_v2";
const FPS = 20;

let state = {
  coins: 0,
  totalCoins: 0,
  stars: 0,
  totalClicks: 0,
  prestigeCount: 0,
  playTime: 0,
  prestigeCost: 1000, // CoÃ»t initial du prestige
  starUpgrades: [
    {id:"star_prod1", name:"Production Ã—2", cost:5, bought:false, effect:2, type:"production"},
    {id:"star_prod2", name:"Production Ã—5", cost:15, bought:false, effect:5, type:"production", requires:"star_prod1"},
    {id:"star_prod3", name:"Production Ã—10", cost:40, bought:false, effect:10, type:"production", requires:"star_prod2"},
    {id:"star_click1", name:"Clics Ã—3", cost:8, bought:false, effect:3, type:"starclick"},
    {id:"star_click2", name:"Clics Ã—10", cost:25, bought:false, effect:10, type:"starclick", requires:"star_click1"},
    {id:"star_gen1", name:"Robot Ã—50", cost:10, bought:false, effect:50, type:"robot"},
    {id:"star_gen2", name:"Usine Ã—50", cost:20, bought:false, effect:50, type:"usine"},
    {id:"star_auto1", name:"Auto-clic (1/s)", cost:30, bought:false, type:"autoclick"},
    {id:"star_prestige", name:"Prestige garde upgrades", cost:50, bought:false, type:"keepupgrades"}
  ],
  generators: [
    {id:"robot", name:"Robot", base:0.5, count:0, price:10, mult:1.15},
    {id:"usine", name:"Usine", base:3, count:0, price:120, mult:1.15},
    {id:"port", name:"Port", base:15, count:0, price:1300, mult:1.15},
    {id:"labo", name:"Labo", base:80, count:0, price:12000, mult:1.15},
    {id:"satellite", name:"Satellite", base:500, count:0, price:140000, mult:1.15},
    {id:"station", name:"Station spatiale", base:3000, count:0, price:2e6, mult:1.15},
    {id:"dyson", name:"SphÃ¨re de Dyson", base:20000, count:0, price:5e7, mult:1.15}
  ],
  upgrades: [
    {id:"click2", name:"Clic Ã—2", price:200, effect:2, bought:false, type:"click"},
    {id:"click5", name:"Clic Ã—5", price:5000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"click10", name:"Clic Ã—10", price:100000, effect:10, bought:false, type:"click", requires:"click5"},
    {id:"gen2", name:"Tous les gen Ã—2", price:5000, effect:2, bought:false, type:"gen"},
    {id:"gen3", name:"Tous les gen Ã—3", price:50000, effect:3, bought:false, type:"gen", requires:"gen2"},
    {id:"gen5", name:"Tous les gen Ã—5", price:500000, effect:5, bought:false, type:"gen", requires:"gen3"},
    {id:"robot10", name:"Robot Ã—10", price:1000, effect:10, bought:false, type:"robot"},
    {id:"usine10", name:"Usine Ã—10", price:10000, effect:10, bought:false, type:"usine"},
    {id:"port10", name:"Port Ã—10", price:100000, effect:10, bought:false, type:"port"},
    {id:"autosave", name:"Sauvegarde auto", price:500, bought:false, type:"feature"},
    {id:"reducefee", name:"Frais rÃ©duits (3%)", price:25000, bought:false, type:"feature"}
  ],
  achievements: [
    {id:"first_coin", name:"PremiÃ¨re piÃ¨ce", desc:"Gagner votre premiÃ¨re piÃ¨ce", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"Avoir 100 piÃ¨ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"Avoir 1000 piÃ¨ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"Acheter votre premier gÃ©nÃ©rateur", unlocked:false},
    {id:"ten_gens", name:"Industriel", desc:"Avoir 10 gÃ©nÃ©rateurs au total", unlocked:false},
    {id:"first_prestige", name:"Renaissance", desc:"Faire votre premier prestige", unlocked:false},
    {id:"clicker", name:"Clickeur fou", desc:"Faire 100 clics", unlocked:false},
    {id:"trader", name:"Trader", desc:"Acheter du fer", unlocked:false},
    {id:"hour_play", name:"Dedication", desc:"Jouer pendant 1 heure", unlocked:false},
    {id:"all_upgrades", name:"AmÃ©liorÃ©", desc:"Acheter toutes les upgrades de base", unlocked:false}
  ]
};

let trade = {
  iron: 0,
  price: 10,
  history: [10],
  fee: 0.05,
  botActive: false,
  totalTrades: 0
};

const $ = id => document.getElementById(id);

function log(txt) {
  const logEl = $("log");
  logEl.insertAdjacentHTML("beforeend", `<div>[${new Date().toLocaleTimeString()}] ${txt}</div>`);
  logEl.scrollTop = 1e9;
}

function formatNum(n) {
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  return (n / 1e9).toFixed(2) + "B";
}

function price(gen) {
  return Math.floor(gen.price * Math.pow(gen.mult, gen.count));
}

function cps() {
  const genMultiplier = state.upgrades
    .filter(u => u.type === "gen" && u.bought)
    .reduce((acc, u) => acc * u.effect, 1);
  
  // Multiplicateur des upgrades Ã©toiles pour la production
  const starProdMult = state.starUpgrades
    .filter(u => u.type === "production" && u.bought)
    .reduce((acc, u) => acc * u.effect, 1);
  
  let total = 0;
  state.generators.forEach(g => {
    let genEffect = genMultiplier * starProdMult;
    const specificUpgrade = state.upgrades.find(u => u.type === g.id && u.bought);
    if (specificUpgrade) genEffect *= specificUpgrade.effect;
    
    // Upgrades Ã©toiles spÃ©cifiques au gÃ©nÃ©rateur
    const starGenUpgrade = state.starUpgrades.find(u => u.type === g.id && u.bought);
    if (starGenUpgrade) genEffect *= starGenUpgrade.effect;
    
    total += g.count * g.base * genEffect;
  });
  
  // Bonus des Ã©toiles : chaque Ã©toile donne Ã—2.2 de production
  return total * Math.pow(2.2, state.stars);
}

function clickVal() {
  const clickMultiplier = state.upgrades
    .filter(u => u.type === "click" && u.bought)
    .reduce((acc, u) => acc * u.effect, 1);
  
  // Multiplicateur des upgrades Ã©toiles pour les clics
  const starClickMult = state.starUpgrades
    .filter(u => u.type === "starclick" && u.bought)
    .reduce((acc, u) => acc * u.effect, 1);
  
  // Bonus des Ã©toiles pour les clics aussi
  return clickMultiplier * starClickMult * Math.pow(2.2, state.stars);
}

function clickBtn() {
  const val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  checkAchievements();
  refreshFast();
}

function buyGen(genId) {
  const gen = state.generators.find(g => g.id === genId);
  if (!gen) return;
  
  const cost = price(gen);
  if (state.coins < cost) return;
  
  state.coins -= cost;
  gen.count++;
  state.totalCoins += cost * 0.1;
  checkAchievements();
  refresh();
  save();
}

function buyStarUpgrade(id) {
  const up = state.starUpgrades.find(u => u.id === id);
  if (!up || up.bought || state.stars < up.cost) return;
  
  if (up.requires) {
    const required = state.starUpgrades.find(u => u.id === up.requires);
    if (!required || !required.bought) return;
  }
  
  state.stars -= up.cost;
  up.bought = true;
  
  log(`âœ¨ Upgrade Ã©toile achetÃ© : ${up.name}`);
  refresh();
  save();
}

function prestige() {
  const gain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  if (gain < 1 || state.totalCoins < state.prestigeCost) return;
  
  state.stars += gain;
  state.prestigeCount++;
  state.prestigeCost = Math.floor(state.prestigeCost * 10); // Le coÃ»t augmente Ã—10 Ã  chaque prestige
  resetCore();
  log(`â­ Prestige ! +${gain} Ã©toiles (Total: ${state.stars}) - Prochain prestige: ${formatNum(state.prestigeCost)} ğŸ’°`);
  checkAchievements();
  save();
}

function prestigeMax() {
  // Calcul du nombre de prestiges possibles
  let tempTotal = state.totalCoins;
  let tempCost = state.prestigeCost;
  let totalGain = 0;
  let prestigesDone = 0;
  
  while (tempTotal >= tempCost) {
    const gain = Math.floor(Math.sqrt(tempTotal / tempCost));
    if (gain < 1) break;
    
    totalGain += gain;
    prestigesDone++;
    tempCost = Math.floor(tempCost * 10);
    tempTotal = 0; // AprÃ¨s chaque prestige on reset
  }
  
  if (totalGain < 1) return;
  
  state.stars += totalGain;
  state.prestigeCount += prestigesDone;
  for (let i = 0; i < prestigesDone; i++) {
    state.prestigeCost = Math.floor(state.prestigeCost * 10);
  }
  resetCore();
  log(`â­ MULTI PRESTIGE ! +${totalGain} Ã©toiles en ${prestigesDone} prestige${prestigesDone > 1 ? 's' : ''} ! (Total: ${state.stars})`);
  checkAchievements();
  save();
}

function resetCore() {
  const keepUpgrades = state.starUpgrades.find(u => u.id === "star_prestige")?.bought;
  
  state.coins = 0;
  state.totalCoins = 0;
  state.generators.forEach(g => g.count = 0);
  
  // Si on a l'upgrade "garder les upgrades", on les garde
  if (!keepUpgrades) {
    state.upgrades.forEach(u => {
      if (u.id !== "autosave" && u.id !== "reducefee") {
        u.bought = false;
      }
    });
  }
  
  trade.iron = 0;
  trade.price = 10;
  trade.history = [10];
  trade.botActive = false;
  refresh();
}

function tickMarket() {
  const change = (Math.random() - 0.48) * 0.08;
  trade.price = Math.max(2, Math.floor(trade.price * (1 + change)));
  trade.history.push(trade.price);
  if (trade.history.length > 20) trade.history.shift();
  
  if (trade.botActive) botTrade();
  refresh();
}

function buyIron() {
  const fee = trade.fee;
  const priceWithFee = trade.price * (1 + fee);
  const qty = Math.max(1, Math.floor(state.coins / priceWithFee));
  const cost = qty * priceWithFee;
  
  if (state.coins < cost) return;
  
  state.coins -= cost;
  trade.iron += qty;
  trade.totalTrades++;
  checkAchievements();
  refreshFast();
  save();
}

function sellIron() {
  if (trade.iron < 1) return;
  
  const gain = trade.iron * trade.price * (1 - trade.fee);
  state.coins += gain;
  state.totalCoins += gain * 0.5;
  trade.iron = 0;
  trade.totalTrades++;
  refreshFast();
  save();
}

function toggleBot() {
  trade.botActive = !trade.botActive;
  log(trade.botActive ? "ğŸ¤– Bot activÃ©" : "ğŸ¤– Bot dÃ©sactivÃ©");
  refresh();
}

function botTrade() {
  if (trade.history.length < 3) return;
  
  const avg = trade.history.reduce((a, b) => a + b, 0) / trade.history.length;
  
  if (trade.price < avg * 0.88 && state.coins > trade.price * 10) {
    buyIron();
  }
  
  if (trade.price > avg * 1.18 && trade.iron > 0) {
    sellIron();
  }
}

function checkAchievements() {
  // DÃ©finir les conditions ici (pas dans state car on peut pas sauvegarder des fonctions)
  const achievementChecks = {
    first_coin: s => s.totalCoins >= 1,
    hundred: s => s.coins >= 100,
    thousand: s => s.coins >= 1000,
    first_gen: s => s.generators.some(g => g.count > 0),
    ten_gens: s => s.generators.reduce((a,g) => a + g.count, 0) >= 10,
    first_prestige: s => s.prestigeCount >= 1,
    clicker: s => s.totalClicks >= 100,
    trader: () => trade.iron > 0 || trade.totalTrades > 0,
    hour_play: s => s.playTime >= 3600,
    all_upgrades: s => s.upgrades.filter(u => u.price < 10000).every(u => u.bought)
  };
  
  state.achievements.forEach(ach => {
    if (!ach.unlocked && achievementChecks[ach.id] && achievementChecks[ach.id](state)) {
      ach.unlocked = true;
      log(`ğŸ† SuccÃ¨s dÃ©bloquÃ© : ${ach.name}`);
    }
  });
}

function save() {
  try {
    const saveData = {
      state: state,
      trade: trade,
      version: 2,
      timestamp: Date.now()
    };
    localStorage.setItem(SAVE_KEY, btoa(JSON.stringify(saveData)));
  } catch (e) {
    log("âŒ Erreur de sauvegarde");
  }
}

function load() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      const data = JSON.parse(atob(raw));
      
      state = {...state, ...data.state};
      trade = {...trade, ...data.trade};
      
      log("ğŸ’¾ Partie chargÃ©e");
    }
  } catch (e) {
    log("âŒ Sauvegarde corrompue");
  }
  refresh();
}

function exportSave() {
  try {
    const saveData = {state: state, trade: trade, version: 2};
    const blob = new Blob([btoa(JSON.stringify(saveData))], {type: "text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `idle_trade_${Date.now()}.txt`;
    a.click();
    log("ğŸ“¤ Sauvegarde exportÃ©e");
  } catch (e) {
    log("âŒ Erreur d'export");
  }
}

function importSave() {
  $("importInput").click();
}

function resetGame() {
  if (confirm("âš ï¸ ATTENTION ! ÃŠtes-vous VRAIMENT sÃ»r de vouloir tout rÃ©initialiser ?\n\nVous perdrez :\n- Toutes vos piÃ¨ces\n- Tous vos gÃ©nÃ©rateurs\n- Toutes vos Ã©toiles\n- Tous vos upgrades\n- Toute votre progression\n\nCette action est IRRÃ‰VERSIBLE !")) {
    if (confirm("DerniÃ¨re confirmation : voulez-vous vraiment TOUT supprimer ?")) {
      localStorage.removeItem(SAVE_KEY);
      log("ğŸ—‘ï¸ Partie complÃ¨tement rÃ©initialisÃ©e !");
      setTimeout(() => location.reload(), 1000);
    }
  }
}

// Fonction pour rafraÃ®chir seulement les chiffres (rapide)
function refreshFast() {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  $("bonus").textContent = formatNum(Math.pow(2.2, state.stars));
  $("stars").textContent = state.stars;
  $("starsAvailable").textContent = state.stars;
  
  const prestigeGain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  $("prestigeGain").textContent = prestigeGain;
  $("prestigeBtn").disabled = prestigeGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeMaxBtn").disabled = prestigeGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeCost").textContent = formatNum(state.prestigeCost);
  
  const prestigeProgress = Math.min(100, (state.totalCoins / state.prestigeCost) * 100);
  $("prestigeProgress").style.width = prestigeProgress + "%";

  // Update seulement les textes des gÃ©nÃ©rateurs (pas le HTML complet)
  state.generators.forEach(g => {
    const cost = price(g);
    const btn = document.querySelector(`[data-gen-id="${g.id}"]`);
    if (btn) {
      btn.disabled = state.coins < cost;
      btn.textContent = formatNum(cost) + " ğŸ’°";
    }
    const countEl = document.querySelector(`#gen-count-${g.id}`);
    const prodEl = document.querySelector(`#gen-prod-${g.id}`);
    if (countEl) countEl.textContent = "Ã—" + g.count;
    if (prodEl) {
      const genProd = g.base * g.count * Math.pow(2.2, state.stars);
      prodEl.textContent = formatNum(genProd) + "/s";
    }
  });

  // Update les upgrades
  state.upgrades.forEach(u => {
    const btn = document.querySelector(`[data-up-id="${u.id}"]`);
    if (btn) {
      btn.disabled = state.coins < u.price;
    }
  });

  // Update les star upgrades
  state.starUpgrades.forEach(u => {
    const btn = document.querySelector(`[data-star-id="${u.id}"]`);
    if (btn) {
      btn.disabled = state.stars < u.cost;
    }
  });

  // Stats
  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  $("playTime").textContent = state.playTime < 60 ? state.playTime + "s" : 
    state.playTime < 3600 ? Math.floor(state.playTime / 60) + "m" :
    (state.playTime / 3600).toFixed(1) + "h";
  $("prestigeCount").textContent = state.prestigeCount;
}

// Fonction complÃ¨te pour reconstruire toute l'interface (lent)
function refresh() {
  refreshFast();
  
  // GÃ©nÃ©rateurs - ON AJOUTE DES EVENT LISTENERS
  $("gens").innerHTML = state.generators.map(g => {
    const cost = price(g);
    const canBuy = state.coins >= cost;
    return `
      <div class="gen-item">
        <div>
          <strong>${g.name}</strong> <span class="count" id="gen-count-${g.id}">Ã—${g.count}</span><br>
          <small id="gen-prod-${g.id}">${formatNum(g.base * g.count * (1 + state.stars * 0.05))}/s</small>
        </div>
        <button class="buy-btn gen-buy-btn" data-gen-id="${g.id}" ${!canBuy ? "disabled" : ""}>
          ${formatNum(cost)} ğŸ’°
        </button>
      </div>
    `;
  }).join("");
  
  // IMPORTANT: Ajouter les event listeners aprÃ¨s avoir crÃ©Ã© les boutons
  document.querySelectorAll('.gen-buy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const genId = this.getAttribute('data-gen-id');
      buyGen(genId);
    });
  });

  // Upgrades - PAREIL ICI
  const availableUpgrades = state.upgrades.filter(u => {
    if (u.bought) return false;
    if (u.requires) {
      const req = state.upgrades.find(r => r.id === u.requires);
      return req && req.bought;
    }
    return true;
  });
  
  $("ups").innerHTML = availableUpgrades.length > 0 ? availableUpgrades.map(u => {
    const canBuy = state.coins >= u.price;
    return `
      <div class="up-item">
        <div>
          <strong>${u.name}</strong><br>
          <small style="color:#888">${u.type}</small>
        </div>
        <button class="buy-btn up-buy-btn" data-up-id="${u.id}" ${!canBuy ? "disabled" : ""}>
          ${formatNum(u.price)} ğŸ’°
        </button>
      </div>
    `;
  }).join("") : "<div style='color:#888;text-align:center'>Toutes les upgrades achetÃ©es !</div>";
  
  // Ajouter les event listeners pour les upgrades
  document.querySelectorAll('.up-buy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const upId = this.getAttribute('data-up-id');
      buyUp(upId);
    });
  });

  // Shop d'Ã©toiles
  const availableStarUpgrades = state.starUpgrades.filter(u => {
    if (u.bought) return false;
    if (u.requires) {
      const req = state.starUpgrades.find(r => r.id === u.requires);
      return req && req.bought;
    }
    return true;
  });
  
  $("starShop").innerHTML = availableStarUpgrades.length > 0 ? availableStarUpgrades.map(u => {
    const canBuy = state.stars >= u.cost;
    return `
      <div class="up-item">
        <div>
          <strong>${u.name}</strong><br>
          <small style="color:#888">${u.type}</small>
        </div>
        <button class="buy-btn star-buy-btn" data-star-id="${u.id}" ${!canBuy ? "disabled" : ""}>
          ${u.cost} â­
        </button>
      </div>
    `;
  }).join("") : "<div style='color:#888;text-align:center'>Toutes les upgrades Ã©toiles achetÃ©es !</div>";
  
  // Ajouter les event listeners pour les star upgrades
  document.querySelectorAll('.star-buy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const starId = this.getAttribute('data-star-id');
      buyStarUpgrade(starId);
    });
  });

  // Trading
  $("iron").textContent = trade.iron;
  $("ironPrice").textContent = trade.price;
  const avg = trade.history.reduce((a, b) => a + b, 0) / trade.history.length;
  $("ironAvg").textContent = avg.toFixed(1);
  $("botBtn").textContent = `ğŸ¤– Bot : ${trade.botActive ? "ON" : "OFF"}`;
  $("botBtn").style.background = trade.botActive ? "#0a0" : "#0af";
  
  if (trade.botActive) {
    const signal = trade.price < avg * 0.9 ? "ğŸ“ˆ ACHAT" : trade.price > avg * 1.15 ? "ğŸ“‰ VENTE" : "â¸ï¸ ATTENTE";
    $("botStatus").textContent = `Bot actif - Signal: ${signal}`;
  } else {
    $("botStatus").textContent = "";
  }

  // Achievements
  $("achievements").innerHTML = state.achievements.map(ach => `
    <div class="achievement ${ach.unlocked ? 'unlocked' : ''}">
      ${ach.unlocked ? 'âœ…' : 'ğŸ”’'} <strong>${ach.name}</strong><br>
      <small>${ach.desc}</small>
    </div>
  `).join("");
}

// INITIALISATION
function init() {
  $("clickBtn").addEventListener("click", clickBtn);
  $("prestigeBtn").addEventListener("click", prestige);
  $("prestigeMaxBtn").addEventListener("click", prestigeMax);
  $("buyIronBtn").addEventListener("click", buyIron);
  $("sellIronBtn").addEventListener("click", sellIron);
  $("botBtn").addEventListener("click", toggleBot);
  $("exportBtn").addEventListener("click", exportSave);
  $("importBtn").addEventListener("click", importSave);
  $("resetBtn").addEventListener("click", resetGame);
  
  $("importInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    file.text().then(txt => {
      try {
        const data = JSON.parse(atob(txt));
        state = data.state;
        trade = data.trade;
        save();
        refresh();
        log("ğŸ“¥ Sauvegarde importÃ©e");
      } catch (x) {
        log("âŒ Fichier invalide");
      }
    });
  });

  load();
  
  // Game loop optimisÃ©
  let updateCounter = 0;
  setInterval(() => {
    const gain = cps() / FPS;
    state.coins += gain;
    state.totalCoins += gain;
    
    // Auto-clic si upgrade achetÃ©
    const autoClickUpgrade = state.starUpgrades.find(u => u.id === "star_auto1");
    if (autoClickUpgrade && autoClickUpgrade.bought) {
      const autoGain = clickVal() / FPS;
      state.coins += autoGain;
      state.totalCoins += autoGain;
    }
    
    updateCounter++;
    
    // Mise Ã  jour rapide des chiffres toutes les frames
    $("coins").textContent = formatNum(state.coins);
    $("totalCoins").textContent = formatNum(state.totalCoins);
    
    // Refresh complet toutes les 10 frames (2 fois par seconde)
    if (updateCounter % 10 === 0) {
      checkAchievements();
      refreshFast();
    }
  }, 1000 / FPS);

  // Market tick every 30s
  setInterval(() => tickMarket(), 30000);

  // Autosave every 10s if upgrade bought
  setInterval(() => {
    if (state.upgrades.find(u => u.id === "autosave")?.bought) {
      save();
    }
  }, 10000);

  // Play time tracker
  setInterval(() => {
    state.playTime++;
  }, 1000);

  // Save on exit
  window.addEventListener("beforeunload", save);
  
  log("ğŸ® Jeu dÃ©marrÃ© - Bon courage !");
}

// DÃ‰MARRAGE DU JEU
init();
</script>
</body>
</html>
