<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0a0a0a">
  <title>Incremental Trade ULTIMATE - v4.1 QOL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @media (prefers-color-scheme: light) {
      body { background: #0a0a0a !important; color: #eee !important; }
    }
    body { font-family: Arial, sans-serif; background: #0a0a0a !important; color: #eee !important; padding: 1rem; }
    html { background: #0a0a0a !important; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { color: #0af; text-align: center; margin: 1rem 0; font-size: 2.2rem; }
    h3, h4 { color: #0af; margin: 0.5rem 0; }
    p { text-align: center; color: #aaa; margin-bottom: 1rem; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .stat { background: #1a1a1a; padding: 1rem; border-radius: 6px; border: 1px solid #0af; text-align: center; }
    .stat-val { font-size: 1.4rem; color: #0f0; font-weight: bold; }
    .tabs { display: flex; gap: 0.3rem; margin: 1rem 0; flex-wrap: wrap; background: #111; padding: 0.5rem; border-radius: 6px; }
    .tab-btn { padding: 0.6rem 1rem; background: #222; color: #aaa; border: 1px solid #333; cursor: pointer; border-radius: 4px; transition: 0.3s; }
    .tab-btn:hover { background: #333; }
    .tab-btn.active { background: #0af; color: #000; border-color: #0af; }
    .content { display: none; }
    .content.active { display: block; }
    .card { background: #1a1a1a; padding: 1rem; margin: 1rem 0; border-radius: 6px; border: 1px solid #333; }
    .btn { padding: 0.6rem 1rem; background: #0af; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 0.3rem 0.3rem 0.3rem 0; transition: 0.2s; touch-action: manipulation; min-height: 40px; }
    .btn:hover:not(:disabled) { transform: scale(1.05); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .danger-btn { background: #f00; color: #fff; }
    .danger-btn:hover:not(:disabled) { background: #c00; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #0a0a0a; margin: 0.6rem 0; border-left: 3px solid #0af; gap: 0.5rem; }
    .big-btn { width: 100%; max-width: 280px; padding: 1.2rem; font-size: 1.1rem; margin: 1rem auto; display: block; }
    .log { background: #000; border-left: 3px solid #0af; padding: 0.8rem; max-height: 120px; overflow-y: auto; margin: 1rem 0; font-size: 0.85rem; }
    canvas { border: 1px solid #0af; background: #111; max-width: 100%; margin: 1rem 0; width: 100%; height: auto; }
    .trade-card { background: #1a1a2a; border: 2px solid #0af; padding: 1rem; margin: 1rem 0; border-radius: 6px; }
    .trade-card.min { border-color: #0f0; }
    .trade-card.mid { border-color: #fa0; }
    .trade-card.high { border-color: #f00; }
    .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .trade-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin: 0.5rem 0; }
    .trade-stat { background: #0a0a1a; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; border-left: 2px solid #0af; }
    .trade-stat-val { font-weight: bold; color: #0f0; font-size: 1.1rem; }
    .trade-input-group { display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap; }
    .trade-input { flex: 1; min-width: 100px; padding: 0.5rem; background: #0a0a0a; border: 1px solid #333; color: #0f0; border-radius: 4px; font-size: 0.9rem; }
    .trade-log-event { padding: 0.5rem; margin: 0.3rem 0; background: #000; border-left: 2px solid #0af; font-size: 0.85rem; }
    .trade-log-event.gain { border-left-color: #0f0; color: #0f0; }
    .trade-log-event.loss { border-left-color: #f00; color: #f00; }
    #tutorialModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 9999; padding: 1rem; overflow-y: auto; display: none; }
    .tut-box { max-width: 700px; margin: 0 auto; background: #1a1a1a; padding: 1.5rem; border: 2px solid #0af; border-radius: 6px; }
    .tut-box h1 { margin-top: 0; }
    .tut-btns { display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0; }
    .graph-container { background: #0a0a1a; padding: 1rem; border-radius: 6px; border: 1px solid #0af; margin: 1rem 0; }
    .market-status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9rem; font-weight: bold; margin: 0.5rem 0; }
    .market-up { background: #0f0; color: #000; }
    .market-down { background: #f00; color: #fff; }
    .market-neutral { background: #fa0; color: #000; }
    @media(max-width: 600px) {
      .tabs { font-size: 0.9rem; }
      .stat { padding: 0.6rem; }
      .btn { padding: 0.7rem 1rem; font-size: 0.9rem; min-height: 44px; margin: 0.4rem; }
      .item { flex-direction: column; align-items: stretch; gap: 0.8rem; }
      .item .btn { width: 100%; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ’ INCREMENTAL TRADE ULTIMATE v4.1 QOL ğŸ’</h1>
  <p>Le jeu inactif addictif avec NEW GAME PLUS! [QUALITY OF LIFE UPDATE]</p>

  <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn" onclick="showTutorial()" style="display:block">ğŸ“– TUTORIEL</button>
    <button class="btn" onclick="showChangelogs()" style="display:block">ğŸ“ CHANGELOGS</button>
    <div class="log" id="log" style="flex: 1; min-width: 200px; max-width: 400px; margin: 0;"></div>
  </div>

  <div class="stats">
    <div class="stat"><div>ğŸ’° PiÃ¨ces</div><div class="stat-val" id="coins">0</div></div>
    <div class="stat"><div>âš¡ /sec</div><div class="stat-val" id="cps">0</div></div>
    <div class="stat"><div>â­ Ã‰toiles</div><div class="stat-val" id="stars">0</div></div>
    <div class="stat"><div>ğŸŒ€ Galaxies</div><div class="stat-val" id="galaxies">0</div></div>
    <div class="stat"><div>ğŸŒ™ Dark Matter</div><div class="stat-val" id="dm">0</div></div>
    <div class="stat"><div>ğŸ’¸ Trade BloquÃ©</div><div class="stat-val" id="tradeBlocked">0</div></div>
    <div class="stat"><div>ğŸš€ Ascension</div><div class="stat-val" id="ascension">0</div></div>
    <div class="stat"><div>ğŸ”„ NGP+</div><div class="stat-val" id="ngpLevel">0</div></div>
    <div class="stat" id="qcStat" style="display:none"><div>ğŸ’ Quantum</div><div class="stat-val" id="quantumCoins">0</div></div>
    <div class="stat"><div>ğŸ† Achievements</div><div class="stat-val" id="achievementCount">0</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="main">ğŸ® JEU</button>
    <button class="tab-btn" data-tab="gens">ğŸ¤– GÃ‰NÃ‰RATEURS</button>
    <button class="tab-btn" data-tab="ups">âš¡ UPGRADES</button>
    <button class="tab-btn" data-tab="research">ğŸ”¬ RECHERCHES</button>
    <button class="tab-btn" data-tab="trade">ğŸ’¸ TRADING</button>
    <button class="tab-btn" data-tab="bank">ğŸ¦ BANQUE</button>
    <button class="tab-btn" data-tab="lottery">ğŸ° LOTTERIE</button>
    <button class="tab-btn" data-tab="ascensionTab">ğŸš€ ASCENSION</button>
    <button class="tab-btn" data-tab="ngp">ğŸ”„ NEW GAME+</button>
    <button class="tab-btn" id="shopNGPBtn" data-tab="shopNGP" style="display:none">ğŸ’ SHOP NGP+</button>
    <button class="tab-btn" id="shopDMBtn" data-tab="shopDM" style="display:none">ğŸŒ™ SHOP DM</button>
    <button class="tab-btn" data-tab="achievements">ğŸ† ACHIEVEMENTS</button>
    <button class="tab-btn" data-tab="milestones">ğŸ¯ MILESTONES</button>
    <button class="tab-btn" data-tab="graph">ğŸ“Š GRAPHIQUE</button>
    <button class="tab-btn" data-tab="stats">ğŸ“ˆ STATS</button>
    <button class="tab-btn" data-tab="params">âš™ï¸ PARAMÃˆTRES</button>
  </div>

  <div id="main" class="content active">
    <div class="card" style="text-align:center">
      <button class="btn big-btn" id="clickBtn">ğŸ–±ï¸ CLIQUER</button>
      <p style="font-size: 1.2rem; color: #0f0;"><strong>Gain: <span id="clickVal">0</span> par clic</strong></p>

```
  <div style="background: #0a0a1a; padding: 1rem; margin: 1rem 0; border-left: 3px solid #0af; border-radius: 4px; text-align: left; font-size: 0.9rem;">
    <p style="margin: 0.3rem 0; color: #aaa;"><strong>DÃ©composition:</strong></p>
    <p style="margin: 0.3rem 0; color: #0f0;">Base: 1</p>
    <p style="margin: 0.3rem 0; color: #0af;">Ã— Upgrades Clic: <span id="clickUpgradesMult">1x</span></p>
    <p style="margin: 0.3rem 0; color: #fa0;">Ã— Ã‰toiles: <span id="clickStarsMult">1x</span></p>
    <p style="margin: 0.3rem 0; color: #fa0;">Ã— Galaxies: <span id="clickGalaxiesMult">1x</span></p>
    <p style="margin: 0.3rem 0; color: #f0f;">Ã— NGP+ Level <span id="clickNGPLevel">0</span>: <span id="clickNGPMult">1x</span></p>
    <p style="margin: 0.3rem 0; color: #0f0;">Ã— Dark Matter: <span id="clickDMMult">1x</span></p>
    <p style="margin: 0.3rem 0; color: #f0f;">Ã— Ascension: <span id="clickAscensionMult">1x</span></p>
  </div>
</div>
<div class="card">
  <h3>â±ï¸ PRESTIGE</h3>
  <p>CoÃ»t: <span id="prestigeCost">50000</span> ğŸ’°</p>
  <p>Progression: <span id="prestProg">0</span></p>
  <p style="color: #0f0; font-size: 1.1rem;"><strong>Possible: <span id="prestigeCount">0</span>Ã—</strong></p>
  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0;">
    <button class="btn" id="prestigeBtn" style="flex: 1; min-width: 120px;">âš¡ PRESTIGE x1</button>
    <button class="btn" onclick="doPrestigeMultiple(10)" style="flex: 1; min-width: 120px; background: #0f0; color: #000;">âš¡âš¡ x10</button>
    <button class="btn" onclick="doPrestigeMultiple(100)" style="flex: 1; min-width: 120px; background: #fa0; color: #000;">âš¡âš¡âš¡ x100</button>
    <button class="btn" onclick="doPrestigeMultiple(9999)" style="flex: 1; min-width: 120px; background: #f0f; color: #fff;">â™¾ï¸ MAX</button>
  </div>
</div>
<div class="card">
  <h3>ğŸŒ€ GALAXIES</h3>
  <p>CoÃ»t: <span id="galaxyCost">500</span> â­</p>
  <button class="btn" id="galaxyBtn">ğŸŒ€ SUPER PRESTIGE (Ã—1.6)</button>
</div>
```

  </div>

  <div id="gens" class="content">
    <div class="card"><h3>ğŸ¤– GÃ‰NÃ‰RATEURS AUTOMATIQUES</h3><div id="gensList"></div></div>
  </div>

  <div id="ups" class="content">
    <div class="card"><h3>âš¡ AMÃ‰LIORATIONS</h3><div id="upsList"></div></div>
  </div>

  <div id="research" class="content">
    <div class="card">
      <h3>ğŸ”¬ RECHERCHES AVANCÃ‰ES - PERMANENT</h3>
      <p style="color: #0f0; margin-bottom: 0.5rem;">Upgrades PERMANENTS qui NE SE RÃ‰INITIALISENT JAMAIS (sauf NGP+)!</p>
      <p style="color: #fa0; font-size: 0.9rem; margin-bottom: 1rem;">ğŸ’¡ Chaque recherche augmente en coÃ»t mais donne des bonus cumulatifs!</p>
      <div id="researchList"></div>
    </div>
  </div>

  <div id="shopDM" class="content">
    <div class="card">
      <h3>ğŸŒ™ SHOP DARK MATTER - BOOSTS TEMPORAIRES</h3>
      <p style="color: #f0f; margin-bottom: 0.5rem;">ğŸ”“ DÃ©bloquÃ© Ã  10 Dark Matter!</p>
      <p style="color: #0f0; margin-bottom: 0.5rem;">AchÃ¨te des boosts puissants avec Dark Matter!</p>
      <p style="color: #f00; font-size: 0.9rem; margin-bottom: 1rem;">âš ï¸ PERDU AU NGP+ (pas Ã  l'Ascension)!</p>

      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #f0f;border-radius:4px;">
        <p style="color:#f0f;margin:0.5rem 0"><strong>ğŸŒ™ Dark Matter: <span id="dmDisplay">0</span></strong></p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">Gagnes 1 DM tous les 10 Prestige!</p>
      </div>

      <div id="shopDMList"></div>
    </div>
  </div>

  <div id="trade" class="content">
    <div class="card">
      <h3>ğŸ’¸ SYSTÃˆME DE TRADING - RÃ‰ALISTE ğŸ“Š</h3>
      <p style="color: #aaa; margin-bottom: 0.5rem;">MarchÃ© volatile! Les taux changent en temps rÃ©el!</p>
      <div style="text-align: center; margin: 1rem 0;">
        <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.5rem;">Ã‰tat du marchÃ©:</div>
        <div id="marketStatus" class="market-status market-neutral">ğŸ“Š NEUTRE</div>
        <div style="color: #aaa; font-size: 0.85rem; margin-top: 0.3rem;">VolatilitÃ©: <span id="marketVolatility">0%</span></div>
      </div>

```
  <div class="trade-card min">
    <div class="trade-header">
      <div><h4>âœ… RISQUE MINIMUM - Obligations</h4><p style="color: #0f0; font-size: 0.9rem;">+2.4% base Â±0.6% volatilitÃ©</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="minAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="minGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="minLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="minInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('min')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('min')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('min')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('min')">TOUT</button>
    </div>
  </div>

  <div class="trade-card mid">
    <div class="trade-header">
      <div><h4>âš ï¸ RISQUE MOYEN - Stocks</h4><p style="color: #fa0; font-size: 0.9rem;">+8% base Â±9.6% volatilitÃ©</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="midAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="midGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="midLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="midInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('mid')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('mid')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('mid')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('mid')">TOUT</button>
    </div>
  </div>

  <div class="trade-card high">
    <div class="trade-header">
      <div><h4>ğŸ”¥ GROS RISQUE - Crypto</h4><p style="color: #f00; font-size: 0.9rem;">+24% base Â±60% volatilitÃ©!</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="highAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="highGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="highLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="highInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('high')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('high')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('high')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('high')">TOUT</button>
    </div>
  </div>

  <div class="card">
    <h4>ğŸ“Š LOG TRADING</h4>
    <div id="tradeLog" style="max-height: 200px; overflow-y: auto;"><div class="trade-log-event">En attente...</div></div>
  </div>
</div>
```

  </div>

  <div id="bank" class="content">
    <div class="card">
      <h3>ğŸ¦ BANQUE - INVESTISSEMENTS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©pose des piÃ¨ces pour +0.005% par sec! (SANS RISQUE)</p>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="bankInvested">0</div></div>
        <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="bankGains">0</div></div>
      </div>
      <div class="trade-input-group">
        <input type="number" class="trade-input" id="bankInput" placeholder="Montant Ã  dÃ©poser" min="0">
        <button class="btn" onclick="depositBank()">ğŸ“¤ DÃ‰POSER</button>
        <button class="btn danger-btn" onclick="withdrawBank()">ğŸ“¥ RETIRER</button>
      </div>
      <div class="card" style="background:#0a0a0a;margin-top:1rem">
        <h4>ğŸ“Š Info Banque</h4>
        <p style="color:#aaa;font-size:0.9rem">Total gÃ©nÃ©rÃ©: <span id="bankGenerated">0</span> ğŸ’°</p>
      </div>
    </div>
  </div>

  <div id="lottery" class="content">
    <div class="card">
      <h3>ğŸ° LOTTERIE - TENTEZ VOTRE CHANCE!</h3>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸŸï¸ Tickets</div><div class="trade-stat-val" id="lotteryTickets">0</div></div>
        <div class="trade-stat"><div>ğŸ’° CoÃ»t</div><div class="trade-stat-val">100</div></div>
      </div>
      <div class="trade-input-group">
        <button class="btn" onclick="buyLotteryTicket(1)">1 Ticket (100)</button>
        <button class="btn" onclick="buyLotteryTicket(10)">10 Tickets (1K)</button>
        <button class="btn" onclick="buyLotteryTicket(100)">100 Tickets (10K)</button>
      </div>
      <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap;">
        <button class="btn" onclick="playLottery()" style="flex: 1; min-width: 150px;">ğŸ° JOUER x1</button>
        <button class="btn" onclick="playLotteryAll()" style="flex: 1; min-width: 150px; background: #f0f; color: #fff;">ğŸ°ğŸ° OUVRIR TOUS!</button>
      </div>
      <div class="card" style="background:#0a0a0a;margin-top:1rem">
        <h4>ğŸ² RÃ©sultats</h4>
        <div id="lotteryLog" style="max-height: 200px; overflow-y: auto;"><div style="color:#aaa">En attente...</div></div>
      </div>
    </div>
  </div>

  <div id="ascensionTab" class="content">
    <div class="card">
      <h3>ğŸš€ ASCENSION - META PRESTIGE</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">RÃ©initialise TOUT sauf Galaxies pour un bonus PERMANENT!</p>

      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸš€ Ascensions</div><div class="trade-stat-val" id="ascensionPoints">0</div></div>
        <div class="trade-stat"><div>âš¡ Bonus Actuel</div><div class="trade-stat-val">+<span id="ascensionBonus">0</span>%</div></div>
        <div class="trade-stat"><div>ğŸŒ€ Galaxies</div><div class="trade-stat-val" id="ascGalaxies">0</div></div>
      </div>

      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #fa0;border-radius:4px;">
        <p style="color:#fa0;margin:0.5rem 0"><strong>ğŸ’° COÃ›T ASCENSION #<span id="nextAscLevel">1</span>:</strong></p>
        <p style="color:#0af;font-size:1rem;margin:0.5rem 0">ğŸŒ€ <span id="ascCost">100</span> Galaxies (tu as: <span id="ascHas">0</span>)</p>
      </div>

      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #0f0;border-radius:4px;">
        <p style="color:#0f0;margin:0.5rem 0"><strong>âœ… BONUS ASCENSION:</strong></p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âœ¨ +5% ALL production par Ascension</p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âœ¨ +5% ALL clics par Ascension</p>
        <p style="color:#0f0;font-size:1rem;margin:0.5rem 0">ğŸ’ª Prochain bonus: +<span id="nextAscBonus">5</span>%</p>
      </div>

      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #f00;border-radius:4px;">
        <p style="color:#f00;margin:0.5rem 0"><strong>âš ï¸ ASCENSION RÃ‰INITIALISE:</strong></p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ Coins, Clics, Prestige, Ã‰toiles, Dark Matter</p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ GÃ©nÃ©rateurs, Upgrades, Trades, Banque</p>
        <p style="color:#0f0;font-size:0.9rem;margin:0.5rem 0">âœ… GARDE: Galaxies (utilisÃ©es), Achievements, NGP+</p>
      </div>

      <button class="btn big-btn danger-btn" onclick="doAscension()" style="max-width: 100%; width: 100%;">ğŸš€ ASCENSIONNER!</button>
    </div>
  </div>

  <div id="ngp" class="content">
    <div class="card">
      <h3>ğŸ”„ NEW GAME PLUS - RECOMMENCE AVEC BONUS!</h3>
      <p style="color: #fa0; margin-bottom: 1rem;">Payant! CoÃ»te Prestige + Ã‰toiles + Dark Matter!</p>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸ”„ NGP+ Level</div><div class="trade-stat-val" id="ngpLevelDisplay">0</div></div>
        <div class="trade-stat"><div>âš¡ Bonus</div><div class="trade-stat-val">+<span id="ngpBonusDisplay">0</span>%</div></div>
      </div>

```
  <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #fa0;border-radius:4px;">
    <p style="color:#fa0;margin:0.5rem 0"><strong>ğŸ’° COÃ›T NGP+ #<span id="nextNGPLevel">1</span>:</strong></p>
    <p style="color:#0af;font-size:1rem;margin:0.5rem 0">âš¡ <span id="ngpCostPrestige">10</span> Prestige (tu as: <span id="yourPrestige">0</span>)</p>
    <p style="color:#0af;font-size:1rem;margin:0.5rem 0">â­ <span id="ngpCostStars">20</span> Ã‰toiles (tu as: <span id="yourStars">0</span>)</p>
    <p style="color:#0af;font-size:1rem;margin:0.5rem 0">ğŸŒ™ <span id="ngpCostDM">3</span> Dark Matter (tu as: <span id="yourDM">0</span>)</p>
  </div>
  
  <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #fa0;border-radius:4px;">
    <p style="color:#fa0;margin:0.5rem 0"><strong>âš ï¸ NGP+ va:</strong></p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les gÃ©nÃ©rateurs</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les upgrades</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser coins, clics, prestige, Ã©toiles, dark matter, trades, banque</p>
    <p style="color:#0f0;font-size:0.9rem;margin:0.5rem 0">âœ… Garder Galaxies et Ascension</p>
    <p style="color:#0f0;font-size:0.9rem;margin:0.5rem 0">âœ… +10% multiplicateur permanent par NGP+</p>
  </div>
  
  <button class="btn big-btn danger-btn" onclick="doNGP()" style="max-width: 100%; width: 100%;">ğŸ”„ NEW GAME PLUS!</button>
</div>
```

  </div>

  <div id="shopNGP" class="content">
    <div class="card">
      <h3>ğŸ’ SHOP NGP+ - BOUTIQUE QUANTIQUE</h3>
      <p style="color: #f0f; margin-bottom: 0.5rem;">ğŸ”“ DÃ©bloquÃ© Ã  NGP+ niveau 5!</p>
      <p style="color: #0f0; margin-bottom: 1rem;">AchÃ¨te des boosts PERMANENTS avec tes Quantum Coins!</p>

      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #f0f;border-radius:4px;">
        <p style="color:#f0f;margin:0.5rem 0"><strong>ğŸ’ Quantum Coins: <span id="qcDisplay">0</span></strong></p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">Gagnes +1 Quantum Coin par NGP+ effectuÃ©!</p>
        <p style="color:#fa0;font-size:0.85rem;margin:0.5rem 0">âš ï¸ Les boosts NE SE RÃ‰INITIALISENT JAMAIS!</p>
      </div>

      <div id="shopItemsList"></div>
    </div>
  </div>

  <div id="achievements" class="content">
    <div class="card">
      <h3>ğŸ† ACHIEVEMENTS & BADGES</h3>
      <p style="color: #0f0; margin-bottom: 0.5rem;">DÃ©bloque des badges et gagne des rÃ©compenses!</p>
      <p style="color: #fa0; font-size: 0.9rem; margin-bottom: 1rem;">ğŸ’¡ Certains achievements sont SECRETS! ğŸ”’</p>
      <div id="achievementsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
    </div>
  </div>

  <div id="milestones" class="content">
    <div class="card">
      <h3>ğŸ¯ MILESTONES - DÃ‰FIS PROGRESSIFS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©bloque des dÃ©fis et gagne des rÃ©compenses!</p>
      <div id="milestonesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;"></div>
    </div>
  </div>

  <div id="graph" class="content">
    <div class="card">
      <h3>ğŸ“Š GRAPHIQUE DE PROGRESSION</h3>
      <div class="graph-container">
        <canvas id="graphCanvas" width="800" height="300"></canvas>
      </div>
      <div class="card" style="background:#0a0a0a">
        <h4>ğŸ“ˆ Info</h4>
        <p style="color:#aaa;font-size:0.9rem">Production: <span id="graphCPS">0</span> ğŸ’°/sec | Max: <span id="graphMax">0</span> ğŸ’°/sec</p>
      </div>
    </div>
  </div>

  <div id="stats" class="content">
    <div class="card">
      <h3>ğŸ“ˆ STATISTIQUES</h3>
      <div class="item"><span>Total PiÃ¨ces</span><span id="totalCoins">0</span></div>
      <div class="item"><span>Total Clics</span><span id="totalClicks">0</span></div>
      <div class="item"><span>Temps Jeu</span><span id="playTime">0s</span></div>
      <div class="item"><span>Prestige</span><span id="presCount">0</span></div>
    </div>
  </div>

  <div id="params" class="content">
    <div class="card">
      <h3>âš™ï¸ PARAMÃˆTRES</h3>
      <div class="item" style="border-left:3px solid #0f0;padding:1rem">
        <div><strong>ğŸ’¾ Sauvegarder</strong><br><span style="color:#aaa;font-size:0.9rem">TÃ©lÃ©charge ta progression</span></div>
        <button class="btn" id="downloadBtn">ğŸ“¥ TÃ‰LÃ‰CHARGER</button>
      </div>
      <div class="item" style="border-left:3px solid #0af;padding:1rem">
        <div><strong>ğŸ“‚ Charger</strong><br><span style="color:#aaa;font-size:0.9rem">Importe une sauvegarde</span></div>
        <button class="btn" id="uploadBtn">ğŸ“¤ IMPORTER</button>
      </div>
      <div class="item" style="border-left:3px solid #fa0;padding:1rem">
        <div><strong>ğŸ—‘ï¸ RÃ©initialiser</strong><br><span style="color:#aaa;font-size:0.9rem">Recommence Ã  zÃ©ro</span></div>
        <button class="btn danger-btn" id="resetBtn">ğŸ”„ RESET</button>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".json">

<div id="tutorialModal">
  <div class="tut-box">
    <h1>ğŸ“– TUTORIEL COMPLET</h1>
    <div id="tutText" style="min-height:400px;line-height:1.8;margin:1rem 0;color:#aaa"></div>
    <div class="tut-btns">
      <button class="btn" id="prevBtn">â† PRÃ‰CÃ‰DENT</button>
      <button class="btn" onclick="document.getElementById('tutorialModal').style.display='none'">FERMER</button>
      <button class="btn" id="nextBtn">SUIVANT â†’</button>
    </div>
    <p style="text-align:center;color:#aaa;font-size:0.85rem">Page <span id="tutPage">1</span>/18</p>
  </div>
</div>

<div id="changelogsModal" style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.98);z-index: 9999;padding: 1rem;overflow-y: auto;display: none;">
  <div class="tut-box">
    <h1>ğŸ“ CHANGELOGS</h1>
    <div id="changelogsContent" style="min-height:300px;line-height:1.8;margin:1rem 0;max-height:600px;overflow-y:auto;"></div>
    <div class="tut-btns">
      <button class="btn" onclick="document.getElementById('changelogsModal').style.display='none'">FERMER</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
const FPS = 10;
const SAVE_KEY = "incremental_v3_final";
let tutPage = 0;
let cache = { prod: 0, clickVal: 0, starsMultiplier: 1, galaxiesMultiplier: 1, ascensionMultiplier: 1, lastUpdate: 0, isDirty: true };
function invalidateCache() { cache.isDirty = true; }

const CHANGELOGS = [
  {
    version: "v4.2 RESEARCH",
    date: "Nov 03, 2025",
    title: "SYSTÃˆMES DE RECHERCHE + DARK MATTER SHOP - PROGRESSION LONGUE",
    changes: [
      "ğŸ”¬ RECHERCHES AVANCÃ‰ES: 15 upgrades permanents qui NE SE RESET JAMAIS (sauf NGP+)!",
      "ğŸ”¬ Recherches: Production I-III, Clics I-III, Prestige Boost, Trading Pro...",
      "ğŸ”¬ Recherches: IntÃ©rÃªts Bancaires, Chance Lotterie, Galaxie Efficiency...",
      "ğŸ”¬ Recherches: Dark Matter Gen (DM tous les 9P au lieu de 10P!)",
      "ğŸ”¬ Recherches: Ascension Power, NGP+ Efficiency, Synergies...",
      "ğŸ”¬ CoÃ»ts progressifs: 10K â†’ 5M coins, jusqu'Ã  20M pour Synergies!",
      "ğŸŒ™ DARK MATTER SHOP: 10 boosts temporaires (perdus au NGP+, PAS Ascension)",
      "ğŸŒ™ DÃ©bloquÃ© Ã  10 Dark Matter!",
      "ğŸŒ™ Mega Production Ã—3, Super Clics Ã—5, Prestige Rapide Ã·2, Galaxie Discount Ã·2",
      "ğŸŒ™ Trading Ã—10, Banque Ã—20, Jackpot Ã—100, Auto-Clicker +5/sec",
      "ğŸŒ™ Time Warp Ã—2, Quantum Rain +1 QC/minute",
      "ğŸŒ™ CoÃ»ts: 5-50 Dark Matter selon le boost",
      "âš™ï¸ Auto-Clicker actif en background quand achetÃ©",
      "âš™ï¸ Quantum Rain gÃ©nÃ¨re passivement des QC",
      "âœ¨ Nouveaux onglets: Recherche (toujours visible) + DM Shop (dÃ©bloquÃ© Ã  10 DM)",
      "âœ¨ Interface avec niveaux, coÃ»ts progressifs, status actif/inactif",
      "âœ¨ Bonus cumulatifs sur TOUS les systÃ¨mes (production, clics, trading, bank, lottery...)",
      "ğŸ® Progression ultra longue et stratÃ©gique avec ces 2 nouveaux systÃ¨mes!"
    ]
  },
  {
    version: "v4.1 QOL",
    date: "Nov 03, 2025",
    title: "QUALITY OF LIFE - UX MOBILE + RÃ‰Ã‰QUILIBRAGES",
    changes: [
      "ğŸ“± MOBILE FIX: Boutons plus gros, zones de clic amÃ©liorÃ©es, touch-friendly",
      "ğŸ“± Sur mobile: Boutons pleine largeur, espacement augmentÃ©",
      "ğŸ’° BANQUE NERFÃ‰E: 0.1%/sec â†’ 0.005%/sec (Ã·20)",
      "ğŸ’¸ TRADING BUFFÃ‰ Ã—2: Gains doublÃ©s, pertes rÃ©duites de moitiÃ©!",
      "âš¡ PRESTIGE MULTIPLE: Boutons x10, x100, MAX ajoutÃ©s!",
      "ğŸ° LOTTERIE RAPIDE: Bouton 'Ouvrir TOUS les tickets' ajoutÃ©!",
      "ğŸš€ INTERFACE ASCENSION: DÃ©tails complets, coÃ»ts clairs, explications",
      "âœ¨ Meilleure expÃ©rience mobile et desktop!"
    ]
  },
  {
    version: "v4.0 QUANTUM",
    date: "Nov 03, 2025",
    title: "SHOP NGP+ + 50 MILESTONES + 35 ACHIEVEMENTS + GÃ‰NÃ‰RATEURS BUFFÃ‰S",
    changes: [
      "ğŸ’ SHOP NGP+ dÃ©bloquÃ© Ã  NGP+5 avec Quantum Coins!",
      "ğŸ’ 10 items permanents: Production Ã—2, Clics Ã—3, MEGA BOOST Ã—10...",
      "ğŸ’ Gagne 1 Quantum Coin par NGP+ effectuÃ©!",
      "ğŸ¯ 50 MILESTONES progressifs avec barres de progression!",
      "ğŸ¯ RÃ©compenses: Coins ET Quantum Coins!",
      "ğŸ† 35+ ACHIEVEMENTS (15 nouveaux + 8 secrets) = Ã‰NORME!",
      "ğŸ† Achievements NGP+, Quantum, Shop, Bank Elite...",
      "ğŸš€ GÃ‰NÃ‰RATEURS BUFFÃ‰S Ã—5-7: Robot 5/s, Usine 15/s, Port 50/s, Labo 200/s, Satellite 1500/s!",
      "âš¡ Shop boosts: Production, Clics, Trading, Banque, Lotterie...",
      "ğŸ’¸ Progression ultra longue et enrichie!",
      "âœ¨ Interface complÃ¨te avec affichage Quantum Coins",
      "âœ¨ Tab Shop NGP+ apparaÃ®t automatiquement Ã  NGP+5"
    ]
  },
  {
    version: "v3.1 BUGFIX",
    date: "Nov 03, 2025",
    title: "CORRECTIONS CRITIQUES - TRADING & CALCULS",
    changes: [
      "ğŸ› FIX: Trading gains corrects (divisÃ©s par FPS au lieu de 60)",
      "ğŸ› FIX: ProbabilitÃ©s de pertes ajustÃ©es (6Ã— moins frÃ©quentes)",
      "ğŸ› FIX: Affichage gÃ©nÃ©rateurs corrigÃ© (vrais multiplicateurs)",
      "ğŸ› FIX: GameLoop optimisÃ© (10fps stable au lieu de ~60fps)",
      "ğŸ› FIX: VÃ©rifications sÃ©curitÃ© pour synergies gÃ©nÃ©rateurs",
      "âœ… Trading maintenant Ã©quilibrÃ© et fiable!",
      "âœ… Gains/pertes correspondent aux valeurs affichÃ©es"
    ]
  },
  {
    version: "v3 FINAL+",
    date: "Nov 03, 2025",
    title: "NEW GAME PLUS PAYANT!",
    changes: [
      "âœ¨ NGP+ MAINTENANT PAYANT: CoÃ»te Prestige + Ã‰toiles + Dark Matter",
      "âœ¨ CoÃ»ts progressifs: 10P/20S/3DM â†’ 15P/30S/5DM â†’ 20P/40S/7DM...",
      "âœ¨ Affichage des coÃ»ts en direct dans le tab NGP+",
      "âœ¨ VÃ©rification des ressources avant de lancer NGP+",
      "âœ¨ Plus hardcore et stratÃ©gique!",
      "âœ¨ Reste: +10% multiplicateur permanent par NGP+"
    ]
  },
  {
    version: "v3 FINAL",
    date: "Nov 03, 2025",
    title: "NEW GAME PLUS + GÃ‰NÃ‰RATEURS BUFF + 20+ ACHIEVEMENTS",
    changes: [
      "âœ¨ NEW GAME PLUS FONCTIONNEL! RÃ©initialisez avec +10% bonus!",
      "âœ¨ GÃ©nÃ©rateurs: +50-100% de gains (Usine 1.5â†’3, Labo 15â†’30, Satellite 100â†’200)",
      "âœ¨ 15 ACHIEVEMENTS RÃ‰GULIERS + 5 SECRETS = 20 total!",
      "âœ¨ 50 MILESTONES progressifs avec rÃ©compenses Ã©normes",
      "âœ¨ Trading volatilitÃ© rÃ©aliste + Graphique live + Achievements secrets",
      "âœ¨ Tutoriel 18 pages complet avec NGP+"
    ]
  },
  {
    version: "v3 ENHANCED",
    date: "Nov 03, 2025",
    title: "TRADING VOLATILITÃ‰ + SECRETS + GRAPHIQUE",
    changes: [
      "âœ¨ TRADING RÃ‰ALISTE avec volatilitÃ© Â±5-75%",
      "âœ¨ 5 ACHIEVEMENTS SECRETS cachÃ©s",
      "âœ¨ GRAPHIQUE DE PROGRESSION en temps rÃ©el"
    ]
  }
];

const TUTORIAL = [
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ® PAGE 1: BIENVENUE v3 FINAL!</h2>
    <p style="margin: 0.5rem 0; color: #aaa;">Bienvenue dans INCREMENTAL TRADE ULTIMATE v3 FINAL!</p>
    <p style="margin: 0.5rem 0; color: #aaa;"><strong>NEW GAME PLUS, GÃ©nÃ©rateurs buffÃ©s, 20 achievements!</strong></p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ–±ï¸ PAGE 2: LE CLIC</h2>
    <p>COMMENCE ICI! Clique jusqu'Ã  50 piÃ¨ces, puis achÃ¨te des Robots!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¤– PAGE 3: GÃ‰NÃ‰RATEURS SUPER BUFFÃ‰S</h2>
    <p><strong>Les gains ont Ã©tÃ© Ã‰NORMÃ‰MENT augmentÃ©s!</strong></p>
    <p>Robot: 5/sec | Usine: 15/sec | Port: 50/sec | Labo: 200/sec | Satellite: 1500/sec</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">âš¡ PAGE 4: UPGRADES</h2>
    <p>Multiplicateurs! Clic +50%, Robot Ã—2, etc.</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">â­ PAGE 5: PRESTIGE</h2>
    <p>50K coins = 1 Ã©toile! +3% multiplicateur!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ€ PAGE 6: GALAXIES</h2>
    <p>500 Ã©toiles = 1 Galaxie! +1% multiplicateur PERMANENT!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ’¸ PAGE 7: TRADING RÃ‰ALISTE</h2>
    <p>MarchÃ© volatile! Les taux changent en temps rÃ©el (Â±5-75%)</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¦ PAGE 8: BANQUE</h2>
    <p>+0.1%/sec SANS RISQUE! Le meilleur investissement!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸš€ PAGE 9: ASCENSION</h2>
    <p>100 Galaxies = Ascension = +5% PERMANENT!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ° PAGE 10: LOTTERIE</h2>
    <p>Achetez des tickets et tentez votre chance!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ† PAGE 11: ACHIEVEMENTS</h2>
    <p>ğŸ”’ 15 RÃ‰GULIERS + 5 SECRETS = 20 TOTAL!</p>
    <p>Les secrets rÃ©vÃ¨lent leur vrai nom quand tu les dÃ©verrouilles!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ™ PAGE 12: DARK MATTER</h2>
    <p>DÃ©bloquÃ© Ã  P10! +5% multiplicateur par unitÃ©!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ“Š PAGE 13: GRAPHIQUE LIVE</h2>
    <p>Vois ta production augmenter en temps rÃ©el!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¯ PAGE 14: 50 MILESTONES</h2>
    <p>DÃ©fis progressifs avec rÃ©compenses Ã©normes!</p>`,
  
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ”„ PAGE 15: NEW GAME PLUS PAYANT!</h2>
    <p><strong>LA GRANDE NOUVEAUTÃ‰!</strong></p>
    <p>NGP+ COÃ›TE CHER:</p>
    <p style="color: #0af;"><strong>NGP+ #1:</strong> 10 Prestige + 20 Ã‰toiles + 3 Dark Matter</p>
    <p style="color: #0af;"><strong>NGP+ #2:</strong> 15 Prestige + 30 Ã‰toiles + 5 Dark Matter</p>
    <p style="color: #0af;"><strong>NGP+ #3:</strong> 20 Prestige + 40 Ã‰toiles + 7 Dark Matter</p>
    <p>Mais bonus: +10% multiplicateur PERMANENT par NGP+!</p>
    <p>Garde Galaxies et Ascension! TRÃˆS HARDCORE!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ’¡ PAGE 16: MEGA-TIPS</h2>
    <p>âœ… HOLD +1 pour cliquer vite!</p>
    <p>âœ… GÃ©nÃ©rateurs > Upgrades!</p>
    <p>âœ… BANQUE meilleure que Trading!</p>
    <p>âœ… Fais NGP+ rÃ©guliÃ¨rement pour des bonus Ã©normes!</p>`,
  
  `<h2 style="color: #0f0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¯ PAGE 17: PROGRESSION IDÃ‰ALE</h2>
    <p><strong>Phase 1:</strong> Clique â†’ Robots â†’ Prestige</p>
    <p><strong>Phase 2:</strong> 5-10 Prestige â†’ GÃ©nÃ©rateurs</p>
    <p><strong>Phase 3:</strong> 15 Prestige â†’ Galaxies</p>
    <p><strong>Phase 4:</strong> Ascension â†’ NGP+ loop!</p>`,
  
  `<h2 style="color: #0f0; font-size: 2rem; margin-bottom: 1rem;">ğŸš€ PAGE 18: C'EST PARTI!</h2>
    <p>1ï¸âƒ£ Clique 50 fois</p>
    <p>2ï¸âƒ£ AchÃ¨te Robots</p>
    <p>3ï¸âƒ£ GÃ©nÃ¨re 50K et Prestige!</p>
    <p>4ï¸âƒ£ Fais NGP+ pour des bonus Ã‰NORMES!</p>
    <p>5ï¸âƒ£ CONTINUE jusqu'Ã  l'infini! â™¾ï¸</p>
    <p style="color: #fa0; margin-top: 1rem;"><strong>ğŸ’ Tu as TOUT! Bon jeu! ğŸ®âœ¨</strong></p>`
];

function getDefaultAchievements() {
  return [
    { id: "click5", name: "ğŸ–±ï¸ DÃ©butant", desc: "Faire 5 clics", check: () => game.totalClicks >= 5, reward: 100, unlocked: false, secret: false },
    { id: "coins1m", name: "ğŸ’° Millionnaire", desc: "1M coins", check: () => game.totalCoins >= 1e6, reward: 1000, unlocked: false, secret: false },
    { id: "gen10", name: "ğŸ¤– AutomatisÃ©", desc: "10 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=10, reward: 5000, unlocked: false, secret: false },
    { id: "prestige5", name: "âš¡ Prestigieux", desc: "5 Prestige", check: () => game.prestige >= 5, reward: 10000, unlocked: false, secret: false },
    { id: "galaxy1", name: "ğŸŒ€ Cosmique", desc: "1Ã¨re Galaxie", check: () => game.galaxies >= 1, reward: 25000, unlocked: false, secret: false },
    { id: "ascension1", name: "ğŸš€ AscensionnÃ©", desc: "1 Ascension", check: () => game.ascension >= 1, reward: 50000, unlocked: false, secret: false },
    { id: "ngp1", name: "ğŸ”„ Renascence", desc: "1er NGP+", check: () => game.ngpLevel >= 1, reward: 100000, unlocked: false, secret: false },
    { id: "darkm10", name: "ğŸŒ™ Ombrageux", desc: "10 Dark Matter", check: () => game.darkMatter >= 10, reward: 75000, unlocked: false, secret: false },
    { id: "trading100m", name: "ğŸ’¸ Trader", desc: "100M en Trading", check: () => Object.values(game.trades).reduce((a,t)=>a+t.totalGains,0)>=1e8, reward: 50000, unlocked: false, secret: false },
    { id: "bank1b", name: "ğŸ¦ Banquier", desc: "1B Ã  la banque", check: () => game.bankGenerated >= 1e9, reward: 200000, unlocked: false, secret: false },
    { id: "lottery10", name: "ğŸ° Chanceux", desc: "10 tirages", check: () => game.lotteryTickets >= 10, reward: 50000, unlocked: false, secret: false },
    { id: "stars100", name: "â­ Supernova", desc: "100 Ã©toiles", check: () => game.stars >= 100, reward: 150000, unlocked: false, secret: false },
    { id: "gen100", name: "ğŸ¤– Dominateur", desc: "100 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=100, reward: 100000, unlocked: false, secret: false },
    { id: "prestige50", name: "âš¡ LÃ©gende", desc: "50 Prestige", check: () => game.prestige >= 50, reward: 500000, unlocked: false, secret: false },
    { id: "galaxy10", name: "ğŸŒ€ Univers", desc: "10 Galaxies", check: () => game.galaxies >= 10, reward: 300000, unlocked: false, secret: false },
    
    // NOUVEAUX ACHIEVEMENTS
    { id: "coins10b", name: "ğŸ’µ Milliardaire", desc: "10B coins", check: () => game.totalCoins >= 1e10, reward: 50000, unlocked: false, secret: false },
    { id: "coins1t", name: "ğŸ’¸ Trillionaire", desc: "1T coins", check: () => game.totalCoins >= 1e12, reward: 250000, unlocked: false, secret: false },
    { id: "clicks1k", name: "ğŸ‘† Clickeur Pro", desc: "1000 clics", check: () => game.totalClicks >= 1000, reward: 25000, unlocked: false, secret: false },
    { id: "gen50", name: "ğŸ­ Industriel", desc: "50 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=50, reward: 50000, unlocked: false, secret: false },
    { id: "gen500", name: "ğŸ™ï¸ Empire", desc: "500 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=500, reward: 500000, unlocked: false, secret: false },
    { id: "prestige20", name: "â­ VÃ©tÃ©ran", desc: "20 Prestige", check: () => game.prestige >= 20, reward: 150000, unlocked: false, secret: false },
    { id: "prestige100", name: "ğŸŒŸ MaÃ®tre", desc: "100 Prestige", check: () => game.prestige >= 100, reward: 1000000, unlocked: false, secret: false },
    { id: "galaxy5", name: "ğŸŒŒ ConquÃ©rant", desc: "5 Galaxies", check: () => game.galaxies >= 5, reward: 200000, unlocked: false, secret: false },
    { id: "galaxy50", name: "ğŸª Dieu Galactique", desc: "50 Galaxies", check: () => game.galaxies >= 50, reward: 2000000, unlocked: false, secret: false },
    { id: "ascension5", name: "ğŸš€ Transcendant", desc: "5 Ascensions", check: () => game.ascension >= 5, reward: 500000, unlocked: false, secret: false },
    { id: "ngp5", name: "ğŸ”„ Persistant", desc: "NGP+ niveau 5", check: () => game.ngpLevel >= 5, reward: 500000, unlocked: false, secret: false },
    { id: "ngp20", name: "â™»ï¸ Ã‰ternel", desc: "NGP+ niveau 20", check: () => game.ngpLevel >= 20, reward: 2000000, unlocked: false, secret: false },
    { id: "qc10", name: "ğŸ’ Collectionneur", desc: "10 Quantum Coins", check: () => game.quantumCoins >= 10, reward: 1000000, unlocked: false, secret: false },
    { id: "shop5", name: "ğŸ›’ Acheteur", desc: "5 items du shop", check: () => game.shopItems && game.shopItems.reduce((a,i)=>a+i.bought,0)>=5, reward: 750000, unlocked: false, secret: false },
    { id: "bank100b", name: "ğŸ¦ Banquier Elite", desc: "100B Ã  la banque", check: () => game.bankGenerated >= 1e11, reward: 500000, unlocked: false, secret: false },
    { id: "trading1t", name: "ğŸ“ˆ Trader Pro", desc: "1T en trading", check: () => Object.values(game.trades).reduce((a,t)=>a+t.totalGains,0)>=1e12, reward: 1000000, unlocked: false, secret: false },

    // SECRETS
    { id: "secret_noclick", name: "ğŸ¤ AscÃ¨te", desc: "???", check: () => game.totalClicks === 0, reward: 50000, unlocked: false, secret: true },
    { id: "secret_lucky", name: "ğŸ€ Miracle", desc: "???", check: () => game.lotteryLog && game.lotteryLog.some(l=>l.includes("GROS")), reward: 100000, unlocked: false, secret: true },
    { id: "secret_ngp10", name: "â™¾ï¸ Infini", desc: "???", check: () => game.ngpLevel >= 10, reward: 500000, unlocked: false, secret: true },
    { id: "secret_rich", name: "ğŸ’ Riche", desc: "???", check: () => game.totalCoins >= 1e18, reward: 1000000, unlocked: false, secret: true },
    { id: "secret_speed", name: "âš¡ Ã‰clair", desc: "???", check: () => game.totalClicks >= 1000 && game.playTime < 300, reward: 200000, unlocked: false, secret: true },
    { id: "secret_shopmax", name: "ğŸ›ï¸ Perfectionniste", desc: "???", check: () => game.shopItems && game.shopItems.every(i=>i.bought >= i.maxBuy), reward: 5000000, unlocked: false, secret: true },
    { id: "secret_qc50", name: "ğŸ’  Quantique", desc: "???", check: () => game.quantumCoins >= 50, reward: 10000000, unlocked: false, secret: true },
    { id: "secret_allach", name: "ğŸ… ComplÃ©tionniste", desc: "???", check: () => game.achievements && game.achievements.filter(a=>!a.secret && a.unlocked).length >= 30, reward: 20000000, unlocked: false, secret: true }
  ];
}

let game = {
  coins: 0, totalCoins: 0, totalClicks: 0, stars: 0, galaxies: 0, prestige: 0, darkMatter: 0, ngpLevel: 0,
  quantumCoins: 0, playTime: 0, logs: [], tradeLogs: [],
  shopItems: [
    { id: "qc1", name: "ğŸš€ Boost Production Ã—2", desc: "Double la production de TOUS les gÃ©nÃ©rateurs", cost: 1, bought: 0, maxBuy: 10, effect: "prodMult", value: 2 },
    { id: "qc2", name: "ğŸ’° Boost Clics Ã—3", desc: "Triple les gains par clic", cost: 2, bought: 0, maxBuy: 5, effect: "clickMult", value: 3 },
    { id: "qc3", name: "â­ Boost Prestige +50%", desc: "+50% gains d'Ã©toiles", cost: 3, bought: 0, maxBuy: 3, effect: "starMult", value: 1.5 },
    { id: "qc4", name: "ğŸŒ€ Boost Galaxies +25%", desc: "+25% gains de galaxies", cost: 5, bought: 0, maxBuy: 3, effect: "galaxyMult", value: 1.25 },
    { id: "qc5", name: "ğŸ’¸ Trading Ã—2", desc: "Double les gains de trading", cost: 4, bought: 0, maxBuy: 5, effect: "tradeMult", value: 2 },
    { id: "qc6", name: "ğŸ¦ Banque +0.1%", desc: "+0.1% d'intÃ©rÃªts bancaires", cost: 3, bought: 0, maxBuy: 10, effect: "bankBonus", value: 0.001 },
    { id: "qc7", name: "ğŸŒ™ Dark Matter Auto", desc: "Gagne 1 DM tous les 5 Prestige", cost: 10, bought: 0, maxBuy: 1, effect: "dmAuto", value: 1 },
    { id: "qc8", name: "â™¾ï¸ NGP+ Discount", desc: "RÃ©duit coÃ»t NGP+ de 20%", cost: 15, bought: 0, maxBuy: 3, effect: "ngpDiscount", value: 0.8 },
    { id: "qc9", name: "âš¡ MEGA BOOST", desc: "Ã—10 TOUT (production, clics, etc)", cost: 25, bought: 0, maxBuy: 1, effect: "megaBoost", value: 10 },
    { id: "qc10", name: "ğŸ° Lucky Lottery", desc: "Ã—5 gains de lotterie", cost: 8, bought: 0, maxBuy: 2, effect: "lotteryMult", value: 5 }
  ],
  
  generators: [
    { id: "r", n: "Robot", b: 5, c: 0, p: 50, m: 1.2, unlock: { type: "none" } },
    { id: "u", n: "Usine", b: 15, c: 0, p: 500, m: 1.2, unlock: { type: "prestige", val: 1 } },
    { id: "po", n: "Port", b: 50, c: 0, p: 5e3, m: 1.2, unlock: { type: "stars", val: 5 } },
    { id: "l", n: "Labo", b: 200, c: 0, p: 50e3, m: 1.2, unlock: { type: "prestige", val: 3 } },
    { id: "s", n: "Satellite", b: 1500, c: 0, p: 500e3, m: 1.2, unlock: { type: "galaxies", val: 1 } }
  ],

  upgrades: [
    { id: "c1", n: "Clic +50%", p: 100, e: 1.02, b: 0, t: "c", unlock: { type: "none" } },
    { id: "r1", n: "Robot Ã—2", p: 2e3, e: 2, b: 0, t: "r", unlock: { type: "prestige", val: 1 } },
    { id: "r2", n: "Robot Ã—3", p: 50e3, e: 3, b: 0, t: "r", unlock: { type: "stars", val: 10 } },
    { id: "u1", n: "Usine Ã—2", p: 50e3, e: 2, b: 0, t: "u", unlock: { type: "prestige", val: 2 } },
    { id: "u2", n: "Usine Ã—3", p: 500e3, e: 3, b: 0, t: "u", unlock: { type: "prestige", val: 5 } },
    { id: "po1", n: "Port Ã—2", p: 500e3, e: 2, b: 0, t: "po", unlock: { type: "stars", val: 20 } },
    { id: "l1", n: "Labo Ã—2", p: 5e6, e: 2, b: 0, t: "l", unlock: { type: "prestige", val: 4 } },
    { id: "s1", n: "Satellite Ã—2", p: 50e6, e: 2, b: 0, t: "s", unlock: { type: "galaxies", val: 1 } }
  ],

  trades: { min: { amount: 0, totalGains: 0, totalLosses: 0 }, mid: { amount: 0, totalGains: 0, totalLosses: 0 }, high: { amount: 0, totalGains: 0, totalLosses: 0 } },
  graphData: [], boosts: [], lotteryLog: [], lotteryTickets: 0,
  bankInvested: 0, bankGenerated: 0, ascension: 0, achievements: [], milestones: [],

  research: [
    { id: "res1", name: "ğŸš€ Production I", desc: "+15% production gÃ©nÃ©rateurs", level: 0, maxLevel: 10, baseCost: 10000, mult: 1.8, effect: "prodBonus", value: 0.15 },
    { id: "res2", name: "ğŸ’° Clics I", desc: "+20% gains par clic", level: 0, maxLevel: 10, baseCost: 5000, mult: 1.8, effect: "clickBonus", value: 0.20 },
    { id: "res3", name: "â­ Prestige Boost", desc: "+10% gains Ã©toiles", level: 0, maxLevel: 5, baseCost: 50000, mult: 2.0, effect: "starBonus", value: 0.10 },
    { id: "res4", name: "ğŸ’¸ Trading Pro", desc: "+25% gains trading", level: 0, maxLevel: 8, baseCost: 25000, mult: 1.9, effect: "tradeBonus", value: 0.25 },
    { id: "res5", name: "ğŸ¦ IntÃ©rÃªts Bancaires", desc: "+50% gains banque", level: 0, maxLevel: 6, baseCost: 30000, mult: 2.0, effect: "bankBonus", value: 0.50 },
    { id: "res6", name: "ğŸ° Chance Lotterie", desc: "+30% gains lotterie", level: 0, maxLevel: 5, baseCost: 15000, mult: 1.7, effect: "lotteryBonus", value: 0.30 },
    { id: "res7", name: "ğŸš€ Production II", desc: "+20% production gÃ©nÃ©rateurs", level: 0, maxLevel: 10, baseCost: 100000, mult: 2.2, effect: "prodBonus", value: 0.20 },
    { id: "res8", name: "ğŸ’° Clics II", desc: "+25% gains par clic", level: 0, maxLevel: 10, baseCost: 75000, mult: 2.2, effect: "clickBonus", value: 0.25 },
    { id: "res9", name: "ğŸŒ€ Galaxie Efficiency", desc: "+5% bonus galaxies", level: 0, maxLevel: 5, baseCost: 500000, mult: 2.5, effect: "galaxyBonus", value: 0.05 },
    { id: "res10", name: "ğŸŒ™ Dark Matter Gen", desc: "+1 DM par 9 Prestige", level: 0, maxLevel: 1, baseCost: 1000000, mult: 1.0, effect: "dmGen", value: 1 },
    { id: "res11", name: "âš¡ Ascension Power", desc: "+10% bonus ascension", level: 0, maxLevel: 5, baseCost: 2000000, mult: 3.0, effect: "ascBonus", value: 0.10 },
    { id: "res12", name: "ğŸš€ Production III", desc: "+30% production gÃ©nÃ©rateurs", level: 0, maxLevel: 10, baseCost: 5000000, mult: 2.5, effect: "prodBonus", value: 0.30 },
    { id: "res13", name: "ğŸ’° Clics III", desc: "+35% gains par clic", level: 0, maxLevel: 10, baseCost: 3000000, mult: 2.5, effect: "clickBonus", value: 0.35 },
    { id: "res14", name: "â™¾ï¸ NGP+ Efficiency", desc: "+5% bonus NGP+", level: 0, maxLevel: 5, baseCost: 10000000, mult: 3.0, effect: "ngpBonus", value: 0.05 },
    { id: "res15", name: "ğŸ­ Synergies", desc: "+50% bonus synergies", level: 0, maxLevel: 3, baseCost: 20000000, mult: 4.0, effect: "synergyBonus", value: 0.50 }
  ],

  shopDM: [
    { id: "dm1", name: "âš¡ Mega Production", desc: "Ã—3 production", cost: 5, bought: false, effect: "dmProdMult", value: 3 },
    { id: "dm2", name: "ğŸ’° Super Clics", desc: "Ã—5 gains clics", cost: 8, bought: false, effect: "dmClickMult", value: 5 },
    { id: "dm3", name: "â­ Prestige Rapide", desc: "Ã·2 coÃ»t Prestige", cost: 10, bought: false, effect: "dmPrestigeCost", value: 0.5 },
    { id: "dm4", name: "ğŸŒ€ Galaxie Discount", desc: "Ã·2 coÃ»t Galaxies", cost: 15, bought: false, effect: "dmGalaxyCost", value: 0.5 },
    { id: "dm5", name: "ğŸ’¸ Trading x10", desc: "Ã—10 gains trading", cost: 12, bought: false, effect: "dmTradeMult", value: 10 },
    { id: "dm6", name: "ğŸ¦ Banque x20", desc: "Ã—20 gains banque", cost: 18, bought: false, effect: "dmBankMult", value: 20 },
    { id: "dm7", name: "ğŸ° Jackpot", desc: "Ã—100 gains lotterie", cost: 20, bought: false, effect: "dmLotteryMult", value: 100 },
    { id: "dm8", name: "ğŸ¤– Auto-Clicker", desc: "+5 coins/sec automatique", cost: 25, bought: false, effect: "dmAutoClick", value: 5 },
    { id: "dm9", name: "âš¡ Time Warp", desc: "Ã—2 vitesse jeu", cost: 30, bought: false, effect: "dmTimeWarp", value: 2 },
    { id: "dm10", name: "ğŸ’ Quantum Rain", desc: "+1 QC par minute", cost: 50, bought: false, effect: "dmQCRain", value: 1 }
  ]
};

function getDefaultMilestones() {
  return [
    // TIER 1 - DÃ©but
    { id: "m1", name: "Premier Pas", desc: "Atteindre 1K coins", goal: 1e3, type: "coins", reward: { coins: 500 }, completed: false },
    { id: "m2", name: "En Route", desc: "Atteindre 10K coins", goal: 1e4, type: "coins", reward: { coins: 5000 }, completed: false },
    { id: "m3", name: "Producteur", desc: "10 coins/sec", goal: 10, type: "cps", reward: { coins: 10000 }, completed: false },

    // TIER 2 - Croissance
    { id: "m4", name: "Fortune", desc: "Atteindre 1M coins", goal: 1e6, type: "coins", reward: { coins: 100000 }, completed: false },
    { id: "m5", name: "RapiditÃ©", desc: "100 coins/sec", goal: 100, type: "cps", reward: { coins: 250000 }, completed: false },
    { id: "m6", name: "Collecteur", desc: "5 gÃ©nÃ©rateurs", goal: 5, type: "totalGens", reward: { coins: 150000 }, completed: false },

    // TIER 3 - Prestige
    { id: "m7", name: "RÃ©incarnation", desc: "1er Prestige", goal: 1, type: "prestige", reward: { coins: 500000 }, completed: false },
    { id: "m8", name: "Richesse", desc: "Atteindre 100M coins", goal: 1e8, type: "coins", reward: { coins: 1000000 }, completed: false },
    { id: "m9", name: "Production", desc: "1K coins/sec", goal: 1000, type: "cps", reward: { coins: 2000000 }, completed: false },
    { id: "m10", name: "Flotte", desc: "25 gÃ©nÃ©rateurs", goal: 25, type: "totalGens", reward: { coins: 1500000 }, completed: false },

    // TIER 4 - Galaxies
    { id: "m11", name: "Cosmique", desc: "1Ã¨re Galaxie", goal: 1, type: "galaxies", reward: { coins: 5000000 }, completed: false },
    { id: "m12", name: "Tycoon", desc: "Atteindre 1B coins", goal: 1e9, type: "coins", reward: { coins: 10000000 }, completed: false },
    { id: "m13", name: "Usine", desc: "10K coins/sec", goal: 10000, type: "cps", reward: { coins: 15000000 }, completed: false },
    { id: "m14", name: "ArmÃ©e", desc: "50 gÃ©nÃ©rateurs", goal: 50, type: "totalGens", reward: { coins: 10000000 }, completed: false },
    { id: "m15", name: "Ã‰toilÃ©", desc: "10 Prestige", goal: 10, type: "prestige", reward: { coins: 20000000 }, completed: false },

    // TIER 5 - Ascension
    { id: "m16", name: "Transcendance", desc: "1Ã¨re Ascension", goal: 1, type: "ascension", reward: { coins: 50000000 }, completed: false },
    { id: "m17", name: "Titan", desc: "Atteindre 1T coins", goal: 1e12, type: "coins", reward: { coins: 100000000 }, completed: false },
    { id: "m18", name: "MÃ©ga Production", desc: "100K coins/sec", goal: 100000, type: "cps", reward: { coins: 150000000 }, completed: false },
    { id: "m19", name: "Galaxies", desc: "5 Galaxies", goal: 5, type: "galaxies", reward: { coins: 100000000 }, completed: false },
    { id: "m20", name: "Industriel", desc: "100 gÃ©nÃ©rateurs", goal: 100, type: "totalGens", reward: { coins: 200000000 }, completed: false },

    // TIER 6 - NGP+
    { id: "m21", name: "Renaissance", desc: "1er NGP+", goal: 1, type: "ngp", reward: { coins: 500000000 }, completed: false },
    { id: "m22", name: "Quantum DÃ©bloquÃ©", desc: "NGP+5 (Shop dÃ©bloquÃ©)", goal: 5, type: "ngp", reward: { quantumCoins: 2 }, completed: false },
    { id: "m23", name: "Infini", desc: "Atteindre 1Qa coins", goal: 1e15, type: "coins", reward: { coins: 1000000000 }, completed: false },
    { id: "m24", name: "Giga Production", desc: "1M coins/sec", goal: 1000000, type: "cps", reward: { coins: 2000000000 }, completed: false },
    { id: "m25", name: "Empire", desc: "200 gÃ©nÃ©rateurs", goal: 200, type: "totalGens", reward: { coins: 1500000000 }, completed: false },

    // TIER 7 - Quantum
    { id: "m26", name: "Acheteur Quantum", desc: "Acheter 1er item shop", goal: 1, type: "shopBought", reward: { quantumCoins: 1 }, completed: false },
    { id: "m27", name: "Collectionneur", desc: "Acheter 5 items shop", goal: 5, type: "shopBought", reward: { quantumCoins: 2 }, completed: false },
    { id: "m28", name: "MaÃ®tre Quantum", desc: "10 Quantum Coins", goal: 10, type: "quantumCoins", reward: { quantumCoins: 3 }, completed: false },
    { id: "m29", name: "LÃ©gende", desc: "50 Prestige", goal: 50, type: "prestige", reward: { quantumCoins: 5 }, completed: false },
    { id: "m30", name: "Dieu", desc: "Atteindre 1Qi coins", goal: 1e18, type: "coins", reward: { quantumCoins: 10 }, completed: false },

    // TIER 8 - ExtrÃªme
    { id: "m31", name: "Tera Production", desc: "10M coins/sec", goal: 10000000, type: "cps", reward: { quantumCoins: 5 }, completed: false },
    { id: "m32", name: "Civilisation", desc: "500 gÃ©nÃ©rateurs", goal: 500, type: "totalGens", reward: { quantumCoins: 3 }, completed: false },
    { id: "m33", name: "Univers", desc: "20 Galaxies", goal: 20, type: "galaxies", reward: { quantumCoins: 8 }, completed: false },
    { id: "m34", name: "Ã‰ternel", desc: "NGP+20", goal: 20, type: "ngp", reward: { quantumCoins: 15 }, completed: false },
    { id: "m35", name: "Transcendant", desc: "10 Ascensions", goal: 10, type: "ascension", reward: { quantumCoins: 12 }, completed: false },

    // TIER 9 - Impossible
    { id: "m36", name: "Au-delÃ ", desc: "Atteindre 1Sx coins", goal: 1e21, type: "coins", reward: { quantumCoins: 20 }, completed: false },
    { id: "m37", name: "Peta Production", desc: "100M coins/sec", goal: 100000000, type: "cps", reward: { quantumCoins: 15 }, completed: false },
    { id: "m38", name: "Multivers", desc: "50 Galaxies", goal: 50, type: "galaxies", reward: { quantumCoins: 25 }, completed: false },
    { id: "m39", name: "Perfection", desc: "100 Prestige", goal: 100, type: "prestige", reward: { quantumCoins: 30 }, completed: false },
    { id: "m40", name: "Divin", desc: "NGP+50", goal: 50, type: "ngp", reward: { quantumCoins: 50 }, completed: false },

    // BONUS MILESTONES
    { id: "m41", name: "Banquier", desc: "100B gÃ©nÃ©rÃ©s banque", goal: 1e11, type: "bankGen", reward: { quantumCoins: 10 }, completed: false },
    { id: "m42", name: "Trader Elite", desc: "1T gains trading", goal: 1e12, type: "tradeGains", reward: { quantumCoins: 10 }, completed: false },
    { id: "m43", name: "Chanceux", desc: "100 tickets lotterie", goal: 100, type: "lotteryTotal", reward: { quantumCoins: 5 }, completed: false },
    { id: "m44", name: "Clicker Fou", desc: "10K clics", goal: 10000, type: "clicks", reward: { quantumCoins: 8 }, completed: false },
    { id: "m45", name: "Achievements Hunter", desc: "20 achievements", goal: 20, type: "achievements", reward: { quantumCoins: 15 }, completed: false },
    { id: "m46", name: "Shop Master", desc: "Tous items shop MAX", goal: 1, type: "shopMax", reward: { quantumCoins: 100 }, completed: false },
    { id: "m47", name: "Dark Matter", desc: "50 Dark Matter", goal: 50, type: "darkMatter", reward: { quantumCoins: 20 }, completed: false },
    { id: "m48", name: "Hyperproducteur", desc: "1B coins/sec", goal: 1e9, type: "cps", reward: { quantumCoins: 50 }, completed: false },
    { id: "m49", name: "Richesse Ultime", desc: "1Sp coins total", goal: 1e24, type: "coins", reward: { quantumCoins: 100 }, completed: false },
    { id: "m50", name: "Dimension Finale", desc: "NGP+100", goal: 100, type: "ngp", reward: { quantumCoins: 200 }, completed: false }
  ];
}

game.achievements = getDefaultAchievements();
game.milestones = getDefaultMilestones();

function $(id) { return document.getElementById(id); }

function fmt(n) {
  if (!isFinite(n) || isNaN(n)) return "âˆ";
  const abbr = [{v:1e33,s:"D"},{v:1e30,s:"No"},{v:1e27,s:"Oc"},{v:1e24,s:"Sp"},{v:1e21,s:"Sx"},{v:1e18,s:"Qi"},{v:1e15,s:"Qa"},{v:1e12,s:"T"},{v:1e9,s:"B"},{v:1e6,s:"M"},{v:1e3,s:"K"}];
  for(let a of abbr) if(n >= a.v) return (n/a.v).toFixed(2).replace(/\.?0+$/,"") + a.s;
  return Math.round(n).toString();
}

function log(msg) { game.logs.unshift(msg); if(game.logs.length > 12) game.logs.pop(); updateLog(); }
function tradeLog(msg, type="info") { game.tradeLogs.unshift({msg,type}); if(game.tradeLogs.length>20) game.tradeLogs.pop(); updateTradeLog(); }
function save() { let now = Date.now(); if(now - lastSaveTime < 5000) return; localStorage.setItem(SAVE_KEY, JSON.stringify(game)); lastSaveTime = now; }
let lastSaveTime = 0;

function load() {
  let data = localStorage.getItem(SAVE_KEY);
  if(data) {
    try {
      let parsed = JSON.parse(data);

      // Preserve default research and shopDM structures
      let defaultResearch = game.research;
      let defaultShopDM = game.shopDM;

      game = {...game, ...parsed};
      if(!Array.isArray(game.generators) || game.generators.length === 0) game.generators = [...game.generators];
      if(!Array.isArray(game.achievements) || game.achievements.length === 0) game.achievements = getDefaultAchievements();
      if(!Array.isArray(game.milestones) || game.milestones.length === 0) game.milestones = getDefaultMilestones();
      if(!game.quantumCoins) game.quantumCoins = 0;
      if(!Array.isArray(game.shopItems)) game.shopItems = [...game.shopItems];

      // Initialize research and shopDM if they don't exist in save
      if(!Array.isArray(game.research)) game.research = defaultResearch;
      if(!Array.isArray(game.shopDM)) game.shopDM = defaultShopDM;
    } catch(e) { console.error("Load error:", e); }
  }
}

function getTradeConfig(type) {
  const baseMarketVolatility = 0.05 + (Math.sin(Date.now() / 5000) * 0.03);
  return {
    min: { baseGain: 0.024, volatility: baseMarketVolatility * 0.5, lossChance: 0.0025, lossRate: 0.005 },
    mid: { baseGain: 0.08, volatility: baseMarketVolatility * 1.2, lossChance: 0.015, lossRate: 0.0125 },
    high: { baseGain: 0.24, volatility: baseMarketVolatility * 2.5, lossChance: 0.04, lossRate: 0.0375, riskAll: 0.0005 }
  }[type];
}

function getProd() {
  if(!game.generators || !Array.isArray(game.generators) || game.generators.length === 0) return 0;
  if(!cache.isDirty && cache.lastUpdate === Date.now()/1000|0) return cache.prod;
  
  let total = 0;
  for(let g of game.generators) {
    let e = 1;
    for(let u of game.upgrades) if(u.t === g.id && u.b > 0) e *= Math.pow(u.e, u.b);
    total += g.c * g.b * e;
  }
  
  let sy = 1;
  // Synergies entre gÃ©nÃ©rateurs avec vÃ©rifications de sÃ©curitÃ©
  if(game.generators && game.generators.length >= 5) {
    let r=game.generators[0], us=game.generators[1], p=game.generators[2], l=game.generators[3], s=game.generators[4];
    if(r && us && r.c >= 5 && us.c >= 3) sy *= 1.3;
    if(p && s && p.c >= 3 && s.c >= 2) sy *= 1.4;
    if(l && us && l.c >= 2 && us.c >= 5) sy *= 1.2;
  }

  // Research bonuses for multipliers
  let resGalaxyBonus = 1 + getResearchBoost("galaxyBonus");
  let resAscBonus = 1 + getResearchBoost("ascBonus");
  let resNGPBonus = 1 + getResearchBoost("ngpBonus");

  cache.starsMultiplier = Math.pow(1.03, game.stars);
  cache.galaxiesMultiplier = Math.pow(1.01 * resGalaxyBonus, game.galaxies);
  cache.ascensionMultiplier = (1 + (game.ascension * 0.05)) * resAscBonus;
  let ngpMult = Math.pow(1.10 * resNGPBonus, game.ngpLevel);

  if(!isFinite(cache.starsMultiplier) || cache.starsMultiplier > 1e100) cache.starsMultiplier = 1e100;
  if(!isFinite(cache.galaxiesMultiplier) || cache.galaxiesMultiplier > 1e100) cache.galaxiesMultiplier = 1e100;
  if(!isFinite(cache.ascensionMultiplier) || cache.ascensionMultiplier > 1e50) cache.ascensionMultiplier = 1e50;
  if(!isFinite(ngpMult) || ngpMult > 1e50) ngpMult = 1e50;

  // Boosts du shop NGP+
  let shopProdBoost = getShopBoost("prodMult");
  let shopMegaBoost = getShopBoost("megaBoost");

  // Research bonuses
  let resProdBonus = 1 + getResearchBoost("prodBonus");
  let resSynergyBonus = 1 + getResearchBoost("synergyBonus");
  sy *= resSynergyBonus;

  // Dark Matter shop bonuses
  let dmProdMult = getDMBoost("dmProdMult");

  let result = (total * sy) * cache.starsMultiplier * cache.galaxiesMultiplier * (1 + game.darkMatter * 0.05) * cache.ascensionMultiplier * ngpMult * shopProdBoost * shopMegaBoost * resProdBonus * dmProdMult;
  if(!isFinite(result) || result > 1e308) result = 1e308;

  cache.prod = result;
  cache.isDirty = false;
  cache.lastUpdate = Date.now()/1000|0;
  return result;
}

function clickVal() {
  let v = 1;
  for(let u of game.upgrades) if(u && u.t === "c" && u.b > 0) v *= Math.pow(u.e, u.b);
  let starsMult = cache.starsMultiplier || 1;
  let galaxiesMult = cache.galaxiesMultiplier || 1;
  let ascensionMult = cache.ascensionMultiplier || 1;
  let ngpMult = Math.pow(1.10, game.ngpLevel || 0);

  // Boosts du shop NGP+
  let shopClickBoost = getShopBoost("clickMult");
  let shopMegaBoost = getShopBoost("megaBoost");

  // Research bonuses
  let resClickBonus = 1 + getResearchBoost("clickBonus");

  // Dark Matter shop bonuses
  let dmClickMult = getDMBoost("dmClickMult");

  let result = v * starsMult * galaxiesMult * (1 + (game.darkMatter || 0) * 0.05) * ascensionMult * ngpMult * shopClickBoost * shopMegaBoost * resClickBonus * dmClickMult;
  if(!isFinite(result) || result > 1e308) return 1e308;
  return result;
}

function clickBtn() {
  let v = clickVal();
  game.coins += v;
  game.totalCoins += v;
  game.totalClicks++;
  updateUI();
}

function buyGen(id) {
  let g = game.generators.find(x => x.id === id);
  if(!g) return;
  let cost = g.p * Math.pow(g.m, g.c);
  if(game.coins < cost) return;
  game.coins -= cost;
  g.c++;
  invalidateCache();
  log("âœ… +" + g.n);
  save();
  updateUI();
}

function buyGenMax(id) {
  let g = game.generators.find(x => x.id === id);
  if(!g) return;
  let count = 0;
  while(true) {
    let cost = g.p * Math.pow(g.m, g.c);
    if(game.coins < cost) break;
    game.coins -= cost;
    g.c++;
    count++;
  }
  if(count > 0) {
    invalidateCache();
    log("âœ… +" + count + "x " + g.n);
    save();
    updateUI();
  }
}

function buyUp(id) {
  let u = game.upgrades.find(x => x.id === id);
  if(!u) return;
  let cost = u.p * Math.pow(1.15, u.b);
  if(game.coins < cost) return;
  game.coins -= cost;
  u.b++;
  invalidateCache();
  log("âœ… " + u.n);
  save();
  updateUI();
}

function buyUpMax(id) {
  let u = game.upgrades.find(x => x.id === id);
  if(!u) return;
  let count = 0;
  while(true) {
    let cost = u.p * Math.pow(1.15, u.b);
    if(game.coins < cost) break;
    game.coins -= cost;
    u.b++;
    count++;
  }
  if(count > 0) {
    invalidateCache();
    log("âœ… " + u.n);
    save();
    updateUI();
  }
}

function doPrestige() {
  let baseCost = 50000;
  let dmPrestigeCostMod = getDMBoost("dmPrestigeCost");
  let prestigeCost = (baseCost * Math.pow(1.5, game.prestige)) * dmPrestigeCostMod;
  if(game.coins < prestigeCost) return;
  game.coins = 0;
  game.totalCoins += prestigeCost;

  // Star bonus from research
  let resStarBonus = 1 + getResearchBoost("starBonus");
  game.stars += Math.max(1, Math.floor(resStarBonus));
  game.prestige++;

  // Dark Matter gain (every 10 prestige, or 9 with research)
  let dmGenResearch = game.research.find(r => r.id === "res10");
  let dmInterval = (dmGenResearch && dmGenResearch.level > 0) ? 9 : 10;
  if(game.prestige >= dmInterval && game.prestige % dmInterval === 0) game.darkMatter++;

  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  invalidateCache();
  log("â­ +1! (Prestige " + game.prestige + ")");
  save();
  updateUI();
}

function doPrestigeMultiple(count) {
  let baseCost = 50000;
  let dmPrestigeCostMod = getDMBoost("dmPrestigeCost");
  let prestigeCount = 0;

  // Calculer combien de prestige sont possibles
  for(let i = 0; i < count; i++) {
    let prestigeCost = (baseCost * Math.pow(1.5, game.prestige + i)) * dmPrestigeCostMod;
    if(game.coins < prestigeCost) break;
    prestigeCount++;
  }

  if(prestigeCount === 0) { alert("âŒ Pas assez de coins!"); return; }

  // Effectuer tous les prestige
  game.coins = 0;

  // Star bonus from research
  let resStarBonus = 1 + getResearchBoost("starBonus");
  let starsGained = Math.max(prestigeCount, Math.floor(prestigeCount * resStarBonus));
  game.stars += starsGained;
  game.prestige += prestigeCount;

  // Calculer Dark Matter gagnÃ© (every 10 prestige, or 9 with research)
  let dmGenResearch = game.research.find(r => r.id === "res10");
  let dmInterval = (dmGenResearch && dmGenResearch.level > 0) ? 9 : 10;
  let dmGained = 0;
  for(let i = game.prestige - prestigeCount; i < game.prestige; i++) {
    if(i >= dmInterval && i % dmInterval === 0) dmGained++;
  }
  if(dmGained > 0) game.darkMatter += dmGained;

  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};

  invalidateCache();
  log(`â­ +${prestigeCount}! (Total: ${game.prestige})` + (dmGained > 0 ? ` ğŸŒ™ +${dmGained} DM!` : ""));
  save();
  updateUI();
}

function doGalaxy() {
  let dmGalaxyCostMod = getDMBoost("dmGalaxyCost");
  let cost = Math.floor((50 + (game.galaxies * 5)) * dmGalaxyCostMod);
  if(game.stars < cost) return;
  game.stars = 0;
  game.coins = 0;
  game.galaxies++;
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  invalidateCache();
  log("ğŸŒ€ +1!");
  save();
  updateUI();
}

function doAscension() {
  let cost = 100 * Math.pow(2, game.ascension);
  if(game.galaxies < cost) { alert("âŒ Tu as besoin de " + cost + " Galaxies!"); return; }
  if(!confirm("ğŸš€ Ascensionner? Tout se rÃ©initialise sauf les Galaxies!")) return;
  game.galaxies -= cost;
  game.ascension++;
  game.coins = 0;
  game.stars = 0;
  game.prestige = 0;
  game.darkMatter = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  invalidateCache();
  log("ğŸš€ ASCENSION! Bonus: +" + (game.ascension * 5) + "%");
  save();
  updateUI();
}

function doNGP() {
  // Calculer les coÃ»ts
  let ngpCost = {
    prestige: 10 + (game.ngpLevel * 5),  // 10, 15, 20, 25...
    stars: 20 + (game.ngpLevel * 10),    // 20, 30, 40, 50...
    darkMatter: 3 + (game.ngpLevel * 2)  // 3, 5, 7, 9...
  };
  
  // VÃ©rifier les ressources
  if(game.prestige < ngpCost.prestige) {
    alert(`âŒ Tu as besoin de ${ngpCost.prestige} Prestige! (Tu en as ${game.prestige})`);
    return;
  }
  if(game.stars < ngpCost.stars) {
    alert(`âŒ Tu as besoin de ${ngpCost.stars} Ã‰toiles! (Tu en as ${game.stars})`);
    return;
  }
  if(game.darkMatter < ngpCost.darkMatter) {
    alert(`âŒ Tu as besoin de ${ngpCost.darkMatter} Dark Matter! (Tu en as ${game.darkMatter})`);
    return;
  }
  
  let confirmMsg = `ğŸ”„ NEW GAME PLUS #${game.ngpLevel + 1}?\n\nCoÃ»te:\n`;
  confirmMsg += `âš¡ ${ngpCost.prestige} Prestige\n`;
  confirmMsg += `â­ ${ngpCost.stars} Ã‰toiles\n`;
  confirmMsg += `ğŸŒ™ ${ngpCost.darkMatter} Dark Matter\n\n`;
  confirmMsg += `Bonus: +${(game.ngpLevel + 1) * 10}% permanent!\n`;
  confirmMsg += `Tout se rÃ©initialise sauf Galaxies et Ascension!`;
  
  if(!confirm(confirmMsg)) return;
  
  // Payer le coÃ»t
  game.prestige -= ngpCost.prestige;
  game.stars -= ngpCost.stars;
  game.darkMatter -= ngpCost.darkMatter;

  // RÃ©initialiser et upgrader
  game.ngpLevel++;
  game.quantumCoins++; // Gagne 1 Quantum Coin par NGP+!
  game.coins = 0;
  game.totalClicks = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  game.bankInvested = 0;
  game.bankGenerated = 0;
  game.lotteryTickets = 0;
  game.lotteryLog = [];
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;

  // Reset Research (NGP+ only)
  for(let res of game.research) res.level = 0;

  // Reset Dark Matter Shop (NGP+ only)
  for(let item of game.shopDM) item.bought = false;

  invalidateCache();
  log("ğŸ”„ NEW GAME PLUS #" + game.ngpLevel + "! CoÃ»t payÃ©! Bonus: +" + (game.ngpLevel * 10) + "%");
  log("ğŸ’ +1 Quantum Coin!");
  log("âš ï¸ Recherches et Dark Matter Shop rÃ©initialisÃ©s!");
  save();
  updateUI();
}

function buyShopItem(id) {
  let item = game.shopItems.find(i => i.id === id);
  if(!item) return;
  if(item.bought >= item.maxBuy) { alert("âŒ Maximum atteint!"); return; }
  if(game.quantumCoins < item.cost) { alert("âŒ Pas assez de Quantum Coins!"); return; }

  game.quantumCoins -= item.cost;
  item.bought++;

  log("ğŸ’ AchetÃ©: " + item.name);
  invalidateCache();
  save();
  updateUI();
}

function getShopBoost(effectType) {
  let boost = 1;
  for(let item of game.shopItems) {
    if(item.effect === effectType && item.bought > 0) {
      boost *= Math.pow(item.value, item.bought);
    }
  }
  return boost;
}

// ========== RESEARCH SYSTEM ==========
function buyResearch(id) {
  let research = game.research.find(r => r.id === id);
  if(!research) return;
  if(research.level >= research.maxLevel) { alert("âŒ Niveau maximum atteint!"); return; }

  let cost = research.baseCost * Math.pow(research.mult, research.level);
  if(game.coins < cost) { alert("âŒ Pas assez de coins!"); return; }

  game.coins -= cost;
  research.level++;

  log(`ğŸ”¬ ${research.name} Lvl ${research.level}`);
  invalidateCache();
  save();
  updateUI();
}

function getResearchBoost(effectType) {
  let boost = 0;
  for(let res of game.research) {
    if(res.effect === effectType && res.level > 0) {
      boost += res.value * res.level;
    }
  }
  return boost;
}

// ========== DARK MATTER SHOP ==========
function buyDMItem(id) {
  let item = game.shopDM.find(i => i.id === id);
  if(!item) return;
  if(item.bought) { alert("âŒ DÃ©jÃ  achetÃ©!"); return; }
  if(game.darkMatter < item.cost) { alert("âŒ Pas assez de Dark Matter!"); return; }

  game.darkMatter -= item.cost;
  item.bought = true;

  log(`ğŸŒ™ AchetÃ©: ${item.name}`);
  invalidateCache();
  save();
  updateUI();
}

function getDMBoost(effectType) {
  for(let item of game.shopDM) {
    if(item.effect === effectType && item.bought) {
      return item.value;
    }
  }
  return effectType.includes("Mult") ? 1 : 0;
}

function investTrade(type) {
  let input = $(`${type}Input`);
  let amount = parseFloat(input.value);
  if(!amount || amount <= 0 || game.coins < amount) { alert("âŒ Montant invalide!"); return; }
  game.coins -= amount;
  game.trades[type].amount += amount;
  input.value = "";
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)}`);
  log(`ğŸ“¤ Trade ${type}: +${fmt(amount)}`);
  save();
  updateUI();
}

function investTrade50(type) {
  let amount = game.coins * 0.5;
  if(amount <= 0) return;
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)} (50%)`);
  save();
  updateUI();
}

function investTradeAll(type) {
  let amount = game.coins;
  if(amount <= 0) return;
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)} (TOUT)`);
  save();
  updateUI();
}

function withdrawTrade(type) {
  let trade = game.trades[type];
  if(trade.amount <= 0) return;
  game.coins += trade.amount;
  game.totalCoins += trade.amount;
  tradeLog(`ğŸ“¥ ${type}: +${fmt(trade.amount)}`, "gain");
  trade.amount = 0;
  trade.totalGains = 0;
  trade.totalLosses = 0;
  save();
  updateUI();
}

function processTradeGains() {
  let tradeMult = getShopBoost("tradeMult");
  let resTradeBonus = 1 + getResearchBoost("tradeBonus");
  let dmTradeMult = getDMBoost("dmTradeMult");

  for(let type of ["min","mid","high"]) {
    let trade = game.trades[type];
    if(!trade || trade.amount <= 0) continue;
    let config = getTradeConfig(type);
    let volatilityFactor = 1 + (Math.random() - 0.5) * config.volatility;
    let actualGain = config.baseGain * volatilityFactor * tradeMult * resTradeBonus * dmTradeMult;
    let gain = trade.amount * actualGain / FPS;
    trade.amount += gain;
    trade.totalGains += gain;
    let rand = Math.random();
    if(type === "high" && rand < (config.riskAll / FPS)) {
      tradeLog("ğŸ’¥ TOUT PERDU!", "loss");
      trade.amount = 0;
      trade.totalGains = 0;
      trade.totalLosses = 0;
    } else if(rand < (config.lossChance / FPS)) {
      let loss = trade.amount * config.lossRate;
      trade.amount = Math.max(0, trade.amount - loss);
      trade.totalLosses += loss;
      tradeLog(`ğŸ“‰ ${type}: -${fmt(loss)}`, "loss");
    }
  }
  save();
}

function depositBank() {
  let amount = parseFloat($("bankInput").value);
  if(!amount || amount <= 0 || game.coins < amount) return;
  game.coins -= amount;
  game.bankInvested += amount;
  $("bankInput").value = "";
  log("ğŸ¦ DÃ©pÃ´t: +" + fmt(amount));
  save();
  updateUI();
}

function withdrawBank() {
  if(game.bankInvested <= 0) return;
  game.coins += game.bankInvested;
  game.totalCoins += game.bankInvested;
  log("ğŸ¦ Retrait: +" + fmt(game.bankInvested));
  game.bankInvested = 0;
  game.bankGenerated = 0;
  save();
  updateUI();
}

function buyLotteryTicket(count) {
  let cost = 100 * count;
  if(game.coins < cost) return;
  game.coins -= cost;
  game.lotteryTickets += count;
  log("ğŸ° +" + count + " tickets");
  save();
  updateUI();
}

function playLottery() {
  if(game.lotteryTickets <= 0) return;
  game.lotteryTickets--;
  let rand = Math.random();
  let gain = 0, result = "";
  let lotteryMult = getShopBoost("lotteryMult");
  let resLotteryBonus = 1 + getResearchBoost("lotteryBonus");
  let dmLotteryMult = getDMBoost("dmLotteryMult");
  let totalMult = lotteryMult * resLotteryBonus * dmLotteryMult;
  if(rand < 0.50) { gain = (50 + Math.floor(Math.random() * 50)) * totalMult; result = "ğŸŸ¢ Petit: +" + gain; }
  else if(rand < 0.75) { gain = (500 + Math.floor(Math.random() * 500)) * totalMult; result = "ğŸŸ¡ Moyen: +" + gain; }
  else { gain = (5000 + Math.floor(Math.random() * 5000)) * totalMult; result = "ğŸ”´ GROS LOT: +" + gain + "! ğŸ‰"; }
  game.coins += gain;
  game.totalCoins += gain;
  game.lotteryLog.unshift(result);
  if(game.lotteryLog.length > 15) game.lotteryLog.pop();
  log(result);
  save();
  updateUI();
}

function playLotteryAll() {
  if(game.lotteryTickets <= 0) { alert("âŒ Aucun ticket!"); return; }

  let ticketsToPlay = game.lotteryTickets;
  let totalGain = 0;
  let petits = 0, moyens = 0, grosLots = 0;
  let lotteryMult = getShopBoost("lotteryMult");
  let resLotteryBonus = 1 + getResearchBoost("lotteryBonus");
  let dmLotteryMult = getDMBoost("dmLotteryMult");
  let totalMult = lotteryMult * resLotteryBonus * dmLotteryMult;

  for(let i = 0; i < ticketsToPlay; i++) {
    let rand = Math.random();
    let gain = 0;
    if(rand < 0.50) {
      gain = (50 + Math.floor(Math.random() * 50)) * totalMult;
      petits++;
    } else if(rand < 0.75) {
      gain = (500 + Math.floor(Math.random() * 500)) * totalMult;
      moyens++;
    } else {
      gain = (5000 + Math.floor(Math.random() * 5000)) * totalMult;
      grosLots++;
    }
    totalGain += gain;
  }

  game.lotteryTickets = 0;
  game.coins += totalGain;
  game.totalCoins += totalGain;

  let summary = `ğŸ° ${ticketsToPlay} tickets: `;
  if(petits > 0) summary += `ğŸŸ¢Ã—${petits} `;
  if(moyens > 0) summary += `ğŸŸ¡Ã—${moyens} `;
  if(grosLots > 0) summary += `ğŸ”´Ã—${grosLots} `;
  summary += `= +${fmt(totalGain)} ğŸ’°`;

  game.lotteryLog.unshift(summary);
  if(game.lotteryLog.length > 15) game.lotteryLog.pop();
  log(summary);

  save();
  updateUI();
}

function checkAchievements() {
  for(let ach of game.achievements) {
    if(!ach.unlocked && ach.check && typeof ach.check === 'function' && ach.check()) {
      ach.unlocked = true;
      if(ach.secret) log("ğŸ”“ SECRET: " + ach.name);
      else log("ğŸ† " + ach.name);
      game.coins += ach.reward;
      game.totalCoins += ach.reward;
      save();
    }
  }
}

function checkMilestones() {
  for(let ms of game.milestones) {
    if(ms.completed) continue;

    let currentValue = 0;
    switch(ms.type) {
      case "coins": currentValue = game.totalCoins; break;
      case "cps": currentValue = getProd(); break;
      case "prestige": currentValue = game.prestige; break;
      case "galaxies": currentValue = game.galaxies; break;
      case "ascension": currentValue = game.ascension; break;
      case "ngp": currentValue = game.ngpLevel; break;
      case "quantumCoins": currentValue = game.quantumCoins; break;
      case "totalGens": currentValue = game.generators.reduce((a,g)=>a+g.c,0); break;
      case "shopBought": currentValue = game.shopItems ? game.shopItems.reduce((a,i)=>a+i.bought,0) : 0; break;
      case "bankGen": currentValue = game.bankGenerated; break;
      case "tradeGains": currentValue = Object.values(game.trades).reduce((a,t)=>a+t.totalGains,0); break;
      case "lotteryTotal": currentValue = game.lotteryTickets || 0; break;
      case "clicks": currentValue = game.totalClicks; break;
      case "achievements": currentValue = game.achievements.filter(a=>a.unlocked).length; break;
      case "shopMax": currentValue = game.shopItems && game.shopItems.every(i=>i.bought >= i.maxBuy) ? 1 : 0; break;
      case "darkMatter": currentValue = game.darkMatter; break;
    }

    if(currentValue >= ms.goal) {
      ms.completed = true;
      log("ğŸ¯ Milestone: " + ms.name);
      if(ms.reward.coins) { game.coins += ms.reward.coins; game.totalCoins += ms.reward.coins; }
      if(ms.reward.quantumCoins) { game.quantumCoins += ms.reward.quantumCoins; }
      save();
    }
  }
}

function updateTradeLog() {
  let html = "";
  for(let entry of game.tradeLogs) html += `<div class="trade-log-event ${entry.type || "info"}">${entry.msg}</div>`;
  $("tradeLog").innerHTML = html || "<div class='trade-log-event'>Attente...</div>";
}

function updateLog() {
  let html = "";
  for(let l of game.logs) html += `<div>${l}</div>`;
  $("log").innerHTML = html;
}

function updateMarketStatus() {
  const sine = Math.sin(Date.now() / 3000);
  const volatility = (0.05 + (Math.sin(Date.now() / 5000) * 0.03)) * 100;
  let status, emoji;
  if(sine > 0.3) { status = "ğŸ“ˆ HAUT"; emoji = "market-up"; }
  else if(sine < -0.3) { status = "ğŸ“‰ BAS"; emoji = "market-down"; }
  else { status = "ğŸ“Š NEUTRE"; emoji = "market-neutral"; }
  let el = $("marketStatus");
  if(el) { el.textContent = status; el.className = "market-status " + emoji; }
  let volEl = $("marketVolatility");
  if(volEl) volEl.textContent = volatility.toFixed(1) + "%";
}

function updateGraph() {
  game.graphData.push({ time: game.playTime, cps: getProd() });
  if(game.graphData.length > 300) game.graphData.shift();
  drawGraph();
}

function drawGraph() {
  const canvas = $("graphCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "#0af";
  ctx.lineWidth = 2;
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
  if(game.graphData.length < 2) return;
  let maxCPS = Math.max(...game.graphData.map(d => d.cps)) || 1;
  ctx.strokeStyle = "#0f0";
  ctx.lineWidth = 3;
  ctx.beginPath();
  for(let i = 0; i < game.graphData.length; i++) {
    let x = (i / (game.graphData.length - 1)) * canvas.width;
    let ratio = (game.graphData[i].cps) / maxCPS;
    let y = canvas.height - (ratio * canvas.height * 0.9) - 10;
    if(i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.fillStyle = "#aaa";
  ctx.font = "14px Arial";
  ctx.fillText("Max: " + fmt(maxCPS) + "/s", 10, 25);
}

function updateUI() {
  let p = getProd();
  $("coins").textContent = fmt(game.coins);
  $("cps").textContent = fmt(p);
  $("stars").textContent = game.stars;
  $("galaxies").textContent = game.galaxies;
  $("dm").textContent = game.darkMatter;
  $("ngpLevel").textContent = game.ngpLevel;
  $("tradeBlocked").textContent = fmt(game.trades.min.amount + game.trades.mid.amount + game.trades.high.amount);
  $("clickVal").textContent = fmt(clickVal());
  
  // Afficher la dÃ©composition des multiplicateurs
  let clickUpgMult = 1;
  for(let u of game.upgrades) if(u && u.t === "c" && u.b > 0) clickUpgMult *= Math.pow(u.e, u.b);
  let clickStarsMult = Math.pow(1.03, game.stars);
  let clickGalaxiesMult = Math.pow(1.01, game.galaxies);
  let clickNGPMult = Math.pow(1.10, game.ngpLevel || 0);
  let clickDMMult = 1 + (game.darkMatter || 0) * 0.05;
  let clickAscMult = 1 + (game.ascension || 0) * 0.05;
  
  if(!isFinite(clickStarsMult) || clickStarsMult > 1e100) clickStarsMult = 1e100;
  if(!isFinite(clickGalaxiesMult) || clickGalaxiesMult > 1e100) clickGalaxiesMult = 1e100;
  if(!isFinite(clickNGPMult) || clickNGPMult > 1e50) clickNGPMult = 1e50;
  
  $("clickUpgradesMult").textContent = clickUpgMult.toFixed(2) + "x";
  $("clickStarsMult").textContent = clickStarsMult.toFixed(2) + "x";
  $("clickGalaxiesMult").textContent = clickGalaxiesMult.toFixed(2) + "x";
  $("clickNGPLevel").textContent = game.ngpLevel || 0;
  $("clickNGPMult").textContent = clickNGPMult.toFixed(2) + "x";
  $("clickDMMult").textContent = clickDMMult.toFixed(2) + "x";
  $("clickAscensionMult").textContent = clickAscMult.toFixed(2) + "x";
  let baseCost = 50000;
  let dmPrestigeCostMod = getDMBoost("dmPrestigeCost");
  let dmGalaxyCostMod = getDMBoost("dmGalaxyCost");
  let nextPrestigeCost = (baseCost * Math.pow(1.5, game.prestige)) * dmPrestigeCostMod;
  $("prestigeCost").textContent = fmt(nextPrestigeCost);
  $("prestigeCount").textContent = game.coins >= nextPrestigeCost ? "âœ…" : "âŒ";
  $("galaxyCost").textContent = fmt(Math.floor((50 + (game.galaxies * 5)) * dmGalaxyCostMod));
  $("totalCoins").textContent = fmt(game.totalCoins);
  $("totalClicks").textContent = game.totalClicks;
  $("playTime").textContent = game.playTime + "s";
  $("presCount").textContent = game.prestige;
  $("ascension").textContent = game.ascension || 0;
  $("ascensionBonus").textContent = (game.ascension || 0) * 5;

  // Ascension Tab dÃ©tails
  if($("ascensionPoints")) $("ascensionPoints").textContent = game.ascension || 0;
  if($("ascGalaxies")) $("ascGalaxies").textContent = game.galaxies || 0;
  if($("nextAscLevel")) $("nextAscLevel").textContent = (game.ascension || 0) + 1;
  let ascCost = 100 * Math.pow(2, game.ascension || 0);
  if($("ascCost")) $("ascCost").textContent = fmt(ascCost);
  if($("ascHas")) $("ascHas").textContent = game.galaxies || 0;
  if($("nextAscBonus")) $("nextAscBonus").textContent = ((game.ascension || 0) + 1) * 5;

  $("ngpLevelDisplay").textContent = game.ngpLevel || 0;
  $("ngpBonusDisplay").textContent = (game.ngpLevel || 0) * 10;
  
  // Mettre Ã  jour les coÃ»ts NGP+
  let nextNGPLevel = (game.ngpLevel || 0) + 1;
  let ngpCostPrestige = 10 + ((game.ngpLevel || 0) * 5);
  let ngpCostStars = 20 + ((game.ngpLevel || 0) * 10);
  let ngpCostDM = 3 + ((game.ngpLevel || 0) * 2);
  $("nextNGPLevel").textContent = nextNGPLevel;
  $("ngpCostPrestige").textContent = ngpCostPrestige;
  $("ngpCostStars").textContent = ngpCostStars;
  $("ngpCostDM").textContent = ngpCostDM;
  $("yourPrestige").textContent = game.prestige;
  $("yourStars").textContent = game.stars;
  $("yourDM").textContent = game.darkMatter;
  $("bankInvested").textContent = fmt(game.bankInvested || 0);
  let bankGains = ((game.bankInvested || 0) * 0.00005) / FPS;
  $("bankGains").textContent = fmt(bankGains);
  $("bankGenerated").textContent = fmt(game.bankGenerated || 0);
  $("lotteryTickets").textContent = game.lotteryTickets || 0;
  
  let lotteryHtml = "";
  if(game.lotteryLog) {
    for(let log of game.lotteryLog) lotteryHtml += `<div style="padding:0.3rem;color:#aaa">${log}</div>`;
  }
  if($("lotteryLog")) $("lotteryLog").innerHTML = lotteryHtml || "<div style='color:#aaa'>Attente...</div>";
  
  let achCount = game.achievements ? game.achievements.filter(a => a.unlocked).length : 0;
  $("achievementCount").textContent = achCount;
  
  let achHtml = "";
  if(game.achievements) {
    for(let ach of game.achievements) {
      let achDiv;
      if(ach.secret && !ach.unlocked) {
        achDiv = `<div style="background:#0a0a0a;padding:1rem;border-radius:4px;border-left:3px solid #666"><div style="color:#999">ğŸ”’ SECRET</div><div style="color:#666">???</div></div>`;
      } else {
        achDiv = ach.unlocked ? 
          `<div style="background:#0a0a2a;padding:1rem;border-radius:4px;border-left:3px solid #0f0"><div style="color:#0f0;font-weight:bold">${ach.name}</div><div style="color:#aaa">${ach.desc}</div></div>` :
          `<div style="background:#0a0a0a;padding:1rem;border-radius:4px;border-left:3px solid #666;opacity:0.5"><div style="color:#aaa">${ach.name}</div><div style="color:#666">${ach.desc}</div></div>`;
      }
      achHtml += achDiv;
    }
  }
  if($("achievementsList")) $("achievementsList").innerHTML = achHtml;
  
  checkAchievements();
  checkMilestones();

  // Affichage du shop NGP+ et Quantum Coins
  if(game.ngpLevel >= 5) {
    if($("shopNGPBtn")) $("shopNGPBtn").style.display = "block";
    if($("qcStat")) $("qcStat").style.display = "block";
  } else {
    if($("shopNGPBtn")) $("shopNGPBtn").style.display = "none";
    if($("qcStat")) $("qcStat").style.display = "none";
  }

  if($("quantumCoins")) $("quantumCoins").textContent = game.quantumCoins || 0;
  if($("qcDisplay")) $("qcDisplay").textContent = game.quantumCoins || 0;

  // Afficher les items du shop
  if($("shopItemsList") && game.shopItems) {
    let shopHtml = "";
    for(let item of game.shopItems) {
      let canBuy = game.quantumCoins >= item.cost && item.bought < item.maxBuy;
      let maxReached = item.bought >= item.maxBuy;
      let itemDiv = `<div class="trade-card" style="border-color:${maxReached ? '#666' : '#f0f'}">
        <div class="trade-header">
          <div>
            <h4>${item.name}</h4>
            <p style="color:#aaa;font-size:0.9rem">${item.desc}</p>
          </div>
        </div>
        <div class="trade-stats">
          <div class="trade-stat"><div>ğŸ’ CoÃ»t</div><div class="trade-stat-val">${item.cost}</div></div>
          <div class="trade-stat"><div>âœ… AchetÃ©</div><div class="trade-stat-val">${item.bought}/${item.maxBuy}</div></div>
        </div>
        <button class="btn" onclick="buyShopItem('${item.id}')" ${!canBuy ? "disabled" : ""} style="width:100%;margin-top:0.5rem">${maxReached ? "âœ… MAX" : "ğŸ’ ACHETER"}</button>
      </div>`;
      shopHtml += itemDiv;
    }
    $("shopItemsList").innerHTML = shopHtml;
  }

  // Afficher les milestones
  if($("milestonesList") && game.milestones) {
    let milestonesHtml = "";
    for(let ms of game.milestones) {
      let currentValue = 0;
      switch(ms.type) {
        case "coins": currentValue = game.totalCoins; break;
        case "cps": currentValue = getProd(); break;
        case "prestige": currentValue = game.prestige; break;
        case "galaxies": currentValue = game.galaxies; break;
        case "ascension": currentValue = game.ascension; break;
        case "ngp": currentValue = game.ngpLevel; break;
        case "quantumCoins": currentValue = game.quantumCoins; break;
        case "totalGens": currentValue = game.generators.reduce((a,g)=>a+g.c,0); break;
        case "shopBought": currentValue = game.shopItems ? game.shopItems.reduce((a,i)=>a+i.bought,0) : 0; break;
        case "bankGen": currentValue = game.bankGenerated; break;
        case "tradeGains": currentValue = Object.values(game.trades).reduce((a,t)=>a+t.totalGains,0); break;
        case "lotteryTotal": currentValue = game.lotteryTickets || 0; break;
        case "clicks": currentValue = game.totalClicks; break;
        case "achievements": currentValue = game.achievements.filter(a=>a.unlocked).length; break;
        case "shopMax": currentValue = game.shopItems && game.shopItems.every(i=>i.bought >= i.maxBuy) ? 1 : 0; break;
        case "darkMatter": currentValue = game.darkMatter; break;
      }

      let progress = Math.min(100, (currentValue / ms.goal) * 100);
      let progressColor = ms.completed ? '#0f0' : (progress >= 100 ? '#0af' : '#fa0');

      let rewardText = "";
      if(ms.reward.coins) rewardText += `${fmt(ms.reward.coins)} ğŸ’°`;
      if(ms.reward.quantumCoins) rewardText += `${ms.reward.quantumCoins} ğŸ’`;

      let msDiv = `<div style="background:${ms.completed ? '#0a0a2a' : '#0a0a0a'};padding:1rem;border-radius:4px;border-left:3px solid ${progressColor}">
        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
          <div style="color:${ms.completed ? '#0f0' : '#0af'};font-weight:bold">${ms.completed ? 'âœ…' : 'ğŸ¯'} ${ms.name}</div>
          <div style="color:#fa0;font-size:0.9rem">${rewardText}</div>
        </div>
        <div style="color:#aaa;font-size:0.9rem;margin-bottom:0.5rem">${ms.desc}</div>
        <div style="color:#0af;font-size:0.85rem;margin-bottom:0.3rem">${fmt(currentValue)} / ${fmt(ms.goal)}</div>
        <div style="background:#111;border-radius:3px;height:8px;overflow:hidden">
          <div style="background:${progressColor};height:100%;width:${progress}%;transition:width 0.3s"></div>
        </div>
      </div>`;
      milestonesHtml += msDiv;
    }
    $("milestonesList").innerHTML = milestonesHtml;
  }

  for(let type of ["min","mid","high"]) {
    let trade = game.trades[type];
    let config = getTradeConfig(type);
    let gain = trade.amount * config.baseGain;
    $(`${type}Amount`).textContent = fmt(trade.amount);
    $(`${type}Gain`).textContent = fmt(gain);
    $(`${type}Loss`).textContent = fmt(trade.amount * config.lossRate);
  }
  
  let genHtml = "";
  for(let g of game.generators) {
    let cost = g.p * Math.pow(g.m, g.c);
    let upgMultiplier = 1;
    for(let u of game.upgrades) if(u.t === g.id && u.b) upgMultiplier *= Math.pow(u.e, u.b);

    // Utiliser les vrais multiplicateurs comme dans getProd()
    let starsMult = cache.starsMultiplier || Math.pow(1.03, game.stars);
    let galaxiesMult = cache.galaxiesMultiplier || Math.pow(1.01, game.galaxies);
    let ascensionMult = cache.ascensionMultiplier || (1 + (game.ascension * 0.05));
    let ngpMult = Math.pow(1.10, game.ngpLevel || 0);
    let dmMult = 1 + (game.darkMatter || 0) * 0.05;

    let gainPerSec = g.c * g.b * upgMultiplier * starsMult * galaxiesMult * dmMult * ascensionMult * ngpMult;
    genHtml += `<div class="item"><strong>${g.n}</strong> Ã—${g.c} <span style="color:#0f0">(${fmt(gainPerSec)}/s)</span><button class="btn" onclick="buyGen('${g.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyGenMax('${g.id}')">MAX</button></div>`;
  }
  $("gensList").innerHTML = genHtml;
  
  let upHtml = "";
  for(let u of game.upgrades) {
    let cost = u.p * Math.pow(1.15, u.b);
    upHtml += `<div class="item"><strong>${u.n}</strong> Ã—${u.e} <span style="color:#0f0">(Lvl ${u.b})</span><button class="btn" onclick="buyUp('${u.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyUpMax('${u.id}')">MAX</button></div>`;
  }
  $("upsList").innerHTML = upHtml;
  
  $("graphCPS").textContent = fmt(getProd());
  let maxCPS = Math.max(...(game.graphData.map(d => d.cps) || [0]));
  $("graphMax").textContent = fmt(maxCPS);

  // ========== RESEARCH UI ==========
  if($("researchList") && game.research) {
    let researchHtml = "";
    for(let res of game.research) {
      let cost = res.baseCost * Math.pow(res.mult, res.level);
      let canBuy = game.coins >= cost && res.level < res.maxLevel;
      let maxReached = res.level >= res.maxLevel;
      let bonusText = `+${(res.value * 100).toFixed(0)}%`;
      if(res.effect === "dmGen") bonusText = `+${res.value} DM`;
      let currentBonus = res.level > 0 ? `(Total: ${bonusText} Ã— ${res.level})` : "";

      let resDiv = `<div class="trade-card" style="border-color:${maxReached ? '#0f0' : '#0af'}">
        <div class="trade-header">
          <div>
            <h4>${res.name}</h4>
            <p style="color:#aaa;font-size:0.9rem">${res.desc} ${currentBonus}</p>
          </div>
        </div>
        <div class="trade-stats">
          <div class="trade-stat"><div>ğŸ’° CoÃ»t</div><div class="trade-stat-val">${fmt(cost)}</div></div>
          <div class="trade-stat"><div>ğŸ“Š Niveau</div><div class="trade-stat-val">${res.level}/${res.maxLevel}</div></div>
        </div>
        <button class="btn" onclick="buyResearch('${res.id}')" ${!canBuy ? "disabled" : ""} style="width:100%;margin-top:0.5rem;background:${maxReached ? '#0f0' : '#0af'}">${maxReached ? "âœ… MAX" : "ğŸ”¬ RECHERCHER"}</button>
      </div>`;
      researchHtml += resDiv;
    }
    $("researchList").innerHTML = researchHtml;
  }

  // ========== DARK MATTER SHOP UI ==========
  // Show/hide DM shop tab based on DM amount
  if(game.darkMatter >= 10) {
    if($("shopDMBtn")) $("shopDMBtn").style.display = "block";
  } else {
    if($("shopDMBtn")) $("shopDMBtn").style.display = "none";
  }

  if($("dmDisplay")) $("dmDisplay").textContent = game.darkMatter || 0;

  if($("shopDMList") && game.shopDM) {
    let dmShopHtml = "";
    for(let item of game.shopDM) {
      let canBuy = game.darkMatter >= item.cost && !item.bought;
      let itemDiv = `<div class="trade-card" style="border-color:${item.bought ? '#0f0' : '#f0f'}">
        <div class="trade-header">
          <div>
            <h4>${item.name}</h4>
            <p style="color:#aaa;font-size:0.9rem">${item.desc}</p>
          </div>
        </div>
        <div class="trade-stats">
          <div class="trade-stat"><div>ğŸŒ™ CoÃ»t</div><div class="trade-stat-val">${item.cost} DM</div></div>
          <div class="trade-stat"><div>ğŸ“Š Status</div><div class="trade-stat-val">${item.bought ? "âœ… Actif" : "âŒ Inactif"}</div></div>
        </div>
        <button class="btn" onclick="buyDMItem('${item.id}')" ${!canBuy ? "disabled" : ""} style="width:100%;margin-top:0.5rem;background:${item.bought ? '#0f0' : '#f0f'};color:#fff">${item.bought ? "âœ… ACHETÃ‰" : "ğŸŒ™ ACHETER"}</button>
      </div>`;
      dmShopHtml += itemDiv;
    }
    $("shopDMList").innerHTML = dmShopHtml;
  }

  save();
}

function showTutorial() {
  $("tutorialModal").style.display = "block";
  tutPage = 0;
  updateTutorial();
}

function updateTutorial() {
  $("tutText").innerHTML = TUTORIAL[tutPage] || "<p>Page non trouvÃ©e</p>";
  $("tutPage").textContent = tutPage + 1;
}

function showChangelogs() {
  $("changelogsModal").style.display = "block";
  let html = `<div style="color:#0af">`;
  for(let log of CHANGELOGS) {
    html += `<div style="background:#0a0a2a;padding:1.5rem;margin-bottom:1rem;border-left:4px solid #0af;border-radius:6px">
      <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
        <div style="color:#0f0;font-weight:bold">${log.version}</div>
        <div style="color:#fa0">${log.date}</div>
      </div>
      <div style="color:#0af;margin-bottom:0.8rem;font-weight:bold">${log.title}</div>`;
    for(let change of log.changes) html += `<div style="color:#aaa;margin:0.4rem 0">â€¢ ${change}</div>`;
    html += `</div>`;
  }
  html += `</div>`;
  $("changelogsContent").innerHTML = html;
}

document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".content").forEach(x => x.classList.remove("active"));
      this.classList.add("active");
      let tab = $(this.dataset.tab);
      if(tab) tab.classList.add("active");
    });
  });
  
  $("clickBtn").addEventListener("click", clickBtn);
  $("prestigeBtn").addEventListener("click", doPrestige);
  $("galaxyBtn").addEventListener("click", doGalaxy);
  $("downloadBtn").addEventListener("click", () => {
    let data = JSON.stringify(game, null, 2);
    let blob = new Blob([data], {type:"application/json"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "save_" + Date.now() + ".json";
    a.click();
  });
  $("uploadBtn").addEventListener("click", () => $("fileInput").click());
  $("fileInput").addEventListener("change", e => {
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = f => {
      try {
        game = JSON.parse(f.target.result);
        save();
        updateUI();
        log("ğŸ“‚ ChargÃ©!");
      } catch(err) { alert("âŒ Erreur"); }
    };
    reader.readAsText(file);
  });
  $("resetBtn").addEventListener("click", () => {
    if(!confirm("VRAIMENT?")) return;
    game = { coins: 0, totalCoins: 0, totalClicks: 0, stars: 0, galaxies: 0, prestige: 0, darkMatter: 0, ngpLevel: 0, quantumCoins: 0, playTime: 0, logs: [], tradeLogs: [],
      shopItems: [
        { id: "qc1", name: "ğŸš€ Boost Production Ã—2", desc: "Double la production de TOUS les gÃ©nÃ©rateurs", cost: 1, bought: 0, maxBuy: 10, effect: "prodMult", value: 2 },
        { id: "qc2", name: "ğŸ’° Boost Clics Ã—3", desc: "Triple les gains par clic", cost: 2, bought: 0, maxBuy: 5, effect: "clickMult", value: 3 },
        { id: "qc3", name: "â­ Boost Prestige +50%", desc: "+50% gains d'Ã©toiles", cost: 3, bought: 0, maxBuy: 3, effect: "starMult", value: 1.5 },
        { id: "qc4", name: "ğŸŒ€ Boost Galaxies +25%", desc: "+25% gains de galaxies", cost: 5, bought: 0, maxBuy: 3, effect: "galaxyMult", value: 1.25 },
        { id: "qc5", name: "ğŸ’¸ Trading Ã—2", desc: "Double les gains de trading", cost: 4, bought: 0, maxBuy: 5, effect: "tradeMult", value: 2 },
        { id: "qc6", name: "ğŸ¦ Banque +0.1%", desc: "+0.1% d'intÃ©rÃªts bancaires", cost: 3, bought: 0, maxBuy: 10, effect: "bankBonus", value: 0.001 },
        { id: "qc7", name: "ğŸŒ™ Dark Matter Auto", desc: "Gagne 1 DM tous les 5 Prestige", cost: 10, bought: 0, maxBuy: 1, effect: "dmAuto", value: 1 },
        { id: "qc8", name: "â™¾ï¸ NGP+ Discount", desc: "RÃ©duit coÃ»t NGP+ de 20%", cost: 15, bought: 0, maxBuy: 3, effect: "ngpDiscount", value: 0.8 },
        { id: "qc9", name: "âš¡ MEGA BOOST", desc: "Ã—10 TOUT (production, clics, etc)", cost: 25, bought: 0, maxBuy: 1, effect: "megaBoost", value: 10 },
        { id: "qc10", name: "ğŸ° Lucky Lottery", desc: "Ã—5 gains de lotterie", cost: 8, bought: 0, maxBuy: 2, effect: "lotteryMult", value: 5 }
      ],
      generators: [{ id: "r", n: "Robot", b: 5, c: 0, p: 50, m: 1.2, unlock: {type:"none"}}, {id:"u",n:"Usine",b:15,c:0,p:500,m:1.2,unlock:{type:"prestige",val:1}}, {id:"po",n:"Port",b:50,c:0,p:5e3,m:1.2,unlock:{type:"stars",val:5}}, {id:"l",n:"Labo",b:200,c:0,p:50e3,m:1.2,unlock:{type:"prestige",val:3}}, {id:"s",n:"Satellite",b:1500,c:0,p:500e3,m:1.2,unlock:{type:"galaxies",val:1}}],
      upgrades: [{id:"c1",n:"Clic +50%",p:100,e:1.02,b:0,t:"c",unlock:{type:"none"}}, {id:"r1",n:"Robot Ã—2",p:2e3,e:2,b:0,t:"r",unlock:{type:"prestige",val:1}}, {id:"r2",n:"Robot Ã—3",p:50e3,e:3,b:0,t:"r",unlock:{type:"stars",val:10}}, {id:"u1",n:"Usine Ã—2",p:50e3,e:2,b:0,t:"u",unlock:{type:"prestige",val:2}}, {id:"u2",n:"Usine Ã—3",p:500e3,e:3,b:0,t:"u",unlock:{type:"prestige",val:5}}, {id:"po1",n:"Port Ã—2",p:500e3,e:2,b:0,t:"po",unlock:{type:"stars",val:20}}, {id:"l1",n:"Labo Ã—2",p:5e6,e:2,b:0,t:"l",unlock:{type:"prestige",val:4}}, {id:"s1",n:"Satellite Ã—2",p:50e6,e:2,b:0,t:"s",unlock:{type:"galaxies",val:1}}],
      trades: {min:{amount:0,totalGains:0,totalLosses:0}, mid:{amount:0,totalGains:0,totalLosses:0}, high:{amount:0,totalGains:0,totalLosses:0}},
      graphData:[], boosts:[], lotteryLog:[], lotteryTickets:0, bankInvested:0, bankGenerated:0, ascension:0, achievements: getDefaultAchievements(), milestones: getDefaultMilestones()
    };
    localStorage.removeItem(SAVE_KEY);
    updateUI();
  });
  $("nextBtn").addEventListener("click", () => { if(tutPage < 17) { tutPage++; updateTutorial(); } });
  $("prevBtn").addEventListener("click", () => { if(tutPage > 0) { tutPage--; updateTutorial(); } });
  
  load();
  updateUI();
  log("Bienvenue v3 FINAL!");
  updateTradeLog();
  
  let lastUIUpdate = 0;
  let lastGameUpdate = 0;
  const gameUpdateInterval = 1000 / FPS; // 100ms pour FPS=10

  function gameLoop(currentTime) {
    // Calculs de jeu Ã  FPS=10
    if(currentTime - lastGameUpdate >= gameUpdateInterval) {
      let p = getProd();
      game.coins += p / FPS;
      game.totalCoins += p / FPS;

      // Auto-Clicker from DM shop
      let dmAutoClick = getDMBoost("dmAutoClick");
      if(dmAutoClick > 0) {
        game.coins += dmAutoClick / FPS;
        game.totalCoins += dmAutoClick / FPS;
      }

      if(game.bankInvested > 0) {
        let bankBoost = getShopBoost("bankBonus");
        let resBankBonus = getResearchBoost("bankBonus");
        let dmBankMult = getDMBoost("dmBankMult");
        let bankRate = (0.00005 + bankBoost) * (1 + resBankBonus) * dmBankMult;
        let bankGains = (game.bankInvested * bankRate) / FPS;
        game.bankInvested += bankGains;
        game.bankGenerated += bankGains;
      }
      processTradeGains();
      lastGameUpdate = currentTime;
    }

    updateMarketStatus();

    // UI update Ã  10fps aussi
    if(currentTime - lastUIUpdate >= 100) {
      updateUI();
      lastUIUpdate = currentTime;
    }
    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);
  
  let qcRainCounter = 0;
  setInterval(() => {
    game.playTime++;
    updateGraph();

    // Quantum Rain from DM shop (1 QC per minute)
    let dmQCRain = getDMBoost("dmQCRain");
    if(dmQCRain > 0) {
      qcRainCounter++;
      if(qcRainCounter >= 60) {
        game.quantumCoins += dmQCRain;
        log("ğŸ’ +1 Quantum Coin (Quantum Rain)");
        qcRainCounter = 0;
      }
    }
  }, 1000);
  
  updateMarketStatus();
});
</script>

</body>
</html>