<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0a0a0a">
  <title>Incremental Trade ULTIMATE - v3 FINAL</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @media (prefers-color-scheme: light) {
      body { background: #0a0a0a !important; color: #eee !important; }
    }
    body { font-family: Arial, sans-serif; background: #0a0a0a !important; color: #eee !important; padding: 1rem; }
    html { background: #0a0a0a !important; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { color: #0af; text-align: center; margin: 1rem 0; font-size: 2.2rem; }
    h3, h4 { color: #0af; margin: 0.5rem 0; }
    p { text-align: center; color: #aaa; margin-bottom: 1rem; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .stat { background: #1a1a1a; padding: 1rem; border-radius: 6px; border: 1px solid #0af; text-align: center; }
    .stat-val { font-size: 1.4rem; color: #0f0; font-weight: bold; }
    .tabs { display: flex; gap: 0.3rem; margin: 1rem 0; flex-wrap: wrap; background: #111; padding: 0.5rem; border-radius: 6px; }
    .tab-btn { padding: 0.6rem 1rem; background: #222; color: #aaa; border: 1px solid #333; cursor: pointer; border-radius: 4px; transition: 0.3s; }
    .tab-btn:hover { background: #333; }
    .tab-btn.active { background: #0af; color: #000; border-color: #0af; }
    .content { display: none; }
    .content.active { display: block; }
    .card { background: #1a1a1a; padding: 1rem; margin: 1rem 0; border-radius: 6px; border: 1px solid #333; }
    .btn { padding: 0.6rem 1rem; background: #0af; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 0.3rem 0.3rem 0.3rem 0; transition: 0.2s; }
    .btn:hover:not(:disabled) { transform: scale(1.05); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .danger-btn { background: #f00; color: #fff; }
    .danger-btn:hover:not(:disabled) { background: #c00; }
    .item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem; background: #0a0a0a; margin: 0.4rem 0; border-left: 3px solid #0af; }
    .big-btn { width: 100%; max-width: 280px; padding: 1.2rem; font-size: 1.1rem; margin: 1rem auto; display: block; }
    .log { background: #000; border-left: 3px solid #0af; padding: 0.8rem; max-height: 120px; overflow-y: auto; margin: 1rem 0; font-size: 0.85rem; }
    canvas { border: 1px solid #0af; background: #111; max-width: 100%; margin: 1rem 0; width: 100%; height: auto; }
    .trade-card { background: #1a1a2a; border: 2px solid #0af; padding: 1rem; margin: 1rem 0; border-radius: 6px; }
    .trade-card.min { border-color: #0f0; }
    .trade-card.mid { border-color: #fa0; }
    .trade-card.high { border-color: #f00; }
    .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .trade-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.5rem; margin: 0.5rem 0; }
    .trade-stat { background: #0a0a1a; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; border-left: 2px solid #0af; }
    .trade-stat-val { font-weight: bold; color: #0f0; font-size: 1.1rem; }
    .trade-input-group { display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap; }
    .trade-input { flex: 1; min-width: 100px; padding: 0.5rem; background: #0a0a0a; border: 1px solid #333; color: #0f0; border-radius: 4px; font-size: 0.9rem; }
    .trade-log-event { padding: 0.5rem; margin: 0.3rem 0; background: #000; border-left: 2px solid #0af; font-size: 0.85rem; }
    .trade-log-event.gain { border-left-color: #0f0; color: #0f0; }
    .trade-log-event.loss { border-left-color: #f00; color: #f00; }
    #tutorialModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.98); z-index: 9999; padding: 1rem; overflow-y: auto; display: none; }
    .tut-box { max-width: 700px; margin: 0 auto; background: #1a1a1a; padding: 1.5rem; border: 2px solid #0af; border-radius: 6px; }
    .tut-box h1 { margin-top: 0; }
    .tut-btns { display: flex; gap: 0.5rem; justify-content: center; margin: 1.5rem 0; }
    .graph-container { background: #0a0a1a; padding: 1rem; border-radius: 6px; border: 1px solid #0af; margin: 1rem 0; }
    .market-status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.9rem; font-weight: bold; margin: 0.5rem 0; }
    .market-up { background: #0f0; color: #000; }
    .market-down { background: #f00; color: #fff; }
    .market-neutral { background: #fa0; color: #000; }
    @media(max-width: 600px) { .tabs { font-size: 0.9rem; } .stat { padding: 0.6rem; } .btn { padding: 0.4rem 0.8rem; font-size: 0.85rem; } }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ’ INCREMENTAL TRADE ULTIMATE v3 FINAL ğŸ’</h1>
  <p>Le jeu inactif addictif avec NEW GAME PLUS! [FINAL EDITION]</p>

  <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn" onclick="showTutorial()" style="display:block">ğŸ“– TUTORIEL</button>
    <button class="btn" onclick="showChangelogs()" style="display:block">ğŸ“ CHANGELOGS</button>
    <div class="log" id="log" style="flex: 1; min-width: 200px; max-width: 400px; margin: 0;"></div>
  </div>

  <div class="stats">
    <div class="stat"><div>ğŸ’° PiÃ¨ces</div><div class="stat-val" id="coins">0</div></div>
    <div class="stat"><div>âš¡ /sec</div><div class="stat-val" id="cps">0</div></div>
    <div class="stat"><div>â­ Ã‰toiles</div><div class="stat-val" id="stars">0</div></div>
    <div class="stat"><div>ğŸŒ€ Galaxies</div><div class="stat-val" id="galaxies">0</div></div>
    <div class="stat"><div>ğŸŒ™ Dark Matter</div><div class="stat-val" id="dm">0</div></div>
    <div class="stat"><div>ğŸ’¸ Trade BloquÃ©</div><div class="stat-val" id="tradeBlocked">0</div></div>
    <div class="stat"><div>ğŸš€ Ascension</div><div class="stat-val" id="ascension">0</div></div>
    <div class="stat"><div>ğŸ”„ NGP+</div><div class="stat-val" id="ngpLevel">0</div></div>
    <div class="stat"><div>ğŸ† Achievements</div><div class="stat-val" id="achievementCount">0</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="main">ğŸ® JEU</button>
    <button class="tab-btn" data-tab="gens">ğŸ¤– GÃ‰NÃ‰RATEURS</button>
    <button class="tab-btn" data-tab="ups">âš¡ UPGRADES</button>
    <button class="tab-btn" data-tab="trade">ğŸ’¸ TRADING</button>
    <button class="tab-btn" data-tab="bank">ğŸ¦ BANQUE</button>
    <button class="tab-btn" data-tab="lottery">ğŸ° LOTTERIE</button>
    <button class="tab-btn" data-tab="ascensionTab">ğŸš€ ASCENSION</button>
    <button class="tab-btn" data-tab="ngp">ğŸ”„ NEW GAME+</button>
    <button class="tab-btn" data-tab="achievements">ğŸ† ACHIEVEMENTS</button>
    <button class="tab-btn" data-tab="milestones">ğŸ¯ MILESTONES</button>
    <button class="tab-btn" data-tab="graph">ğŸ“Š GRAPHIQUE</button>
    <button class="tab-btn" data-tab="stats">ğŸ“ˆ STATS</button>
    <button class="tab-btn" data-tab="params">âš™ï¸ PARAMÃˆTRES</button>
  </div>

  <div id="main" class="content active">
    <div class="card" style="text-align:center">
      <button class="btn big-btn" id="clickBtn">ğŸ–±ï¸ CLIQUER</button>
      <p>Gain: <span id="clickVal">0</span> par clic</p>
    </div>
    <div class="card">
      <h3>â±ï¸ PRESTIGE</h3>
      <p>CoÃ»t: <span id="prestigeCost">50000</span> ğŸ’°</p>
      <p>Progression: <span id="prestProg">0</span></p>
      <p style="color: #0f0; font-size: 1.1rem;"><strong>Possible: <span id="prestigeCount">0</span>Ã—</strong></p>
      <button class="btn" id="prestigeBtn">âš¡ PRESTIGE (+10% par prestige)</button>
    </div>
    <div class="card">
      <h3>ğŸŒ€ GALAXIES</h3>
      <p>CoÃ»t: <span id="galaxyCost">500</span> â­</p>
      <button class="btn" id="galaxyBtn">ğŸŒ€ SUPER PRESTIGE (Ã—1.6)</button>
    </div>
  </div>

  <div id="gens" class="content">
    <div class="card"><h3>ğŸ¤– GÃ‰NÃ‰RATEURS AUTOMATIQUES</h3><div id="gensList"></div></div>
  </div>

  <div id="ups" class="content">
    <div class="card"><h3>âš¡ AMÃ‰LIORATIONS</h3><div id="upsList"></div></div>
  </div>

  <div id="trade" class="content">
    <div class="card">
      <h3>ğŸ’¸ SYSTÃˆME DE TRADING - RÃ‰ALISTE ğŸ“Š</h3>
      <p style="color: #aaa; margin-bottom: 0.5rem;">MarchÃ© volatile! Les taux changent en temps rÃ©el!</p>
      <div style="text-align: center; margin: 1rem 0;">
        <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.5rem;">Ã‰tat du marchÃ©:</div>
        <div id="marketStatus" class="market-status market-neutral">ğŸ“Š NEUTRE</div>
        <div style="color: #aaa; font-size: 0.85rem; margin-top: 0.3rem;">VolatilitÃ©: <span id="marketVolatility">0%</span></div>
      </div>

```
  <div class="trade-card min">
    <div class="trade-header">
      <div><h4>âœ… RISQUE MINIMUM - Obligations</h4><p style="color: #0f0; font-size: 0.9rem;">+1.2% base Â±0.6% volatilitÃ©</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="minAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="minGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="minLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="minInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('min')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('min')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('min')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('min')">TOUT</button>
    </div>
  </div>

  <div class="trade-card mid">
    <div class="trade-header">
      <div><h4>âš ï¸ RISQUE MOYEN - Stocks</h4><p style="color: #fa0; font-size: 0.9rem;">+4% base Â±4.8% volatilitÃ©</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="midAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="midGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="midLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="midInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('mid')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('mid')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('mid')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('mid')">TOUT</button>
    </div>
  </div>

  <div class="trade-card high">
    <div class="trade-header">
      <div><h4>ğŸ”¥ GROS RISQUE - Crypto</h4><p style="color: #f00; font-size: 0.9rem;">+30% base Â±75% volatilitÃ©!</p></div>
    </div>
    <div class="trade-stats">
      <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="highAmount">0</div></div>
      <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="highGain">0</div></div>
      <div class="trade-stat"><div>ğŸ“‰ Risque</div><div class="trade-stat-val" id="highLoss">0</div></div>
    </div>
    <div class="trade-input-group">
      <input type="number" class="trade-input" id="highInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('high')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('high')">ğŸ“¥ RETIRER</button>
    </div>
    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('high')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('high')">TOUT</button>
    </div>
  </div>

  <div class="card">
    <h4>ğŸ“Š LOG TRADING</h4>
    <div id="tradeLog" style="max-height: 200px; overflow-y: auto;"><div class="trade-log-event">En attente...</div></div>
  </div>
</div>
```

  </div>

  <div id="bank" class="content">
    <div class="card">
      <h3>ğŸ¦ BANQUE - INVESTISSEMENTS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©pose des piÃ¨ces pour +0.1% par sec! (SANS RISQUE)</p>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸ’° Investi</div><div class="trade-stat-val" id="bankInvested">0</div></div>
        <div class="trade-stat"><div>âš¡ +/sec</div><div class="trade-stat-val" id="bankGains">0</div></div>
      </div>
      <div class="trade-input-group">
        <input type="number" class="trade-input" id="bankInput" placeholder="Montant Ã  dÃ©poser" min="0">
        <button class="btn" onclick="depositBank()">ğŸ“¤ DÃ‰POSER</button>
        <button class="btn danger-btn" onclick="withdrawBank()">ğŸ“¥ RETIRER</button>
      </div>
      <div class="card" style="background:#0a0a0a;margin-top:1rem">
        <h4>ğŸ“Š Info Banque</h4>
        <p style="color:#aaa;font-size:0.9rem">Total gÃ©nÃ©rÃ©: <span id="bankGenerated">0</span> ğŸ’°</p>
      </div>
    </div>
  </div>

  <div id="lottery" class="content">
    <div class="card">
      <h3>ğŸ° LOTTERIE - TENTEZ VOTRE CHANCE!</h3>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸŸï¸ Tickets</div><div class="trade-stat-val" id="lotteryTickets">0</div></div>
        <div class="trade-stat"><div>ğŸ’° CoÃ»t</div><div class="trade-stat-val">100</div></div>
      </div>
      <div class="trade-input-group">
        <button class="btn" onclick="buyLotteryTicket(1)">1 Ticket (100)</button>
        <button class="btn" onclick="buyLotteryTicket(10)">10 Tickets (1K)</button>
        <button class="btn" onclick="buyLotteryTicket(100)">100 Tickets (10K)</button>
      </div>
      <button class="btn big-btn" onclick="playLottery()" style="max-width: 100%; width: 100%;">ğŸ° JOUER!</button>
      <div class="card" style="background:#0a0a0a;margin-top:1rem">
        <h4>ğŸ² RÃ©sultats</h4>
        <div id="lotteryLog" style="max-height: 200px; overflow-y: auto;"><div style="color:#aaa">En attente...</div></div>
      </div>
    </div>
  </div>

  <div id="ascensionTab" class="content">
    <div class="card">
      <h3>ğŸš€ ASCENSION - META PRESTIGE</h3>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸš€ Points</div><div class="trade-stat-val" id="ascensionPoints">0</div></div>
        <div class="trade-stat"><div>âš¡ Bonus</div><div class="trade-stat-val">+<span id="ascensionBonus">0</span>%</div></div>
      </div>
      <button class="btn big-btn danger-btn" onclick="doAscension()" style="max-width: 100%; width: 100%;">ğŸš€ ASCENSIONNER!</button>
    </div>
  </div>

  <div id="ngp" class="content">
    <div class="card">
      <h3>ğŸ”„ NEW GAME PLUS - RECOMMENCE AVEC BONUS!</h3>
      <p style="color: #fa0; margin-bottom: 1rem;">RÃ©initialise TOUT mais garde des bonus permanents!</p>
      <div class="trade-stats">
        <div class="trade-stat"><div>ğŸ”„ NGP+ Level</div><div class="trade-stat-val" id="ngpLevelDisplay">0</div></div>
        <div class="trade-stat"><div>âš¡ Bonus</div><div class="trade-stat-val">+<span id="ngpBonusDisplay">0</span>%</div></div>
      </div>
      <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #fa0;border-radius:4px;">
        <p style="color:#fa0;margin:0.5rem 0"><strong>âš ï¸ NGP+ va:</strong></p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les gÃ©nÃ©rateurs</p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les upgrades</p>
        <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser coins, Ã©toiles, prestige</p>
        <p style="color:#0f0;font-size:0.9rem;margin:0.5rem 0">âœ… Garder Galaxies et Ascension</p>
        <p style="color:#0f0;font-size:0.9rem;margin:0.5rem 0">âœ… +10% multiplicateur permanent par NGP+</p>
      </div>
      <button class="btn big-btn danger-btn" onclick="doNGP()" style="max-width: 100%; width: 100%;">ğŸ”„ NEW GAME PLUS!</button>
    </div>
  </div>

  <div id="achievements" class="content">
    <div class="card">
      <h3>ğŸ† ACHIEVEMENTS & BADGES</h3>
      <p style="color: #0f0; margin-bottom: 0.5rem;">DÃ©bloque des badges et gagne des rÃ©compenses!</p>
      <p style="color: #fa0; font-size: 0.9rem; margin-bottom: 1rem;">ğŸ’¡ Certains achievements sont SECRETS! ğŸ”’</p>
      <div id="achievementsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;"></div>
    </div>
  </div>

  <div id="milestones" class="content">
    <div class="card">
      <h3>ğŸ¯ MILESTONES - DÃ‰FIS PROGRESSIFS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©bloque des dÃ©fis et gagne des rÃ©compenses!</p>
      <div id="milestonesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;"></div>
    </div>
  </div>

  <div id="graph" class="content">
    <div class="card">
      <h3>ğŸ“Š GRAPHIQUE DE PROGRESSION</h3>
      <div class="graph-container">
        <canvas id="graphCanvas" width="800" height="300"></canvas>
      </div>
      <div class="card" style="background:#0a0a0a">
        <h4>ğŸ“ˆ Info</h4>
        <p style="color:#aaa;font-size:0.9rem">Production: <span id="graphCPS">0</span> ğŸ’°/sec | Max: <span id="graphMax">0</span> ğŸ’°/sec</p>
      </div>
    </div>
  </div>

  <div id="stats" class="content">
    <div class="card">
      <h3>ğŸ“ˆ STATISTIQUES</h3>
      <div class="item"><span>Total PiÃ¨ces</span><span id="totalCoins">0</span></div>
      <div class="item"><span>Total Clics</span><span id="totalClicks">0</span></div>
      <div class="item"><span>Temps Jeu</span><span id="playTime">0s</span></div>
      <div class="item"><span>Prestige</span><span id="presCount">0</span></div>
    </div>
  </div>

  <div id="params" class="content">
    <div class="card">
      <h3>âš™ï¸ PARAMÃˆTRES</h3>
      <div class="item" style="border-left:3px solid #0f0;padding:1rem">
        <div><strong>ğŸ’¾ Sauvegarder</strong><br><span style="color:#aaa;font-size:0.9rem">TÃ©lÃ©charge ta progression</span></div>
        <button class="btn" id="downloadBtn">ğŸ“¥ TÃ‰LÃ‰CHARGER</button>
      </div>
      <div class="item" style="border-left:3px solid #0af;padding:1rem">
        <div><strong>ğŸ“‚ Charger</strong><br><span style="color:#aaa;font-size:0.9rem">Importe une sauvegarde</span></div>
        <button class="btn" id="uploadBtn">ğŸ“¤ IMPORTER</button>
      </div>
      <div class="item" style="border-left:3px solid #fa0;padding:1rem">
        <div><strong>ğŸ—‘ï¸ RÃ©initialiser</strong><br><span style="color:#aaa;font-size:0.9rem">Recommence Ã  zÃ©ro</span></div>
        <button class="btn danger-btn" id="resetBtn">ğŸ”„ RESET</button>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" style="display:none" accept=".json">

<div id="tutorialModal">
  <div class="tut-box">
    <h1>ğŸ“– TUTORIEL COMPLET</h1>
    <div id="tutText" style="min-height:400px;line-height:1.8;margin:1rem 0;color:#aaa"></div>
    <div class="tut-btns">
      <button class="btn" id="prevBtn">â† PRÃ‰CÃ‰DENT</button>
      <button class="btn" onclick="document.getElementById('tutorialModal').style.display='none'">FERMER</button>
      <button class="btn" id="nextBtn">SUIVANT â†’</button>
    </div>
    <p style="text-align:center;color:#aaa;font-size:0.85rem">Page <span id="tutPage">1</span>/18</p>
  </div>
</div>

<div id="changelogsModal" style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.98);z-index: 9999;padding: 1rem;overflow-y: auto;display: none;">
  <div class="tut-box">
    <h1>ğŸ“ CHANGELOGS</h1>
    <div id="changelogsContent" style="min-height:300px;line-height:1.8;margin:1rem 0;max-height:600px;overflow-y:auto;"></div>
    <div class="tut-btns">
      <button class="btn" onclick="document.getElementById('changelogsModal').style.display='none'">FERMER</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
const FPS = 10;
const SAVE_KEY = "incremental_v3_final";
let tutPage = 0;
let cache = { prod: 0, clickVal: 0, starsMultiplier: 1, galaxiesMultiplier: 1, ascensionMultiplier: 1, lastUpdate: 0, isDirty: true };
function invalidateCache() { cache.isDirty = true; }

const CHANGELOGS = [
  {
    version: "v3 FINAL",
    date: "Nov 03, 2025",
    title: "NEW GAME PLUS + GÃ‰NÃ‰RATEURS BUFF + 20+ ACHIEVEMENTS",
    changes: [
      "âœ¨ NEW GAME PLUS FONCTIONNEL! RÃ©initialisez avec +10% bonus!",
      "âœ¨ GÃ©nÃ©rateurs: +50-100% de gains (Usine 1.5â†’3, Labo 15â†’30, Satellite 100â†’200)",
      "âœ¨ 15 ACHIEVEMENTS RÃ‰GULIERS + 5 SECRETS = 20 total!",
      "âœ¨ 50 MILESTONES progressifs avec rÃ©compenses Ã©normes",
      "âœ¨ Trading volatilitÃ© rÃ©aliste + Graphique live + Achievements secrets",
      "âœ¨ Tutoriel 18 pages complet avec NGP+"
    ]
  },
  {
    version: "v3 ENHANCED",
    date: "Nov 03, 2025",
    title: "TRADING VOLATILITÃ‰ + SECRETS + GRAPHIQUE",
    changes: [
      "âœ¨ TRADING RÃ‰ALISTE avec volatilitÃ© Â±5-75%",
      "âœ¨ 5 ACHIEVEMENTS SECRETS cachÃ©s",
      "âœ¨ GRAPHIQUE DE PROGRESSION en temps rÃ©el"
    ]
  }
];

const TUTORIAL = [
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ® PAGE 1: BIENVENUE v3 FINAL!</h2>
    <p style="margin: 0.5rem 0; color: #aaa;">Bienvenue dans INCREMENTAL TRADE ULTIMATE v3 FINAL!</p>
    <p style="margin: 0.5rem 0; color: #aaa;"><strong>NEW GAME PLUS, GÃ©nÃ©rateurs buffÃ©s, 20 achievements!</strong></p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ–±ï¸ PAGE 2: LE CLIC</h2>
    <p>COMMENCE ICI! Clique jusqu'Ã  50 piÃ¨ces, puis achÃ¨te des Robots!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¤– PAGE 3: GÃ‰NÃ‰RATEURS BUFFÃ‰S</h2>
    <p><strong>Les gains ont augmentÃ©!</strong></p>
    <p>Robot: 1/sec | Usine: 3/sec | Port: 8/sec | Labo: 30/sec | Satellite: 200/sec</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">âš¡ PAGE 4: UPGRADES</h2>
    <p>Multiplicateurs! Clic +50%, Robot Ã—2, etc.</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">â­ PAGE 5: PRESTIGE</h2>
    <p>50K coins = 1 Ã©toile! +3% multiplicateur!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ€ PAGE 6: GALAXIES</h2>
    <p>500 Ã©toiles = 1 Galaxie! +1% multiplicateur PERMANENT!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ’¸ PAGE 7: TRADING RÃ‰ALISTE</h2>
    <p>MarchÃ© volatile! Les taux changent en temps rÃ©el (Â±5-75%)</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¦ PAGE 8: BANQUE</h2>
    <p>+0.1%/sec SANS RISQUE! Le meilleur investissement!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸš€ PAGE 9: ASCENSION</h2>
    <p>100 Galaxies = Ascension = +5% PERMANENT!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ° PAGE 10: LOTTERIE</h2>
    <p>Achetez des tickets et tentez votre chance!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ† PAGE 11: ACHIEVEMENTS</h2>
    <p>ğŸ”’ 15 RÃ‰GULIERS + 5 SECRETS = 20 TOTAL!</p>
    <p>Les secrets rÃ©vÃ¨lent leur vrai nom quand tu les dÃ©verrouilles!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ™ PAGE 12: DARK MATTER</h2>
    <p>DÃ©bloquÃ© Ã  P10! +5% multiplicateur par unitÃ©!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ“Š PAGE 13: GRAPHIQUE LIVE</h2>
    <p>Vois ta production augmenter en temps rÃ©el!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¯ PAGE 14: 50 MILESTONES</h2>
    <p>DÃ©fis progressifs avec rÃ©compenses Ã©normes!</p>`,
  
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ”„ PAGE 15: NEW GAME PLUS!</h2>
    <p><strong>LA GRANDE NOUVEAUTÃ‰!</strong></p>
    <p>RÃ©initialise TOUT mais +10% multiplicateur PERMANENT!</p>
    <p>Garde Galaxies et Ascension! Peut faire NGP+ infini!</p>`,
  
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ’¡ PAGE 16: MEGA-TIPS</h2>
    <p>âœ… HOLD +1 pour cliquer vite!</p>
    <p>âœ… GÃ©nÃ©rateurs > Upgrades!</p>
    <p>âœ… BANQUE meilleure que Trading!</p>
    <p>âœ… Fais NGP+ rÃ©guliÃ¨rement pour des bonus Ã©normes!</p>`,
  
  `<h2 style="color: #0f0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¯ PAGE 17: PROGRESSION IDÃ‰ALE</h2>
    <p><strong>Phase 1:</strong> Clique â†’ Robots â†’ Prestige</p>
    <p><strong>Phase 2:</strong> 5-10 Prestige â†’ GÃ©nÃ©rateurs</p>
    <p><strong>Phase 3:</strong> 15 Prestige â†’ Galaxies</p>
    <p><strong>Phase 4:</strong> Ascension â†’ NGP+ loop!</p>`,
  
  `<h2 style="color: #0f0; font-size: 2rem; margin-bottom: 1rem;">ğŸš€ PAGE 18: C'EST PARTI!</h2>
    <p>1ï¸âƒ£ Clique 50 fois</p>
    <p>2ï¸âƒ£ AchÃ¨te Robots</p>
    <p>3ï¸âƒ£ GÃ©nÃ¨re 50K et Prestige!</p>
    <p>4ï¸âƒ£ Fais NGP+ pour des bonus Ã‰NORMES!</p>
    <p>5ï¸âƒ£ CONTINUE jusqu'Ã  l'infini! â™¾ï¸</p>
    <p style="color: #fa0; margin-top: 1rem;"><strong>ğŸ’ Tu as TOUT! Bon jeu! ğŸ®âœ¨</strong></p>`
];

function getDefaultAchievements() {
  return [
    { id: "click5", name: "ğŸ–±ï¸ DÃ©butant", desc: "Faire 5 clics", check: () => game.totalClicks >= 5, reward: 100, unlocked: false, secret: false },
    { id: "coins1m", name: "ğŸ’° Millionnaire", desc: "1M coins", check: () => game.totalCoins >= 1e6, reward: 1000, unlocked: false, secret: false },
    { id: "gen10", name: "ğŸ¤– AutomatisÃ©", desc: "10 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=10, reward: 5000, unlocked: false, secret: false },
    { id: "prestige5", name: "âš¡ Prestigieux", desc: "5 Prestige", check: () => game.prestige >= 5, reward: 10000, unlocked: false, secret: false },
    { id: "galaxy1", name: "ğŸŒ€ Cosmique", desc: "1Ã¨re Galaxie", check: () => game.galaxies >= 1, reward: 25000, unlocked: false, secret: false },
    { id: "ascension1", name: "ğŸš€ AscensionnÃ©", desc: "1 Ascension", check: () => game.ascension >= 1, reward: 50000, unlocked: false, secret: false },
    { id: "ngp1", name: "ğŸ”„ Renascence", desc: "1er NGP+", check: () => game.ngpLevel >= 1, reward: 100000, unlocked: false, secret: false },
    { id: "darkm10", name: "ğŸŒ™ Ombrageux", desc: "10 Dark Matter", check: () => game.darkMatter >= 10, reward: 75000, unlocked: false, secret: false },
    { id: "trading100m", name: "ğŸ’¸ Trader", desc: "100M en Trading", check: () => Object.values(game.trades).reduce((a,t)=>a+t.totalGains,0)>=1e8, reward: 50000, unlocked: false, secret: false },
    { id: "bank1b", name: "ğŸ¦ Banquier", desc: "1B Ã  la banque", check: () => game.bankGenerated >= 1e9, reward: 200000, unlocked: false, secret: false },
    { id: "lottery10", name: "ğŸ° Chanceux", desc: "10 tirages", check: () => game.lotteryTickets >= 10, reward: 50000, unlocked: false, secret: false },
    { id: "stars100", name: "â­ Supernova", desc: "100 Ã©toiles", check: () => game.stars >= 100, reward: 150000, unlocked: false, secret: false },
    { id: "gen100", name: "ğŸ¤– Dominateur", desc: "100 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=100, reward: 100000, unlocked: false, secret: false },
    { id: "prestige50", name: "âš¡ LÃ©gende", desc: "50 Prestige", check: () => game.prestige >= 50, reward: 500000, unlocked: false, secret: false },
    { id: "galaxy10", name: "ğŸŒ€ Univers", desc: "10 Galaxies", check: () => game.galaxies >= 10, reward: 300000, unlocked: false, secret: false },
    
    { id: "secret_noclick", name: "ğŸ¤ AscÃ¨te", desc: "???", check: () => game.totalClicks === 0, reward: 50000, unlocked: false, secret: true },
    { id: "secret_lucky", name: "ğŸ€ Miracle", desc: "???", check: () => game.lotteryLog && game.lotteryLog.some(l=>l.includes("GROS")), reward: 100000, unlocked: false, secret: true },
    { id: "secret_ngp10", name: "â™¾ï¸ Infini", desc: "???", check: () => game.ngpLevel >= 10, reward: 500000, unlocked: false, secret: true },
    { id: "secret_rich", name: "ğŸ’ Riche", desc: "???", check: () => game.totalCoins >= 1e18, reward: 1000000, unlocked: false, secret: true },
    { id: "secret_speed", name: "âš¡ Ã‰clair", desc: "???", check: () => game.totalClicks >= 1000 && game.playTime < 300, reward: 200000, unlocked: false, secret: true }
  ];
}

let game = {
  coins: 0, totalCoins: 0, totalClicks: 0, stars: 0, galaxies: 0, prestige: 0, darkMatter: 0, ngpLevel: 0,
  playTime: 0, logs: [], tradeLogs: [],
  
  generators: [
    { id: "r", n: "Robot", b: 1, c: 0, p: 50, m: 1.2, unlock: { type: "none" } },
    { id: "u", n: "Usine", b: 3, c: 0, p: 500, m: 1.2, unlock: { type: "prestige", val: 1 } },
    { id: "po", n: "Port", b: 8, c: 0, p: 5e3, m: 1.2, unlock: { type: "stars", val: 5 } },
    { id: "l", n: "Labo", b: 30, c: 0, p: 50e3, m: 1.2, unlock: { type: "prestige", val: 3 } },
    { id: "s", n: "Satellite", b: 200, c: 0, p: 500e3, m: 1.2, unlock: { type: "galaxies", val: 1 } }
  ],

  upgrades: [
    { id: "c1", n: "Clic +50%", p: 100, e: 1.02, b: 0, t: "c", unlock: { type: "none" } },
    { id: "r1", n: "Robot Ã—2", p: 2e3, e: 2, b: 0, t: "r", unlock: { type: "prestige", val: 1 } },
    { id: "r2", n: "Robot Ã—3", p: 50e3, e: 3, b: 0, t: "r", unlock: { type: "stars", val: 10 } },
    { id: "u1", n: "Usine Ã—2", p: 50e3, e: 2, b: 0, t: "u", unlock: { type: "prestige", val: 2 } },
    { id: "u2", n: "Usine Ã—3", p: 500e3, e: 3, b: 0, t: "u", unlock: { type: "prestige", val: 5 } },
    { id: "po1", n: "Port Ã—2", p: 500e3, e: 2, b: 0, t: "po", unlock: { type: "stars", val: 20 } },
    { id: "l1", n: "Labo Ã—2", p: 5e6, e: 2, b: 0, t: "l", unlock: { type: "prestige", val: 4 } },
    { id: "s1", n: "Satellite Ã—2", p: 50e6, e: 2, b: 0, t: "s", unlock: { type: "galaxies", val: 1 } }
  ],

  trades: { min: { amount: 0, totalGains: 0, totalLosses: 0 }, mid: { amount: 0, totalGains: 0, totalLosses: 0 }, high: { amount: 0, totalGains: 0, totalLosses: 0 } },
  graphData: [], boosts: [], lotteryLog: [], lotteryTickets: 0,
  bankInvested: 0, bankGenerated: 0, ascension: 0, achievements: []
};

game.achievements = getDefaultAchievements();

function $(id) { return document.getElementById(id); }

function fmt(n) {
  if (!isFinite(n) || isNaN(n)) return "âˆ";
  const abbr = [{v:1e33,s:"D"},{v:1e30,s:"No"},{v:1e27,s:"Oc"},{v:1e24,s:"Sp"},{v:1e21,s:"Sx"},{v:1e18,s:"Qi"},{v:1e15,s:"Qa"},{v:1e12,s:"T"},{v:1e9,s:"B"},{v:1e6,s:"M"},{v:1e3,s:"K"}];
  for(let a of abbr) if(n >= a.v) return (n/a.v).toFixed(2).replace(/\.?0+$/,"") + a.s;
  return Math.round(n).toString();
}

function log(msg) { game.logs.unshift(msg); if(game.logs.length > 12) game.logs.pop(); updateLog(); }
function tradeLog(msg, type="info") { game.tradeLogs.unshift({msg,type}); if(game.tradeLogs.length>20) game.tradeLogs.pop(); updateTradeLog(); }
function save() { let now = Date.now(); if(now - lastSaveTime < 5000) return; localStorage.setItem(SAVE_KEY, JSON.stringify(game)); lastSaveTime = now; }
let lastSaveTime = 0;

function load() {
  let data = localStorage.getItem(SAVE_KEY);
  if(data) {
    try {
      let parsed = JSON.parse(data);
      game = {...game, ...parsed};
      if(!Array.isArray(game.generators) || game.generators.length === 0) game.generators = [...game.generators];
      if(!Array.isArray(game.achievements) || game.achievements.length === 0) game.achievements = getDefaultAchievements();
    } catch(e) { console.error("Load error:", e); }
  }
}

function getTradeConfig(type) {
  const baseMarketVolatility = 0.05 + (Math.sin(Date.now() / 5000) * 0.03);
  return {
    min: { baseGain: 0.012, volatility: baseMarketVolatility * 0.5, lossChance: 0.005, lossRate: 0.01 },
    mid: { baseGain: 0.04, volatility: baseMarketVolatility * 1.2, lossChance: 0.03, lossRate: 0.025 },
    high: { baseGain: 0.12, volatility: baseMarketVolatility * 2.5, lossChance: 0.08, lossRate: 0.075, riskAll: 0.001 }
  }[type];
}

function getProd() {
  if(!game.generators || !Array.isArray(game.generators) || game.generators.length === 0) return 0;
  if(!cache.isDirty && cache.lastUpdate === Date.now()/1000|0) return cache.prod;
  
  let total = 0;
  for(let g of game.generators) {
    let e = 1;
    for(let u of game.upgrades) if(u.t === g.id && u.b > 0) e *= Math.pow(u.e, u.b);
    total += g.c * g.b * e;
  }
  
  let sy = 1;
  let r=game.generators[0], us=game.generators[1], p=game.generators[2], l=game.generators[3], s=game.generators[4];
  if(r && us && r.c >= 5 && us.c >= 3) sy *= 1.3;
  if(p && s && p.c >= 3 && s.c >= 2) sy *= 1.4;
  if(l && us && l.c >= 2 && us.c >= 5) sy *= 1.2;

  cache.starsMultiplier = Math.pow(1.03, game.stars);
  cache.galaxiesMultiplier = Math.pow(1.01, game.galaxies);
  cache.ascensionMultiplier = 1 + (game.ascension * 0.05);
  let ngpMult = Math.pow(1.10, game.ngpLevel);

  if(!isFinite(cache.starsMultiplier) || cache.starsMultiplier > 1e100) cache.starsMultiplier = 1e100;
  if(!isFinite(cache.galaxiesMultiplier) || cache.galaxiesMultiplier > 1e100) cache.galaxiesMultiplier = 1e100;
  if(!isFinite(cache.ascensionMultiplier) || cache.ascensionMultiplier > 1e50) cache.ascensionMultiplier = 1e50;
  if(!isFinite(ngpMult) || ngpMult > 1e50) ngpMult = 1e50;

  let result = (total * sy) * cache.starsMultiplier * cache.galaxiesMultiplier * (1 + game.darkMatter * 0.05) * cache.ascensionMultiplier * ngpMult;
  if(!isFinite(result) || result > 1e308) result = 1e308;
  
  cache.prod = result;
  cache.isDirty = false;
  cache.lastUpdate = Date.now()/1000|0;
  return result;
}

function clickVal() {
  let v = 1;
  for(let u of game.upgrades) if(u && u.t === "c" && u.b > 0) v *= Math.pow(u.e, u.b);
  let starsMult = cache.starsMultiplier || 1;
  let galaxiesMult = cache.galaxiesMultiplier || 1;
  let ascensionMult = cache.ascensionMultiplier || 1;
  let ngpMult = Math.pow(1.10, game.ngpLevel || 0);
  let result = v * starsMult * galaxiesMult * (1 + (game.darkMatter || 0) * 0.05) * ascensionMult * ngpMult;
  if(!isFinite(result) || result > 1e308) return 1e308;
  return result;
}

function clickBtn() {
  let v = clickVal();
  game.coins += v;
  game.totalCoins += v;
  game.totalClicks++;
  updateUI();
}

function buyGen(id) {
  let g = game.generators.find(x => x.id === id);
  if(!g) return;
  let cost = g.p * Math.pow(g.m, g.c);
  if(game.coins < cost) return;
  game.coins -= cost;
  g.c++;
  invalidateCache();
  log("âœ… +" + g.n);
  save();
  updateUI();
}

function buyGenMax(id) {
  let g = game.generators.find(x => x.id === id);
  if(!g) return;
  let count = 0;
  while(true) {
    let cost = g.p * Math.pow(g.m, g.c);
    if(game.coins < cost) break;
    game.coins -= cost;
    g.c++;
    count++;
  }
  if(count > 0) {
    invalidateCache();
    log("âœ… +" + count + "x " + g.n);
    save();
    updateUI();
  }
}

function buyUp(id) {
  let u = game.upgrades.find(x => x.id === id);
  if(!u) return;
  let cost = u.p * Math.pow(1.15, u.b);
  if(game.coins < cost) return;
  game.coins -= cost;
  u.b++;
  invalidateCache();
  log("âœ… " + u.n);
  save();
  updateUI();
}

function buyUpMax(id) {
  let u = game.upgrades.find(x => x.id === id);
  if(!u) return;
  let count = 0;
  while(true) {
    let cost = u.p * Math.pow(1.15, u.b);
    if(game.coins < cost) break;
    game.coins -= cost;
    u.b++;
    count++;
  }
  if(count > 0) {
    invalidateCache();
    log("âœ… " + u.n);
    save();
    updateUI();
  }
}

function doPrestige() {
  let baseCost = 50000;
  let prestigeCost = baseCost * Math.pow(1.5, game.prestige);
  if(game.coins < prestigeCost) return;
  game.coins = 0;
  game.totalCoins += prestigeCost;
  game.stars++;
  game.prestige++;
  if(game.prestige >= 10 && game.prestige % 10 === 0) game.darkMatter++;
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  invalidateCache();
  log("â­ +1! (Prestige " + game.prestige + ")");
  save();
  updateUI();
}

function doGalaxy() {
  let cost = 50 + (game.galaxies * 5);
  if(game.stars < cost) return;
  game.stars = 0;
  game.coins = 0;
  game.galaxies++;
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  invalidateCache();
  log("ğŸŒ€ +1!");
  save();
  updateUI();
}

function doAscension() {
  let cost = 100 * Math.pow(2, game.ascension);
  if(game.galaxies < cost) { alert("âŒ Tu as besoin de " + cost + " Galaxies!"); return; }
  if(!confirm("ğŸš€ Ascensionner? Tout se rÃ©initialise sauf les Galaxies!")) return;
  game.galaxies -= cost;
  game.ascension++;
  game.coins = 0;
  game.stars = 0;
  game.prestige = 0;
  game.darkMatter = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  invalidateCache();
  log("ğŸš€ ASCENSION! Bonus: +" + (game.ascension * 5) + "%");
  save();
  updateUI();
}

function doNGP() {
  if(!confirm("ğŸ”„ NEW GAME PLUS? Tout se rÃ©initialise mais +10% bonus permanent!")) return;
  game.ngpLevel++;
  game.coins = 0;
  game.stars = 0;
  game.prestige = 0;
  game.darkMatter = 0;
  game.trades.min = {amount:0,totalGains:0,totalLosses:0};
  game.trades.mid = {amount:0,totalGains:0,totalLosses:0};
  game.trades.high = {amount:0,totalGains:0,totalLosses:0};
  for(let gen of game.generators) gen.c = 0;
  for(let u of game.upgrades) u.b = 0;
  invalidateCache();
  log("ğŸ”„ NEW GAME PLUS #" + game.ngpLevel + "! Bonus: +" + (game.ngpLevel * 10) + "%");
  save();
  updateUI();
}

function investTrade(type) {
  let input = $(`${type}Input`);
  let amount = parseFloat(input.value);
  if(!amount || amount <= 0 || game.coins < amount) { alert("âŒ Montant invalide!"); return; }
  game.coins -= amount;
  game.trades[type].amount += amount;
  input.value = "";
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)}`);
  log(`ğŸ“¤ Trade ${type}: +${fmt(amount)}`);
  save();
  updateUI();
}

function investTrade50(type) {
  let amount = game.coins * 0.5;
  if(amount <= 0) return;
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)} (50%)`);
  save();
  updateUI();
}

function investTradeAll(type) {
  let amount = game.coins;
  if(amount <= 0) return;
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ ${type}: +${fmt(amount)} (TOUT)`);
  save();
  updateUI();
}

function withdrawTrade(type) {
  let trade = game.trades[type];
  if(trade.amount <= 0) return;
  game.coins += trade.amount;
  game.totalCoins += trade.amount;
  tradeLog(`ğŸ“¥ ${type}: +${fmt(trade.amount)}`, "gain");
  trade.amount = 0;
  trade.totalGains = 0;
  trade.totalLosses = 0;
  save();
  updateUI();
}

function processTradeGains() {
  for(let type of ["min","mid","high"]) {
    let trade = game.trades[type];
    if(!trade || trade.amount <= 0) continue;
    let config = getTradeConfig(type);
    let volatilityFactor = 1 + (Math.random() - 0.5) * config.volatility;
    let actualGain = config.baseGain * volatilityFactor;
    let gain = trade.amount * actualGain / 60;
    trade.amount += gain;
    trade.totalGains += gain;
    let rand = Math.random();
    if(type === "high" && rand < config.riskAll) {
      tradeLog("ğŸ’¥ TOUT PERDU!", "loss");
      trade.amount = 0;
      trade.totalGains = 0;
      trade.totalLosses = 0;
    } else if(rand < config.lossChance) {
      let loss = trade.amount * config.lossRate;
      trade.amount = Math.max(0, trade.amount - loss);
      trade.totalLosses += loss;
      tradeLog(`ğŸ“‰ ${type}: -${fmt(loss)}`, "loss");
    }
  }
  save();
}

function depositBank() {
  let amount = parseFloat($("bankInput").value);
  if(!amount || amount <= 0 || game.coins < amount) return;
  game.coins -= amount;
  game.bankInvested += amount;
  $("bankInput").value = "";
  log("ğŸ¦ DÃ©pÃ´t: +" + fmt(amount));
  save();
  updateUI();
}

function withdrawBank() {
  if(game.bankInvested <= 0) return;
  game.coins += game.bankInvested;
  game.totalCoins += game.bankInvested;
  log("ğŸ¦ Retrait: +" + fmt(game.bankInvested));
  game.bankInvested = 0;
  game.bankGenerated = 0;
  save();
  updateUI();
}

function buyLotteryTicket(count) {
  let cost = 100 * count;
  if(game.coins < cost) return;
  game.coins -= cost;
  game.lotteryTickets += count;
  log("ğŸ° +" + count + " tickets");
  save();
  updateUI();
}

function playLottery() {
  if(game.lotteryTickets <= 0) return;
  game.lotteryTickets--;
  let rand = Math.random();
  let gain = 0, result = "";
  if(rand < 0.50) { gain = 50 + Math.floor(Math.random() * 50); result = "ğŸŸ¢ Petit: +" + gain; }
  else if(rand < 0.75) { gain = 500 + Math.floor(Math.random() * 500); result = "ğŸŸ¡ Moyen: +" + gain; }
  else { gain = 5000 + Math.floor(Math.random() * 5000); result = "ğŸ”´ GROS LOT: +" + gain + "! ğŸ‰"; }
  game.coins += gain;
  game.totalCoins += gain;
  game.lotteryLog.unshift(result);
  if(game.lotteryLog.length > 15) game.lotteryLog.pop();
  log(result);
  save();
  updateUI();
}

function checkAchievements() {
  for(let ach of game.achievements) {
    if(!ach.unlocked && ach.check && typeof ach.check === 'function' && ach.check()) {
      ach.unlocked = true;
      if(ach.secret) log("ğŸ”“ SECRET: " + ach.name);
      else log("ğŸ† " + ach.name);
      game.coins += ach.reward;
      game.totalCoins += ach.reward;
      save();
    }
  }
}

function updateTradeLog() {
  let html = "";
  for(let entry of game.tradeLogs) html += `<div class="trade-log-event ${entry.type || "info"}">${entry.msg}</div>`;
  $("tradeLog").innerHTML = html || "<div class='trade-log-event'>Attente...</div>";
}

function updateLog() {
  let html = "";
  for(let l of game.logs) html += `<div>${l}</div>`;
  $("log").innerHTML = html;
}

function updateMarketStatus() {
  const sine = Math.sin(Date.now() / 3000);
  const volatility = (0.05 + (Math.sin(Date.now() / 5000) * 0.03)) * 100;
  let status, emoji;
  if(sine > 0.3) { status = "ğŸ“ˆ HAUT"; emoji = "market-up"; }
  else if(sine < -0.3) { status = "ğŸ“‰ BAS"; emoji = "market-down"; }
  else { status = "ğŸ“Š NEUTRE"; emoji = "market-neutral"; }
  let el = $("marketStatus");
  if(el) { el.textContent = status; el.className = "market-status " + emoji; }
  let volEl = $("marketVolatility");
  if(volEl) volEl.textContent = volatility.toFixed(1) + "%";
}

function updateGraph() {
  game.graphData.push({ time: game.playTime, cps: getProd() });
  if(game.graphData.length > 300) game.graphData.shift();
  drawGraph();
}

function drawGraph() {
  const canvas = $("graphCanvas");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = "#0af";
  ctx.lineWidth = 2;
  ctx.strokeRect(0, 0, canvas.width, canvas.height);
  if(game.graphData.length < 2) return;
  let maxCPS = Math.max(...game.graphData.map(d => d.cps)) || 1;
  ctx.strokeStyle = "#0f0";
  ctx.lineWidth = 3;
  ctx.beginPath();
  for(let i = 0; i < game.graphData.length; i++) {
    let x = (i / (game.graphData.length - 1)) * canvas.width;
    let ratio = (game.graphData[i].cps) / maxCPS;
    let y = canvas.height - (ratio * canvas.height * 0.9) - 10;
    if(i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.fillStyle = "#aaa";
  ctx.font = "14px Arial";
  ctx.fillText("Max: " + fmt(maxCPS) + "/s", 10, 25);
}

function updateUI() {
  let p = getProd();
  $("coins").textContent = fmt(game.coins);
  $("cps").textContent = fmt(p);
  $("stars").textContent = game.stars;
  $("galaxies").textContent = game.galaxies;
  $("dm").textContent = game.darkMatter;
  $("ngpLevel").textContent = game.ngpLevel;
  $("tradeBlocked").textContent = fmt(game.trades.min.amount + game.trades.mid.amount + game.trades.high.amount);
  $("clickVal").textContent = fmt(clickVal());
  let baseCost = 50000;
  let nextPrestigeCost = baseCost * Math.pow(1.5, game.prestige);
  $("prestigeCost").textContent = fmt(nextPrestigeCost);
  $("prestigeCount").textContent = game.coins >= nextPrestigeCost ? "âœ…" : "âŒ";
  $("galaxyCost").textContent = fmt(50 + (game.galaxies * 5));
  $("totalCoins").textContent = fmt(game.totalCoins);
  $("totalClicks").textContent = game.totalClicks;
  $("playTime").textContent = game.playTime + "s";
  $("presCount").textContent = game.prestige;
  $("ascension").textContent = game.ascension || 0;
  $("ascensionBonus").textContent = (game.ascension || 0) * 5;
  $("ngpLevelDisplay").textContent = game.ngpLevel || 0;
  $("ngpBonusDisplay").textContent = (game.ngpLevel || 0) * 10;
  $("bankInvested").textContent = fmt(game.bankInvested || 0);
  let bankGains = ((game.bankInvested || 0) * 0.001) / FPS;
  $("bankGains").textContent = fmt(bankGains);
  $("bankGenerated").textContent = fmt(game.bankGenerated || 0);
  $("lotteryTickets").textContent = game.lotteryTickets || 0;
  
  let lotteryHtml = "";
  if(game.lotteryLog) {
    for(let log of game.lotteryLog) lotteryHtml += `<div style="padding:0.3rem;color:#aaa">${log}</div>`;
  }
  if($("lotteryLog")) $("lotteryLog").innerHTML = lotteryHtml || "<div style='color:#aaa'>Attente...</div>";
  
  let achCount = game.achievements ? game.achievements.filter(a => a.unlocked).length : 0;
  $("achievementCount").textContent = achCount;
  
  let achHtml = "";
  if(game.achievements) {
    for(let ach of game.achievements) {
      let achDiv;
      if(ach.secret && !ach.unlocked) {
        achDiv = `<div style="background:#0a0a0a;padding:1rem;border-radius:4px;border-left:3px solid #666"><div style="color:#999">ğŸ”’ SECRET</div><div style="color:#666">???</div></div>`;
      } else {
        achDiv = ach.unlocked ? 
          `<div style="background:#0a0a2a;padding:1rem;border-radius:4px;border-left:3px solid #0f0"><div style="color:#0f0;font-weight:bold">${ach.name}</div><div style="color:#aaa">${ach.desc}</div></div>` :
          `<div style="background:#0a0a0a;padding:1rem;border-radius:4px;border-left:3px solid #666;opacity:0.5"><div style="color:#aaa">${ach.name}</div><div style="color:#666">${ach.desc}</div></div>`;
      }
      achHtml += achDiv;
    }
  }
  if($("achievementsList")) $("achievementsList").innerHTML = achHtml;
  
  checkAchievements();
  
  for(let type of ["min","mid","high"]) {
    let trade = game.trades[type];
    let config = getTradeConfig(type);
    let gain = trade.amount * config.baseGain;
    $(`${type}Amount`).textContent = fmt(trade.amount);
    $(`${type}Gain`).textContent = fmt(gain);
    $(`${type}Loss`).textContent = fmt(trade.amount * config.lossRate);
  }
  
  let genHtml = "";
  for(let g of game.generators) {
    let cost = g.p * Math.pow(g.m, g.c);
    let upgMultiplier = 1;
    for(let u of game.upgrades) if(u.t === g.id && u.b) upgMultiplier *= u.e;
    let gainPerSec = g.c * g.b * upgMultiplier * Math.pow(1.25, game.stars) * Math.pow(1.6, game.galaxies) * (1 + game.darkMatter * 0.05);
    genHtml += `<div class="item"><strong>${g.n}</strong> Ã—${g.c} <span style="color:#0f0">(${fmt(gainPerSec)}/s)</span><button class="btn" onclick="buyGen('${g.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyGenMax('${g.id}')">MAX</button></div>`;
  }
  $("gensList").innerHTML = genHtml;
  
  let upHtml = "";
  for(let u of game.upgrades) {
    let cost = u.p * Math.pow(1.15, u.b);
    upHtml += `<div class="item"><strong>${u.n}</strong> Ã—${u.e} <span style="color:#0f0">(Lvl ${u.b})</span><button class="btn" onclick="buyUp('${u.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyUpMax('${u.id}')">MAX</button></div>`;
  }
  $("upsList").innerHTML = upHtml;
  
  $("graphCPS").textContent = fmt(getProd());
  let maxCPS = Math.max(...(game.graphData.map(d => d.cps) || [0]));
  $("graphMax").textContent = fmt(maxCPS);
  
  save();
}

function showTutorial() {
  $("tutorialModal").style.display = "block";
  tutPage = 0;
  updateTutorial();
}

function updateTutorial() {
  $("tutText").innerHTML = TUTORIAL[tutPage] || "<p>Page non trouvÃ©e</p>";
  $("tutPage").textContent = tutPage + 1;
}

function showChangelogs() {
  $("changelogsModal").style.display = "block";
  let html = `<div style="color:#0af">`;
  for(let log of CHANGELOGS) {
    html += `<div style="background:#0a0a2a;padding:1.5rem;margin-bottom:1rem;border-left:4px solid #0af;border-radius:6px">
      <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem">
        <div style="color:#0f0;font-weight:bold">${log.version}</div>
        <div style="color:#fa0">${log.date}</div>
      </div>
      <div style="color:#0af;margin-bottom:0.8rem;font-weight:bold">${log.title}</div>`;
    for(let change of log.changes) html += `<div style="color:#aaa;margin:0.4rem 0">â€¢ ${change}</div>`;
    html += `</div>`;
  }
  html += `</div>`;
  $("changelogsContent").innerHTML = html;
}

document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".content").forEach(x => x.classList.remove("active"));
      this.classList.add("active");
      let tab = $(this.dataset.tab);
      if(tab) tab.classList.add("active");
    });
  });
  
  $("clickBtn").addEventListener("click", clickBtn);
  $("prestigeBtn").addEventListener("click", doPrestige);
  $("galaxyBtn").addEventListener("click", doGalaxy);
  $("downloadBtn").addEventListener("click", () => {
    let data = JSON.stringify(game, null, 2);
    let blob = new Blob([data], {type:"application/json"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "save_" + Date.now() + ".json";
    a.click();
  });
  $("uploadBtn").addEventListener("click", () => $("fileInput").click());
  $("fileInput").addEventListener("change", e => {
    let file = e.target.files[0];
    if(!file) return;
    let reader = new FileReader();
    reader.onload = f => {
      try {
        game = JSON.parse(f.target.result);
        save();
        updateUI();
        log("ğŸ“‚ ChargÃ©!");
      } catch(err) { alert("âŒ Erreur"); }
    };
    reader.readAsText(file);
  });
  $("resetBtn").addEventListener("click", () => {
    if(!confirm("VRAIMENT?")) return;
    game = { coins: 0, totalCoins: 0, totalClicks: 0, stars: 0, galaxies: 0, prestige: 0, darkMatter: 0, ngpLevel: 0, playTime: 0, logs: [], tradeLogs: [],
      generators: [{ id: "r", n: "Robot", b: 1, c: 0, p: 50, m: 1.2, unlock: {type:"none"}}, {id:"u",n:"Usine",b:3,c:0,p:500,m:1.2,unlock:{type:"prestige",val:1}}, {id:"po",n:"Port",b:8,c:0,p:5e3,m:1.2,unlock:{type:"stars",val:5}}, {id:"l",n:"Labo",b:30,c:0,p:50e3,m:1.2,unlock:{type:"prestige",val:3}}, {id:"s",n:"Satellite",b:200,c:0,p:500e3,m:1.2,unlock:{type:"galaxies",val:1}}],
      upgrades: [{id:"c1",n:"Clic +50%",p:100,e:1.02,b:0,t:"c",unlock:{type:"none"}}, {id:"r1",n:"Robot Ã—2",p:2e3,e:2,b:0,t:"r",unlock:{type:"prestige",val:1}}, {id:"r2",n:"Robot Ã—3",p:50e3,e:3,b:0,t:"r",unlock:{type:"stars",val:10}}, {id:"u1",n:"Usine Ã—2",p:50e3,e:2,b:0,t:"u",unlock:{type:"prestige",val:2}}, {id:"u2",n:"Usine Ã—3",p:500e3,e:3,b:0,t:"u",unlock:{type:"prestige",val:5}}, {id:"po1",n:"Port Ã—2",p:500e3,e:2,b:0,t:"po",unlock:{type:"stars",val:20}}, {id:"l1",n:"Labo Ã—2",p:5e6,e:2,b:0,t:"l",unlock:{type:"prestige",val:4}}, {id:"s1",n:"Satellite Ã—2",p:50e6,e:2,b:0,t:"s",unlock:{type:"galaxies",val:1}}],
      trades: {min:{amount:0,totalGains:0,totalLosses:0}, mid:{amount:0,totalGains:0,totalLosses:0}, high:{amount:0,totalGains:0,totalLosses:0}},
      graphData:[], boosts:[], lotteryLog:[], lotteryTickets:0, bankInvested:0, bankGenerated:0, ascension:0, achievements: getDefaultAchievements()
    };
    localStorage.removeItem(SAVE_KEY);
    updateUI();
  });
  $("nextBtn").addEventListener("click", () => { if(tutPage < 17) { tutPage++; updateTutorial(); } });
  $("prevBtn").addEventListener("click", () => { if(tutPage > 0) { tutPage--; updateTutorial(); } });
  
  load();
  updateUI();
  log("Bienvenue v3 FINAL!");
  updateTradeLog();
  
  let lastUIUpdate = 0;
  function gameLoop(currentTime) {
    let p = getProd();
    game.coins += p / FPS;
    game.totalCoins += p / FPS;
    if(game.bankInvested > 0) {
      let bankGains = (game.bankInvested * 0.001) / FPS;
      game.bankInvested += bankGains;
      game.bankGenerated += bankGains;
    }
    processTradeGains();
    updateMarketStatus();
    if(currentTime - lastUIUpdate >= 100) {
      updateUI();
      lastUIUpdate = currentTime;
    }
    requestAnimationFrame(gameLoop);
  }
  requestAnimationFrame(gameLoop);
  
  setInterval(() => {
    game.playTime++;
    updateGraph();
  }, 1000);
  
  updateMarketStatus();
});
</script>

</body>
</html>