<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-text-size-adjust:none}
  body{font-family:system-ui,Arial;background:#0a0a0a;color:#eee;display:flex;flex-direction:column;align-items:center;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;padding:1rem}
  
  button{padding:.6rem 1.2rem;font-size:1rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  button:hover:not(:disabled){background:#0cf;transform:scale(1.05)}
  button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
  button:active{transform:scale(0.95)}
  
  .container{width:100%;max-width:1400px}
  .tab-nav{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;justify-content:center}
  .tab-btn{padding:0.5rem 1rem;font-size:1rem;background:#333;color:#aaa;border:2px solid transparent;border-radius:6px;cursor:pointer}
  .tab-btn.active{background:#0af;color:#fff;border-color:#0af}
  .tab-content{display:none}
  .tab-content.active{display:block}
  
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%}
  .card{background:#1a1a1a;padding:1rem;border-radius:8px;flex:1 1 280px;margin:.5rem;box-shadow:0 4px 6px rgba(0,0,0,0.5);border-left:4px solid #0af}
  .card h3{margin-top:0;color:#0af;border-bottom:2px solid #0af;padding-bottom:.5rem;margin-bottom:1rem;font-size:1.1rem}
  
  .header{text-align:center;margin-bottom:2rem}
  .header h1{font-size:2rem;color:#0af;margin-bottom:0.5rem;text-shadow:0 0 20px rgba(0,170,255,0.5)}
  .header-stats{display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap;font-size:1rem}
  .stat-block{background:#222;padding:0.8rem;border-radius:6px;min-width:120px;text-align:center}
  .stat-value{color:#0f0;font-weight:bold;font-size:1.2rem}
  
  #log{background:#111;padding:.6rem;border-radius:8px;margin:1rem 0;max-width:100%;border-left:4px solid #0af;max-height:100px;overflow-y:auto;font-size:0.85rem}
  .log-message{padding:.2rem 0;animation:fadeIn 0.3s}
  .log-success{color:#0f0}.log-unlock{color:#0af}.log-event{color:#ffa}.log-warning{color:#f55}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  
  .gen-item,.up-item{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0;padding:.4rem;background:#222;border-radius:4px;gap:0.3rem;flex-wrap:wrap}
  .stat-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #333;font-size:0.95rem}
  
  #clickBtn{font-size:1.3rem;padding:1rem 2rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1rem;width:90%;max-width:400px}
  .price{color:#ffa}.count{color:#0f0;font-weight:bold}
  .progress-bar{background:#333;height:15px;border-radius:8px;overflow:hidden;margin:.3rem 0}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf);height:100%;transition:width 0.1s}
  .buy-btn{padding:.4rem .8rem;font-size:0.9rem}
  
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:0}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;max-width:600px;max-height:80vh;overflow-y:auto;border:3px solid #0af}
  .modal-content h2{color:#0af;margin-bottom:1rem;font-size:1.8rem}
  .modal-content p{margin:0.8rem 0;line-height:1.6;font-size:1.05rem}
  .modal-content button{width:100%;margin-top:1rem;padding:0.8rem}
  
  #upgradeClickSection{position:sticky;top:0;background:#0a0a0a;padding:1rem;margin:-1rem -1rem 1rem -1rem;border-bottom:3px solid #0af;border-radius:0}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ’° INCREMENTAL TRADE ULTIMATE ğŸ’°</h1>
    <div class="header-stats">
      <div class="stat-block"><div>PiÃ¨ces</div><div class="stat-value" id="coins">0</div></div>
      <div class="stat-block"><div>PiÃ¨ces/sec</div><div class="stat-value" id="cps">0</div></div>
      <div class="stat-block"><div>â­ Ã‰toiles</div><div class="stat-value" id="stars">0</div></div>
      <div class="stat-block"><div>ğŸŒ€ Galaxies</div><div class="stat-value" id="galaxies">0</div></div>
      <div class="stat-block"><div>Prestige</div><div class="stat-value" id="prestigeCount">0</div></div>
    </div>
  </div>

  <div id="log"></div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('main')">ğŸ® MAIN</button>
    <button class="tab-btn" onclick="switchTab('prestige')">â­ PRESTIGE</button>
    <button class="tab-btn" onclick="switchTab('trading')">ğŸ“Š TRADING</button>
    <button class="tab-btn" onclick="switchTab('milestones')">ğŸ¯ MILESTONES</button>
    <button class="tab-btn" onclick="switchTab('challenges')">âš”ï¸ CHALLENGES</button>
    <button class="tab-btn" onclick="switchTab('skills')">ğŸŒ³ SKILLS</button>
    <button class="tab-btn" onclick="switchTab('stats')">ğŸ“ˆ STATS</button>
    <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ PARAMÃˆTRES</button>
  </div>

  <!-- MAIN TAB -->
  <div id="main" class="tab-content active">
    <button id="clickBtn" style="font-size:1.3rem;padding:1rem 2rem">ğŸ‘† Clic +<span id="clickValue">1</span></button>
    
    <div id="upgradeClickSection" class="card">
      <h3>âš¡ Upgrade Clics (Toujours visible)</h3>
      <div id="clickUpgrades"></div>
    </div>

    <div class="row">
      <div class="card">
        <h3>ğŸ¤– GÃ©nÃ©rateurs</h3>
        <div id="gens"></div>
      </div>
      
      <div class="card">
        <h3>âš¡ Autres Upgrades</h3>
        <div id="ups"></div>
      </div>
      
      <div class="card">
        <h3>âœ¨ Shop Ã‰toiles</h3>
        <div>Ã‰toiles: <span class="count" id="starsAvailable">0</span> â­</div>
        <div id="starShop"></div>
      </div>
    </div>
  </div>

  <!-- PRESTIGE TAB -->
  <div id="prestige" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>â­ Prestige Standard</h3>
        <div class="stat-line"><span>Ã‰toiles GagnÃ©es</span><span class="count" id="prestigeGain">0</span></div>
        <div class="stat-line"><span>CoÃ»t</span><span class="price">10,000</span> ğŸ’°</div>
        <div class="progress-bar"><div class="progress-fill" id="prestigeProgress" style="width:0%"></div></div>
        <button onclick="prestige()" id="prestigeBtn" disabled>Prestige +<span id="prestigeGainDisplay">0</span> â­</button>
        <button onclick="prestigeMax()" id="prestigeMaxBtn" disabled>MAX</button>
      </div>

      <div class="card">
        <h3>ğŸŒ€ Super Prestige (Galaxies)</h3>
        <div id="galaxyInfo"></div>
        <button onclick="superPrestige()" id="superPrestigeBtn" disabled>Super Prestige</button>
      </div>
    </div>
  </div>

  <!-- TRADING TAB -->
  <div id="trading" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ“Š MarchÃ©s Trading</h3>
        <div id="tradeContent"></div>
      </div>
    </div>
  </div>

  <!-- MILESTONES TAB -->
  <div id="milestones" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸ¯ Objectifs Milestones</h3>
        <div id="milestonesContent"></div>
      </div>
    </div>
  </div>

  <!-- CHALLENGES TAB -->
  <div id="challenges" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>âš”ï¸ Challenges de Prestige</h3>
        <button onclick="resetAllChallenges()" style="background:#f55">ğŸ”„ Reset Challenges</button>
        <div id="challengesContent" style="margin-top:1rem"></div>
      </div>
    </div>
  </div>

  <!-- SKILLS TAB -->
  <div id="skills" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>ğŸŒ³ Arbre de CompÃ©tences</h3>
        <div class="stat-line"><span>Points Disponibles</span><span class="count" id="skillPoints">0</span></div>
        <div id="skillTree"></div>
      </div>
    </div>
  </div>

  <!-- STATS TAB -->
  <div id="stats" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>ğŸ“Š Statistiques</h3>
        <div class="stat-line"><span>Total PiÃ¨ces</span><span class="count" id="totalCoins">0</span></div>
        <div class="stat-line"><span>Total Clics</span><span class="count" id="totalClicks">0</span></div>
        <div class="stat-line"><span>Temps de Jeu</span><span class="count" id="playTime">0s</span></div>
        <div class="stat-line"><span>Prestiges</span><span class="count" id="prestigeCountStat">0</span></div>
      </div>

      <div class="card">
        <h3>ğŸ† Achievements</h3>
        <div style="font-size:0.9rem;margin-bottom:0.5rem">
          <span class="count" id="achievementCount">0</span> / <span id="achievementTotal">0</span>
        </div>
        <div id="achievements" style="max-height:250px;overflow-y:auto;font-size:0.85rem"></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="settings" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>ğŸ’¾ Sauvegarde & Reset</h3>
        <button onclick="exportSave()">ğŸ“¤ Exporter</button>
        <button onclick="importSave()">ğŸ“¥ Importer</button>
        <button onclick="resetGame()" style="background:#c33;margin-top:1rem">ğŸ—‘ï¸ RESET COMPLET</button>
        <input id="importInput" type="file" accept=".txt" style="display:none">
      </div>

      <div class="card">
        <h3>âš™ï¸ Aide</h3>
        <button onclick="showTutorial()">ğŸ“– Afficher le Tuto</button>
        <button onclick="showHelp()">â“ Comment Jouer</button>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL MODAL -->
<div id="tutorialModal" class="modal" style="display:none">
  <div class="modal-content">
    <h2>ğŸ® Bienvenue dans Incremental Trade!</h2>
    <div id="tutorialContent"></div>
    <button onclick="closeTutorial()">Fermer le Tuto â†’</button>
  </div>
</div>

<script>
const SAVE_KEY = "idleTrade_v8_optimized";
const FPS = 20;
const UPDATE_INTERVAL = 150; // ms - RafraÃ®chir l'UI tous les 150ms au lieu de toujours

let state = {
  coins: 0, totalCoins: 0, stars: 0, galaxies: 0, totalClicks: 0, prestigeCount: 0,
  playTime: 0, difficulty: "normal", skillPoints: 0, maxCoins: 0, maxCps: 0,
  unlockedFeatures: ["basic"], logMessages: [],
  generators: [
    {id:"robot", name:"Robot", base:0.1, count:0, price:15, mult:1.20},
    {id:"usine", name:"Usine", base:0.8, count:0, price:250, mult:1.20, unlock_prestige:5},
    {id:"port", name:"Port", base:1.5, count:0, price:3500, mult:1.20, unlock_prestige:6},
    {id:"labo", name:"Labo", base:5, count:0, price:50000, mult:1.20, unlock_prestige:10},
    {id:"satellite", name:"Satellite", base:20, count:0, price:750000, mult:1.20, unlock_prestige:15},
    {id:"station", name:"Station", base:80, count:0, price:15e6, mult:1.20, unlock_prestige:20},
    {id:"dyson", name:"Dyson", base:300, count:0, price:500e6, mult:1.20, unlock_prestige:25},
    {id:"blackhole", name:"Trou Noir", base:15000, count:0, price:50e9, mult:1.20, unlock:"advanced"},
    {id:"multiverse", name:"Multivers", base:100000, count:0, price:5e12, mult:1.20, unlock:"advanced"},
    {id:"quantum", name:"Simulateur Quantique", base:500000, count:0, price:100e12, mult:1.20, unlock:"endgame"}
  ],
  upgrades: [
    {id:"click1", name:"Clic +50%", price:100, effect:1.5, bought:false, type:"click"},
    {id:"click2", name:"Clic Ã—2", price:500, effect:2, bought:false, type:"click", requires:"click1"},
    {id:"click5", name:"Clic Ã—5", price:25000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"gen2", name:"Gen Ã—2", price:15000, effect:2, bought:false, type:"gen"},
    {id:"robot10", name:"Robot Ã—10", price:5000, effect:10, bought:false, type:"robot"},
    {id:"usine10", name:"Usine Ã—10", price:75000, effect:10, bought:false, type:"usine"},
    {id:"autosave", name:"Sauvegarde auto", price:2000, bought:false, type:"feature"}
  ],
  starUpgrades: [
    {id:"star_prod1", name:"Prod Ã—2", cost:30, bought:false, effect:2, type:"production"},
    {id:"star_click1", name:"Clic Ã—3", cost:50, bought:false, effect:3, type:"starclick"},
    {id:"star_auto1", name:"Auto-clic", cost:200, bought:false, type:"autoclick"}
  ],
  achievements: [
    {id:"first_coin", name:"PremiÃ¨re piÃ¨ce", desc:"Gagner 1 piÃ¨ce", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"100 piÃ¨ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"1000 piÃ¨ces", unlocked:false},
    {id:"million", name:"Ultra-Millionnaire", desc:"1M piÃ¨ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"1er gÃ©nÃ©rateur", unlocked:false},
    {id:"first_prestige", name:"Renaissance", desc:"1er prestige", unlocked:false},
    {id:"ten_gens", name:"Industriel", desc:"10 gÃ©nÃ©rateurs", unlocked:false},
    {id:"first_galaxy", name:"Explorateur", desc:"1Ã¨re Galaxie", unlocked:false},
    {id:"completionist", name:"Perfectionniste", desc:"50 achievements", unlocked:false}
  ]
};

let trade = {
  resources: {
    iron: {amount: 0, price: 10, history: [10], botActive: false},
    gold: {amount: 0, price: 50, history: [50], botActive: false}
  },
  totalTrades: 0, jackpots: 0
};

const $ = id => document.getElementById(id);

function log(txt, type = "normal") {
  const timestamp = new Date().toLocaleTimeString();
  let cssClass = type === "success" ? "log-success" : type === "unlock" ? "log-unlock" : type === "event" ? "log-event" : type === "warning" ? "log-warning" : "";
  state.logMessages.unshift({text: txt, time: timestamp, type: cssClass});
  if (state.logMessages.length > 5) state.logMessages.pop();
  
  // Mettre Ã  jour l'affichage du log immÃ©diatement
  updateLogDisplay();
}

function formatNum(n) {
  if (!isFinite(n)) return "âˆ";
  if (n < 0) return "-" + formatNum(-n);
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  if (n < 1e12) return (n / 1e9).toFixed(2) + "B";
  if (n < 1e15) return (n / 1e12).toFixed(2) + "T";
  return (n / 1e15).toFixed(2) + "Qa";
}

function isUnlocked(feature) {
  if (!feature) return true;
  return state.unlockedFeatures && state.unlockedFeatures.includes(feature);
}

function switchTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  $(tab).classList.add("active");
  event.target.classList.add("active");
}

function price(gen) {
  return Math.floor(gen.price * Math.pow(gen.mult, gen.count));
}

function cps() {
  let total = 0;
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock) || (g.unlock_prestige && state.prestigeCount < g.unlock_prestige)) continue;
    let eff = 1;
    for (let u of state.upgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    for (let u of state.starUpgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    total += g.count * g.base * eff;
  }
  return total * Math.pow(1.2, state.stars) * Math.pow(1.5, state.galaxies);
}

function clickVal() {
  let mult = 1;
  for (let u of state.upgrades) {
    if (u.type === "click" && u.bought) mult *= u.effect;
  }
  for (let u of state.starUpgrades) {
    if (u.type === "starclick" && u.bought) mult *= u.effect;
  }
  return Math.max(1, mult * Math.pow(1.2, state.stars) * Math.pow(1.5, state.galaxies));
}

function clickBtn() {
  let val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  state.maxCoins = Math.max(state.maxCoins, state.coins);
  checkAchievements();
}

function buyGen(genId) {
  for (let g of state.generators) {
    if (g.id === genId) {
      let cost = price(g);
      if (state.coins < cost) return;
      state.coins -= cost;
      g.count++;
      state.totalCoins += cost * 0.1;
      checkAchievements();
      save();
      updateUIPartial();
      return;
    }
  }
}

function buyGenMultiple(genId, qty) {
  for (let i = 0; i < qty; i++) {
    for (let g of state.generators) {
      if (g.id === genId) {
        let cost = price(g);
        if (state.coins < cost) return;
        state.coins -= cost;
        g.count++;
        state.totalCoins += cost * 0.1;
        break;
      }
    }
  }
  checkAchievements();
  save();
  updateUIPartial();
}

function buyUp(upId) {
  for (let u of state.upgrades) {
    if (u.id === upId) {
      if (u.bought || state.coins < u.price) return;
      if (!isUnlocked(u.unlock)) return;
      if (u.requires) {
        let reqMet = state.upgrades.some(uu => uu.id === u.requires && uu.bought);
        if (!reqMet) return;
      }
      state.coins -= u.price;
      u.bought = true;
      log("âœ… " + u.name, "success");
      checkAchievements();
      save();
      updateUIPartial();
      return;
    }
  }
}

function buyStarUpgrade(id) {
  for (let u of state.starUpgrades) {
    if (u.id === id) {
      if (u.bought || state.stars < u.cost) return;
      if (!isUnlocked(u.unlock)) return;
      state.stars -= u.cost;
      u.bought = true;
      log("âœ¨ " + u.name, "success");
      save();
      updateUIPartial();
      return;
    }
  }
}

function prestige() {
  if (state.coins < 1000 || state.totalCoins < 10000) return;
  let gain = Math.floor(state.totalCoins / 10000);
  if (gain < 1) return;
  
  state.coins = 0;
  state.stars += gain;
  state.prestigeCount++;
  state.skillPoints += 3;
  
  for (let g of state.generators) g.count = 0;
  for (let u of state.upgrades) if (u.id !== "autosave") u.bought = false;
  
  log("â­ +" + gain + " Ã©toiles", "success");
  checkAchievements();
  checkUnlocks();
  save();
  updateUI();
}

function superPrestige() {
  let cost = state.galaxies === 0 ? 100 : 100 * Math.pow(10, state.galaxies);
  if (state.coins < 1000 || state.stars < cost) return;
  
  state.stars -= cost;
  state.galaxies++;
  state.skillPoints += 10;
  
  for (let g of state.generators) g.count = 0;
  for (let u of state.upgrades) if (u.id !== "autosave") u.bought = false;
  
  log("ğŸŒ€ +" + 1 + " Galaxie!", "unlock");
  checkAchievements();
  save();
  updateUI();
}

function checkAchievements() {
  const checks = {
    first_coin: () => state.totalCoins >= 1,
    hundred: () => state.coins >= 100,
    thousand: () => state.coins >= 1000,
    million: () => state.coins >= 1e6,
    first_gen: () => state.generators.some(g => g.count > 0),
    first_prestige: () => state.prestigeCount >= 1,
    ten_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 10,
    first_galaxy: () => state.galaxies >= 1,
    completionist: () => state.achievements.filter(a => a.unlocked).length >= 8
  };
  
  for (let a of state.achievements) {
    if (!a.unlocked && checks[a.id]?.()){
      a.unlocked = true;
      log("ğŸ† " + a.name, "success");
    }
  }
}

function checkUnlocks() {
  if (state.prestigeCount >= 5 && !state.unlockedFeatures.includes("midgame")) {
    state.unlockedFeatures.push("midgame");
    log("ğŸ‰ NOUVEAU : Upgrades AvancÃ©s!", "unlock");
  }
  if (state.prestigeCount >= 15 && !state.unlockedFeatures.includes("advanced")) {
    state.unlockedFeatures.push("advanced");
    log("ğŸ‰ NOUVEAU : Contenu AvancÃ©!", "unlock");
  }
}

function resetGame() {
  let confirmed = confirm(`RESET TOTAL?

Tu vas perdre:
- ${formatNum(state.totalCoins)} piÃ¨ces
- ${state.stars} Ã©toiles
- ${state.prestigeCount} prestiges

Clique OK pour confirmer.`);
  
  if (confirmed) {
    try {
      let keys = Object.keys(localStorage);
      for (let key of keys) {
        localStorage.removeItem(key);
      }
      sessionStorage.clear();
      setTimeout(() => {
        location.href = location.href.split('?')[0] + '?nocache=' + Date.now();
      }, 100);
    } catch (e) {
      alert("Erreur reset: " + e.message);
    }
  }
}

function exportSave() {
  try {
    let data = JSON.stringify({state, trade, v: 8});
    let blob = new Blob([data], {type: "text/plain;charset=utf-8"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "save_" + Date.now() + ".txt";
    a.click();
    log("ğŸ“¤ ExportÃ©", "success");
  } catch (e) {
    log("âŒ Erreur export", "event");
  }
}

function importSave() {
  $("importInput").click();
}

function save() {
  try {
    // Utiliser encodeURIComponent pour gÃ©rer les accents
    let data = JSON.stringify({state, trade, v: 8});
    let encoded = encodeURIComponent(data);
    localStorage.setItem(SAVE_KEY, encoded);
  } catch (e) {
    console.error("Save error:", e);
  }
}

function load() {
  try {
    let raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      // DÃ©coder avec decodeURIComponent
      let data = JSON.parse(decodeURIComponent(raw));
      Object.assign(state, data.state);
      Object.assign(trade, data.trade);
      log("ğŸ’¾ ChargÃ©", "success");
    }
  } catch (e) {
    log("âŒ Erreur chargement", "event");
  }
}

function showTutorial() {
  $("tutorialContent").innerHTML = `
    <p><strong>1ï¸âƒ£ LES BASES</strong><br>
    Clique sur le gros bouton bleu! Chaque clic te donne des piÃ¨ces ğŸ’°. C'est ta richesse!
    </p>
    
    <p><strong>2ï¸âƒ£ LES GÃ‰NÃ‰RATEURS</strong><br>
    AchÃ¨te des Robots (0.1 piÃ¨ces/sec), puis Usines, Ports... Ils produisent automatiquement pour toi!
    </p>
    
    <p><strong>3ï¸âƒ£ LES UPGRADES</strong><br>
    Augmente ta puissance avec des upgrades (Clic Ã—2, Gen Ã—3). Chaque upgrade n'existe qu'une fois!
    </p>
    
    <p><strong>4ï¸âƒ£ LE PRESTIGE</strong><br>
    Quand tu as 10,000 piÃ¨ces au total, tu peux faire un Prestige = reset qui te donne â­ Ã‰toiles!
    Avec les Ã©toiles, tu peux acheter des super boosts permanents.
    </p>
    
    <p><strong>5ï¸âƒ£ LES GALAXIES</strong><br>
    AprÃ¨s plusieurs prestiges, dÃ©bloque les Super Prestige (Galaxies) = Ã—1.5 multiplicateur Ã  TOUT!
    </p>
    
    <p><strong>6ï¸âƒ£ CONSEILS</strong><br>
    - Fais des prestiges rÃ©guliers pour gagner des Ã©toiles<br>
    - Les upgrades sont une fois/partie mais permanents<br>
    - DÃ©bloquez des gÃ©nÃ©rateurs en fonction des prestiges<br>
    - Le jeu s'accÃ©lÃ¨re exponentiellement = c'est normal!
    </p>
  `;
  $("tutorialModal").style.display = "flex";
}

function showHelp() {
  showTutorial(); // MÃªme contenu
}

function closeTutorial() {
  $("tutorialModal").style.display = "none";
}

let lastLogUpdate = 0;
let lastLogMessageCount = 0;

function updateLogDisplay() {
  // Mettre Ã  jour le log seulement si y a des nouveaux messages
  if (state.logMessages.length !== lastLogMessageCount) {
    let logHTML = state.logMessages.map(m => `<div class="log-message ${m.type}">[${m.time}] ${m.text}</div>`).join("");
    $("log").innerHTML = logHTML;
    lastLogMessageCount = state.logMessages.length;
  }
}

let lastUIUpdate = 0;

function updateUIPartial() {
  let now = Date.now();
  if (now - lastUIUpdate < UPDATE_INTERVAL) return;
  lastUIUpdate = now;
  updateUI(false); // false = ne pas update le log (on le fait sÃ©parÃ©ment)
}

function updateUI(updateLog = true) {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  $("stars").textContent = state.stars;
  $("galaxies").textContent = state.galaxies;
  $("prestigeCount").textContent = state.prestigeCount;
  $("starsAvailable").textContent = state.stars;
  $("skillPoints").textContent = state.skillPoints;
  
  // Prestige display
  let pGain = Math.floor(state.totalCoins / 10000);
  $("prestigeGain").textContent = pGain;
  $("prestigeGainDisplay").textContent = pGain;
  $("prestigeBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeMaxBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeProgress").style.width = Math.min(100, (state.totalCoins / 10000) * 100) + "%";
  
  // Galaxy
  let galaxyCost = state.galaxies === 0 ? 100 : 100 * Math.pow(10, state.galaxies);
  $("superPrestigeBtn").disabled = state.stars < galaxyCost;
  $("galaxyInfo").innerHTML = `<div style="text-align:center"><div>${state.galaxies} ğŸŒ€</div><div style="font-size:0.9rem">CoÃ»t: ${formatNum(galaxyCost)} â­</div></div>`;
  
  // Generators
  let gensHTML = "";
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock) || (g.unlock_prestige && state.prestigeCount < g.unlock_prestige)) continue;
    let cost = price(g);
    let canBuy = state.coins >= cost;
    gensHTML += `<div class="gen-item">
      <div><strong>${g.name}</strong> <span class="count">Ã—${g.count}</span></div>
      <div style="display:flex;gap:0.2rem">
        <button class="buy-btn" onclick="buyGen('${g.id}')" ${canBuy ? '' : 'disabled'} style="flex:1">${formatNum(cost)}</button>
        <button class="buy-btn" onclick="buyGenMultiple('${g.id}',10)" style="flex:0.5;background:#0cf">Ã—10</button>
      </div>
    </div>`;
  }
  $("gens").innerHTML = gensHTML;
  
  // Click Upgrades (toujours visibles)
  let clickUpsHTML = "";
  for (let u of state.upgrades) {
    if (u.type !== "click" || u.bought) continue;
    if (u.requires) {
      let req = state.upgrades.find(uu => uu.id === u.requires);
      if (!req || !req.bought) continue;
    }
    let canBuy = state.coins >= u.price;
    clickUpsHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong> (${u.effect}x)</div>
      <button class="buy-btn" onclick="buyUp('${u.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(u.price)}</button>
    </div>`;
  }
  $("clickUpgrades").innerHTML = clickUpsHTML || "Tous achetÃ©s!";
  
  // Other Upgrades
  let upsHTML = "";
  for (let u of state.upgrades) {
    if (u.type === "click" || u.bought) continue;
    if (u.requires) {
      let req = state.upgrades.find(uu => uu.id === u.requires);
      if (!req || !req.bought) continue;
    }
    let canBuy = state.coins >= u.price;
    upsHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyUp('${u.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(u.price)}</button>
    </div>`;
  }
  $("ups").innerHTML = upsHTML || "Tous achetÃ©s!";
  
  // Star Upgrades
  let starHTML = "";
  for (let u of state.starUpgrades) {
    if (u.bought) continue;
    let canBuy = state.stars >= u.cost;
    starHTML += `<div class="gen-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyStarUpgrade('${u.id}')" ${canBuy ? '' : 'disabled'}>${u.cost}â­</button>
    </div>`;
  }
  $("starShop").innerHTML = starHTML || "Tous achetÃ©s!";
  
  // LOG - mettre Ã  jour seulement si y a de nouveaux messages
  if (updateLog) {
    updateLogDisplay();
  }
  
  // Stats
  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  let timeStr = state.playTime < 60 ? state.playTime + "s" : state.playTime < 3600 ? Math.floor(state.playTime/60) + "m" : (state.playTime/3600).toFixed(1) + "h";
  $("playTime").textContent = timeStr;
  $("prestigeCountStat").textContent = state.prestigeCount;
  
  // Achievements
  let achHTML = state.achievements.map(a => `<div style="background:${a.unlocked ? '#002a00' : '#2a2a00'};padding:0.3rem;margin:0.2rem 0;border-radius:3px;font-size:0.8rem">
    ${a.unlocked ? 'âœ…' : 'ğŸ”’'} ${a.name}
  </div>`).join("");
  $("achievements").innerHTML = achHTML;
  $("achievementCount").textContent = state.achievements.filter(a => a.unlocked).length;
  $("achievementTotal").textContent = state.achievements.length;
}

function init() {
  $("clickBtn").addEventListener("click", clickBtn);
  $("importInput").addEventListener("change", function(e) {
    let file = e.target.files[0];
    if (!file) return;
    file.text().then(txt => {
      try {
        // Essayer d'abord le nouveau format (JSON direct)
        let data = JSON.parse(txt);
        if (!data.state) {
          // Essayer ancien format (base64)
          data = JSON.parse(atob(txt));
        }
        state = data.state;
        trade = data.trade;
        save();
        updateUI();
        log("ğŸ“¥ ImportÃ©", "success");
      } catch (x) {
        log("âŒ Fichier invalide", "event");
      }
    });
  });

  load();
  
  setTimeout(() => {
    updateUI();
    log("ğŸ® Bienvenue!", "unlock");
    if (state.prestigeCount === 0) {
      showTutorial();
    }
  }, 100);
  
  // Game loop - OPTIMISÃ‰
  setInterval(() => {
    let gain = cps() / FPS;
    state.coins += gain;
    state.totalCoins += gain;
    state.maxCps = Math.max(state.maxCps, cps());
    
    for (let u of state.starUpgrades) {
      if (u.id === "star_auto1" && u.bought) {
        state.coins += clickVal() / FPS;
        state.totalCoins += clickVal() / FPS;
      }
    }
    
    // Update UI moins souvent
    updateUIPartial();
  }, 1000 / FPS);

  setInterval(() => {
    state.playTime++;
    checkAchievements();
    save();
  }, 1000);

  window.addEventListener("beforeunload", save);
}

init();
</script>
</body>
</html>
