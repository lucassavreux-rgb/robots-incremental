<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade ULTIMATE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  *{margin:0;padding:0;box-sizing:border-box;-webkit-touch-callout:none;-webkit-text-size-adjust:none}
  body{font-family:system-ui,Arial;background:#0a0a0a;color:#eee;display:flex;flex-direction:column;align-items:center;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;padding:1rem}
  
  button{padding:.6rem 1.2rem;font-size:1rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  button:hover:not(:disabled){background:#0cf;transform:scale(1.05)}
  button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
  button:active{transform:scale(0.95)}
  
  .container{width:100%;max-width:1400px}
  .tab-nav{display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:1rem;justify-content:center}
  .tab-btn{padding:0.5rem 1rem;font-size:1rem;background:#333;color:#aaa;border:2px solid transparent}
  .tab-btn.active{background:#0af;color:#fff;border-color:#0af}
  .tab-content{display:none}
  .tab-content.active{display:block}
  
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%}
  .card{background:#1a1a1a;padding:1rem;border-radius:8px;flex:1 1 280px;margin:.5rem;box-shadow:0 4px 6px rgba(0,0,0,0.5);border-left:4px solid #0af}
  .card h3{margin-top:0;color:#0af;border-bottom:2px solid #0af;padding-bottom:.5rem;margin-bottom:1rem}
  .card h4{color:#0cf;margin-top:1rem;margin-bottom:0.5rem}
  
  .header{text-align:center;margin-bottom:2rem}
  .header h1{font-size:2.5rem;color:#0af;margin-bottom:0.5rem;text-shadow:0 0 20px rgba(0,170,255,0.5)}
  .header-stats{display:flex;gap:2rem;justify-content:center;flex-wrap:wrap;font-size:1.1rem}
  .stat-block{background:#222;padding:1rem;border-radius:6px;min-width:150px}
  .stat-value{color:#0f0;font-weight:bold;font-size:1.3rem}
  
  #log{background:#111;padding:.8rem;border-radius:8px;margin:1rem 0;max-width:100%;border-left:4px solid #0af;max-height:150px;overflow-y:auto}
  .log-message{padding:.3rem 0;font-size:.85rem;animation:fadeIn 0.3s}
  .log-success{color:#0f0}
  .log-unlock{color:#0af}
  .log-event{color:#ffa}
  .log-warning{color:#f55}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  
  .gen-item,.up-item,.milestone-item,.challenge-item,.research-item{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0;padding:.5rem;background:#222;border-radius:4px}
  .gen-item:hover,.up-item:hover{background:#333}
  
  .milestone-item{background:#1a2a00;border-left:4px solid #0f0}
  .milestone-item.completed{opacity:0.6}
  
  .challenge-item{background:#2a1a00;border-left:4px solid #ffa}
  .challenge-item.completed{background:#1a2a00;border-left-color:#0f0}
  
  .research-item{background:#1a1a2a;border-left:4px solid #0cf}
  .research-item.completed{opacity:0.6}
  
  .achievement{background:#2a2a00;padding:.5rem;margin:.3rem 0;border-left:4px solid #ffa;border-radius:4px;font-size:.85rem}
  .achievement.unlocked{background:#002a00;border-left-color:#0f0}
  
  .stat-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #333}
  
  .progress-bar{background:#333;height:20px;border-radius:10px;overflow:hidden;margin:.5rem 0}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf);height:100%;transition:width 0.3s}
  
  .buy-btn{padding:.5rem 1rem;font-size:.9rem}
  .price{color:#ffa}
  .count{color:#0f0;font-weight:bold}
  
  .event-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border:3px solid #ffa;border-radius:12px;padding:2rem;text-align:center;z-index:1000;box-shadow:0 0 30px rgba(255,170,0,0.5)}
  .event-popup h2{color:#ffa;font-size:1.8rem;margin-bottom:1rem}
  .event-popup p{font-size:1.2rem;margin:0.5rem 0;color:#eee}
  .event-popup button{margin-top:1rem}
  
  .corruption-item{background:#2a0000;border-left:4px solid #f55;padding:.5rem;margin:.3rem 0;border-radius:4px}
  .corruption-item.active{background:#4a0000}
  
  .skill-tree-container{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}
  .skill-node{background:#222;padding:1rem;border-radius:8px;border:2px solid #555;text-align:center;cursor:pointer;transition:all 0.2s}
  .skill-node:hover:not(.locked){border-color:#0af;transform:scale(1.05)}
  .skill-node.locked{opacity:0.5;cursor:not-allowed}
  .skill-node.unlocked{border-color:#0f0;background:#1a2a1a}
  .skill-node small{display:block;margin-top:0.5rem;color:#aaa}
  
  .galaxy-display{text-align:center;padding:1rem;background:#222;border-radius:8px;margin:1rem 0}
  .galaxy-count{font-size:2rem;color:#0af;font-weight:bold;margin:1rem 0}
  
  .difficulty-selector{display:flex;gap:0.5rem;flex-wrap:wrap;margin:1rem 0}
  .difficulty-btn{padding:0.7rem 1.2rem;background:#333;border:2px solid #555;border-radius:6px;cursor:pointer;transition:all 0.2s}
  .difficulty-btn.active{background:#0af;border-color:#0af;color:#fff}
  
  .market-chart{background:#111;padding:1rem;border-radius:8px;margin:1rem 0;height:200px;position:relative}
  
  .mini-event{position:fixed;bottom:20px;right:20px;background:#2a2a00;border-left:4px solid #ffa;padding:1rem;border-radius:6px;animation:slideIn 0.3s;z-index:100}
  @keyframes slideIn{from{transform:translateX(400px)}to{transform:translateX(0)}}
  
  .tabs-container{width:100%}
  
  .compact-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.5rem}
  .compact-item{background:#222;padding:0.5rem;border-radius:4px;font-size:0.9rem}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üí∞ INCREMENTAL TRADE ULTIMATE üí∞</h1>
    <div class="header-stats">
      <div class="stat-block">
        <div>Pi√®ces</div>
        <div class="stat-value" id="coins">0</div>
      </div>
      <div class="stat-block">
        <div>Pi√®ces/sec</div>
        <div class="stat-value" id="cps">0</div>
      </div>
      <div class="stat-block">
        <div>‚≠ê √âtoiles</div>
        <div class="stat-value" id="stars">0</div>
      </div>
      <div class="stat-block">
        <div>üåÄ Galaxies</div>
        <div class="stat-value" id="galaxies">0</div>
      </div>
      <div class="stat-block">
        <div>Prestige</div>
        <div class="stat-value" id="prestigeCount">0</div>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('main')">üéÆ MAIN</button>
    <button class="tab-btn" onclick="switchTab('prestige')">‚≠ê PRESTIGE</button>
    <button class="tab-btn" onclick="switchTab('trading')">üìä TRADING</button>
    <button class="tab-btn" onclick="switchTab('milestones')">üéØ MILESTONES</button>
    <button class="tab-btn" onclick="switchTab('challenges')">‚öîÔ∏è CHALLENGES</button>
    <button class="tab-btn" onclick="switchTab('skills')">üå≥ SKILLS</button>
    <button class="tab-btn" onclick="switchTab('research')">üìö RECHERCHE</button>
    <button class="tab-btn" onclick="switchTab('corruption')">üî• CORRUPTION</button>
    <button class="tab-btn" onclick="switchTab('stats')">üìà STATS</button>
    <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è PARAM√àTRES</button>
  </div>

  <!-- MAIN TAB -->
  <div id="main" class="tab-content active">
    <button id="clickBtn" style="font-size:2rem;padding:1.5rem 3rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1rem;width:90%;max-width:400px;">üëÜ Clic +<span id="clickValue">1</span></button>
    
    <div class="row">
      <div class="card">
        <h3>ü§ñ G√©n√©rateurs</h3>
        <div id="gens"></div>
      </div>
      
      <div class="card">
        <h3>‚ö° Upgrades</h3>
        <div id="ups"></div>
      </div>
      
      <div class="card">
        <h3>‚ú® Shop √âtoiles</h3>
        <div>√âtoiles : <span class="count" id="starsAvailable">0</span> ‚≠ê</div>
        <div id="starShop" style="max-height:300px;overflow-y:auto;margin-top:.5rem"></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h3>üé≤ √âv√©nements Al√©atoires</h3>
        <button id="eventBtn" onclick="triggerRandomEvent()">D√©clencher √âv√©nement</button>
        <div id="eventLog" style="margin-top:1rem;font-size:0.9rem"></div>
      </div>

      <div class="card">
        <h3>üìä Mode Difficile</h3>
        <div class="difficulty-selector" id="difficultySelector"></div>
        <div style="margin-top:1rem;font-size:0.9rem" id="difficultyDesc"></div>
      </div>
    </div>
  </div>

  <!-- PRESTIGE TAB -->
  <div id="prestige" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>‚≠ê Prestige Standard</h3>
        <div class="stat-line"><span>√âtoiles Gagn√©es</span><span class="count" id="prestigeGain">0</span></div>
        <div class="stat-line"><span>Co√ªt</span><span class="price" id="prestigeCost">1000</span> üí∞</div>
        <div class="progress-bar"><div class="progress-fill" id="prestigeProgress" style="width:0%"></div></div>
        <button id="prestigeBtn" onclick="prestige()" disabled>Prestige +<span id="prestigeGainDisplay">0</span> ‚≠ê</button>
        <button id="prestigeMaxBtn" onclick="prestigeMax()" disabled>MAX</button>
      </div>

      <div class="card">
        <h3>üåÄ Super Prestige (Galaxies)</h3>
        <div id="galaxyInfo"></div>
        <button id="superPrestigeBtn" onclick="superPrestige()" disabled>Super Prestige</button>
      </div>

      <div class="card">
        <h3>üíé Bonus Actifs</h3>
        <div class="stat-line"><span>Multiplicateur Production</span><span class="count">√ó<span id="prodBonus">1</span></span></div>
        <div class="stat-line"><span>Multiplicateur √âtoiles</span><span class="count">√ó<span id="starBonus">1</span></span></div>
        <div class="stat-line"><span>Multiplicateur Clics</span><span class="count">√ó<span id="clickBonus">1</span></span></div>
      </div>
    </div>
  </div>

  <!-- TRADING TAB -->
  <div id="trading" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>üìä March√©s Trading</h3>
        <div id="tradeContent"></div>
      </div>
    </div>
  </div>

  <!-- MILESTONES TAB -->
  <div id="milestones" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>üéØ Objectifs Milestones</h3>
        <div id="milestonesContent"></div>
      </div>
    </div>
  </div>

  <!-- CHALLENGES TAB -->
  <div id="challenges" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>‚öîÔ∏è Challenges de Prestige</h3>
        <button onclick="resetAllChallenges()" style="background:#f55">üîÑ Reset Challenges</button>
        <div id="challengesContent" style="margin-top:1rem"></div>
      </div>
    </div>
  </div>

  <!-- SKILLS TAB -->
  <div id="skills" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>üå≥ Arbre de Comp√©tences</h3>
        <div class="stat-line"><span>Points de Comp√©tence Disponibles</span><span class="count" id="skillPoints">0</span></div>
        <div class="skill-tree-container" id="skillTree"></div>
      </div>
    </div>
  </div>

  <!-- RESEARCH TAB -->
  <div id="research" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>üìö Syst√®me de Recherches</h3>
        <div id="researchContent"></div>
      </div>
    </div>
  </div>

  <!-- CORRUPTION TAB -->
  <div id="corruption" class="tab-content">
    <div class="row">
      <div class="card" style="flex:1 1 100%">
        <h3>üî• Syst√®me de Corruption</h3>
        <p style="margin-bottom:1rem;color:#ffa">Activez des malus pour augmenter vos gains d'√©toiles au prestige !</p>
        <div class="stat-line"><span>Corruptions Actives</span><span class="count" id="corruptionCount">0</span>/10</div>
        <div class="stat-line"><span>Bonus d'√âtoiles</span><span class="count" id="corruptionBonus">0</span>%</div>
        <div id="corruptionList"></div>
      </div>
    </div>
  </div>

  <!-- STATS TAB -->
  <div id="stats" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>üìä Statistiques G√©n√©rales</h3>
        <div class="stat-line"><span>Total Pi√®ces Gagn√©es</span><span class="count" id="totalCoins">0</span></div>
        <div class="stat-line"><span>Total Clics</span><span class="count" id="totalClicks">0</span></div>
        <div class="stat-line"><span>Temps de Jeu</span><span class="count" id="playTime">0s</span></div>
        <div class="stat-line"><span>Prestiges Effectu√©s</span><span class="count" id="prestigeCountStat">0</span></div>
        <div class="stat-line"><span>Challenges Compl√©t√©s</span><span class="count" id="challengesCompleted">0</span></div>
        <div class="stat-line"><span>Milestones Atteints</span><span class="count" id="milestonesCompleted">0</span></div>
      </div>

      <div class="card">
        <h3>üèÜ Achievements</h3>
        <div style="font-size:0.9rem;margin-bottom:0.5rem">
          <span class="count" id="achievementCount">0</span> / <span id="achievementTotal">0</span>
        </div>
        <div id="achievements" style="max-height:300px;overflow-y:auto"></div>
      </div>

      <div class="card">
        <h3>üîù Records</h3>
        <div class="stat-line"><span>Pic Pi√®ces</span><span class="count" id="maxCoins">0</span></div>
        <div class="stat-line"><span>Max Production/sec</span><span class="count" id="maxCps">0</span></div>
        <div class="stat-line"><span>Max Clics/sec</span><span class="count" id="maxClickRate">0</span></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS TAB -->
  <div id="settings" class="tab-content">
    <div class="row">
      <div class="card">
        <h3>üíæ Sauvegarde & Reset</h3>
        <button onclick="exportSave()">üì§ Exporter</button>
        <button onclick="importSave()">üì• Importer</button>
        <button onclick="resetGame()" style="background:#c33">üóëÔ∏è Reset Complet</button>
        <input id="importInput" type="file" accept=".txt" style="display:none">
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Param√®tres</h3>
        <label style="display:block;margin:0.5rem 0">
          <input type="checkbox" id="autoSaveToggle" onchange="toggleAutoSave()"> Auto-sauvegarde (10s)
        </label>
        <label style="display:block;margin:0.5rem 0">
          <input type="checkbox" id="soundToggle" onchange="toggleSound()"> Sons activ√©s
        </label>
        <label style="display:block;margin:0.5rem 0">
          <input type="checkbox" id="popupToggle" onchange="togglePopups()"> Popups √©v√©nements
        </label>
      </div>

      <div class="card">
        <h3>‚ÑπÔ∏è Informations</h3>
        <div style="font-size:0.9rem">
          <p>Version : v5.0 ULTIMATE</p>
          <p>Cr√©√© avec ‚ù§Ô∏è pour les clickers</p>
          <p id="debugInfo"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="eventPopup" class="event-popup" style="display:none"></div>

<script>
const SAVE_KEY = "idleTrade_v5_ultimate";
const FPS = 20;

// ==================== STATE ====================
let state = {
  coins: 0,
  totalCoins: 0,
  stars: 0,
  galaxies: 0,
  totalClicks: 0,
  prestigeCount: 0,
  playTime: 0,
  prestigeCost: 1000,
  unlockedFeatures: ["basic"],
  logMessages: [],
  difficulty: "normal",
  autoSaveEnabled: true,
  soundEnabled: true,
  popupEnabled: true,
  maxCoins: 0,
  maxCps: 0,
  maxClickRate: 0,
  
  generators: [
    {id:"robot", name:"Robot", base:0.1, count:0, price:15, mult:1.15},
    {id:"usine", name:"Usine", base:0.8, count:0, price:250, mult:1.15},
    {id:"port", name:"Port", base:4, count:0, price:3500, mult:1.15},
    {id:"labo", name:"Labo", base:20, count:0, price:50000, mult:1.15},
    {id:"satellite", name:"Satellite", base:100, count:0, price:750000, mult:1.15},
    {id:"station", name:"Station", base:500, count:0, price:15e6, mult:1.15},
    {id:"dyson", name:"Dyson", base:3000, count:0, price:500e6, mult:1.15},
    {id:"blackhole", name:"Trou Noir", base:15000, count:0, price:50e9, mult:1.15, unlock:"advanced"},
    {id:"multiverse", name:"Multivers", base:100000, count:0, price:5e12, mult:1.15, unlock:"advanced"},
    {id:"quantum", name:"Simulateur Quantique", base:500000, count:0, price:100e12, mult:1.15, unlock:"endgame"}
  ],
  
  upgrades: [
    {id:"click2", name:"Clic √ó2", price:500, effect:2, bought:false, type:"click"},
    {id:"click5", name:"Clic √ó5", price:25000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"click10", name:"Clic √ó10", price:500000, effect:10, bought:false, type:"click", requires:"click5"},
    {id:"click25", name:"Clic √ó25", price:50e6, effect:25, bought:false, type:"click", requires:"click10", unlock:"advanced"},
    {id:"gen2", name:"Gen √ó2", price:15000, effect:2, bought:false, type:"gen"},
    {id:"gen3", name:"Gen √ó3", price:250000, effect:3, bought:false, type:"gen", requires:"gen2"},
    {id:"gen5", name:"Gen √ó5", price:5e6, effect:5, bought:false, type:"gen", requires:"gen3"},
    {id:"robot10", name:"Robot √ó10", price:5000, effect:10, bought:false, type:"robot"},
    {id:"usine10", name:"Usine √ó10", price:75000, effect:10, bought:false, type:"usine"},
    {id:"port10", name:"Port √ó10", price:1e6, effect:10, bought:false, type:"port"},
    {id:"labo10", name:"Labo √ó10", price:5e6, effect:10, bought:false, type:"labo", unlock:"midgame"},
    {id:"satellite10", name:"Satellite √ó10", price:50e6, effect:10, bought:false, type:"satellite", unlock:"midgame"},
    {id:"autosave", name:"Sauvegarde auto", price:2000, bought:false, type:"feature"},
    {id:"allgen10", name:"Tous Gens √ó10", price:500e6, effect:10, bought:false, type:"gen", unlock:"advanced", requires:"gen5"}
  ],
  
  starUpgrades: [
    {id:"star_prod1", name:"Prod √ó2", cost:10, bought:false, effect:2, type:"production"},
    {id:"star_prod2", name:"Prod √ó5", cost:35, bought:false, effect:5, type:"production", requires:"star_prod1"},
    {id:"star_prod3", name:"Prod √ó10", cost:100, bought:false, effect:10, type:"production", requires:"star_prod2"},
    {id:"star_click1", name:"Clic √ó3", cost:20, bought:false, effect:3, type:"starclick"},
    {id:"star_click2", name:"Clic √ó10", cost:60, bought:false, effect:10, type:"starclick", requires:"star_click1"},
    {id:"star_gen1", name:"Robot √ó50", cost:25, bought:false, effect:50, type:"robot"},
    {id:"star_gen2", name:"Usine √ó50", cost:50, bought:false, effect:50, type:"usine"},
    {id:"star_gen3", name:"Port √ó50", cost:80, bought:false, effect:50, type:"port"},
    {id:"star_auto1", name:"Auto-clic", cost:75, bought:false, type:"autoclick"},
    {id:"star_autobuy", name:"Auto-achat gen", cost:200, bought:false, type:"autobuy", unlock:"advanced"},
    {id:"star_market", name:"March√© rapide", cost:120, bought:false, type:"fastmarket", unlock:"advanced"}
  ],

  achievements: [
    {id:"first_coin", name:"Premi√®re pi√®ce", desc:"Gagner 1 pi√®ce", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"100 pi√®ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"1000 pi√®ces", unlocked:false},
    {id:"million", name:"Ultra-Millionnaire", desc:"1M pi√®ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"1er g√©n√©rateur", unlocked:false},
    {id:"first_prestige", name:"Renaissance", desc:"1er prestige", unlocked:false},
    {id:"ten_gens", name:"Industriel", desc:"10 g√©n√©rateurs", unlocked:false},
    {id:"fifty_gens", name:"Magnat", desc:"50 g√©n√©rateurs", unlocked:false},
    {id:"clicker", name:"Clickeur", desc:"100 clics", unlocked:false},
    {id:"trader", name:"Trader", desc:"Acheter du fer", unlocked:false},
    {id:"five_prestige", name:"Renaissant", desc:"5 prestiges", unlocked:false},
    {id:"ten_prestige", name:"Ph√©nix", desc:"10 prestiges", unlocked:false},
    {id:"first_galaxy", name:"Explorateur", desc:"1√®re Galaxie", unlocked:false},
    {id:"challenge_complete", name:"Challenger", desc:"Compl√©ter un challenge", unlocked:false},
    {id:"five_challenges", name:"D√©fieur", desc:"5 challenges", unlocked:false},
    {id:"skill_master", name:"Ma√Ætre des Comp√©tences", desc:"10 comp√©tences achet√©es", unlocked:false},
    {id:"research_master", name:"Chercheur", desc:"5 recherches compl√©t√©es", unlocked:false},
    {id:"corruption1", name:"Corrompu", desc:"1√®re corruption", unlocked:false},
    {id:"corruption10", name:"Sombre Maitre", desc:"10 corruptions actives", unlocked:false},
    {id:"hardcore_beat", name:"Coeur de Fer", desc:"Prestige en mode Hardcore", unlocked:false},
    {id:"speed_beat", name:"Vitesse √âclair", desc:"Prestige en mode Speed", unlocked:false},
    {id:"chaos_survive", name:"Survivant du Chaos", desc:"10 min en mode Chaos", unlocked:false},
    {id:"milestone_ten", name:"Objecteur", desc:"10 milestones atteints", unlocked:false},
    {id:"event_lucky", name:"Chanceux", desc:"Avoir 3 Jackpots", unlocked:false},
    {id:"infinite", name:"Infini", desc:"Atteindre 1e100 pi√®ces", unlocked:false},
    {id:"rich_prestige", name:"Riche Prestige", desc:"Prestige avec 100M", unlocked:false},
    {id:"fast_prestige", name:"Prestige Rapide", desc:"3 prestiges en 5 min", unlocked:false},
    {id:"all_gens", name:"Collectionneur", desc:"Tous les g√©n√©rateurs", unlocked:false},
    {id:"completionist", name:"Perfectionniste", desc:"30 achievements", unlocked:false}
  ],

  milestones: [
    {id:"m1", name:"D√©butant", desc:"Atteindre 1K pi√®ces", target:"coins", value:1000, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m2", name:"Ambitieux", desc:"Atteindre 100K pi√®ces", target:"coins", value:100000, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m3", name:"Magnat", desc:"Atteindre 1M pi√®ces", target:"coins", value:1e6, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m4", name:"Tycoon", desc:"Atteindre 1B pi√®ces", target:"coins", value:1e9, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m5", name:"G√©n√©rateurs", desc:"Avoir 10 g√©n√©rateurs", target:"totalGens", value:10, reward:{mult:1.1,type:"click"}, completed:false},
    {id:"m6", name:"Productivit√©", desc:"10 pi√®ces/sec", target:"cps", value:10, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m7", name:"Prestige 1", desc:"1er prestige", target:"prestige", value:1, reward:{mult:1.2,type:"stars"}, completed:false},
    {id:"m8", name:"Prestige 5", desc:"5 prestiges", target:"prestige", value:5, reward:{mult:1.1,type:"stars"}, completed:false},
    {id:"m9", name:"Prestige 10", desc:"10 prestiges", target:"prestige", value:10, reward:{mult:1.1,type:"stars"}, completed:false},
    {id:"m10", name:"Prestige 20", desc:"20 prestiges", target:"prestige", value:20, reward:{mult:1.1,type:"stars"}, completed:false},
    {id:"m11", name:"Super Prestige", desc:"1√®re Galaxie", target:"galaxies", value:1, reward:{mult:1.3,type:"stars"}, completed:false},
    {id:"m12", name:"5 √âtoiles", desc:"5 √©toiles gagn√©es", target:"stars", value:5, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m13", name:"50 √âtoiles", desc:"50 √©toiles gagn√©es", target:"stars", value:50, reward:{mult:1.1,type:"production"}, completed:false},
    {id:"m14", name:"Challenges", desc:"5 challenges compl√©t√©s", target:"challengesCompleted", value:5, reward:{mult:1.05,type:"production"}, completed:false},
    {id:"m15", name:"Comp√©tences", desc:"5 comp√©tences achet√©es", target:"skillsUnlocked", value:5, reward:{mult:1.1,type:"click"}, completed:false}
  ],

  challenges: [
    {id:"ch1", name:"Sans Usines", desc:"Prestige sans Usines", active:false, completed:false, reward:50, mult:"robot"},
    {id:"ch2", name:"Rapide", desc:"Prestige en <10 min", active:false, completed:false, reward:25, bonus_stars:2},
    {id:"ch3", name:"Riche", desc:"Prestige avec 100M", active:false, completed:false, reward:100, mult:"all"},
    {id:"ch4", name:"Cliqueur", desc:"Prestige avec 1000+ clics", active:false, completed:false, reward:30, mult:"click"},
    {id:"ch5", name:"Sans Upgrades", desc:"Prestige sans upgrades", active:false, completed:false, reward:75, mult:"gen"},
    {id:"ch6", name:"Trader", desc:"Vendre 100 fer", active:false, completed:false, reward:40, mult:"trading"},
    {id:"ch7", name:"Millionnaire", desc:"Atteindre 1M en <5 min", active:false, completed:false, reward:60, mult:"click"},
    {id:"ch8", name:"Sans Clics", desc:"Prestige sans clics manuels", active:false, completed:false, reward:80, mult:"auto"},
    {id:"ch9", name:"Hardcore", desc:"Prestige en mode Hardcore", active:false, completed:false, reward:100, mult:"stars"},
    {id:"ch10", name:"Triple", desc:"3 prestiges en 10 min", active:false, completed:false, reward:120, mult:"all"}
  ],

  skills: [
    // Production Branch (10 skills)
    {id:"sk1", name:"Production +10%", cost:1, branch:"production", bought:false, effect:1.1},
    {id:"sk2", name:"Production +20%", cost:2, branch:"production", bought:false, effect:1.2, requires:"sk1"},
    {id:"sk3", name:"Robots √ó2", cost:1, branch:"production", bought:false, effect:2, type:"robot"},
    {id:"sk4", name:"Usines √ó2", cost:1, branch:"production", bought:false, effect:2, type:"usine"},
    {id:"sk5", name:"Ports √ó2", cost:1, branch:"production", bought:false, effect:2, type:"port"},
    {id:"sk6", name:"Production +50%", cost:3, branch:"production", bought:false, effect:1.5, requires:"sk2"},
    {id:"sk7", name:"Labo √ó3", cost:2, branch:"production", bought:false, effect:3, type:"labo"},
    {id:"sk8", name:"Satellite √ó3", cost:2, branch:"production", bought:false, effect:3, type:"satellite"},
    {id:"sk9", name:"Station √ó2", cost:2, branch:"production", bought:false, effect:2, type:"station"},
    {id:"sk10", name:"Production √ó2", cost:5, branch:"production", bought:false, effect:2, requires:"sk6"},
    // Click Branch (10 skills)
    {id:"sk11", name:"Clics +20%", cost:1, branch:"click", bought:false, effect:1.2},
    {id:"sk12", name:"Clics √ó2", cost:2, branch:"click", bought:false, effect:2, requires:"sk11"},
    {id:"sk13", name:"Clics √ó3", cost:3, branch:"click", bought:false, effect:3, requires:"sk12"},
    {id:"sk14", name:"Auto-clic 1/sec", cost:2, branch:"click", bought:false, type:"autoclick"},
    {id:"sk15", name:"Auto-clic 2/sec", cost:4, branch:"click", bought:false, type:"autoclick2", requires:"sk14"},
    {id:"sk16", name:"Clics +50%", cost:2, branch:"click", bought:false, effect:1.5},
    {id:"sk17", name:"Clic Critique", cost:3, branch:"click", bought:false, effect:2, type:"crit"},
    {id:"sk18", name:"Clic Cha√Æne", cost:4, branch:"click", bought:false, type:"chain"},
    {id:"sk19", name:"Clics √ó5", cost:5, branch:"click", bought:false, effect:5, requires:"sk13"},
    {id:"sk20", name:"Clic Explosion", cost:6, branch:"click", bought:false, effect:10, type:"explosion", requires:"sk19"},
    // Trading Branch (10 skills)
    {id:"sk21", name:"Fer +10%", cost:1, branch:"trading", bought:false, effect:1.1, type:"iron"},
    {id:"sk22", name:"Fer +25%", cost:2, branch:"trading", bought:false, effect:1.25, type:"iron", requires:"sk21"},
    {id:"sk23", name:"Or Meilleur", cost:2, branch:"trading", bought:false, type:"gold"},
    {id:"sk24", name:"Platine Meilleur", cost:3, branch:"trading", bought:false, type:"platinum"},
    {id:"sk25", name:"Crypto Meilleur", cost:4, branch:"trading", bought:false, type:"crypto"},
    {id:"sk26", name:"Bot Trading √ó2", cost:2, branch:"trading", bought:false, effect:2, type:"bot"},
    {id:"sk27", name:"Profit +20%", cost:3, branch:"trading", bought:false, effect:1.2, type:"profit"},
    {id:"sk28", name:"Volatilit√© -30%", cost:2, branch:"trading", bought:false, effect:0.7, type:"volatility"},
    {id:"sk29", name:"Arbitrage", cost:4, branch:"trading", bought:false, type:"arbitrage"},
    {id:"sk30", name:"March√© Ma√Ætre", cost:5, branch:"trading", bought:false, effect:1.5, type:"master", requires:"sk27"}
  ],

  researches: [
    {id:"r1", name:"Productivit√© I", desc:"D√©bloquer +10% production", cost_coins:10000, cost_time:30, completed:false, reward:"prod_1"},
    {id:"r2", name:"Productivit√© II", desc:"D√©bloquer +25% production", cost_coins:100000, cost_time:60, completed:false, reward:"prod_2"},
    {id:"r3", name:"Robotique", desc:"D√©bloquer Robots √ó10", cost_coins:50000, cost_time:45, completed:false, reward:"robot_10"},
    {id:"r4", name:"Industrie", desc:"D√©bloquer Usines √ó10", cost_coins:200000, cost_time:60, completed:false, reward:"industry_10"},
    {id:"r5", name:"Logistique", desc:"D√©bloquer Ports √ó20", cost_coins:500000, cost_time:90, completed:false, reward:"port_20"},
    {id:"r6", name:"Clic Am√©lior√©", desc:"D√©bloquer Clic √ó5", cost_coins:75000, cost_time:45, completed:false, reward:"click_5"},
    {id:"r7", name:"Chimie", desc:"D√©bloquer Labos √ó5", cost_coins:300000, cost_time:60, completed:false, reward:"labo_5"},
    {id:"r8", name:"Astronomie", desc:"D√©bloquer Satellites √ó5", cost_coins:1e6, cost_time:120, completed:false, reward:"satellite_5"},
    {id:"r9", name:"√ânergie", desc:"D√©bloquer Station √ó2", cost_coins:5e6, cost_time:150, completed:false, reward:"station_2"},
    {id:"r10", name:"Dyson Advanced", desc:"D√©bloquer Dyson √ó2", cost_coins:50e6, cost_time:180, completed:false, reward:"dyson_2"},
    {id:"r11", name:"Trou Noir", desc:"D√©bloquer Trou Noir", cost_coins:100e9, cost_time:300, completed:false, reward:"bh_unlock"},
    {id:"r12", name:"Multivers", desc:"D√©bloquer Multivers", cost_coins:1e12, cost_time:300, completed:false, reward:"mv_unlock"},
    {id:"r13", name:"Trading Avanc√©", desc:"D√©bloquer Or & Platine", cost_coins:500000, cost_time:90, completed:false, reward:"trade_adv"},
    {id:"r14", name:"Crypto Trading", desc:"D√©bloquer Crypto", cost_coins:2e6, cost_time:120, completed:false, reward:"crypto_unlock"},
    {id:"r15", name:"Bot Autonome", desc:"D√©bloquer Auto-trading", cost_coins:10e6, cost_time:150, completed:false, reward:"autobot"}
  ],

  corruptions: [
    {id:"c1", name:"Prod -50%", desc:"Production -50%", effect:"prod", value:-0.5, bonus_stars:100, active:false},
    {id:"c2", name:"Prix √ó2", desc:"Prix g√©n√©rateurs √ó2", effect:"price", value:2, bonus_stars:150, active:false},
    {id:"c3", name:"Prod -80%", desc:"Production -80%", effect:"prod", value:-0.8, bonus_stars:200, active:false},
    {id:"c4", name:"Pas d'√âtoiles", desc:"√âtoiles -50%", effect:"stars", value:-0.5, bonus_stars:250, active:false},
    {id:"c5", name:"Pi√®ces -40%", desc:"Pi√®ces gagn√©es -40%", effect:"coins", value:-0.4, bonus_stars:120, active:false},
    {id:"c6", name:"Prix √ó5", desc:"Prix g√©n√©rateurs √ó5", effect:"price", value:5, bonus_stars:300, active:false},
    {id:"c7", name:"Clics -70%", desc:"Clics -70%", effect:"click", value:-0.7, bonus_stars:180, active:false},
    {id:"c8", name:"Prod -95%", desc:"Production -95%", effect:"prod", value:-0.95, bonus_stars:500, active:false},
    {id:"c9", name:"D√©fi Total", desc:"Prod -99% but +1000% stars", effect:"extreme", value:-0.99, bonus_stars:1000, active:false},
    {id:"c10", name:"Chaos Complet", desc:"Tous les malus!", effect:"chaos", bonus_stars:2000, active:false}
  ]
};

let trade = {
  resources: {
    iron: {amount: 0, price: 10, history: [10], botActive: false},
    gold: {amount: 0, price: 50, history: [50], botActive: false},
    platinum: {amount: 0, price: 200, history: [200], botActive: false},
    crypto: {amount: 0, price: 1000, history: [1000], botActive: false}
  },
  totalTrades: 0,
  jackpots: 0
};

let currentTab = "main";
const $ = id => document.getElementById(id);

// ==================== UTILITIES ====================
function log(txt, type) {
  type = type || "normal";
  const timestamp = new Date().toLocaleTimeString();
  let cssClass = "";
  if (type === "success") cssClass = "log-success";
  if (type === "unlock") cssClass = "log-unlock";
  if (type === "event") cssClass = "log-event";
  if (type === "warning") cssClass = "log-warning";
  state.logMessages.unshift({text: txt, time: timestamp, type: cssClass});
  if (state.logMessages.length > 10) state.logMessages.pop();
  const logEl = $("log");
  logEl.innerHTML = state.logMessages.map(msg => 
    `<div class="log-message ${msg.type}">[${msg.time}] ${msg.text}</div>`
  ).join("");
}

function formatNum(n) {
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  if (n < 1e12) return (n / 1e9).toFixed(2) + "B";
  if (n < 1e15) return (n / 1e12).toFixed(2) + "T";
  if (n < 1e18) return (n / 1e15).toFixed(2) + "Qa";
  return (n / 1e18).toFixed(2) + "Qi";
}

function isUnlocked(feature) {
  if (!feature) return true;
  return state.unlockedFeatures && state.unlockedFeatures.indexOf(feature) !== -1;
}

function switchTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  $(tab).classList.add("active");
  event.target.classList.add("active");
  currentTab = tab;
}

// ==================== GENERATION & INCOME ====================
function price(gen) {
  let base_price = gen.price * Math.pow(gen.mult, gen.count);
  
  // Apply corruption
  let corruption_mult = 1;
  for (let c of state.corruptions) {
    if (c.active && c.effect === "price") corruption_mult *= c.value;
  }
  
  return Math.floor(base_price * corruption_mult);
}

function cps() {
  let genMult = 1;
  for (let u of state.upgrades) {
    if (u.type === "gen" && u.bought) genMult *= u.effect;
  }
  
  let starMult = 1;
  for (let u of state.starUpgrades) {
    if (u.type === "production" && u.bought) starMult *= u.effect;
  }
  
  let skillMult = 1;
  for (let s of state.skills) {
    if (s.bought && s.branch === "production" && s.effect) skillMult *= s.effect;
  }
  
  let milestoneBonus = 1;
  for (let m of state.milestones) {
    if (m.completed && m.reward.type === "production") milestoneBonus *= m.reward.mult;
  }
  
  let total = 0;
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock)) continue;
    
    let eff = genMult * starMult * skillMult * milestoneBonus;
    
    for (let u of state.upgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    for (let s of state.skills) {
      if (s.type === g.id && s.bought) eff *= s.effect;
    }
    for (let u of state.starUpgrades) {
      if (u.type === g.id && u.bought) eff *= u.effect;
    }
    
    total += g.count * g.base * eff;
  }
  
  let star_bonus = Math.pow(1.5, state.stars) * Math.pow(3, state.galaxies);
  
  // Apply corruption
  let corruption_mult = 1;
  for (let c of state.corruptions) {
    if (c.active && c.effect === "prod") corruption_mult *= (1 + c.value);
  }
  if (state.difficulty === "hardcore") corruption_mult *= 0.1;
  if (state.difficulty === "speed") corruption_mult *= 5;
  
  return total * star_bonus * corruption_mult;
}

function clickVal() {
  let clickMult = 1;
  for (let u of state.upgrades) {
    if (u.type === "click" && u.bought) clickMult *= u.effect;
  }
  
  let starMult = 1;
  for (let u of state.starUpgrades) {
    if (u.type === "starclick" && u.bought) starMult *= u.effect;
  }
  
  let skillMult = 1;
  for (let s of state.skills) {
    if (s.bought && s.branch === "click" && s.effect) skillMult *= s.effect;
  }
  
  let milestoneBonus = 1;
  for (let m of state.milestones) {
    if (m.completed && m.reward.type === "click") milestoneBonus *= m.reward.mult;
  }
  
  let total = clickMult * starMult * skillMult * milestoneBonus;
  let star_bonus = Math.pow(1.5, state.stars) * Math.pow(3, state.galaxies);
  
  // Apply corruption
  let corruption_mult = 1;
  for (let c of state.corruptions) {
    if (c.active && c.effect === "click") corruption_mult *= (1 + c.value);
  }
  
  return total * star_bonus * corruption_mult;
}

function clickBtn() {
  let val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  state.maxCoins = Math.max(state.maxCoins, state.coins);
  checkAchievements();
}

// ==================== BUYING ====================
function buyGen(genId) {
  for (let g of state.generators) {
    if (g.id === genId) {
      let cost = price(g);
      if (state.coins < cost) return;
      state.coins -= cost;
      g.count++;
      state.totalCoins += cost * 0.1;
      checkAchievements();
      updateUI();
      save();
      return;
    }
  }
}

function buyUp(upId) {
  for (let u of state.upgrades) {
    if (u.id === upId) {
      if (u.bought || state.coins < u.price) return;
      if (!isUnlocked(u.unlock)) return;
      if (u.requires) {
        let reqFound = false;
        for (let uu of state.upgrades) {
          if (uu.id === u.requires && uu.bought) { reqFound = true; break; }
        }
        if (!reqFound) return;
      }
      state.coins -= u.price;
      u.bought = true;
      log("‚úÖ " + u.name, "success");
      checkAchievements();
      updateUI();
      save();
      return;
    }
  }
}

function buyStarUpgrade(id) {
  for (let u of state.starUpgrades) {
    if (u.id === id) {
      if (u.bought || state.stars < u.cost) return;
      if (!isUnlocked(u.unlock)) return;
      if (u.requires) {
        let reqFound = false;
        for (let uu of state.starUpgrades) {
          if (uu.id === u.requires && uu.bought) { reqFound = true; break; }
        }
        if (!reqFound) return;
      }
      state.stars -= u.cost;
      u.bought = true;
      log("‚ú® " + u.name, "success");
      updateUI();
      save();
      return;
    }
  }
}

function buySkill(id) {
  for (let s of state.skills) {
    if (s.id === id) {
      if (s.bought) return;
      if (state.skillPoints < s.cost) return;
      if (s.requires) {
        let reqFound = false;
        for (let ss of state.skills) {
          if (ss.id === s.requires && ss.bought) { reqFound = true; break; }
        }
        if (!reqFound) return;
      }
      state.skillPoints -= s.cost;
      s.bought = true;
      log("üå≥ Comp√©tence: " + s.name, "success");
      updateUI();
      save();
      return;
    }
  }
}

function toggleCorruption(id) {
  for (let c of state.corruptions) {
    if (c.id === id) {
      if (!c.active) {
        let active_count = state.corruptions.filter(x => x.active).length;
        if (active_count >= 10) return;
      }
      c.active = !c.active;
      log((c.active ? "üî• " : "‚ú® ") + c.name, c.active ? "warning" : "success");
      updateUI();
      save();
      return;
    }
  }
}

function activateChallenge(id) {
  for (let c of state.challenges) {
    if (c.id === id) {
      if (c.active) return;
      // Reset other active challenge
      for (let cc of state.challenges) cc.active = false;
      c.active = true;
      c.challengeStartTime = Date.now();
      c.challengeStartCoins = state.totalCoins;
      c.challengeStartClicks = state.totalClicks;
      log("‚öîÔ∏è Challenge Activ√©: " + c.name, "unlock");
      updateUI();
      save();
      return;
    }
  }
}

function completeChallenge(id) {
  for (let c of state.challenges) {
    if (c.id === id && c.active) {
      c.active = false;
      c.completed = true;
      state.skillPoints += c.reward;
      log("üèÜ Challenge Compl√©t√©! +" + c.reward + " points", "success");
      checkAchievements();
      updateUI();
      save();
      return;
    }
  }
}

// ==================== PRESTIGE ====================
function getDifficultyMultiplier() {
  const mults = {normal: 1, hardcore: 5, speed: 0.2, chaos: 1.5};
  return mults[state.difficulty] || 1;
}

function prestige() {
  // Besoin d'au MOINS 1000 pi√®ces ACTUELLES en cash pour prestige
  if (state.coins < 1000) return;
  
  let gain = Math.floor(state.totalCoins / state.prestigeCost);
  if (gain < 1) return;
  
  // Tu d√©penses tes pi√®ces actuelles
  state.coins = 0;
  
  // Apply difficulty multiplier
  let diff_mult = getDifficultyMultiplier();
  if (state.difficulty === "hardcore") {
    // In hardcore, you gain MORE stars but harder to get coins
    gain *= 5;
  } else if (state.difficulty === "speed") {
    // In speed, you gain LESS stars
    gain *= 0.2;
  }
  
  // Apply corruption bonus
  let corruption_bonus = 1;
  for (let c of state.corruptions) {
    if (c.active) corruption_bonus += c.bonus_stars / 100;
  }
  gain *= corruption_bonus;
  
  // Check challenges
  for (let c of state.challenges) {
    if (c.active) {
      let elapsed = (Date.now() - c.challengeStartTime) / 1000;
      if (c.id === "ch2" && elapsed < 600) { // Prestige en <10 min
        completeChallenge(c.id);
        gain += c.reward;
      }
      if (c.id === "ch3" && state.coins >= 100e6) { // Prestige avec 100M
        completeChallenge(c.id);
        gain += c.reward;
      }
      if (c.id === "ch7" && elapsed < 300 && state.coins >= 1e6) { // 1M en <5 min
        completeChallenge(c.id);
        gain += c.reward;
      }
      if (c.id === "ch9" && state.difficulty === "hardcore") { // Hardcore prestige
        completeChallenge(c.id);
        gain += c.reward;
      }
    }
  }
  
  state.stars += Math.floor(gain);
  state.prestigeCount++;
  state.skillPoints += 3; // 3 skill points par prestige
  resetCore();
  log("‚≠ê +" + Math.floor(gain) + " √©toiles (Total: " + state.stars + ")", "success");
  checkAchievements();
  checkUnlocks();
  updateUI();
  save();
}

function prestigeMax() {
  // Faire prestige plusieurs fois d'affil√©e
  if (state.coins < 1000) return;
  
  let loop_count = 0;
  while (state.coins >= 1000 && state.totalCoins >= state.prestigeCost && loop_count < 100) {
    prestige();
    loop_count++;
  }
}

function superPrestige() {
  // Need 100 stars for first galaxy, 1000 for second, etc.
  // Et faut avoir 1000 pi√®ces actuelles
  if (state.coins < 1000) return;
  let cost = 100 * Math.pow(10, state.galaxies);
  if (state.stars < cost) return;
  
  state.stars -= cost;
  state.galaxies++;
  state.skillPoints += 10;
  state.coins = 0;
  resetCore();
  log("üåÄ +" + 1 + " Galaxie! (Bonus √ó" + Math.pow(3, state.galaxies) + ")", "unlock");
  checkAchievements();
  updateUI();
  save();
}

function resetCore() {
  state.coins = 0;
  for (let g of state.generators) g.count = 0;
  for (let u of state.upgrades) {
    if (u.id !== "autosave") u.bought = false;
  }
  for (let r of Object.values(trade.resources)) {
    r.amount = 0;
  }
}

// ==================== TRADING ====================
function buyResource(resource) {
  let r = trade.resources[resource];
  let cost = r.price * 1.05;
  let qty = Math.max(1, Math.floor(state.coins / cost));
  let total = qty * cost;
  if (state.coins < total) return;
  state.coins -= total;
  r.amount += qty;
  trade.totalTrades++;
  checkAchievements();
  updateUI();
  save();
}

function sellResource(resource) {
  let r = trade.resources[resource];
  if (r.amount < 1) return;
  let gain = r.amount * r.price * 0.95;
  state.coins += gain;
  state.totalCoins += gain * 0.5;
  r.amount = 0;
  trade.totalTrades++;
  updateUI();
  save();
}

function tickMarket() {
  for (let name in trade.resources) {
    let r = trade.resources[name];
    let volatility = {iron: 0.08, gold: 0.05, platinum: 0.15, crypto: 0.30}[name];
    let change = (Math.random() - 0.48) * volatility;
    r.price = Math.max(2, Math.floor(r.price * (1 + change)));
    r.history.push(r.price);
    if (r.history.length > 20) r.history.shift();
  }
}

// ==================== MILESTONES ====================
function checkMilestones() {
  for (let m of state.milestones) {
    if (m.completed) continue;
    
    let target_val = 0;
    if (m.target === "coins") target_val = state.coins;
    if (m.target === "totalGens") target_val = state.generators.reduce((a,g) => a + g.count, 0);
    if (m.target === "cps") target_val = cps();
    if (m.target === "prestige") target_val = state.prestigeCount;
    if (m.target === "galaxies") target_val = state.galaxies;
    if (m.target === "stars") target_val = state.stars;
    if (m.target === "challengesCompleted") target_val = state.challenges.filter(c => c.completed).length;
    if (m.target === "skillsUnlocked") target_val = state.skills.filter(s => s.bought).length;
    
    if (target_val >= m.value && !m.completed) {
      m.completed = true;
      log("üéØ Milestone: " + m.name, "success");
      checkAchievements();
    }
  }
}

// ==================== ACHIEVEMENTS ====================
function checkAchievements() {
  const checks = {
    first_coin: () => state.totalCoins >= 1,
    hundred: () => state.coins >= 100,
    thousand: () => state.coins >= 1000,
    million: () => state.coins >= 1e6,
    first_gen: () => state.generators.some(g => g.count > 0),
    first_prestige: () => state.prestigeCount >= 1,
    ten_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 10,
    fifty_gens: () => state.generators.reduce((a,g) => a + g.count, 0) >= 50,
    clicker: () => state.totalClicks >= 100,
    trader: () => trade.totalTrades > 0,
    five_prestige: () => state.prestigeCount >= 5,
    ten_prestige: () => state.prestigeCount >= 10,
    first_galaxy: () => state.galaxies >= 1,
    challenge_complete: () => state.challenges.some(c => c.completed),
    five_challenges: () => state.challenges.filter(c => c.completed).length >= 5,
    skill_master: () => state.skills.filter(s => s.bought).length >= 10,
    research_master: () => state.researches.filter(r => r.completed).length >= 5,
    corruption1: () => state.corruptions.some(c => c.active),
    corruption10: () => state.corruptions.filter(c => c.active).length >= 10,
    hardcore_beat: () => state.prestigeCount >= 1 && state.difficulty === "hardcore",
    speed_beat: () => state.prestigeCount >= 1 && state.difficulty === "speed",
    chaos_survive: () => state.difficulty === "chaos" && state.playTime >= 600,
    milestone_ten: () => state.milestones.filter(m => m.completed).length >= 10,
    event_lucky: () => trade.jackpots >= 3,
    infinite: () => state.totalCoins >= 1e100,
    rich_prestige: () => state.prestigeCount >= 1 && state.coins >= 100e6,
    fast_prestige: () => false, // Special check needed
    all_gens: () => state.generators.every(g => g.count > 0),
    completionist: () => state.achievements.filter(a => a.unlocked).length >= 30
  };
  
  for (let a of state.achievements) {
    if (!a.unlocked && checks[a.id] && checks[a.id]()) {
      a.unlocked = true;
      log("üèÜ " + a.name, "success");
    }
  }
}

// ==================== EVENTS ====================
function triggerRandomEvent() {
  const events = [
    {name: "M√©t√©ore üå†", effect: () => {
      state.coins = Math.max(0, state.coins * 0.8);
      state.boostedCps = cps() * 5;
      state.boostTime = 30;
      log("üå† M√©t√©ore! -20% pi√®ces, +500% prod pendant 30s", "event");
    }},
    {name: "Jackpot üé∞", effect: () => {
      state.coins += state.coins * 9;
      trade.jackpots++;
      log("üé∞ JACKPOT! √ó10 pi√®ces!", "success");
    }},
    {name: "Taxe üí∏", effect: () => {
      state.coins = Math.max(0, state.coins * 0.9);
      log("üí∏ Taxe! -10% pi√®ces", "warning");
    }},
    {name: "Bonus Myst√®re üéÅ", effect: () => {
      let options = [
        () => { state.stars++; log("üéÅ +1 √©toile!", "success"); },
        () => { state.skillPoints += 5; log("üéÅ +5 points comp√©tence!", "success"); },
        () => { state.coins *= 2; log("üéÅ √ó2 pi√®ces!", "success"); },
        () => { for(let g of state.generators) g.count += 5; log("üéÅ +5 g√©n√©rateurs random!", "success"); }
      ];
      options[Math.floor(Math.random() * options.length)]();
    }}
  ];
  
  let evt = events[Math.floor(Math.random() * events.length)];
  evt.effect();
  checkAchievements();
  updateUI();
  save();
}

// ==================== UNLOCKS ====================
function checkUnlocks() {
  if (!state.unlockedFeatures) state.unlockedFeatures = ["basic"];
  
  if (state.prestigeCount >= 5 && !state.unlockedFeatures.includes("midgame")) {
    state.unlockedFeatures.push("midgame");
    log("üéâ NOUVEAU : Upgrades Avanc√©s !", "unlock");
  }
  
  if (state.prestigeCount >= 15 && !state.unlockedFeatures.includes("advanced")) {
    state.unlockedFeatures.push("advanced");
    log("üéâ NOUVEAU : Trading Multi-Ressources + Auto-achat !", "unlock");
  }

  if (state.prestigeCount >= 30 && !state.unlockedFeatures.includes("lategame")) {
    state.unlockedFeatures.push("lategame");
    log("üéâ NOUVEAU : Super Prestige (Galaxies) !", "unlock");
  }

  if (state.prestigeCount >= 50 && !state.unlockedFeatures.includes("endgame")) {
    state.unlockedFeatures.push("endgame");
    log("üéâ NOUVEAU : ENDGAME - Modes Difficiles, Corruption, Chaos !", "unlock");
  }
}

// ==================== UI UPDATE ====================
function updateUI() {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  $("stars").textContent = state.stars;
  $("galaxies").textContent = state.galaxies;
  $("prestigeCount").textContent = state.prestigeCount;
  $("starsAvailable").textContent = state.stars;
  $("skillPoints").textContent = state.skillPoints;
  
  // Prestige display
  let pGain = Math.floor(state.totalCoins / state.prestigeCost);
  $("prestigeGain").textContent = pGain;
  $("prestigeGainDisplay").textContent = pGain;
  $("prestigeBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeMaxBtn").disabled = pGain < 1 || state.coins < 1000;
  $("prestigeCost").textContent = formatNum(state.prestigeCost);
  
  let pProgress = Math.min(100, (state.totalCoins / state.prestigeCost) * 100);
  $("prestigeProgress").style.width = pProgress + "%";

  // Galaxy display
  let galaxyCost = 100 * Math.pow(10, state.galaxies);
  let canSuperPrestige = state.stars >= galaxyCost;
  $("superPrestigeBtn").disabled = !canSuperPrestige;
  $("galaxyInfo").innerHTML = `
    <div class="galaxy-display">
      <div>Galaxies Actuelles</div>
      <div class="galaxy-count">${state.galaxies} üåÄ</div>
      <div>Prochaine Galaxie : ${formatNum(galaxyCost)} ‚≠ê</div>
      <div>Bonus Actuel : √ó${Math.pow(3, state.galaxies)}</div>
    </div>
  `;

  // Bonus display
  let prod_bonus = 1;
  for (let m of state.milestones) {
    if (m.completed && m.reward.type === "production") prod_bonus *= m.reward.mult;
  }
  let star_bonus = 1;
  for (let m of state.milestones) {
    if (m.completed && m.reward.type === "stars") star_bonus *= m.reward.mult;
  }
  let click_bonus = 1;
  for (let m of state.milestones) {
    if (m.completed && m.reward.type === "click") click_bonus *= m.reward.mult;
  }
  
  $("prodBonus").textContent = formatNum(Math.pow(1.5, state.stars) * Math.pow(3, state.galaxies) * prod_bonus);
  $("starBonus").textContent = formatNum(star_bonus);
  $("clickBonus").textContent = formatNum(click_bonus);

  // Generators
  let gensHTML = "";
  for (let g of state.generators) {
    if (!isUnlocked(g.unlock)) continue;
    let cost = price(g);
    let canBuy = state.coins >= cost;
    gensHTML += `<div class="gen-item">
      <div><strong>${g.name}</strong> <span class="count">√ó${g.count}</span><br><small>${formatNum(g.base * g.count * cps() / state.generators.reduce((a,x) => a + x.base * x.count, 0))}/s</small></div>
      <button class="buy-btn" onclick="buyGen('${g.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(cost)}üí∞</button>
    </div>`;
  }
  $("gens").innerHTML = gensHTML;

  // Upgrades
  let availUps = [];
  for (let u of state.upgrades) {
    if (u.bought) continue;
    if (!isUnlocked(u.unlock)) continue;
    if (u.requires) {
      let reqMet = false;
      for (let uu of state.upgrades) {
        if (uu.id === u.requires && uu.bought) { reqMet = true; break; }
      }
      if (!reqMet) continue;
    }
    availUps.push(u);
  }
  
  let upsHTML = availUps.length > 0 ? availUps.map(u => {
    let canBuy = state.coins >= u.price;
    return `<div class="up-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyUp('${u.id}')" ${canBuy ? '' : 'disabled'}>${formatNum(u.price)}üí∞</button>
    </div>`;
  }).join("") : '<div style="color:#888;text-align:center">Tous achet√©s!</div>';
  $("ups").innerHTML = upsHTML;

  // Star Upgrades
  let availStar = [];
  for (let u of state.starUpgrades) {
    if (u.bought) continue;
    if (!isUnlocked(u.unlock)) continue;
    if (u.requires) {
      let reqMet = false;
      for (let uu of state.starUpgrades) {
        if (uu.id === u.requires && uu.bought) { reqMet = true; break; }
      }
      if (!reqMet) continue;
    }
    availStar.push(u);
  }
  
  let starHTML = availStar.length > 0 ? availStar.map(u => {
    let canBuy = state.stars >= u.cost;
    return `<div class="up-item">
      <div><strong>${u.name}</strong></div>
      <button class="buy-btn" onclick="buyStarUpgrade('${u.id}')" ${canBuy ? '' : 'disabled'}>${u.cost}‚≠ê</button>
    </div>`;
  }).join("") : '<div style="color:#888;text-align:center">Tous achet√©s!</div>';
  $("starShop").innerHTML = starHTML;

  // Trading
  let tradeHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem">';
  for (let name in trade.resources) {
    let r = trade.resources[name];
    let avg = r.history.reduce((a,b) => a+b, 0) / r.history.length;
    tradeHTML += `<div style="background:#222;padding:1rem;border-radius:8px">
      <h4>${name.toUpperCase()}</h4>
      <div class="stat-line"><span>Quantit√©</span><span class="count">${r.amount}</span></div>
      <div class="stat-line"><span>Prix</span><span class="price">${r.price}</span> üí∞</div>
      <div class="stat-line"><span>Moyenne</span><span>${avg.toFixed(1)}</span></div>
      <button onclick="buyResource('${name}')">Acheter</button>
      <button onclick="sellResource('${name}')">Vendre</button>
    </div>`;
  }
  tradeHTML += '</div>';
  $("tradeContent").innerHTML = tradeHTML;

  // Milestones
  let milestonesHTML = state.milestones.map(m => {
    let pct = 0;
    if (m.target === "coins") pct = Math.min(100, (state.coins / m.value) * 100);
    if (m.target === "totalGens") pct = Math.min(100, ((state.generators.reduce((a,g) => a + g.count, 0)) / m.value) * 100);
    if (m.target === "cps") pct = Math.min(100, (cps() / m.value) * 100);
    if (m.target === "prestige") pct = Math.min(100, (state.prestigeCount / m.value) * 100);
    
    return `<div class="milestone-item ${m.completed ? 'completed' : ''}">
      <div>
        <strong>${m.name}</strong><br>
        <small>${m.desc}</small>
        <div class="progress-bar" style="margin-top:0.3rem">
          <div class="progress-fill" style="width:${pct}%"></div>
        </div>
      </div>
      ${m.completed ? '<span style="color:#0f0">‚úì</span>' : ''}
    </div>`;
  }).join("");
  $("milestonesContent").innerHTML = milestonesHTML;

  // Challenges
  let challengesHTML = state.challenges.map(c => {
    return `<div class="challenge-item ${c.completed ? 'completed' : ''}">
      <div>
        <strong>${c.name}</strong> ${c.reward ? `(+${c.reward} points)` : ''}<br>
        <small>${c.desc}</small>
      </div>
      <button onclick="activateChallenge('${c.id}')" ${c.active || c.completed ? 'disabled' : ''}>${c.completed ? '‚úì' : 'Activer'}</button>
    </div>`;
  }).join("");
  $("challengesContent").innerHTML = challengesHTML;

  // Skills
  let skillsHTML = '<div class="skill-tree-container">';
  for (let s of state.skills) {
    let canBuy = state.skillPoints >= s.cost && !s.bought;
    if (s.requires) {
      let reqFound = false;
      for (let ss of state.skills) {
        if (ss.id === s.requires && ss.bought) { reqFound = true; break; }
      }
      if (!reqFound) canBuy = false;
    }
    
    let color = s.branch === "production" ? "#0a0" : s.branch === "click" ? "#0af" : "#fa0";
    skillsHTML += `<div class="skill-node ${s.bought ? 'unlocked' : ''}" style="border-color:${color}">
      <strong>${s.name}</strong>
      <small>${s.cost} pts</small>
      ${s.bought ? '<div style="margin-top:0.5rem;color:#0f0">‚úì Achet√©</div>' : ''}
      <button onclick="buySkill('${s.id}')" style="margin-top:0.5rem;font-size:0.8rem" ${canBuy ? '' : 'disabled'}>${canBuy ? 'Acheter' : 'Bloqu√©'}</button>
    </div>`;
  }
  skillsHTML += '</div>';
  $("skillTree").innerHTML = skillsHTML;

  // Research
  let researchHTML = state.researches.map(r => {
    return `<div class="research-item ${r.completed ? 'completed' : ''}">
      <div>
        <strong>${r.name}</strong><br>
        <small>${r.desc}</small>
        <small style="display:block;color:#aaa;margin-top:0.3rem">Co√ªt: ${formatNum(r.cost_coins)} üí∞ | ${r.cost_time}s</small>
      </div>
      ${r.completed ? '<span style="color:#0f0">‚úì</span>' : '<span style="color:#aaa">Bient√¥t</span>'}
    </div>`;
  }).join("");
  $("researchContent").innerHTML = researchHTML;

  // Corruptions
  let corruptionHTML = state.corruptions.map(c => {
    let active_count = state.corruptions.filter(x => x.active).length;
    return `<div class="corruption-item ${c.active ? 'active' : ''}">
      <div style="display:flex;justify-content:space-between">
        <div>
          <strong>${c.name}</strong><br>
          <small>${c.desc}</small><br>
          <small style="color:#ffa">+${c.bonus_stars}% √©toiles</small>
        </div>
        <button onclick="toggleCorruption('${c.id}')" ${active_count >= 10 && !c.active ? 'disabled' : ''} style="align-self:center">${c.active ? 'D√©sactiver' : 'Activer'}</button>
      </div>
    </div>`;
  }).join("");
  $("corruptionList").innerHTML = corruptionHTML;
  $("corruptionCount").textContent = state.corruptions.filter(c => c.active).length;
  let total_bonus = 0;
  for (let c of state.corruptions) {
    if (c.active) total_bonus += c.bonus_stars;
  }
  $("corruptionBonus").textContent = total_bonus;

  // Difficulty selector
  const difficulties = {normal: "Normal", hardcore: "Hardcore (Prod√∑10, Stars√ó5)", speed: "Speed (5√ó plus rapide)", chaos: "Chaos (√âv√©nements)"};
  let diffHTML = "";
  for (let diff in difficulties) {
    diffHTML += `<button class="difficulty-btn ${state.difficulty === diff ? 'active' : ''}" onclick="setDifficulty('${diff}')">${difficulties[diff]}</button>`;
  }
  $("difficultySelector").innerHTML = diffHTML;
  
  const diffDescriptions = {
    normal: "Mode normal - pas de malus",
    hardcore: "Production divis√©e par 10, mais tu gagnes 5√ó plus d'√©toiles!",
    speed: "Tout va 5 fois plus vite, mais tu gagnes moins d'√©toiles",
    chaos: "√âv√©nements al√©atoires constants!"
  };
  $("difficultyDesc").textContent = diffDescriptions[state.difficulty] || "Mode normal";

  // Stats
  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  let playTimeStr = state.playTime < 60 ? state.playTime + "s" : state.playTime < 3600 ? Math.floor(state.playTime / 60) + "m" : (state.playTime / 3600).toFixed(1) + "h";
  $("playTime").textContent = playTimeStr;
  $("prestigeCountStat").textContent = state.prestigeCount;
  $("challengesCompleted").textContent = state.challenges.filter(c => c.completed).length;
  $("milestonesCompleted").textContent = state.milestones.filter(m => m.completed).length;
  
  $("maxCoins").textContent = formatNum(state.maxCoins);
  $("maxCps").textContent = formatNum(state.maxCps);
  $("maxClickRate").textContent = formatNum(state.maxClickRate);

  // Achievements
  let achHTML = "";
  for (let a of state.achievements) {
    achHTML += `<div class="achievement ${a.unlocked ? 'unlocked' : ''}">
      ${a.unlocked ? '‚úÖ' : 'üîí'} <strong>${a.name}</strong><br>
      <small>${a.desc}</small>
    </div>`;
  }
  $("achievements").innerHTML = achHTML;
  $("achievementCount").textContent = state.achievements.filter(a => a.unlocked).length;
  $("achievementTotal").textContent = state.achievements.length;
}

function setDifficulty(diff) {
  state.difficulty = diff;
  log("‚öôÔ∏è Mode: " + (diff === "normal" ? "Normal" : diff === "hardcore" ? "Hardcore" : diff === "speed" ? "Speed" : "Chaos"), "event");
  updateUI();
  save();
}

// ==================== SAVE/LOAD ====================
function save() {
  try {
    let saveData = {state, trade, v: 5, t: Date.now()};
    saveData.state.logMessages = [];
    localStorage.setItem(SAVE_KEY, btoa(JSON.stringify(saveData)));
  } catch (e) {
    console.error("Save error:", e);
  }
}

function load() {
  try {
    let raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      let data = JSON.parse(atob(raw));
      Object.assign(state, data.state);
      Object.assign(trade, data.trade);
      if (!state.logMessages) state.logMessages = [];
      log("üíæ Charg√©", "success");
    }
  } catch (e) {
    log("‚ùå Erreur chargement", "event");
  }
  updateUI();
}

function exportSave() {
  try {
    let saveData = {state, trade, v: 5};
    saveData.state.logMessages = [];
    let blob = new Blob([btoa(JSON.stringify(saveData))], {type: "text/plain"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "save_" + Date.now() + ".txt";
    a.click();
    log("üì§ Export√©", "success");
  } catch (e) {
    log("‚ùå Erreur export", "event");
  }
}

function importSave() {
  $("importInput").click();
}

function resetGame() {
  if (confirm("Reset TOTAL? Tu perdras TOUT!")) {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }
}

function resetAllChallenges() {
  for (let c of state.challenges) {
    c.active = false;
    c.completed = false;
  }
  log("üîÑ Challenges r√©initialis√©s", "event");
  updateUI();
  save();
}

function toggleAutoSave() {
  state.autoSaveEnabled = !state.autoSaveEnabled;
  log(state.autoSaveEnabled ? "‚úÖ Auto-save ON" : "‚ùå Auto-save OFF", "event");
}

function toggleSound() {
  state.soundEnabled = !state.soundEnabled;
}

function togglePopups() {
  state.popupEnabled = !state.popupEnabled;
}

// ==================== INIT ====================
function init() {
  $("clickBtn").addEventListener("click", clickBtn);
  
  $("importInput").addEventListener("change", function(e) {
    let file = e.target.files[0];
    if (!file) return;
    file.text().then(txt => {
      try {
        let data = JSON.parse(atob(txt));
        state = data.state;
        trade = data.trade;
        save();
        updateUI();
        log("üì• Import√©", "success");
      } catch (x) {
        log("‚ùå Fichier invalide", "event");
      }
    });
  });

  load();
  
  setTimeout(() => {
    updateUI();
    log("üéÆ Bienvenue dans ULTIMATE!", "unlock");
  }, 100);
  
  let updateCounter = 0;
  setInterval(() => {
    let gain = cps() / FPS;
    state.coins += gain;
    state.totalCoins += gain;
    
    let currentCps = cps();
    state.maxCps = Math.max(state.maxCps, currentCps);
    
    // Auto-click
    for (let u of state.starUpgrades) {
      if (u.id === "star_auto1" && u.bought) {
        let autoGain = clickVal() / FPS;
        state.coins += autoGain;
        state.totalCoins += autoGain;
      }
    }
    
    updateCounter++;
    
    $("coins").textContent = formatNum(state.coins);
    $("totalCoins").textContent = formatNum(state.totalCoins);
    $("cps").textContent = formatNum(currentCps);
    
    if (updateCounter % 10 === 0) {
      checkMilestones();
      checkAchievements();
      updateUI();
    }
    
    if (updateCounter % 30 === 0) {
      save();
    }
  }, 1000 / FPS);

  setInterval(() => {
    tickMarket();
  }, 30000);

  setInterval(() => {
    state.playTime++;
    if (state.playTime % 300 === 0) {
      checkAchievements();
    }
  }, 1000);

  window.addEventListener("beforeunload", save);
}

init();
</script>
</body>
</html>
