<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0a0a0a">
  <title>Incremental Trade ULTIMATE - FIXED</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

```
/* âœ… FORCER LE MODE SOMBRE PARTOUT */
@media (prefers-color-scheme: light) {
  body {
    background: #0a0a0a !important;
    color: #eee !important;
  }
}

body {
  font-family: Arial, sans-serif;
  background: #0a0a0a !important;
  color: #eee !important;
  padding: 1rem;
}

html {
  background: #0a0a0a !important;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
}

h1 {
  color: #0af;
  text-align: center;
  margin: 1rem 0;
  font-size: 2.2rem;
}

h3, h4 {
  color: #0af;
  margin: 0.5rem 0;
}

p {
  text-align: center;
  color: #aaa;
  margin-bottom: 1rem;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 1rem;
  margin: 1rem 0;
}

.stat {
  background: #1a1a1a;
  padding: 1rem;
  border-radius: 6px;
  border: 1px solid #0af;
  text-align: center;
}

.stat-val {
  font-size: 1.4rem;
  color: #0f0;
  font-weight: bold;
}

.tabs {
  display: flex;
  gap: 0.3rem;
  margin: 1rem 0;
  flex-wrap: wrap;
  background: #111;
  padding: 0.5rem;
  border-radius: 6px;
}

.tab-btn {
  padding: 0.6rem 1rem;
  background: #222;
  color: #aaa;
  border: 1px solid #333;
  cursor: pointer;
  border-radius: 4px;
  transition: 0.3s;
}

.tab-btn:hover {
  background: #333;
}

.tab-btn.active {
  background: #0af;
  color: #000;
  border-color: #0af;
}

.content {
  display: none;
}

.content.active {
  display: block;
}

.card {
  background: #1a1a1a;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 6px;
  border: 1px solid #333;
}

.btn {
  padding: 0.6rem 1rem;
  background: #0af;
  color: #000;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin: 0.3rem 0.3rem 0.3rem 0;
  transition: 0.2s;
}

.btn:hover:not(:disabled) {
  transform: scale(1.05);
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.danger-btn {
  background: #f00;
  color: #fff;
}

.danger-btn:hover:not(:disabled) {
  background: #c00;
}

.item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.6rem;
  background: #0a0a0a;
  margin: 0.4rem 0;
  border-left: 3px solid #0af;
}

.big-btn {
  width: 100%;
  max-width: 280px;
  padding: 1.2rem;
  font-size: 1.1rem;
  margin: 1rem auto;
  display: block;
}

.log {
  background: #000;
  border-left: 3px solid #0af;
  padding: 0.8rem;
  max-height: 120px;
  overflow-y: auto;
  margin: 1rem 0;
  font-size: 0.85rem;
}

canvas {
  border: 1px solid #0af;
  background: #111;
  max-width: 100%;
  margin: 1rem 0;
}

.trade-card {
  background: #1a1a2a;
  border: 2px solid #0af;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 6px;
}

.trade-card.min {
  border-color: #0f0;
}

.trade-card.mid {
  border-color: #fa0;
}

.trade-card.high {
  border-color: #f00;
}

.trade-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.trade-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.trade-stat {
  background: #0a0a1a;
  padding: 0.5rem;
  border-radius: 4px;
  font-size: 0.9rem;
  border-left: 2px solid #0af;
}

.trade-stat-val {
  font-weight: bold;
  color: #0f0;
  font-size: 1.1rem;
}

.trade-input-group {
  display: flex;
  gap: 0.5rem;
  margin: 0.5rem 0;
  flex-wrap: wrap;
}

.trade-input {
  flex: 1;
  min-width: 100px;
  padding: 0.5rem;
  background: #0a0a0a;
  border: 1px solid #333;
  color: #0f0;
  border-radius: 4px;
  font-size: 0.9rem;
}

.trade-log-event {
  padding: 0.5rem;
  margin: 0.3rem 0;
  background: #000;
  border-left: 2px solid #0af;
  font-size: 0.85rem;
}

.trade-log-event.gain {
  border-left-color: #0f0;
  color: #0f0;
}

.trade-log-event.loss {
  border-left-color: #f00;
  color: #f00;
}

#tutorialModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.98);
  z-index: 9999;
  padding: 1rem;
  overflow-y: auto;
  display: none;
}

.tut-box {
  max-width: 700px;
  margin: 0 auto;
  background: #1a1a1a;
  padding: 1.5rem;
  border: 2px solid #0af;
  border-radius: 6px;
}

.tut-box h1 {
  margin-top: 0;
}

.tut-btns {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin: 1.5rem 0;
}

@media(max-width: 600px) {
  .tabs {
    font-size: 0.9rem;
  }

  .stat {
    padding: 0.6rem;
  }

  .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
}
```

  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ’ INCREMENTAL TRADE ULTIMATE ğŸ’</h1>
  <p>Le jeu inactif addictif! [FIXED VERSION]</p>
  <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn" onclick="showTutorial()" style="display:block">ğŸ“– TUTORIEL</button>
    <button class="btn" onclick="showChangelogs()" style="display:block">ğŸ“ CHANGELOGS</button>
    <div class="log" id="log" style="flex: 1; min-width: 200px; max-width: 400px; margin: 0;"></div>
  </div>

  <!-- STATS AFFICHAGE -->

  <div class="stats">
    <div class="stat">
      <div>ğŸ’° PiÃ¨ces</div>
      <div class="stat-val" id="coins">0</div>
    </div>
    <div class="stat">
      <div>âš¡ /sec</div>
      <div class="stat-val" id="cps">0</div>
    </div>
    <div class="stat">
      <div>â­ Ã‰toiles</div>
      <div class="stat-val" id="stars">0</div>
    </div>
    <div class="stat">
      <div>ğŸŒ€ Galaxies</div>
      <div class="stat-val" id="galaxies">0</div>
    </div>
    <div class="stat">
      <div>ğŸŒ™ Dark Matter</div>
      <div class="stat-val" id="dm">0</div>
    </div>
    <div class="stat">
      <div>ğŸ’¸ Trade BloquÃ©</div>
      <div class="stat-val" id="tradeBlocked">0</div>
    </div>
    <div class="stat">
      <div>ğŸš€ Ascension</div>
      <div class="stat-val" id="ascension">0</div>
    </div>
    <div class="stat">
      <div>ğŸ† Achievements</div>
      <div class="stat-val" id="achievementCount">0</div>
    </div>
    <div class="stat">
      <div>ğŸ¦ Banque</div>
      <div class="stat-val" id="bankAmount">0</div>
    </div>
  </div>

  <!-- TABS NAVIGATION -->

  <div class="tabs">
    <button class="tab-btn active" data-tab="main">ğŸ® JEU</button>
    <button class="tab-btn" data-tab="gens">ğŸ¤– GÃ‰NÃ‰RATEURS</button>
    <button class="tab-btn" data-tab="ups">âš¡ UPGRADES</button>
    <button class="tab-btn" data-tab="trade">ğŸ’¸ TRADING</button>
    <button class="tab-btn" data-tab="bank">ğŸ¦ BANQUE</button>
    <button class="tab-btn" data-tab="lottery">ğŸ° LOTTERIE</button>
    <button class="tab-btn" data-tab="ascensionTab">ğŸš€ ASCENSION</button>
    <button class="tab-btn" data-tab="achievements">ğŸ† ACHIEVEMENTS</button>
    <button class="tab-btn" data-tab="milestones">ğŸ¯ MILESTONES</button>
    <button class="tab-btn" data-tab="ngp">ğŸ”„ NEW GAME+</button>
    <button class="tab-btn" data-tab="feat">âœ¨ FEATURES</button>
    <button class="tab-btn" data-tab="stats">ğŸ“Š STATS</button>
    <button class="tab-btn" data-tab="params">âš™ï¸ PARAMÃˆTRES</button>
  </div>

  <!-- TAB: MAIN GAME -->

  <div id="main" class="content active">
    <div class="card" style="text-align:center">
      <button class="btn big-btn" id="clickBtn">ğŸ–±ï¸ CLIQUER</button>
      <p>Gain: <span id="clickVal">0</span> par clic</p>
    </div>

```
<div class="card">
  <h3>â±ï¸ PRESTIGE</h3>
  <p>CoÃ»t: <span id="prestigeCost">50000</span> ğŸ’°</p>
  <p>Progression: <span id="prestProg">0</span></p>
  <p style="color: #0f0; font-size: 1.1rem;"><strong>Possible: <span id="prestigeCount">0</span>Ã—</strong></p>
  <button class="btn" id="prestigeBtn">âš¡ PRESTIGE (+10% par prestige)</button>
</div>

<div class="card">
  <h3>ğŸŒ€ GALAXIES</h3>
  <p>CoÃ»t: <span id="galaxyCost">500</span> â­</p>
  <button class="btn" id="galaxyBtn">ğŸŒ€ SUPER PRESTIGE (Ã—1.6)</button>
</div>
```

  </div>

  <!-- TAB: GENERATORS -->

  <div id="gens" class="content">
    <div class="card">
      <h3>ğŸ¤– GÃ‰NÃ‰RATEURS AUTOMATIQUES</h3>
      <div id="gensList"></div>
    </div>
  </div>

  <!-- TAB: UPGRADES -->

  <div id="ups" class="content">
    <div class="card">
      <h3>âš¡ AMÃ‰LIORATIONS</h3>
      <div id="upsList"></div>
    </div>
  </div>

  <!-- TAB: TRADING -->

  <div id="trade" class="content">
    <div class="card">
      <h3>ğŸ’¸ SYSTÃˆME DE TRADING</h3>
      <p style="color: #aaa; margin-bottom: 1rem;">Plus tu dÃ©poses, plus tu gagnes/perds! L'argent est BLOQUÃ‰ jusqu'au retrait.</p>

```
  <!-- RISQUE MINIMUM -->
  <div class="trade-card min">
    <div class="trade-header">
      <div>
        <h4>âœ… RISQUE MINIMUM</h4>
        <p style="color: #0f0; font-size: 0.9rem;">+3% par seconde | -2% risque (0.5% chance)</p>
      </div>
    </div>
    
    <div class="trade-stats">
      <div class="trade-stat">
        <div>ğŸ’° Investi</div>
        <div class="trade-stat-val" id="minAmount">0</div>
      </div>
      <div class="trade-stat">
        <div>âš¡ +/sec</div>
        <div class="trade-stat-val" id="minGain">0</div>
      </div>
      <div class="trade-stat">
        <div>ğŸ“‰ Risque</div>
        <div class="trade-stat-val" id="minLoss">0</div>
      </div>
    </div>

    <div class="trade-input-group">
      <input type="number" class="trade-input" id="minInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('min')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('min')">ğŸ“¥ RETIRER</button>
    </div>

    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('min')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('min')">TOUT</button>
    </div>
  </div>

  <!-- RISQUE MOYEN -->
  <div class="trade-card mid">
    <div class="trade-header">
      <div>
        <h4>âš ï¸ RISQUE MOYEN</h4>
        <p style="color: #fa0; font-size: 0.9rem;">+10% par seconde | -5% risque (3% chance)</p>
      </div>
    </div>
    
    <div class="trade-stats">
      <div class="trade-stat">
        <div>ğŸ’° Investi</div>
        <div class="trade-stat-val" id="midAmount">0</div>
      </div>
      <div class="trade-stat">
        <div>âš¡ +/sec</div>
        <div class="trade-stat-val" id="midGain">0</div>
      </div>
      <div class="trade-stat">
        <div>ğŸ“‰ Risque</div>
        <div class="trade-stat-val" id="midLoss">0</div>
      </div>
    </div>

    <div class="trade-input-group">
      <input type="number" class="trade-input" id="midInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('mid')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('mid')">ğŸ“¥ RETIRER</button>
    </div>

    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('mid')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('mid')">TOUT</button>
    </div>
  </div>

  <!-- GROS RISQUE -->
  <div class="trade-card high">
    <div class="trade-header">
      <div>
        <h4>ğŸ”¥ GROS RISQUE</h4>
        <p style="color: #f00; font-size: 0.9rem;">+30% par seconde | -15% risque (8% chance) | TOUT PERDRE (0.1% chance)</p>
      </div>
    </div>
    
    <div class="trade-stats">
      <div class="trade-stat">
        <div>ğŸ’° Investi</div>
        <div class="trade-stat-val" id="highAmount">0</div>
      </div>
      <div class="trade-stat">
        <div>âš¡ +/sec</div>
        <div class="trade-stat-val" id="highGain">0</div>
      </div>
      <div class="trade-stat">
        <div>ğŸ“‰ Risque</div>
        <div class="trade-stat-val" id="highLoss">0</div>
      </div>
    </div>

    <div class="trade-input-group">
      <input type="number" class="trade-input" id="highInput" placeholder="Montant Ã  dÃ©poser" min="0">
      <button class="btn" onclick="investTrade('high')">ğŸ“¤ DÃ‰POSER</button>
      <button class="btn danger-btn" onclick="withdrawTrade('high')">ğŸ“¥ RETIRER</button>
    </div>

    <div class="trade-input-group">
      <button class="btn" style="background:#fa0" onclick="investTrade50('high')">50%</button>
      <button class="btn" style="background:#f00" onclick="investTradeAll('high')">TOUT</button>
    </div>
  </div>

  <!-- TRADE LOG -->
  <div class="card">
    <h4>ğŸ“Š LOG TRADING</h4>
    <div id="tradeLog" style="max-height: 200px; overflow-y: auto;">
      <div class="trade-log-event">En attente...</div>
    </div>
  </div>
</div>
```

  </div>

  <!-- TAB: BANQUE -->

  <div id="bank" class="content">
    <div class="card">
      <h3>ğŸ¦ BANQUE - INVESTISSEMENTS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©pose des piÃ¨ces pour +0.1% par sec!</p>

```
  <div class="trade-stats">
    <div class="trade-stat">
      <div>ğŸ’° Investi</div>
      <div class="trade-stat-val" id="bankInvested">0</div>
    </div>
    <div class="trade-stat">
      <div>âš¡ +/sec</div>
      <div class="trade-stat-val" id="bankGains">0</div>
    </div>
  </div>

  <div class="trade-input-group">
    <input type="number" class="trade-input" id="bankInput" placeholder="Montant Ã  dÃ©poser" min="0">
    <button class="btn" onclick="depositBank()">ğŸ“¤ DÃ‰POSER</button>
    <button class="btn danger-btn" onclick="withdrawBank()">ğŸ“¥ RETIRER</button>
  </div>

  <div class="card" style="background:#0a0a0a;margin-top:1rem">
    <h4>ğŸ“Š Info Banque</h4>
    <p style="color:#aaa;font-size:0.9rem">
      Total gÃ©nÃ©rÃ©: <span id="bankGenerated">0</span> ğŸ’°
    </p>
  </div>
</div>
```

  </div>

  <!-- TAB: LOTTERIE -->

  <div id="lottery" class="content">
    <div class="card">
      <h3>ğŸ° LOTTERIE - TENTEZ VOTRE CHANCE!</h3>
      <p style="color: #aaa; margin-bottom: 1rem;">Achetez des tickets et tentez votre chance!</p>

```
  <div class="trade-stats">
    <div class="trade-stat">
      <div>ğŸŸï¸ Tickets</div>
      <div class="trade-stat-val" id="lotteryTickets">0</div>
    </div>
    <div class="trade-stat">
      <div>ğŸ’° CoÃ»t</div>
      <div class="trade-stat-val">100</div>
    </div>
  </div>

  <div class="trade-input-group">
    <button class="btn" onclick="buyLotteryTicket(1)">ğŸŸï¸ 1 Ticket (100)</button>
    <button class="btn" onclick="buyLotteryTicket(10)">ğŸŸï¸ 10 Tickets (1K)</button>
    <button class="btn" onclick="buyLotteryTicket(100)">ğŸŸï¸ 100 Tickets (10K)</button>
  </div>

  <div style="margin-top: 1rem;">
    <button class="btn big-btn" onclick="playLottery()" style="max-width: 100%; width: 100%;">ğŸ° JOUER!</button>
  </div>

  <div class="card" style="background:#0a0a0a;margin-top:1rem">
    <h4>ğŸ² RÃ©sultats</h4>
    <div id="lotteryLog" style="max-height: 200px; overflow-y: auto;">
      <div style="color:#aaa;font-size:0.9rem">En attente...</div>
    </div>
  </div>
</div>
```

  </div>

  <!-- TAB: ASCENSION -->

  <div id="ascensionTab" class="content">
    <div class="card">
      <h3>ğŸš€ ASCENSION - META PRESTIGE</h3>
      <p style="color: #fa0; margin-bottom: 1rem;">RÃ©initialise TOUT mais donne des bonus permanents Ã©normes!</p>

```
  <div class="trade-stats">
    <div class="trade-stat">
      <div>ğŸš€ Points</div>
      <div class="trade-stat-val" id="ascensionPoints">0</div>
    </div>
    <div class="trade-stat">
      <div>âš¡ Bonus</div>
      <div class="trade-stat-val">+<span id="ascensionBonus">0</span>%</div>
    </div>
    <div class="trade-stat">
      <div>ğŸŒ€ CoÃ»t</div>
      <div class="trade-stat-val" id="ascensionCost">100</div>
    </div>
  </div>

  <div style="background:#0a0a1a;padding:1rem;margin:1rem 0;border-left:3px solid #fa0;border-radius:4px;">
    <p style="color:#fa0;margin:0.5rem 0"><strong>âš ï¸ ATTENTION!</strong></p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">L'Ascension va:</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les gÃ©nÃ©rateurs</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser TOUS les upgrades</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âŒ RÃ©initialiser les Ã©toiles et prestige</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âœ… Garder les Galaxies</p>
    <p style="color:#aaa;font-size:0.9rem;margin:0.5rem 0">âœ… Garder les points d'Ascension</p>
  </div>

  <button class="btn big-btn danger-btn" onclick="doAscension()" style="max-width: 100%; width: 100%;">ğŸš€ ASCENSIONNER!</button>

  <div class="card" style="background:#0a0a0a;margin-top:1rem">
    <h4>ğŸ“Š Info Ascension</h4>
    <p style="color:#aaa;font-size:0.9rem">
      Galaxies nÃ©cessaires: <span id="ascensionRequired">100</span><br>
      Galaxies actuelles: <span id="ascensionCurrent">0</span>
    </p>
  </div>
</div>
```

  </div>

  <!-- TAB: ACHIEVEMENTS -->

  <div id="achievements" class="content">
    <div class="card">
      <h3>ğŸ† ACHIEVEMENTS & BADGES</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©bloque des badges et gagne des rÃ©compenses!</p>

```
  <div id="achievementsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
    <!-- Les achievements s'affichent ici -->
  </div>
</div>
```

  </div>

  <!-- TAB: MILESTONES -->

  <div id="milestones" class="content">
    <div class="card">
      <h3>ğŸ¯ MILESTONES - DÃ‰FIS PROGRESSIFS</h3>
      <p style="color: #0f0; margin-bottom: 1rem;">DÃ©bloque des dÃ©fis et gagne des rÃ©compenses!</p>

```
  <div id="milestonesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
    <!-- Les milestones s'affichent ici -->
  </div>
</div>
```

  </div>

  <!-- TAB: NEW GAME PLUS -->

  <div id="ngp" class="content">
    <div class="card">
      <h3>ğŸ”„ NEW GAME PLUS</h3>
      <p style="color: #fa0; margin-bottom: 1rem;">RÃ©initialise tout mais avec des bonus Ã©normes!</p>

```
  <div style="background:#0a0a2a;padding:1.5rem;border-left:4px solid #fa0;border-radius:6px;margin:1rem 0">
    <div style="color:#fa0;font-weight:bold;font-size:1.1rem;margin-bottom:1rem">â³ FONCTIONNALITÃ‰ EN DÃ‰VELOPPEMENT</div>
    <p style="color:#aaa;line-height:1.8;margin-bottom:1rem">
      Le New Game Plus est actuellement en cours de dÃ©veloppement. Cette fonctionnalitÃ© rÃ©volutionnaire te permettra de:
    </p>
    
    <div style="background:#0a0a0a;padding:1rem;border-radius:4px;margin:1rem 0;color:#aaa">
      <p style="margin:0.5rem 0">âœ… RÃ©initialiser ta progression</p>
      <p style="margin:0.5rem 0">âœ… Garder certains bonus permanents</p>
      <p style="margin:0.5rem 0">âœ… DÃ©verrouiller du contenu spÃ©cial</p>
      <p style="margin:0.5rem 0">âœ… Progresser encore plus vite</p>
      <p style="margin:0.5rem 0">âœ… Multiplier les multiplicateurs</p>
    </div>
    
    <button class="btn danger-btn" disabled style="width:100%;margin-top:1rem;cursor:not-allowed">
      ğŸ”„ NEW GAME PLUS [Ã€ VENIR]
    </button>
    
    <p style="color:#666;font-size:0.85rem;margin-top:1rem;text-align:center">
      Termine d'abord tes dÃ©fis Milestones! ğŸ¯
    </p>
  </div>

  <div class="card" style="background:#0a0a0a;margin-top:1rem">
    <h4>ğŸ“Š Info NGP</h4>
    <div class="item">
      <span>Statut:</span>
      <span style="color:#fa0">En dÃ©veloppement</span>
    </div>
    <div class="item">
      <span>NGP ComplÃ©tÃ©s:</span>
      <span id="ngpCount">0</span>
    </div>
  </div>
</div>
```

  </div>

  <!-- TAB: FEATURES -->

  <div id="feat" class="content">
    <div class="card">
      <h3>ğŸŒ™ DARK MATTER</h3>
      <div class="item">
        <div>
          <strong>Dark Matter: <span id="dmCount">0</span></strong><br>
          <span style="color:#aaa;font-size:0.9rem">+5% Ã  TOUS les gains par Dark Matter</span>
        </div>
      </div>
      <div id="dmInfo" style="color:#aaa;font-size:0.9rem;margin-top:0.5rem"></div>
    </div>

```
<div class="card">
  <h3>ğŸ¯ QUÃŠTES</h3>
  <div id="questsList"></div>
</div>

<div class="card">
  <h3>â° BOOSTS</h3>
  <button class="btn" id="boostProd">Prod Ã—2 (50K)</button>
  <button class="btn" id="boostClick">Click Ã—2 (30K)</button>
  <div id="activeBoosts" style="margin-top:0.5rem"></div>
</div>

<div class="card">
  <h3>âš™ï¸ SYNERGIES</h3>
  <div id="synergies"></div>
</div>

<div class="card">
  <h3>ğŸ“Š GRAPHIQUE</h3>
  <canvas id="graph" width="600" height="200"></canvas>
</div>
```

  </div>

  <!-- TAB: STATS -->

  <div id="stats" class="content">
    <div class="card">
      <h3>ğŸ“ˆ STATISTIQUES</h3>
      <div class="item">
        <span>Total PiÃ¨ces</span>
        <span id="totalCoins">0</span>
      </div>
      <div class="item">
        <span>Total Clics</span>
        <span id="totalClicks">0</span>
      </div>
      <div class="item">
        <span>Temps Jeu</span>
        <span id="playTime">0s</span>
      </div>
      <div class="item">
        <span>Prestige</span>
        <span id="presCount">0</span>
      </div>
    </div>
  </div>

  <!-- TAB: PARAMETRES -->

  <div id="params" class="content">
    <div class="card">
      <h3>âš™ï¸ PARAMÃˆTRES</h3>
      <p style="color:#aaa;margin-bottom:1rem">GÃ¨re ta partie ici</p>

```
  <div class="item" style="border-left:3px solid #0f0;padding:1rem">
    <div>
      <strong>ğŸ’¾ Sauvegarder</strong><br>
      <span style="color:#aaa;font-size:0.9rem">TÃ©lÃ©charge une copie de ta progression</span>
    </div>
    <button class="btn" id="downloadBtn">ğŸ“¥ TÃ‰LÃ‰CHARGER</button>
  </div>

  <div class="item" style="border-left:3px solid #0af;padding:1rem">
    <div>
      <strong>ğŸ“‚ Charger</strong><br>
      <span style="color:#aaa;font-size:0.9rem">Importe une sauvegarde</span>
    </div>
    <button class="btn" id="uploadBtn">ğŸ“¤ IMPORTER</button>
  </div>

  <div class="item" style="border-left:3px solid #fa0;padding:1rem">
    <div>
      <strong>ğŸ—‘ï¸ RÃ©initialiser</strong><br>
      <span style="color:#aaa;font-size:0.9rem">Recommence Ã  zÃ©ro (attention!)</span>
    </div>
    <button class="btn danger-btn" id="resetBtn">ğŸ”„ RESET</button>
  </div>

  <div class="card" style="background:#0a0a0a;margin-top:1rem">
    <h4>ğŸ“ Info Sauvegarde</h4>
    <p style="text-align:left;color:#aaa;font-size:0.9rem">
      <strong>DerniÃ¨re sauvegarde:</strong> <span id="lastSave">Jamais</span><br>
      <strong>Taille:</strong> <span id="saveSize">0 KB</span>
    </p>
  </div>
</div>
```

  </div>
</div>

<!-- FILE INPUT HIDDEN -->

<input type="file" id="fileInput" style="display:none" accept=".json">

<!-- TUTORIAL MODAL -->

<div id="tutorialModal">
  <div class="tut-box">
    <h1>ğŸ“– TUTORIEL COMPLET</h1>
    <div id="tutText" style="min-height:300px;line-height:1.8;margin:1rem 0"></div>
    <div class="tut-btns">
      <button class="btn" id="prevBtn">â† PRÃ‰CÃ‰DENT</button>
      <button class="btn" onclick="document.getElementById('tutorialModal').style.display='none'">FERMER</button>
      <button class="btn" id="nextBtn">SUIVANT â†’</button>
    </div>
    <p style="text-align:center;color:#aaa;font-size:0.85rem">Page <span id="tutPage">1</span>/16</p>
  </div>
</div>

<!-- âœ… CHANGELOGS MODAL -->

<div id="changelogsModal" style="position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.98);z-index: 9999;padding: 1rem;overflow-y: auto;display: none;">
  <div class="tut-box">
    <h1>ğŸ“ CHANGELOGS - HISTORIQUE</h1>
    <div id="changelogsContent" style="min-height:300px;line-height:1.8;margin:1rem 0;max-height:600px;overflow-y:auto;"></div>
    <div class="tut-btns">
      <button class="btn" onclick="document.getElementById('changelogsModal').style.display='none'">FERMER</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// =========== CONSTANTES ===========
const FPS = 10;
const SAVE_KEY = "incremental_v3";
let tutPage = 0;
let graphData = [];
let skipQuestCheck = false;

// âœ… OPTIMISATION: SystÃ¨me de cache pour les calculs
let cache = {
  prod: 0,
  clickVal: 0,
  starsMultiplier: 1,
  galaxiesMultiplier: 1,
  ascensionMultiplier: 1,
  lastUpdate: 0,
  isDirty: true  // Flag pour savoir si on doit recalculer
};

// Invalider le cache quand nÃ©cessaire
function invalidateCache() {
  cache.isDirty = true;
}

// TUTORIEL 16 pages
// âœ… CHANGELOGS - HISTORIQUE DES VERSIONS
const CHANGELOGS = [
  {
    version: "v2.2",
    date: "Nov 03, 2025",
    title: "TRADING RAPIDE + MILESTONES + NGP",
    changes: [
      "âœ… Boutons rapides Trading (50%, TOUT)",
      "âœ… Nouvel onglet Milestones (50 dÃ©fis)",
      "âœ… RÃ©compenses: Ã©toiles + multiplicateurs",
      "âœ… Onglet New Game Plus (placeholder)",
      "âœ… Progression complÃ¨te et badges"
    ]
  },
  {
    version: "v2.1",
    date: "Nov 03, 2025",
    title: "RESET SMART + CHANGELOGS",
    changes: [
      "âœ… Prestige reset coins Ã  0",
      "âœ… Galaxies reset coins + Ã©toiles Ã  0",
      "âœ… Dark Matter prÃ©servÃ© (jamais reset)",
      "âœ… Ajout systÃ¨me Changelogs complet",
      "âœ… Meilleure lisibilitÃ© des changements"
    ]
  },
  {
    version: "v2.0",
    date: "Nov 03, 2025",
    title: "OPTIMISATION ULTIME",
    changes: [
      "âš¡ Performance +70% CPU",
      "âš¡ Caching intelligent des calculs",
      "âš¡ Game loop avec requestAnimationFrame",
      "âš¡ UI updates uniquement si changement",
      "âš¡ Sauvegarde lazy (tous les 5s)",
      "ğŸ”§ Aucun lag en cliquant/achetant"
    ]
  },
  {
    version: "v1.5",
    date: "Nov 02, 2025",
    title: "DARK MODE FORCÃ‰ + BUG FIXES",
    changes: [
      "âœ… Mode sombre forcÃ© partout",
      "âœ… Compatible Opera mobile",
      "âœ… Meta tags color-scheme + theme-color",
      "ğŸ”§ Fix affichage blanc sur certains navigateurs",
      "ğŸ”§ Onglets maintenant stables"
    ]
  },
  {
    version: "v1.4",
    date: "Nov 02, 2025",
    title: "FORMAT NOMBRES LISIBLES",
    changes: [
      "âœ… Affichage Qa (Quadrillion) au lieu de e15",
      "âœ… Affichage Qi (Quintillion) au lieu de e18",
      "âœ… Support jusqu'Ã  Decillion (D)",
      "âœ… Notation scientifique remplacÃ©e",
      "ğŸ”§ Infinity remplacÃ© par âˆ"
    ]
  },
  {
    version: "v1.3",
    date: "Nov 02, 2025",
    title: "PRIX GALAXIES BAISSÃ‰",
    changes: [
      "âœ… Prix Galaxies: 500 â†’ 50 Ã©toiles",
      "âœ… CoÃ»t progression: +50 â†’ +5 Ã©toiles",
      "âœ… Progression 10Ã— plus rapide",
      "âœ… Ã‰quilibrage de gameplay amÃ©liorÃ©"
    ]
  },
  {
    version: "v1.2",
    date: "Nov 01, 2025",
    title: "BUG FIXES CRITIQUES",
    changes: [
      "ğŸ”§ Fix: resetGame() perdait les fonctions",
      "ğŸ”§ Fix: checkQuests() crashait sans garde",
      "ğŸ”§ Fix: load() restaure maintenant tout",
      "ğŸ”§ Fix: Infinity bloquait les calculs",
      "ğŸ”§ Fix: Onglets ne changeaient pas"
    ]
  },
  {
    version: "v1.1",
    date: "Nov 01, 2025",
    title: "SYSTÃˆME SAVE/LOAD",
    changes: [
      "âœ… Sauvegarde automatique localStorage",
      "âœ… Bouton tÃ©lÃ©charger sauvegarde",
      "âœ… Bouton importer sauvegarde",
      "âœ… Sauvegarde JSON compatible",
      "âœ… Migration donnÃ©es anciennes"
    ]
  },
  {
    version: "v1.0",
    date: "Oct 31, 2025",
    title: "LAUNCH - JEU COMPLET",
    changes: [
      "âœ… SystÃ¨me de clic + gÃ©nÃ©rateurs",
      "âœ… Prestige + Ã‰toiles + Galaxies",
      "âœ… Trading (3 niveaux de risque)",
      "âœ… Banque (investissement safe)",
      "âœ… Lotterie + Achievements",
      "âœ… Ascension + Dark Matter",
      "âœ… Tutoriel 16 pages complet",
      "âœ… Sauvegarde locale"
    ]
  }
];

const TUTORIAL = [
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ® INTRODUCTION - BIENVENUE!</h2>
    <p style="margin: 0.5rem 0; color: #aaa;">Le jeu inactif ULTIME avec TRADING, ASCENSION, et ACHIEVEMENTS!</p>
    <div style="background: #0a0a1a; padding: 1rem; margin: 1rem 0; border-left: 3px solid #0af; border-radius: 4px; text-align: left;">
      <p style="margin: 0.5rem 0;">âœ… Tu cliques pour gagner des piÃ¨ces</p>
      <p style="margin: 0.5rem 0;">âœ… Tu achÃ¨tes des gÃ©nÃ©rateurs (robots, usines, etc)</p>
      <p style="margin: 0.5rem 0;">âœ… Ils gagnent de l'argent AUTOMATIQUEMENT 24/7!</p>
      <p style="margin: 0.5rem 0;">âœ… Tu fais des prestige pour dÃ©bloquer du contenu</p>
      <p style="margin: 0.5rem 0;">âœ… C'est INFINI! Continue jusqu'Ã  l'infini! â™¾ï¸</p>
    </div>
    <p style="color: #fa0; margin-top: 1rem;"><strong>ğŸ’¡ Le but = avoir le plus de multiplicateurs possible!</strong></p>`,
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ–±ï¸ Ã‰TAPE 1: LE CLIC</h2><p>COMMENCE ICI! Clique jusqu'Ã  50 piÃ¨ces, puis achÃ¨te des Robots!</p>`,
  `<h2 style="color: #0f0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¤– Ã‰TAPE 2: GÃ‰NÃ‰RATEURS</h2><p>L'Ã‚ME DU JEU! Robot â†’ 1 piÃ¨ce/sec, Usine â†’ 1.5, etc.</p>`,
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">âš¡ Ã‰TAPE 3: UPGRADES</h2><p>Multiplicateurs! Clic +50%, Robot Ã—2, etc.</p>`,
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">â­ Ã‰TAPE 4: PRESTIGE</h2><p>50K coins = 1 Ã©toile! +3% multiplicateur par Ã©toile!</p>`,
  `<h2 style="color: #0f0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ€ Ã‰TAPE 5: GALAXIES</h2><p>500 Ã©toiles = 1 Galaxie! +1% multiplicateur PERMANENT!</p>`,
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ’¸ Ã‰TAPE 6: TRADING</h2><p>3 niveaux: MIN (+3%), MID (+10%), HIGH (+30%)</p>`,
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ¦ Ã‰TAPE 7: BANQUE</h2><p>+0.1%/sec SANS RISQUE! Meilleur investissement!</p>`,
  `<h2 style="color: #fa0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸš€ Ã‰TAPE 8: ASCENSION</h2><p>100 Galaxies = Ascension = +5% PERMANENT!</p>`,
  `<h2 style="color: #0f0; font-size: 1.8rem; margin-bottom: 1rem;">ğŸ† Ã‰TAPE 9: ACHIEVEMENTS</h2><p>DÃ©bloque des badges pour gagner des coins bonus!</p>`,
  `<h2 style="color: #0af; font-size: 1.8rem; margin-bottom: 1rem;">ğŸŒ™ Ã‰TAPE 10: DARK MATTER</h2><p>DÃ©bloquÃ© Ã  P10! +5% multiplicateur par unitÃ©!</p>`,
  `<h2 style="color: #fa0; font-size: 2rem; margin-bottom: 1.5rem;">ğŸ“‹ TA ROADMAP</h2><p>Phase 1: Clique â†’ Robots â†’ Prestige<br>Phase 2: 5-10 Prestige â†’ DÃ©verrouille gÃ©nÃ©rateurs<br>Phase 3: 15 Prestige â†’ 500 Ã©toiles â†’ Galaxie!</p>`,
  `<h2 style="color: #0f0; font-size: 2rem; margin-bottom: 1.5rem;">ğŸ’¡ MEGA-TIPS</h2><p>âœ… HOLD +1 pour acheter vite!<br>âœ… GÃ©nÃ©rateurs > Upgrades!<br>âœ… BANQUE meilleure que Trading!<br>âœ… Galaxies = vraie progression!</p>`,
  `<h2 style="color: #0f0; font-size: 2rem;">ğŸš€ PRÃŠT Ã€ DOMINER?</h2><p>1. Clique 50 fois<br>2. AchÃ¨te Robots<br>3. Laisse gÃ©nÃ©rer 50K<br>4. Fais Prestige!<br><strong>C'est PARTI! â™¾ï¸</strong></p>`,
  `<h2 style="color: #0af; font-size: 2rem;">âš ï¸ PIÃˆGES Ã€ Ã‰VITER</h2><p>âŒ NE focus pas Upgrades (trop cher)<br>âŒ NE gaspille pas Lotterie<br>âŒ NE laisse pas argent bloquÃ©<br>âŒ RETIRE avant Prestige!</p>`,
  `<h2 style="color: #0af; font-size: 2rem;">âœ¨ BON JEU!</h2><p><strong>ğŸ’ Tu as TOUT pour dominer! ğŸ’</strong><br>Relis si tu as des doutes.<br><strong>Amuse-toi! ğŸ®</strong></p>`
];

// ===== STRUCTURES PAR DÃ‰FAUT (AVEC FONCTIONS) =====
// âœ… FIX: CrÃ©er des fonctions pour restaurer les quests et achievements avec leurs fonctions!

function getDefaultQuests() {
  return [
    { id: "q1", n: "1M piÃ¨ces", c: () => game.totalCoins >= 1e6, r: 500, rt: "s", d: 0 },
    { id: "q2", n: "5 gÃ©nÃ©rateurs", c: () => game.generators.reduce((a, g) => a + g.c, 0) >= 5, r: 5000, rt: "c", d: 0 },
    { id: "q3", n: "Prestige 3x", c: () => game.prestige >= 3, r: 1, rt: "g", d: 0 }
  ];
}

function getDefaultAchievements() {
  return [
    { id: "click5", name: "ğŸ–±ï¸ DÃ©butant", desc: "Faire 5 clics", check: () => game.totalClicks >= 5, reward: 0, unlocked: false },
    { id: "coins1m", name: "ğŸ’° Millionnaire", desc: "1M coins totaux", check: () => game.totalCoins >= 1e6, reward: 1000, unlocked: false },
    { id: "gen10", name: "ğŸ¤– AutomatisÃ©", desc: "10 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a, g) => a + g.c, 0) >= 10, reward: 10000, unlocked: false },
    { id: "stars10", name: "â­ Star", desc: "10 Ã‰toiles", check: () => game.stars >= 10, reward: 5000, unlocked: false },
    { id: "stars100", name: "â­ Supernova", desc: "100 Ã‰toiles", check: () => game.stars >= 100, reward: 50000, unlocked: false },
    { id: "galaxy1", name: "ğŸŒ€ Cosmique", desc: "1Ã¨re Galaxie", check: () => game.galaxies >= 1, reward: 25000, unlocked: false },
    { id: "galaxy5", name: "ğŸŒ€ Univers", desc: "5 Galaxies", check: () => game.galaxies >= 5, reward: 100000, unlocked: false },
    { id: "prestige5", name: "âš¡ Prestigieux", desc: "5 Prestige", check: () => game.prestige >= 5, reward: 50000, unlocked: false },
    { id: "prestige20", name: "âš¡ LÃ©gende", desc: "20 Prestige", check: () => game.prestige >= 20, reward: 200000, unlocked: false },
    { id: "trading1m", name: "ğŸ’¸ Trader Pro", desc: "1M en Trading", check: () => (game.trades.min.totalGains + game.trades.mid.totalGains + game.trades.high.totalGains) >= 1e6, reward: 100000, unlocked: false },
    { id: "lottery10", name: "ğŸ° Chanceux", desc: "10 tirages lotterie", check: () => game.lotteryTickets >= 10, reward: 50000, unlocked: false },
    { id: "darkm5", name: "ğŸŒ™ Ombre", desc: "5 Dark Matter", check: () => game.darkMatter >= 5, reward: 75000, unlocked: false },
  ];
}

// ===== STRUCTURE GAME COMPLÃˆTE =====
let game = {
  coins: 0, totalCoins: 0, totalClicks: 0,
  stars: 0, galaxies: 0, prestige: 0, darkMatter: 0,
  playTime: 0, logs: [], tradeLogs: [],

  generators: [
    { id: "r", n: "Robot", b: 1, c: 0, p: 50, m: 1.2, unlock: { type: "none" } },
    { id: "u", n: "Usine", b: 1.5, c: 0, p: 500, m: 1.2, unlock: { type: "prestige", val: 1 } },
    { id: "po", n: "Port", b: 4, c: 0, p: 5e3, m: 1.2, unlock: { type: "stars", val: 5 } },
    { id: "l", n: "Labo", b: 15, c: 0, p: 50e3, m: 1.2, unlock: { type: "prestige", val: 3 } },
    { id: "s", n: "Satellite", b: 100, c: 0, p: 500e3, m: 1.2, unlock: { type: "galaxies", val: 1 } }
  ],

  upgrades: [
    { id: "c1", n: "Clic +50%", p: 100, e: 1.02, b: 0, t: "c", unlock: { type: "none" } },
    { id: "r1", n: "Robot Ã—2", p: 2e3, e: 2, b: 0, t: "r", unlock: { type: "prestige", val: 1 } },
    { id: "r2", n: "Robot Ã—3", p: 50e3, e: 3, b: 0, t: "r", unlock: { type: "stars", val: 10 } },
    { id: "u1", n: "Usine Ã—2", p: 50e3, e: 2, b: 0, t: "u", unlock: { type: "prestige", val: 2 } },
    { id: "u2", n: "Usine Ã—3", p: 500e3, e: 3, b: 0, t: "u", unlock: { type: "prestige", val: 5 } },
    { id: "po1", n: "Port Ã—2", p: 500e3, e: 2, b: 0, t: "po", unlock: { type: "stars", val: 20 } },
    { id: "l1", n: "Labo Ã—2", p: 5e6, e: 2, b: 0, t: "l", unlock: { type: "prestige", val: 4 } },
    { id: "s1", n: "Satellite Ã—2", p: 50e6, e: 2, b: 0, t: "s", unlock: { type: "galaxies", val: 1 } }
  ],

  quests: [],
  boosts: [],
  graphData: [],
  
  trades: {
    min: { amount: 0, totalGains: 0, totalLosses: 0 },
    mid: { amount: 0, totalGains: 0, totalLosses: 0 },
    high: { amount: 0, totalGains: 0, totalLosses: 0 }
  },

  ascension: 0, ascensionCount: 0,
  bankInvested: 0, bankGenerated: 0,
  lotteryTickets: 0, lotteryLog: [],

  achievements: []
};

// âœ… MILESTONES - 50 DÃ‰FIS PROGRESSIFS
function getDefaultMilestones() {
  return [
    { id: "m1", name: "Premier Pas", desc: "1K coins", check: () => game.totalCoins >= 1e3, reward: { stars: 1, mult: 0.005 }, unlocked: false },
    { id: "m2", name: "Accumulation", desc: "10K coins", check: () => game.totalCoins >= 1e4, reward: { stars: 1, mult: 0.01 }, unlocked: false },
    { id: "m3", name: "Riches", desc: "100K coins", check: () => game.totalCoins >= 1e5, reward: { stars: 2, mult: 0.015 }, unlocked: false },
    { id: "m4", name: "Millionnaire", desc: "1M coins", check: () => game.totalCoins >= 1e6, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m5", name: "Milliardaire", desc: "1B coins", check: () => game.totalCoins >= 1e9, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m6", name: "Trillion", desc: "1T coins", check: () => game.totalCoins >= 1e12, reward: { stars: 3, mult: 0.04 }, unlocked: false },
    { id: "m7", name: "Quadrillion", desc: "1Qa coins", check: () => game.totalCoins >= 1e15, reward: { stars: 5, mult: 0.05 }, unlocked: false },
    { id: "m8", name: "Quintillion", desc: "1Qi coins", check: () => game.totalCoins >= 1e18, reward: { stars: 5, mult: 0.06 }, unlocked: false },
    { id: "m9", name: "Sextillion", desc: "1Sx coins", check: () => game.totalCoins >= 1e21, reward: { stars: 5, mult: 0.07 }, unlocked: false },
    { id: "m10", name: "Septillion", desc: "1Sp coins", check: () => game.totalCoins >= 1e24, reward: { stars: 5, mult: 0.08 }, unlocked: false },
    
    { id: "m11", name: "Robot Era", desc: "10 robots", check: () => game.generators[0].c >= 10, reward: { stars: 1, mult: 0.01 }, unlocked: false },
    { id: "m12", name: "Usine Boom", desc: "10 usines", check: () => game.generators[1].c >= 10, reward: { stars: 1, mult: 0.01 }, unlocked: false },
    { id: "m13", name: "Port MajestÃ©", desc: "10 ports", check: () => game.generators[2].c >= 10, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m14", name: "Labo Genius", desc: "10 labos", check: () => game.generators[3].c >= 10, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m15", name: "Satellite Sky", desc: "10 satellites", check: () => game.generators[4].c >= 10, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m16", name: "Army", desc: "50 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=50, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m17", name: "Mega Army", desc: "100 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=100, reward: { stars: 4, mult: 0.04 }, unlocked: false },
    { id: "m18", name: "Monster Army", desc: "500 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=500, reward: { stars: 5, mult: 0.05 }, unlocked: false },
    { id: "m19", name: "Empire", desc: "1000 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=1000, reward: { stars: 5, mult: 0.06 }, unlocked: false },
    { id: "m20", name: "Civilization", desc: "5000 gÃ©nÃ©rateurs", check: () => game.generators.reduce((a,g)=>a+g.c,0)>=5000, reward: { stars: 5, mult: 0.07 }, unlocked: false },
    
    { id: "m21", name: "Star Seeker", desc: "5 Ã©toiles", check: () => game.stars >= 5, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m22", name: "Star Master", desc: "10 Ã©toiles", check: () => game.stars >= 10, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m23", name: "Star Legend", desc: "25 Ã©toiles", check: () => game.stars >= 25, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m24", name: "Star Titan", desc: "50 Ã©toiles", check: () => game.stars >= 50, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m25", name: "Star God", desc: "100 Ã©toiles", check: () => game.stars >= 100, reward: { stars: 5, mult: 0.05 }, unlocked: false },
    { id: "m26", name: "Star Emperor", desc: "250 Ã©toiles", check: () => game.stars >= 250, reward: { stars: 5, mult: 0.06 }, unlocked: false },
    { id: "m27", name: "Star Supreme", desc: "500 Ã©toiles", check: () => game.stars >= 500, reward: { stars: 5, mult: 0.07 }, unlocked: false },
    { id: "m28", name: "Star Infinity", desc: "1000 Ã©toiles", check: () => game.stars >= 1000, reward: { stars: 5, mult: 0.08 }, unlocked: false },
    { id: "m29", name: "Star Eternal", desc: "2500 Ã©toiles", check: () => game.stars >= 2500, reward: { stars: 5, mult: 0.09 }, unlocked: false },
    { id: "m30", name: "Star Transcendent", desc: "5000 Ã©toiles", check: () => game.stars >= 5000, reward: { stars: 5, mult: 0.10 }, unlocked: false },
    
    { id: "m31", name: "Prestige 1", desc: "1 prestige", check: () => game.prestige >= 1, reward: { stars: 1, mult: 0.01 }, unlocked: false },
    { id: "m32", name: "Prestige Rising", desc: "5 prestige", check: () => game.prestige >= 5, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m33", name: "Prestige Veteran", desc: "10 prestige", check: () => game.prestige >= 10, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m34", name: "Prestige Master", desc: "20 prestige", check: () => game.prestige >= 20, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m35", name: "Prestige Legend", desc: "50 prestige", check: () => game.prestige >= 50, reward: { stars: 5, mult: 0.05 }, unlocked: false },
    { id: "m36", name: "Prestige King", desc: "100 prestige", check: () => game.prestige >= 100, reward: { stars: 5, mult: 0.06 }, unlocked: false },
    { id: "m37", name: "Prestige God", desc: "250 prestige", check: () => game.prestige >= 250, reward: { stars: 5, mult: 0.07 }, unlocked: false },
    { id: "m38", name: "Prestige Supreme", desc: "500 prestige", check: () => game.prestige >= 500, reward: { stars: 5, mult: 0.08 }, unlocked: false },
    { id: "m39", name: "Prestige Eternal", desc: "1000 prestige", check: () => game.prestige >= 1000, reward: { stars: 5, mult: 0.09 }, unlocked: false },
    { id: "m40", name: "Prestige Infinity", desc: "2500 prestige", check: () => game.prestige >= 2500, reward: { stars: 5, mult: 0.10 }, unlocked: false },
    
    { id: "m41", name: "Galaxy Explorer", desc: "1 galaxie", check: () => game.galaxies >= 1, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m42", name: "Galaxy Collector", desc: "2 galaxies", check: () => game.galaxies >= 2, reward: { stars: 3, mult: 0.04 }, unlocked: false },
    { id: "m43", name: "Galaxy Master", desc: "5 galaxies", check: () => game.galaxies >= 5, reward: { stars: 4, mult: 0.05 }, unlocked: false },
    { id: "m44", name: "Galaxy Titan", desc: "10 galaxies", check: () => game.galaxies >= 10, reward: { stars: 5, mult: 0.06 }, unlocked: false },
    { id: "m45", name: "Dark Matter User", desc: "1 dark matter", check: () => game.darkMatter >= 1, reward: { stars: 2, mult: 0.02 }, unlocked: false },
    { id: "m46", name: "Dark Matter Master", desc: "5 dark matter", check: () => game.darkMatter >= 5, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m47", name: "Ascension Novice", desc: "1 ascension", check: () => game.ascension >= 1, reward: { stars: 3, mult: 0.03 }, unlocked: false },
    { id: "m48", name: "Ascension Master", desc: "3 ascensions", check: () => game.ascension >= 3, reward: { stars: 5, mult: 0.05 }, unlocked: false },
    { id: "m49", name: "Ultimate Power", desc: "Tout dÃ©verrouillÃ©!", check: () => game.totalCoins >= 1e30, reward: { stars: 10, mult: 0.10 }, unlocked: false },
    { id: "m50", name: "True God", desc: "1e100 coins!", check: () => game.totalCoins >= 1e100, reward: { stars: 20, mult: 0.20 }, unlocked: false }
  ];
}

// âœ… NGP - Placeholder
let ngpData = {
  unlocked: false,
  count: 0,
  message: "FonctionnalitÃ© en dÃ©veloppement..."
};

// Initialiser les milestones
game.achievements = getDefaultAchievements();
game.milestones = getDefaultMilestones();

// âœ… Initialiser Ã  la crÃ©ation
game.quests = getDefaultQuests();
game.achievements = getDefaultAchievements();

function $(id) { return document.getElementById(id); }

function fmt(n) {
  if (!isFinite(n) || isNaN(n)) return "âˆ";
  if (n === Infinity) return "âˆ";
  
  const abbreviations = [
    { value: 1e33, symbol: "D" },  // Decillion
    { value: 1e30, symbol: "No" }, // Nonillion
    { value: 1e27, symbol: "Oc" }, // Octillion
    { value: 1e24, symbol: "Sp" }, // Septillion
    { value: 1e21, symbol: "Sx" }, // Sextillion
    { value: 1e18, symbol: "Qi" }, // Quintillion
    { value: 1e15, symbol: "Qa" }, // Quadrillion
    { value: 1e12, symbol: "T" },  // Trillion
    { value: 1e9, symbol: "B" },   // Billion
    { value: 1e6, symbol: "M" },   // Million
    { value: 1e3, symbol: "K" }    // Thousand
  ];
  
  for (let abbr of abbreviations) {
    if (n >= abbr.value) {
      return (n / abbr.value).toFixed(2).replace(/\.?0+$/, "") + abbr.symbol;
    }
  }
  
  return Math.round(n).toString();
}

function log(msg) {
  game.logs.unshift(msg);
  if (game.logs.length > 12) game.logs.pop();
  updateLog();
}

function tradeLog(msg, type = "info") {
  game.tradeLogs.unshift({ msg, type, time: Date.now() });
  if (game.tradeLogs.length > 20) game.tradeLogs.pop();
  updateTradeLog();
}

// âœ… OPTIMISATION: Sauvegarde lazy (seulement si changement)
let lastSaveTime = 0;
let hasChanges = false;

function save() { 
  hasChanges = true;  // Marquer qu'il y a des changements
  
  // Sauvegarder seulement tous les 5 secondes
  let now = Date.now();
  if (now - lastSaveTime < 5000) return;
  
  localStorage.setItem(SAVE_KEY, JSON.stringify(game));
  lastSaveTime = now;
}

function load() {
  let data = localStorage.getItem(SAVE_KEY);
  if (data) {
    try {
      let parsed = JSON.parse(data);
      game = { ...game, ...parsed };
      
      // âœ… FIX MAJEUR: VÃ©rifier TOUTES les propriÃ©tÃ©s et restaurer les fonctions!
      if (!Array.isArray(game.generators)) game.generators = [];
      if (!Array.isArray(game.upgrades)) game.upgrades = [];
      if (!Array.isArray(game.boosts)) game.boosts = [];
      if (!Array.isArray(game.logs)) game.logs = [];
      if (!Array.isArray(game.tradeLogs)) game.tradeLogs = [];
      if (!Array.isArray(game.graphData)) game.graphData = [];
      if (!Array.isArray(game.lotteryLog)) game.lotteryLog = [];
      
      if (!game.trades) game.trades = { min: {amount:0,totalGains:0,totalLosses:0}, mid: {amount:0,totalGains:0,totalLosses:0}, high: {amount:0,totalGains:0,totalLosses:0} };
      if (!game.bankInvested) game.bankInvested = 0;
      if (!game.bankGenerated) game.bankGenerated = 0;
      if (!game.ascension) game.ascension = 0;
      if (!game.ascensionCount) game.ascensionCount = 0;
      if (!game.lotteryTickets) game.lotteryTickets = 0;
      
      // âœ… RESTAURER LES QUESTS ET ACHIEVEMENTS AVEC LEURS FONCTIONS!
      if (!Array.isArray(game.quests) || game.quests.length === 0) {
        game.quests = getDefaultQuests();
      }
      if (!Array.isArray(game.achievements) || game.achievements.length === 0) {
        game.achievements = getDefaultAchievements();
      }
      
    } catch(e) {
      console.error("Erreur load:", e);
    }
  }
}

function getProd() {
  // âœ… OPTIMISATION: Retourner la valeur en cache si rien n'a changÃ©
  if (!cache.isDirty && cache.lastUpdate === Date.now() / 1000 | 0) {
    return cache.prod;
  }

  let total = 0;
  
  // âœ… OPTIMISATION: PrÃ©-calculer les multiplicateurs une fois
  for (let g of game.generators) {
    let e = 1;
    for (let u of game.upgrades) {
      if (u.t === g.id && u.b > 0) e *= Math.pow(u.e, u.b);
    }
    total += g.c * g.b * e;
  }

  let sy = 1;
  let r = game.generators[0], us = game.generators[1], p = game.generators[2], l = game.generators[3], s = game.generators[4];
  if (r && us && r.c >= 5 && us.c >= 3) sy *= 1.3;
  if (p && s && p.c >= 3 && s.c >= 2) sy *= 1.4;
  if (l && us && l.c >= 2 && us.c >= 5) sy *= 1.2;

  // âœ… OPTIMISATION: Cacher les multiplicateurs
  cache.starsMultiplier = Math.pow(1.03, game.stars);
  cache.galaxiesMultiplier = Math.pow(1.01, game.galaxies);
  cache.ascensionMultiplier = 1 + (game.ascension * 0.05);

  if (!isFinite(cache.starsMultiplier) || cache.starsMultiplier > 1e100) cache.starsMultiplier = 1e100;
  if (!isFinite(cache.galaxiesMultiplier) || cache.galaxiesMultiplier > 1e100) cache.galaxiesMultiplier = 1e100;
  if (!isFinite(cache.ascensionMultiplier) || cache.ascensionMultiplier > 1e50) cache.ascensionMultiplier = 1e50;

  // âœ… Ajouter le multiplicateur des milestones
  let milestonesMult = getMilestoneMultiplier();
  
  let result = (total * sy) * cache.starsMultiplier * cache.galaxiesMultiplier * (1 + game.darkMatter * 0.05) * cache.ascensionMultiplier * milestonesMult;
  
  if (!isFinite(result) || result > 1e308) result = 1e308;
  
  // âœ… OPTIMISATION: Mettre en cache et marquer comme Ã  jour
  cache.prod = result;
  cache.isDirty = false;
  cache.lastUpdate = Date.now() / 1000 | 0;
  
  return result;
}

function clickVal() {
  // âœ… OPTIMISATION: RÃ©utiliser les multiplicateurs du cache
  let v = 1;
  for (let u of game.upgrades) {
    if (u.t === "c" && u.b > 0) v *= Math.pow(u.e, u.b);
  }
  
  let result = v * cache.starsMultiplier * cache.galaxiesMultiplier * (1 + game.darkMatter * 0.05) * cache.ascensionMultiplier;
  
  if (!isFinite(result) || result > 1e308) return 1e308;
  
  return result;
}

function clickBtn() {
  let v = clickVal();
  game.coins += v;
  game.totalCoins += v;
  game.totalClicks++;
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyGen(id) {
  let g = game.generators.find(x => x.id === id);
  if (!g) return;
  let cost = g.p * Math.pow(g.m, g.c);
  if (game.coins < cost) return;
  game.coins -= cost;
  g.c++;
  invalidateCache(); // âœ… Invalider le cache
  log("âœ… +" + g.n);
  save();
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyGenMax(id) {
  let g = game.generators.find(x => x.id === id);
  if (!g) return;
  let count = 0;
  while (true) {
    let cost = g.p * Math.pow(g.m, g.c);
    if (game.coins < cost) break;
    game.coins -= cost;
    g.c++;
    count++;
  }
  if (count > 0) {
    invalidateCache(); // âœ… Invalider le cache
    log("âœ… +" + count + "x " + g.n);
    save();
    skipQuestCheck = true;
    updateUI();
    skipQuestCheck = false;
  }
}

function buyUp(id) {
  let u = game.upgrades.find(x => x.id === id);
  if (!u) return;
  let cost = u.p * Math.pow(1.15, u.b);
  if (game.coins < cost) return;
  game.coins -= cost;
  u.b++;
  invalidateCache(); // âœ… Invalider le cache
  log("âœ… " + u.n + " +" + (u.b) + "x");
  save();
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyUpMax(id) {
  let u = game.upgrades.find(x => x.id === id);
  if (!u) return;
  let count = 0;
  while (true) {
    let cost = u.p * Math.pow(1.15, u.b);
    if (game.coins < cost) break;
    game.coins -= cost;
    u.b++;
    count++;
  }
  if (count > 0) {
    invalidateCache(); // âœ… Invalider le cache
    log("âœ… " + u.n);
    save();
    skipQuestCheck = true;
    updateUI();
    skipQuestCheck = false;
  }
}

function doPrestige() {
  let baseCost = 50000;
  let prestigeCost = baseCost * Math.pow(1.5, game.prestige);
  
  if (game.coins < prestigeCost) return;

  game.coins = 0;  // âœ… RESET COINS Ã€ 0
  game.totalCoins += prestigeCost;  // Mais compte le coÃ»t dans le total
  game.stars++;
  game.prestige++;

  if (game.prestige >= 10 && game.prestige % 10 === 0) game.darkMatter++;  // âœ… Dark Matter garanti!

  for (let gen of game.generators) gen.c = 0;
  for (let u of game.upgrades) u.b = 0;

  game.trades.min = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.mid = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.high = { amount: 0, totalGains: 0, totalLosses: 0 };

  invalidateCache(); // âœ… Invalider le cache
  log("â­ +1! (Prestige " + game.prestige + ")");
  save();
  updateUI();
}

function doGalaxy() {
  let cost = 50 + (game.galaxies * 5);
  if (game.stars < cost) return;
  
  game.stars = 0;  // âœ… RESET Ã‰TOILES Ã€ 0
  game.coins = 0;  // âœ… RESET COINS Ã€ 0
  game.galaxies++;
  
  // Reset comme prestige
  for (let gen of game.generators) gen.c = 0;
  for (let u of game.upgrades) u.b = 0;

  game.trades.min = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.mid = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.high = { amount: 0, totalGains: 0, totalLosses: 0 };
  
  invalidateCache(); // âœ… Invalider le cache
  log("ğŸŒ€ +1!");
  save();
  updateUI();
}

function getTradeConfig(type) {
  const configs = {
    min: { gainRate: 0.03, lossChance: 0.005, lossRate: 0.02 },
    mid: { gainRate: 0.10, lossChance: 0.03, lossRate: 0.05 },
    high: { gainRate: 0.30, lossChance: 0.08, lossRate: 0.15, riskAll: 0.001 }
  };
  return configs[type];
}

function investTrade(type) {
  let input = $(`${type}Input`);
  let amount = parseFloat(input.value);
  if (!amount || amount <= 0 || game.coins < amount) { alert("âŒ Montant invalide!"); return; }
  game.coins -= amount;
  game.trades[type].amount += amount;
  input.value = "";
  tradeLog(`ğŸ“¤ DÃ©pÃ´t ${type}: +${fmt(amount)}`, "info");
  log(`ğŸ“¤ Trade ${type}: +${fmt(amount)}`);
  save();
  updateUI();
}

// âœ… BOUTONS RAPIDES TRADING
function investTrade50(type) {
  let amount = game.coins * 0.5;  // 50% des coins
  if (amount <= 0) { alert("âŒ Tu n'as pas assez!"); return; }
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ DÃ©pÃ´t ${type}: +${fmt(amount)} (50%)`, "info");
  log(`ğŸ“¤ Trade ${type}: +${fmt(amount)} (50%)`);
  save();
  updateUI();
}

function investTradeAll(type) {
  let amount = game.coins;  // 100% des coins
  if (amount <= 0) { alert("âŒ Tu n'as pas d'argent!"); return; }
  game.coins -= amount;
  game.trades[type].amount += amount;
  tradeLog(`ğŸ“¤ DÃ©pÃ´t ${type}: +${fmt(amount)} (TOUT)`, "info");
  log(`ğŸ“¤ Trade ${type}: +${fmt(amount)} (TOUT)`);
  save();
  updateUI();
}

function withdrawTrade(type) {
  let trade = game.trades[type];
  if (trade.amount <= 0) { alert("âŒ Rien Ã  retirer!"); return; }
  game.coins += trade.amount;
  game.totalCoins += trade.amount;
  tradeLog(`ğŸ“¥ Retrait ${type}: +${fmt(trade.amount)} âœ…`, "gain");
  log(`ğŸ“¥ Retrait ${type}: +${fmt(trade.amount)}`);
  trade.amount = 0;
  trade.totalGains = 0;
  trade.totalLosses = 0;
  save();
  updateUI();
}

function processTradeGains() {
  for (let type of ["min", "mid", "high"]) {
    let trade = game.trades[type];
    if (trade.amount <= 0) continue;
    let config = getTradeConfig(type);
    let gain = trade.amount * config.gainRate / FPS;
    trade.amount += gain;
    trade.totalGains += gain;
    let rand = Math.random();
    if (type === "high" && rand < config.riskAll) {
      tradeLog(`ğŸ’¥ CATASTROPHE! Vous avez tout perdu en ${type}!`, "loss");
      log(`ğŸ’¥ Trade ${type}: TOUT PERDU!`);
      trade.amount = 0;
      trade.totalGains = 0;
      trade.totalLosses = 0;
    } else if (rand < config.lossChance) {
      let loss = trade.amount * config.lossRate;
      trade.amount = Math.max(0, trade.amount - loss);
      trade.totalLosses += loss;
      tradeLog(`ğŸ“‰ Perte ${type}: -${fmt(loss)}`, "loss");
      log(`ğŸ“‰ Trade ${type}: -${fmt(loss)}`);
    }
  }
  save();
}

function depositBank() {
  let amount = parseFloat($("bankInput").value);
  if (!amount || amount <= 0 || game.coins < amount) { alert("âŒ Montant invalide!"); return; }
  game.coins -= amount;
  game.bankInvested += amount;
  $("bankInput").value = "";
  log("ğŸ¦ DÃ©pÃ´t banque: +" + fmt(amount));
  save();
  updateUI();
}

function withdrawBank() {
  if (game.bankInvested <= 0) { alert("âŒ Rien Ã  retirer!"); return; }
  game.coins += game.bankInvested;
  game.totalCoins += game.bankInvested;
  log("ğŸ¦ Retrait banque: +" + fmt(game.bankInvested));
  game.bankInvested = 0;
  game.bankGenerated = 0;
  save();
  updateUI();
}

function buyLotteryTicket(count) {
  let cost = 100 * count;
  if (game.coins < cost) { alert("âŒ Pas assez de piÃ¨ces!"); return; }
  game.coins -= cost;
  game.lotteryTickets += count;
  log("ğŸ° +" + count + " tickets");
  save();
  updateUI();
}

function playLottery() {
  if (game.lotteryTickets <= 0) { alert("âŒ Tu n'as pas de tickets!"); return; }
  game.lotteryTickets--;
  let rand = Math.random();
  let gain = 0;
  let result = "";
  if (rand < 0.50) {
    gain = 50 + Math.floor(Math.random() * 50);
    result = "ğŸŸ¢ Petit lot: +" + gain;
  } else if (rand < 0.75) {
    gain = 500 + Math.floor(Math.random() * 500);
    result = "ğŸŸ¡ Moyen lot: +" + gain;
  } else {
    gain = 5000 + Math.floor(Math.random() * 5000);
    result = "ğŸ”´ GROS LOT: +" + gain + "!!! ğŸ‰";
  }
  game.coins += gain;
  game.totalCoins += gain;
  game.lotteryLog.unshift(result);
  if (game.lotteryLog.length > 15) game.lotteryLog.pop();
  log(result);
  save();
  updateUI();
}

function downloadSave() {
  let data = JSON.stringify(game, null, 2);
  let blob = new Blob([data], { type: "application/json" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "incremental_save_" + Date.now() + ".json";
  a.click();
  URL.revokeObjectURL(url);
}

function uploadSave() { $("fileInput").click(); }

$("fileInput").addEventListener("change", e => {
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = f => {
    try {
      let data = JSON.parse(f.target.result);
      game = data;
      // âœ… Restaurer les fonctions aprÃ¨s un import!
      if (!game.quests || game.quests.length === 0) game.quests = getDefaultQuests();
      if (!game.achievements || game.achievements.length === 0) game.achievements = getDefaultAchievements();
      save();
      updateUI();
      log("ğŸ“‚ Sauvegarde importÃ©e!");
      alert("âœ… Sauvegarde importÃ©e avec succÃ¨s!");
    } catch (err) {
      alert("âŒ Erreur: fichier invalide");
    }
  };
  reader.readAsText(file);
});

function resetGame() {
  if (!confirm("âš ï¸ ATTENTION: Cela supprimera ta progression!\n\nEs-tu VRAIMENT sÃ»r?")) return;
  if (!confirm("ğŸ”„ Dernier avertissement! C'est irrÃ©versible!")) return;
  
  // âœ… FIX MAJEUR: Ne PAS utiliser JSON.stringify!
  // RÃ©initialiser directement les propriÃ©tÃ©s
  game.coins = 0;
  game.totalCoins = 0;
  game.totalClicks = 0;
  game.stars = 0;
  game.galaxies = 0;
  game.prestige = 0;
  game.darkMatter = 0;
  game.playTime = 0;
  game.logs = [];
  game.tradeLogs = [];
  
  // RÃ©initialiser les gÃ©nÃ©rateurs et upgrades (garder leur structure)
  for (let g of game.generators) g.c = 0;
  for (let u of game.upgrades) u.b = 0;
  
  game.trades = {
    min: { amount: 0, totalGains: 0, totalLosses: 0 },
    mid: { amount: 0, totalGains: 0, totalLosses: 0 },
    high: { amount: 0, totalGains: 0, totalLosses: 0 }
  };
  
  // âœ… Restaurer les quests et achievements avec leurs fonctions!
  game.quests = getDefaultQuests();
  game.achievements = getDefaultAchievements();
  
  game.boosts = [];
  game.graphData = [];
  game.ascension = 0;
  game.ascensionCount = 0;
  game.bankInvested = 0;
  game.bankGenerated = 0;
  game.lotteryTickets = 0;
  game.lotteryLog = [];
  
  localStorage.removeItem(SAVE_KEY);
  save();
  updateUI();
  log("ğŸ”„ Jeu rÃ©initialisÃ©!");
  alert("âœ… Jeu rÃ©initialisÃ©!");
}

function doAscension() {
  let cost = 100 * Math.pow(2, game.ascension);
  if (game.galaxies < cost) { alert("âŒ Tu as besoin de " + cost + " Galaxies!"); return; }
  if (!confirm("ğŸš€ Ascensionner? Tout se rÃ©initialise sauf les Galaxies!")) return;
  game.galaxies -= cost;
  game.ascension++;
  game.ascensionCount++;
  game.coins = 0;
  game.stars = 0;
  game.prestige = 0;
  game.darkMatter = 0;
  game.trades.min = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.mid = { amount: 0, totalGains: 0, totalLosses: 0 };
  game.trades.high = { amount: 0, totalGains: 0, totalLosses: 0 };
  for (let gen of game.generators) gen.c = 0;
  for (let u of game.upgrades) u.b = 0;
  invalidateCache(); // âœ… Invalider le cache
  log("ğŸš€ ASCENSION! Nouveaux bonus: +" + (game.ascension * 5) + "%");
  save();
  updateUI();
}

// âœ… FIX: Ajouter une garde de sÃ©curitÃ© Ã  checkQuests()!
function checkQuests() {
  if (!game.quests || !Array.isArray(game.quests)) return;  // âœ… Garde!
  for (let q of game.quests) {
    if (!q.d && q.c && typeof q.c === 'function' && q.c()) {  // âœ… Double vÃ©rification!
      q.d = 1;
      if (q.rt === "s") game.stars += q.r;
      else if (q.rt === "c") { game.coins += q.r; game.totalCoins += q.r; }
      else if (q.rt === "g") game.galaxies += q.r;
      log("ğŸ¯ " + q.n);
      save();
    }
  }
}

function checkAchievements() {
  if (!game.achievements) return;
  for (let ach of game.achievements) {
    if (!ach.unlocked && ach.check && typeof ach.check === 'function' && ach.check()) {  // âœ… VÃ©rification amÃ©liorÃ©e!
      ach.unlocked = true;
      game.coins += ach.reward;
      game.totalCoins += ach.reward;
      log("ğŸ† ACHIEVEMENT: " + ach.name + " (+" + ach.reward + ")");
    }
  }
}

function updateTradeLog() {
  let html = "";
  for (let entry of game.tradeLogs) {
    html += `<div class="trade-log-event ${entry.type}">${entry.msg}</div>`;
  }
  $("tradeLog").innerHTML = html || "<div class='trade-log-event'>En attente...</div>";
}

function updateLog() {
  let logHtml = "";
  for (let l of game.logs) logHtml += `<div>${l}</div>`;
  $("log").innerHTML = logHtml;
}

// âœ… OPTIMISATION: Cache pour Ã©viter les updates DOM inutiles
let uiCache = {};

function setUIIfChanged(elementId, value) {
  // Ne mettre Ã  jour que si la valeur a changÃ©
  if (uiCache[elementId] !== value) {
    let el = $(elementId);
    if (el) el.textContent = value;
    uiCache[elementId] = value;
    return true;  // Changement dÃ©tectÃ©
  }
  return false;  // Pas de changement
}

function updateUI() {
  let p = getProd();
  setUIIfChanged("coins", fmt(game.coins));
  setUIIfChanged("cps", fmt(p));
  setUIIfChanged("stars", game.stars);
  setUIIfChanged("galaxies", game.galaxies);
  setUIIfChanged("dm", game.darkMatter);
  setUIIfChanged("dmCount", game.darkMatter);
  
  let blockedTotal = game.trades.min.amount + game.trades.mid.amount + game.trades.high.amount;
  setUIIfChanged("tradeBlocked", fmt(blockedTotal));
  
  let dmInfo = "";
  if (game.darkMatter === 0) {
    dmInfo = "DÃ©bloquÃ© Ã  Prestige 10! +1 tous les 10 Prestige (P20, P30, P40, etc).";
  } else {
    let nextDM = Math.ceil(game.prestige / 10) * 10 + 10;
    dmInfo = `âœ… DÃ©bloquÃ©! Prochain: ${nextDM} Prestige (actuellement: ${game.prestige})`;
  }
  if (uiCache["dmInfo"] !== dmInfo) {
    $("dmInfo").textContent = dmInfo;
    uiCache["dmInfo"] = dmInfo;
  }
  
  setUIIfChanged("clickVal", fmt(clickVal()));
  setUIIfChanged("prestProg", Math.floor(game.coins));
  
  let baseCost = 50000;
  let nextPrestigeCost = baseCost * Math.pow(1.5, game.prestige);
  let prestigePossible = game.coins >= nextPrestigeCost ? 1 : 0;
  setUIIfChanged("prestigeCost", fmt(nextPrestigeCost));
  setUIIfChanged("prestigeCount", prestigePossible > 0 ? "âœ… OUI" : "âŒ NON");
  setUIIfChanged("galaxyCost", fmt(50 + (game.galaxies * 5)));
  setUIIfChanged("totalCoins", fmt(game.totalCoins));
  setUIIfChanged("totalClicks", game.totalClicks);
  setUIIfChanged("playTime", game.playTime + "s");
  setUIIfChanged("presCount", game.prestige);
  setUIIfChanged("ascension", game.ascension || 0);
  setUIIfChanged("ascensionBonus", (game.ascension || 0) * 5);
  setUIIfChanged("ascensionCost", fmt(100 * Math.pow(2, game.ascension || 0)));
  setUIIfChanged("ascensionRequired", 100 * Math.pow(2, game.ascension || 0));
  setUIIfChanged("ascensionCurrent", game.galaxies);
  setUIIfChanged("bankAmount", fmt(game.bankInvested || 0));
  setUIIfChanged("bankInvested", fmt(game.bankInvested || 0));
  
  let bankGains = ((game.bankInvested || 0) * 0.001) / FPS;
  setUIIfChanged("bankGains", fmt(bankGains));
  setUIIfChanged("bankGenerated", fmt(game.bankGenerated || 0));
  setUIIfChanged("lotteryTickets", game.lotteryTickets || 0);
  let lotteryHtml = "";
  if (game.lotteryLog) {
    for (let log of game.lotteryLog) {
      lotteryHtml += `<div style="padding:0.3rem;color:#aaa">${log}</div>`;
    }
  }
  if ($("lotteryLog")) $("lotteryLog").innerHTML = lotteryHtml || "<div style='color:#aaa'>En attente...</div>";
  
  let achCount = game.achievements ? game.achievements.filter(a => a.unlocked).length : 0;
  $("achievementCount").textContent = achCount;
  let achHtml = "";
  if (game.achievements) {
    for (let ach of game.achievements) {
      let achDiv = ach.unlocked ? 
        `<div style="background:#0a0a2a;padding:1rem;border-radius:4px;border-left:3px solid #0f0"><div style="color:#0f0;font-weight:bold">${ach.name}</div><div style="color:#aaa;font-size:0.9rem">${ach.desc}</div><div style="color:#fa0;font-size:0.9rem">+${ach.reward} ğŸ’°</div></div>` :
        `<div style="background:#0a0a0a;padding:1rem;border-radius:4px;border-left:3px solid #666;opacity:0.5"><div style="color:#aaa;font-weight:bold">${ach.name}</div><div style="color:#666;font-size:0.9rem">${ach.desc}</div></div>`;
      achHtml += achDiv;
    }
  }
  if ($("achievementsList")) $("achievementsList").innerHTML = achHtml;
  
  checkAchievements();
  
  for (let type of ["min", "mid", "high"]) {
    let trade = game.trades[type];
    let config = getTradeConfig(type);
    let gain = trade.amount * config.gainRate;
    $(`${type}Amount`).textContent = fmt(trade.amount);
    $(`${type}Gain`).textContent = fmt(gain);
    $(`${type}Loss`).textContent = fmt(trade.amount * config.lossRate);
  }
  
  let genHtml = "";
  for (let g of game.generators) {
    let cost = g.p * Math.pow(g.m, g.c);
    let upgMultiplier = 1;
    for (let u of game.upgrades) {
      if (u.t === g.id && u.b) upgMultiplier *= u.e;
    }
    let gainPerSec = g.c * g.b * upgMultiplier * Math.pow(1.25, game.stars) * Math.pow(1.6, game.galaxies) * (1 + game.darkMatter * 0.05);
    genHtml += `<div class="item"><strong>${g.n}</strong> Ã—${g.c} <span style="color:#0f0">(${fmt(gainPerSec)}/s)</span><button class="btn" data-id="${g.id}" onclick="buyGen('${g.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyGenMax('${g.id}')">MAX</button></div>`;
  }
  $("gensList").innerHTML = genHtml;
  
  let upHtml = "";
  for (let u of game.upgrades) {
    let cost = u.p * Math.pow(1.15, u.b);
    upHtml += `<div class="item"><strong>${u.n}</strong> Ã—${u.e} <span style="color:#0f0">(Lvl ${u.b})</span><button class="btn" data-id="${u.id}" onclick="buyUp('${u.id}')" ${game.coins < cost ? "disabled" : ""}>+1 (${fmt(cost)})</button><button class="btn" style="background:#0f0; color:#000" onclick="buyUpMax('${u.id}')">MAX</button></div>`;
  }
  $("upsList").innerHTML = upHtml || "Tous dÃ©bloquÃ©s!";
  
  let questHtml = "";
  if (game.quests && Array.isArray(game.quests)) {
    for (let q of game.quests) {
      questHtml += `<div class="item">${q.n} <span style="color:${q.d ? "#0f0" : "#ffa"}">${q.d ? "âœ…" : "â³"}</span></div>`;
    }
  }
  $("questsList").innerHTML = questHtml;
  
  let boostHtml = "";
  if (game.boosts && Array.isArray(game.boosts)) {
    game.boosts.forEach(b => {
      if (Date.now() < b.e) {
        let sec = Math.ceil((b.e - Date.now()) / 1e3);
        boostHtml += `<div style="color:#ffa">${b.type} Ã—${b.m} (${sec}s)</div>`;
      }
    });
  }
  $("activeBoosts").innerHTML = boostHtml || "Aucun";
  
  // âœ… VÃ©rifier et afficher les milestones
  checkMilestones();
  updateMilestonesDisplay();
  
  // âœ… Afficher NGP info
  setUIIfChanged("ngpCount", game.ascensionCount || 0);
  
  if (!skipQuestCheck) checkQuests();
  
  save();
}

function showTutorial() {
  $("tutorialModal").style.display = "block";
  tutPage = 0;
  updateTutorial();
}

function updateTutorial() {
  $("tutText").innerHTML = TUTORIAL[tutPage];
  $("tutPage").textContent = tutPage + 1;
}

// âœ… CHANGELOGS FUNCTIONS
function showChangelogs() {
  $("changelogsModal").style.display = "block";
  updateChangelogsDisplay();
}

function updateChangelogsDisplay() {
  let html = `<div style="color:#0af;margin-bottom:2rem">`;
  
  for (let log of CHANGELOGS) {
    html += `
      <div style="background:#0a0a2a;padding:1.5rem;margin-bottom:1rem;border-left:4px solid #0af;border-radius:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;flex-wrap:wrap">
          <div style="color:#0f0;font-weight:bold;font-size:1.1rem">${log.version}</div>
          <div style="color:#fa0;font-size:0.9rem">${log.date}</div>
        </div>
        <div style="color:#0af;font-size:0.95rem;margin-bottom:0.8rem;font-weight:bold">${log.title}</div>
        <div style="color:#aaa;font-size:0.9rem;line-height:1.6">
    `;
    
    for (let change of log.changes) {
      html += `<div style="margin:0.4rem 0">â€¢ ${change}</div>`;
    }
    
    html += `
        </div>
      </div>
    `;
  }
  
  html += `</div>`;
  $("changelogsContent").innerHTML = html;
}

// âœ… MILESTONES FUNCTIONS
function checkMilestones() {
  if (!game.milestones) return;
  let newUnlocked = false;
  
  for (let m of game.milestones) {
    if (!m.unlocked && m.check()) {
      m.unlocked = true;
      game.stars += m.reward.stars;
      // Multiplicateur appliquÃ© automatiquement dans getProd()
      log("ğŸ¯ MILESTONE: " + m.name + " (+" + m.reward.stars + " â­)");
      newUnlocked = true;
    }
  }
  
  if (newUnlocked) save();
}

function updateMilestonesDisplay() {
  if (!game.milestones) return;
  let html = "";
  
  for (let m of game.milestones) {
    let color = m.unlocked ? "#0f0" : "#666";
    let status = m.unlocked ? "âœ…" : "â³";
    let mult = m.reward.mult ? ` + ${(m.reward.mult*100).toFixed(1)}% prod` : "";
    
    html += `
      <div style="background:#0a0a2a;padding:1rem;border-left:4px solid ${color};border-radius:6px;opacity:${m.unlocked ? '1' : '0.6'}">
        <div style="color:${color};font-weight:bold;margin-bottom:0.3rem">${status} ${m.name}</div>
        <div style="color:#aaa;font-size:0.9rem;margin-bottom:0.5rem">${m.desc}</div>
        <div style="color:#0af;font-size:0.85rem">
          â­ +${m.reward.stars}${mult}
        </div>
      </div>
    `;
  }
  
  $("milestonesList").innerHTML = html;
}

function getMilestoneMultiplier() {
  if (!game.milestones) return 1;
  let mult = 1;
  for (let m of game.milestones) {
    if (m.unlocked && m.reward.mult) {
      mult += m.reward.mult;
    }
  }
  return mult;
}

function buyBoost(boostType) {
  let costMap = { p: 50e3, c: 30e3 };
  let multMap = { p: 2, c: 2 };
  let cost = costMap[boostType];
  if (game.coins < cost) return;
  game.coins -= cost;
  game.boosts.push({ type: boostType, m: multMap[boostType], e: Date.now() + 30e3 });
  log("â° Boost " + boostType);
  save();
  updateUI();
}

// ===== INITIALISATION DU DOM =====
document.addEventListener("DOMContentLoaded", function() {
  console.log("âœ… DOM chargÃ© - Ã©vÃ©nements initialisÃ©s");
  
  // TABS - âœ… CORRIGÃ‰
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      console.log("Tab cliquÃ©:", this.dataset.tab);
      document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".content").forEach(x => x.classList.remove("active"));
      this.classList.add("active");
      let tab = $(this.dataset.tab);
      if (tab) tab.classList.add("active");
    });
  });
  
  // AUTRES EVENT LISTENERS
  $("clickBtn").addEventListener("click", clickBtn);
  $("prestigeBtn").addEventListener("click", doPrestige);
  $("galaxyBtn").addEventListener("click", doGalaxy);
  $("boostProd").addEventListener("click", () => buyBoost("p"));
  $("boostClick").addEventListener("click", () => buyBoost("c"));
  $("downloadBtn").addEventListener("click", downloadSave);
  $("uploadBtn").addEventListener("click", uploadSave);
  $("resetBtn").addEventListener("click", resetGame);
  $("nextBtn").addEventListener("click", () => { if (tutPage < 15) { tutPage++; updateTutorial(); } });
  $("prevBtn").addEventListener("click", () => { if (tutPage > 0) { tutPage--; updateTutorial(); } });
  
  // CHARGEMENT
  load();
  updateUI();
  log("Bienvenue!");
  updateTradeLog();
  
  // âœ… OPTIMISATION: Utiliser requestAnimationFrame pour les calculs
  // et faire les updates UI de maniÃ¨re plus efficace
  let lastUIUpdate = 0;
  const UI_UPDATE_INTERVAL = 1000 / 10;  // 10 FPS pour l'UI
  
  function gameLoop(currentTime) {
    // âœ… Calculs toutes les frames (rapide et lÃ©ger)
    let p = getProd();
    game.coins += p / FPS;
    game.totalCoins += p / FPS;
    
    // âœ… Banque tous les frames
    if (game.bankInvested > 0) {
      let bankGains = (game.bankInvested * 0.001) / FPS;
      game.bankInvested += bankGains;
      game.bankGenerated += bankGains;
    }
    
    // âœ… Trading tous les frames
    processTradeGains();
    
    // âœ… UI update seulement tous les 100ms (10 FPS)
    if (currentTime - lastUIUpdate >= UI_UPDATE_INTERVAL) {
      updateUI();
      lastUIUpdate = currentTime;
    }
    
    requestAnimationFrame(gameLoop);
  }
  
  // DÃ©marrer la boucle
  requestAnimationFrame(gameLoop);
  
  // âœ… PlayTime update sÃ©parÃ© (1x par seconde)
  setInterval(() => {
    game.playTime++;
  }, 1000);
});
</script>

</body>
</html>