<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incremental Trade ULTIMATE</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #0a0a0a;
      color: #eee;
      padding: 1rem;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      color: #0af;
      text-align: center;
      margin: 1rem 0;
      font-size: 2.2rem;
    }

    h3, h4 {
      color: #0af;
      margin: 0.5rem 0;
    }

    p {
      text-align: center;
      color: #aaa;
      margin-bottom: 1rem;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat {
      background: #1a1a1a;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #0af;
      text-align: center;
    }

    .stat-val {
      font-size: 1.4rem;
      color: #0f0;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      gap: 0.3rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      background: #111;
      padding: 0.5rem;
      border-radius: 6px;
    }

    .tab-btn {
      padding: 0.6rem 1rem;
      background: #222;
      color: #aaa;
      border: 1px solid #333;
      cursor: pointer;
      border-radius: 4px;
      transition: 0.3s;
    }

    .tab-btn:hover {
      background: #333;
    }

    .tab-btn.active {
      background: #0af;
      color: #000;
      border-color: #0af;
    }

    .content {
      display: none;
    }

    .content.active {
      display: block;
    }

    .card {
      background: #1a1a1a;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .btn {
      padding: 0.6rem 1rem;
      background: #0af;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin: 0.3rem 0.3rem 0.3rem 0;
      transition: 0.2s;
    }

    .btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .danger-btn {
      background: #f00;
      color: #fff;
    }

    .danger-btn:hover:not(:disabled) {
      background: #c00;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem;
      background: #0a0a0a;
      margin: 0.4rem 0;
      border-left: 3px solid #0af;
    }

    .big-btn {
      width: 100%;
      max-width: 280px;
      padding: 1.2rem;
      font-size: 1.1rem;
      margin: 1rem auto;
      display: block;
    }

    .log {
      background: #000;
      border-left: 3px solid #0af;
      padding: 0.8rem;
      max-height: 120px;
      overflow-y: auto;
      margin: 1rem 0;
      font-size: 0.85rem;
    }

    canvas {
      border: 1px solid #0af;
      background: #111;
      max-width: 100%;
      margin: 1rem 0;
    }

    #tutorialModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.98);
      z-index: 9999;
      padding: 1rem;
      overflow-y: auto;
      display: none;
    }

    .tut-box {
      max-width: 700px;
      margin: 0 auto;
      background: #1a1a1a;
      padding: 1.5rem;
      border: 2px solid #0af;
      border-radius: 6px;
    }

    .tut-box h1 {
      margin-top: 0;
    }

    .tut-btns {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1.5rem 0;
    }

    @media(max-width: 600px) {
      .tabs {
        font-size: 0.9rem;
      }

      .stat {
        padding: 0.6rem;
      }

      .btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üíé INCREMENTAL TRADE ULTIMATE üíé</h1>
  <p>Le jeu inactif addictif!</p>
  <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap;">
    <button class="btn" onclick="showTutorial()" style="display:block">üìñ TUTORIEL</button>
    <div class="log" id="log" style="flex: 1; min-width: 200px; max-width: 400px; margin: 0;"></div>
  </div>

  <!-- STATS AFFICHAGE -->
  <div class="stats">
    <div class="stat">
      <div>üí∞ Pi√®ces</div>
      <div class="stat-val" id="coins">0</div>
    </div>
    <div class="stat">
      <div>‚ö° /sec</div>
      <div class="stat-val" id="cps">0</div>
    </div>
    <div class="stat">
      <div>‚≠ê √âtoiles</div>
      <div class="stat-val" id="stars">0</div>
    </div>
    <div class="stat">
      <div>üåÄ Galaxies</div>
      <div class="stat-val" id="galaxies">0</div>
    </div>
    <div class="stat">
      <div>üåô Dark Matter</div>
      <div class="stat-val" id="dm">0</div>
    </div>
  </div>

  <!-- TABS NAVIGATION -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="main">üéÆ JEU</button>
    <button class="tab-btn" data-tab="gens">ü§ñ G√âN√âRATEURS</button>
    <button class="tab-btn" data-tab="ups">‚ö° UPGRADES</button>
    <button class="tab-btn" data-tab="feat">‚ú® FEATURES</button>
    <button class="tab-btn" data-tab="stats">üìä STATS</button>
    <button class="tab-btn" data-tab="params">‚öôÔ∏è PARAM√àTRES</button>
  </div>

  <!-- TAB: MAIN GAME -->
  <div id="main" class="content active">
    <div class="card" style="text-align:center">
      <button class="btn big-btn" id="clickBtn">üñ±Ô∏è CLIQUER</button>
      <p>Gain: <span id="clickVal">0</span> par clic</p>
    </div>

    <div class="card">
      <h3>‚è±Ô∏è PRESTIGE</h3>
      <p>Progression: <span id="prestProg">0</span> / 5000</p>
      <p style="color: #0f0; font-size: 1.1rem;"><strong>Possible: <span id="prestigeCount">0</span>√ó</strong></p>
      <button class="btn" id="prestigeBtn">‚ö° PRESTIGE (+10% par prestige)</button>
    </div>

    <div class="card">
      <h3>üåÄ GALAXIES</h3>
      <p>Co√ªt: <span id="galaxyCost">100</span> ‚≠ê</p>
      <button class="btn" id="galaxyBtn">üåÄ SUPER PRESTIGE (√ó1.6)</button>
    </div>
  </div>

  <!-- TAB: GENERATORS -->
  <div id="gens" class="content">
    <div class="card">
      <h3>ü§ñ G√âN√âRATEURS AUTOMATIQUES</h3>
      <div id="gensList"></div>
    </div>
  </div>

  <!-- TAB: UPGRADES -->
  <div id="ups" class="content">
    <div class="card">
      <h3>‚ö° AM√âLIORATIONS</h3>
      <div id="upsList"></div>
    </div>
  </div>

  <!-- TAB: FEATURES -->
  <div id="feat" class="content">
    <div class="card">
      <h3>üåô DARK MATTER</h3>
      <div class="item">
        <div>
          <strong>Dark Matter: <span id="dmCount">0</span></strong><br>
          <span style="color:#aaa;font-size:0.9rem">+5% √† TOUS les gains par Dark Matter</span>
        </div>
      </div>
      <div id="dmInfo" style="color:#aaa;font-size:0.9rem;margin-top:0.5rem"></div>
    </div>

    <div class="card">
      <h3>üéØ QU√äTES</h3>
      <div id="questsList"></div>
    </div>

    <div class="card">
      <h3>‚è∞ BOOSTS</h3>
      <button class="btn" id="boostProd">Prod √ó2 (50K)</button>
      <button class="btn" id="boostClick">Click √ó2 (30K)</button>
      <div id="activeBoosts" style="margin-top:0.5rem"></div>
    </div>

    <div class="card">
      <h3>‚öôÔ∏è SYNERGIES</h3>
      <div id="synergies"></div>
    </div>

    <div class="card">
      <h3>üìä GRAPHIQUE</h3>
      <canvas id="graph" width="600" height="200"></canvas>
    </div>
  </div>

  <!-- TAB: STATS -->
  <div id="stats" class="content">
    <div class="card">
      <h3>üìà STATISTIQUES</h3>
      <div class="item">
        <span>Total Pi√®ces</span>
        <span id="totalCoins">0</span>
      </div>
      <div class="item">
        <span>Total Clics</span>
        <span id="totalClicks">0</span>
      </div>
      <div class="item">
        <span>Temps Jeu</span>
        <span id="playTime">0s</span>
      </div>
      <div class="item">
        <span>Prestige</span>
        <span id="presCount">0</span>
      </div>
    </div>
  </div>

  <!-- TAB: PARAMETRES -->
  <div id="params" class="content">
    <div class="card">
      <h3>‚öôÔ∏è PARAM√àTRES</h3>
      <p style="color:#aaa;margin-bottom:1rem">G√®re ta partie ici</p>

      <div class="item" style="border-left:3px solid #0f0;padding:1rem">
        <div>
          <strong>üíæ Sauvegarder</strong><br>
          <span style="color:#aaa;font-size:0.9rem">T√©l√©charge une copie de ta progression</span>
        </div>
        <button class="btn" id="downloadBtn">üì• T√âL√âCHARGER</button>
      </div>

      <div class="item" style="border-left:3px solid #0af;padding:1rem">
        <div>
          <strong>üìÇ Charger</strong><br>
          <span style="color:#aaa;font-size:0.9rem">Importe une sauvegarde</span>
        </div>
        <button class="btn" id="uploadBtn">üì§ IMPORTER</button>
      </div>

      <div class="item" style="border-left:3px solid #fa0;padding:1rem">
        <div>
          <strong>üóëÔ∏è R√©initialiser</strong><br>
          <span style="color:#aaa;font-size:0.9rem">Recommence √† z√©ro (attention!)</span>
        </div>
        <button class="btn danger-btn" id="resetBtn">üîÑ RESET</button>
      </div>

      <div class="card" style="background:#0a0a0a;margin-top:1rem">
        <h4>üìù Info Sauvegarde</h4>
        <p style="text-align:left;color:#aaa;font-size:0.9rem">
          <strong>Derni√®re sauvegarde:</strong> <span id="lastSave">Jamais</span><br>
          <strong>Taille:</strong> <span id="saveSize">0 KB</span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- FILE INPUT HIDDEN -->
<input type="file" id="fileInput" style="display:none" accept=".json">

<!-- TUTORIAL MODAL -->
<div id="tutorialModal">
  <div class="tut-box">
    <h1>üìñ TUTORIEL</h1>
    <div id="tutText" style="min-height:200px;line-height:1.6;margin:1rem 0"></div>
    <div class="tut-btns">
      <button class="btn" id="prevBtn">‚Üê PR√âC√âDENT</button>
      <button class="btn" onclick="document.getElementById('tutorialModal').style.display='none'">FERMER</button>
      <button class="btn" id="nextBtn">SUIVANT ‚Üí</button>
    </div>
    <p style="text-align:center;color:#aaa;font-size:0.9rem">Page <span id="tutPage">1</span>/10</p>
  </div>
</div>

<!-- ============================================================ -->
<!-- SCRIPT -->
<!-- ============================================================ -->

<script>
// =========== CONSTANTES ===========
const FPS = 10;
const SAVE_KEY = "incremental_v3";
let tutPage = 0;
let graphData = [];
let skipQuestCheck = false;

// =========== TUTORIEL ===========
const TUTORIAL = [
  "Bienvenue! Clique CLIQUER pour gagner des pi√®ces. √Ä 5000 progression = Prestige!",
  "Les g√©n√©rateurs gagnent auto: Robot (15‚Üí0.5/s), Usine (100‚Üí0.8/s), Port (1100‚Üí2/s), Labo (12K‚Üí8/s), Satellite (130K‚Üí50/s)",
  "8 Upgrades: Clic+50%, Robot√ó2, Robot√ó3, Usine√ó2, Usine√ó3, Port√ó2, Labo√ó2, Satellite√ó2. Se r√©initialisent apr√®s Prestige!",
  "Prestige r√©initialise TOUT sauf les ‚≠ê √âtoiles! Gagne: (progression/5000) √ó (1 + prestige√ó0.1, max √ó2)",
  "Les √âtoiles amplifient: √ó1.25 par √©toile sur clics ET production! 10‚≠ê = √ó9.3 multiplicateur!",
  "Galaxies PLUS puissant: √ó1.6 par Galaxy! Co√ªts: 100‚≠ê, 1000‚≠ê, 10000‚≠ê... Permanent!",
  "Qu√™tes: 1M pi√®ces‚Üí500‚≠ê, 5 g√©n√©rateurs‚Üí50Küí∞, Prestige 3x‚Üí1üåÄ GRATUITE! Boosts: Prod√ó2 (50K,30s), Click√ó2 (30K,30s)",
  "Synergies AUTO: Robot+Usine (5+,3+)‚Üí+30%, Port+Satellite (3+,2+)‚Üí+40%, Labo+Usine (2+,5+)‚Üí+50% clics, MEGA (30+gens,P10)‚Üí√ó2!",
  "Dark Matter: Prestige 20‚Üíd√©block√©. +1 tous les 10 P apr√®s P20. Chaque DM=+5% sur TOUT!",
  "Phase 1 (P0-2): Grind clics+robots‚ÜíPrestige. Phase 2 (P2-5): D√©blocage‚Üí30‚≠ê‚Üí1üåÄ. Phase 5 (P20+): Infinite grind! Bonne chance!"
];

// =========== GAME STATE ===========
let game = {
  coins: 0,
  totalCoins: 0,
  totalClicks: 0,
  stars: 0,
  galaxies: 0,
  prestige: 0,
  darkMatter: 0,
  playTime: 0,
  logs: [],

  generators: [
    { id: "r", n: "Robot", b: 1, c: 0, p: 15, m: 1.15, unlock: { type: "none" } },
    { id: "u", n: "Usine", b: 1.5, c: 0, p: 100, m: 1.15, unlock: { type: "prestige", val: 1 } },
    { id: "po", n: "Port", b: 4, c: 0, p: 1100, m: 1.15, unlock: { type: "stars", val: 5 } },
    { id: "l", n: "Labo", b: 15, c: 0, p: 12e3, m: 1.15, unlock: { type: "prestige", val: 3 } },
    { id: "s", n: "Satellite", b: 100, c: 0, p: 130e3, m: 1.15, unlock: { type: "galaxies", val: 1 } }
  ],

  upgrades: [
    { id: "c1", n: "Clic +50%", p: 100, e: 1.15, b: 0, t: "c", unlock: { type: "none" } },
    { id: "r1", n: "Robot √ó2", p: 500, e: 2, b: 0, t: "r", unlock: { type: "prestige", val: 1 } },
    { id: "r2", n: "Robot √ó3", p: 5e3, e: 3, b: 0, t: "r", unlock: { type: "stars", val: 10 } },
    { id: "u1", n: "Usine √ó2", p: 5e3, e: 2, b: 0, t: "u", unlock: { type: "prestige", val: 2 } },
    { id: "u2", n: "Usine √ó3", p: 50e3, e: 3, b: 0, t: "u", unlock: { type: "prestige", val: 5 } },
    { id: "po1", n: "Port √ó2", p: 50e3, e: 2, b: 0, t: "po", unlock: { type: "stars", val: 20 } },
    { id: "l1", n: "Labo √ó2", p: 500e3, e: 2, b: 0, t: "l", unlock: { type: "prestige", val: 4 } },
    { id: "s1", n: "Satellite √ó2", p: 5e6, e: 2, b: 0, t: "s", unlock: { type: "galaxies", val: 1 } }
  ],

  quests: [
    { id: "q1", n: "1M pi√®ces", c: () => game.totalCoins >= 1e6, r: 500, rt: "s", d: 0 },
    { id: "q2", n: "5 g√©n√©rateurs", c: () => game.generators.reduce((a, g) => a + g.c, 0) >= 5, r: 5000, rt: "c", d: 0 },
    { id: "q3", n: "Prestige 3x", c: () => game.prestige >= 3, r: 1, rt: "g", d: 0 }
  ],

  boosts: [],
  graphData: []
};

// =========== UNLOCK SYSTEM ===========
function isUnlocked(item) {
  if (!item.unlock || item.unlock.type === "none") return true;
  
  if (item.unlock.type === "prestige") return game.prestige >= item.unlock.val;
  if (item.unlock.type === "stars") return game.stars >= item.unlock.val;
  if (item.unlock.type === "galaxies") return game.galaxies >= item.unlock.val;
  
  return false;
}

function getUnlockText(item) {
  if (!item.unlock || item.unlock.type === "none") return "";
  
  if (item.unlock.type === "prestige") {
    return `üîí D√©bloqu√© √† Prestige ${item.unlock.val} (actuellement: ${game.prestige})`;
  }
  if (item.unlock.type === "stars") {
    return `üîí D√©bloqu√© √† ${item.unlock.val}‚≠ê (actuellement: ${game.stars})`;
  }
  if (item.unlock.type === "galaxies") {
    return `üîí D√©bloqu√© √† ${item.unlock.val}üåÄ (actuellement: ${game.galaxies})`;
  }
  
  return "";
}

// =========== UTILITY FUNCTIONS ===========
function $(id) {
  return document.getElementById(id);
}

function fmt(n) {
  // V√©rifier si c'est NaN ou Infinity
  if (!isFinite(n) || isNaN(n)) return "0";
  
  // Tr√®s grands nombres en notation scientifique
  if (n >= 1e15) {
    let exp = Math.floor(Math.log10(n));
    let mantissa = (n / Math.pow(10, exp)).toFixed(2);
    return mantissa + "e" + exp;
  }
  if (n >= 1e12) return (n / 1e12).toFixed(1) + "T";
  if (n >= 1e9) return (n / 1e9).toFixed(1) + "B";
  if (n >= 1e6) return (n / 1e6).toFixed(1) + "M";
  if (n >= 1e3) return (n / 1e3).toFixed(1) + "K";
  return Math.round(n).toString();
}

function log(msg) {
  game.logs.unshift(msg);
  if (game.logs.length > 12) game.logs.pop();
  updateLog();
}

function save() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(game));
  updateSaveInfo();
}

function load() {
  let data = localStorage.getItem(SAVE_KEY);
  if (data) game = JSON.parse(data);
}

// =========== GAME MECHANICS ===========
function clickVal() {
  let v = 1;
  for (let u of game.upgrades) {
    if (u.t === "c" && u.b > 0) v *= Math.pow(u.e, u.b);
  }
  
  // Utiliser Math.exp et Math.log pour √©viter Infinity
  let starsMultiplier = Math.exp(game.stars * Math.log(1.25));
  let galaxiesMultiplier = Math.exp(game.galaxies * Math.log(1.6));
  
  return v * starsMultiplier * galaxiesMultiplier * (1 + game.darkMatter * 0.05);
}

function getProd() {
  let total = 0;
  for (let g of game.generators) {
    let e = 1;
    for (let u of game.upgrades) {
      if (u.t === g.id && u.b > 0) e *= Math.pow(u.e, u.b);
    }
    total += g.c * g.b * e;
  }

  let sy = 1;
  let r = game.generators[0], us = game.generators[1], p = game.generators[2], l = game.generators[3], s = game.generators[4];

  if (r.c >= 5 && us.c >= 3) sy *= 1.3;
  if (p.c >= 3 && s.c >= 2) sy *= 1.4;
  if (l.c >= 2 && us.c >= 5) sy *= 1.2;

  // Utiliser Math.exp et Math.log pour √©viter Infinity
  let starsMultiplier = Math.exp(game.stars * Math.log(1.25));
  let galaxiesMultiplier = Math.exp(game.galaxies * Math.log(1.6));

  return (total * sy) * starsMultiplier * galaxiesMultiplier * (1 + game.darkMatter * 0.05);
}

function clickBtn() {
  let v = clickVal();
  game.coins += v;
  game.totalCoins += v;
  game.totalClicks++;
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyGen(id) {
  let g = game.generators.find(x => x.id === id);
  if (!g || !isUnlocked(g)) return;

  let cost = g.p * Math.pow(g.m, g.c);
  if (game.coins < cost) return;

  game.coins -= cost;
  g.c++;
  log("‚úÖ +" + g.n);
  save();
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyUp(id) {
  let u = game.upgrades.find(x => x.id === id);
  if (!u || !isUnlocked(u)) return;

  // Calculer le prix avec multiplicateur (comme les g√©n√©rateurs)
  let cost = u.p * Math.pow(1.15, u.b);
  if (game.coins < cost) return;

  game.coins -= cost;
  u.b++;
  log("‚úÖ " + u.n + " +" + (u.b) + "x");
  save();
  skipQuestCheck = true;
  updateUI();
  skipQuestCheck = false;
}

function buyBoost(boostType) {
  let costMap = { p: 50e3, c: 30e3 };
  let multMap = { p: 2, c: 2 };
  let cost = costMap[boostType];
  let mult = multMap[boostType];

  if (game.coins < cost) return;

  game.coins -= cost;
  game.boosts.push({ type: boostType, m: mult, e: Date.now() + 30e3 });
  log("‚è∞ Boost " + boostType);
  save();
  updateUI();
}

function doPrestige() {
  if (game.coins < 5000) return;

  let totalStarsGained = 0;
  let prestigesCount = 0;

  // Boucle pour faire plusieurs prestiges si les pi√®ces le permettent
  while (game.coins >= 5000) {
    let coinsForThisPrestige = Math.floor(game.coins / 5000) * 5000;
    let starsFromThisPrestige = Math.floor(coinsForThisPrestige / 5000);
    let ms = Math.min(2, 1 + game.prestige * 0.1);
    let starsGained = Math.floor(starsFromThisPrestige * ms);

    game.coins -= coinsForThisPrestige;
    game.totalCoins += coinsForThisPrestige;
    game.stars += starsGained;
    totalStarsGained += starsGained;
    game.prestige++;
    prestigesCount++;

    if (game.prestige >= 20 && game.prestige % 10 === 0) game.darkMatter++;

    // BONUS PRESTIGE: +0.5 niveau auto sur Clic et Robot
    let clickUpgrade = game.upgrades.find(u => u.id === "c1");
    let robotUpgrade = game.upgrades.find(u => u.id === "r1");
    
    if (clickUpgrade) clickUpgrade.b += 0.5;
    if (robotUpgrade) robotUpgrade.b += 0.5;
    
    log("üéÅ Bonus: +0.5 Clic, +0.5 Robot");

    for (let gen of game.generators) gen.c = 0;
    for (let u of game.upgrades) {
      if (u.id !== "c1" && u.id !== "r1") u.b = 0;
    }

    log("‚≠ê +" + starsGained + "! (Prestige " + game.prestige + ")");
  }

  log("üéâ +" + prestigesCount + " Prestige! Total: ‚≠ê +" + totalStarsGained);
  save();
  updateUI();
}

function doGalaxy() {
  let cost = game.galaxies === 0 ? 100 : 100 * Math.pow(10, game.galaxies);
  if (game.stars < cost) return;

  game.stars -= cost;
  game.galaxies++;
  log("üåÄ +1!");
  save();
  updateUI();
}

function getSynergies() {
  let s = [];
  let r = game.generators[0], u = game.generators[1], p = game.generators[2], l = game.generators[3], sat = game.generators[4];

  if (r.c >= 5 && u.c >= 3) s.push("‚úÖ Robot+Usine +30%");
  if (p.c >= 3 && sat.c >= 2) s.push("‚úÖ Port+Satellite +40%");
  if (l.c >= 2 && u.c >= 5) s.push("‚úÖ Labo+Usine +50% clics");

  let tg = [r, u, p, l, sat].reduce((a, g) => a + g.c, 0);
  if (tg >= 30 && game.prestige >= 10) s.push("‚úÖ MEGA SYNERGIE √ó2!");

  return s.length ? s.join("<br>") : "Aucune synergy";
}

function checkQuests() {
  for (let q of game.quests) {
    if (!q.d && q.c()) {
      q.d = 1;
      if (q.rt === "s") game.stars += q.r;
      else if (q.rt === "c") {
        game.coins += q.r;
        game.totalCoins += q.r;
      }
      else if (q.rt === "g") game.galaxies += q.r;
      log("üéØ " + q.n);
      save();
    }
  }
}

function drawGraph() {
  let c = $("graph");
  if (!c || graphData.length < 2) return;

  let ct = c.getContext("2d");
  ct.fillStyle = "#0a0a0a";
  ct.fillRect(0, 0, c.width, c.height);

  let mx = Math.max(...graphData) || 1;

  ct.strokeStyle = "#0af";
  ct.lineWidth = 2;
  ct.beginPath();

  for (let i = 0; i < graphData.length; i++) {
    let x = i / graphData.length * c.width;
    let y = c.height - (graphData[i] / mx) * c.height * 0.9;
    if (i === 0) ct.moveTo(x, y);
    else ct.lineTo(x, y);
  }

  ct.stroke();
}

// =========== UI UPDATE ===========
function updateUI() {
  let p = getProd();

  // Update stats
  $("coins").textContent = fmt(game.coins);
  $("cps").textContent = fmt(p);
  $("stars").textContent = game.stars;
  $("galaxies").textContent = game.galaxies;
  $("dm").textContent = game.darkMatter;
  $("dmCount").textContent = game.darkMatter;
  
  // Dark Matter info
  let dmInfo = "";
  if (game.darkMatter === 0) {
    dmInfo = "D√©bloqu√© √† Prestige 20! +1 tous les 10 Prestige apr√®s P20.";
  } else {
    let nextDM = Math.ceil((game.prestige - 20) / 10) * 10 + 20;
    dmInfo = `‚úÖ D√©bloqu√©! Prochain: ${nextDM} Prestige (actuellement: ${game.prestige})`;
  }
  $("dmInfo").textContent = dmInfo;
  $("clickVal").textContent = fmt(clickVal());
  $("prestProg").textContent = Math.floor(game.coins);
  let prestigePossible = Math.floor(game.coins / 5000);
  $("prestigeCount").textContent = prestigePossible;
  $("galaxyCost").textContent = game.galaxies === 0 ? 100 : 100 * Math.pow(10, game.galaxies);
  $("totalCoins").textContent = fmt(game.totalCoins);
  $("totalClicks").textContent = game.totalClicks;
  $("playTime").textContent = game.playTime + "s";
  $("presCount").textContent = game.prestige;

  // Generators list
  let genHtml = "";
  for (let g of game.generators) {
    let cost = g.p * Math.pow(g.m, g.c);
    let unlocked = isUnlocked(g);
    let unlockText = getUnlockText(g);
    
    // Calculer le gain/sec de ce g√©n√©rateur
    let upgMultiplier = 1;
    for (let u of game.upgrades) {
      if (u.t === g.id && u.b) upgMultiplier *= u.e;
    }
    let gainPerSec = g.c * g.b * upgMultiplier * Math.pow(1.25, game.stars) * Math.pow(1.6, game.galaxies) * (1 + game.darkMatter * 0.05);
    
    if (!unlocked) {
      genHtml += `<div class="item" style="opacity:0.5;border-left:3px solid #f66"><strong>${g.n}</strong> ${unlockText}</div>`;
    } else {
      genHtml += `<div class="item"><strong>${g.n}</strong> √ó${g.c} <span style="color:#0f0">(${fmt(gainPerSec)}/s)</span><button class="btn gen-buy" data-id="${g.id}" ${game.coins < cost ? "disabled" : ""}>${fmt(cost)}</button></div>`;
    }
  }
  $("gensList").innerHTML = genHtml;

  // Upgrades list
  let upHtml = "";
  for (let u of game.upgrades) {
    let unlocked = isUnlocked(u);
    let unlockText = getUnlockText(u);
    let cost = u.p * Math.pow(1.15, u.b);
    
    if (!unlocked) {
      upHtml += `<div class="item" style="opacity:0.5;border-left:3px solid #f66"><strong>${u.n}</strong> ${unlockText}</div>`;
    } else {
      upHtml += `<div class="item"><strong>${u.n}</strong> √ó${u.e} <span style="color:#0f0">(Lvl ${u.b})</span><button class="btn up-buy" data-id="${u.id}" ${game.coins < cost ? "disabled" : ""}>${fmt(cost)}</button></div>`;
    }
  }
  $("upsList").innerHTML = upHtml || "Tous d√©bloqu√©s!";

  // Quests list
  let questHtml = "";
  for (let q of game.quests) {
    questHtml += `<div class="item">${q.n} <span style="color:${q.d ? "#0f0" : "#ffa"}">${q.d ? "‚úÖ" : "‚è≥"}</span></div>`;
  }
  $("questsList").innerHTML = questHtml;

  // Active boosts
  let boostHtml = "";
  game.boosts.forEach(b => {
    if (Date.now() < b.e) {
      let sec = Math.ceil((b.e - Date.now()) / 1e3);
      boostHtml += `<div style="color:#ffa">${b.type} √ó${b.m} (${sec}s)</div>`;
    }
  });
  $("activeBoosts").innerHTML = boostHtml || "Aucun";

  // Synergies
  $("synergies").innerHTML = getSynergies();

  // Graph
  graphData.push(p);
  if (graphData.length > 60) graphData.shift();
  drawGraph();

  // Check quests
  if (!skipQuestCheck) checkQuests();

  // Logs
  let logHtml = "";
  for (let l of game.logs) logHtml += `<div>${l}</div>`;
  $("log").innerHTML = logHtml;

  save();
}

function updateLog() {
  let logHtml = "";
  for (let l of game.logs) logHtml += `<div>${l}</div>`;
  $("log").innerHTML = logHtml;
}

function updateSaveInfo() {
  let d = new Date().toLocaleString();
  $("lastSave").textContent = d;
  let size = (JSON.stringify(game).length / 1024).toFixed(2);
  $("saveSize").textContent = size + " KB";
}

// =========== SAVE/LOAD FUNCTIONS ===========
function downloadSave() {
  let data = JSON.stringify(game, null, 2);
  let blob = new Blob([data], { type: "application/json" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "incremental_save_" + Date.now() + ".json";
  a.click();
  URL.revokeObjectURL(url);
}

function uploadSave() {
  $("fileInput").click();
}

$("fileInput").addEventListener("change", e => {
  let file = e.target.files[0];
  if (!file) return;

  let reader = new FileReader();
  reader.onload = f => {
    try {
      let data = JSON.parse(f.target.result);
      game = data;
      save();
      updateUI();
      log("üìÇ Sauvegarde import√©e!");
      alert("‚úÖ Sauvegarde import√©e avec succ√®s!");
    } catch (err) {
      alert("‚ùå Erreur: fichier invalide");
    }
  };
  reader.readAsText(file);
});

function resetGame() {
  if (!confirm("‚ö†Ô∏è ATTENTION: Cela supprimera ta progression!\n\nEs-tu VRAIMENT s√ªr?")) return;
  if (!confirm("üîÑ Dernier avertissement! C'est irr√©versible!")) return;

  game = {
    coins: 0,
    totalCoins: 0,
    totalClicks: 0,
    stars: 0,
    galaxies: 0,
    prestige: 0,
    darkMatter: 0,
    playTime: 0,
    logs: [],
    generators: [
      { id: "r", n: "Robot", b: 0.5, c: 0, p: 15, m: 1.15, unlock: { type: "none" } },
      { id: "u", n: "Usine", b: 0.8, c: 0, p: 100, m: 1.15, unlock: { type: "prestige", val: 1 } },
      { id: "po", n: "Port", b: 2, c: 0, p: 1100, m: 1.15, unlock: { type: "stars", val: 5 } },
      { id: "l", n: "Labo", b: 8, c: 0, p: 12e3, m: 1.15, unlock: { type: "prestige", val: 3 } },
      { id: "s", n: "Satellite", b: 50, c: 0, p: 130e3, m: 1.15, unlock: { type: "galaxies", val: 1 } }
    ],
    upgrades: [
      { id: "c1", n: "Clic +50%", p: 100, e: 1.15, b: 0, t: "c", unlock: { type: "none" } },
      { id: "r1", n: "Robot √ó2", p: 500, e: 2, b: 0, t: "r", unlock: { type: "prestige", val: 1 } },
      { id: "r2", n: "Robot √ó3", p: 5e3, e: 3, b: 0, t: "r", unlock: { type: "stars", val: 10 } },
      { id: "u1", n: "Usine √ó2", p: 5e3, e: 2, b: 0, t: "u", unlock: { type: "prestige", val: 2 } },
      { id: "u2", n: "Usine √ó3", p: 50e3, e: 3, b: 0, t: "u", unlock: { type: "prestige", val: 5 } },
      { id: "po1", n: "Port √ó2", p: 50e3, e: 2, b: 0, t: "po", unlock: { type: "stars", val: 20 } },
      { id: "l1", n: "Labo √ó2", p: 500e3, e: 2, b: 0, t: "l", unlock: { type: "prestige", val: 4 } },
      { id: "s1", n: "Satellite √ó2", p: 5e6, e: 2, b: 0, t: "s", unlock: { type: "galaxies", val: 1 } }
    ],
    quests: [
      { id: "q1", n: "1M pi√®ces", c: () => game.totalCoins >= 1e6, r: 500, rt: "s", d: 0 },
      { id: "q2", n: "5 g√©n√©rateurs", c: () => game.generators.reduce((a, g) => a + g.c, 0) >= 5, r: 5000, rt: "c", d: 0 },
      { id: "q3", n: "Prestige 3x", c: () => game.prestige >= 3, r: 1, rt: "g", d: 0 }
    ],
    boosts: [],
    graphData: []
  };

  localStorage.removeItem(SAVE_KEY);
  save();
  updateUI();
  log("üîÑ Jeu r√©initialis√©!");
  alert("‚úÖ Jeu r√©initialis√©!");
}

// =========== TUTORIAL ===========
function showTutorial() {
  $("tutorialModal").style.display = "block";
  tutPage = 0;
  updateTutorial();
}

function updateTutorial() {
  $("tutText").textContent = TUTORIAL[tutPage];
  $("tutPage").textContent = tutPage + 1;
}

$("nextBtn").addEventListener("click", () => {
  if (tutPage < 9) {
    tutPage++;
    updateTutorial();
  }
});

$("prevBtn").addEventListener("click", () => {
  if (tutPage > 0) {
    tutPage--;
    updateTutorial();
  }
});

// =========== TAB NAVIGATION ===========
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    document.querySelectorAll(".tab-btn").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".content").forEach(x => x.classList.remove("active"));
    this.classList.add("active");
    $(this.dataset.tab).classList.add("active");
  });
});

// =========== EVENT LISTENERS ===========
$("clickBtn").addEventListener("click", clickBtn);
$("prestigeBtn").addEventListener("click", doPrestige);
$("galaxyBtn").addEventListener("click", doGalaxy);
$("boostProd").addEventListener("click", () => buyBoost("p"));
$("boostClick").addEventListener("click", () => buyBoost("c"));
$("downloadBtn").addEventListener("click", downloadSave);
$("uploadBtn").addEventListener("click", uploadSave);
$("resetBtn").addEventListener("click", resetGame);

document.addEventListener("click", e => {
  if (e.target.classList.contains("gen-buy")) buyGen(e.target.dataset.id);
  if (e.target.classList.contains("up-buy")) buyUp(e.target.dataset.id);
});

// =========== GAME LOOP ===========
setInterval(() => {
  let p = getProd();
  game.coins += p / FPS;
  game.totalCoins += p / FPS;
  updateUI();
}, 1000 / FPS);

setInterval(() => {
  game.playTime++;
  updateUI();
}, 1000);

// =========== INIT ===========
load();
updateUI();
log("Bienvenue!");
</script>

</body>
</html>
