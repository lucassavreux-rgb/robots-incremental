<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Incremental Trade</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:system-ui,Arial;background:#111;color:#eee;margin:0;padding:1rem;display:flex;flex-direction:column;align-items:center;touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent}
  button{padding:.6rem 1.2rem;font-size:1.2rem;margin:.3rem;border:none;border-radius:6px;background:#0af;color:#fff;cursor:pointer;transition:all 0.2s;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
  button:hover:not(:disabled){background:#0cf;transform:scale(1.05)}
  button:disabled{background:#555;cursor:not-allowed;opacity:0.5}
  button:active{transform:scale(0.95)}
  .row{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;width:100%;max-width:1200px}
  .card{background:#222;padding:1rem;border-radius:8px;flex:1 1 220px;margin:.5rem;box-shadow:0 4px 6px rgba(0,0,0,0.3)}
  .card h3{margin-top:0;color:#0af;border-bottom:2px solid #0af;padding-bottom:.5rem}
  #log{background:#1a1a1a;padding:.8rem;border-radius:8px;margin:.5rem 0;max-width:1200px;width:100%;border-left:4px solid #0af}
  .log-message{padding:.3rem 0;font-size:.9rem;animation:fadeIn 0.3s}
  .log-success{color:#0f0}
  .log-unlock{color:#0af}
  .log-event{color:#ffa}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
  #cpsDisp{font-size:1rem;color:#ffa;margin-bottom:1rem}
  .gen-item,.up-item{display:flex;justify-content:space-between;align-items:center;margin:.4rem 0;padding:.5rem;background:#333;border-radius:4px}
  .gen-item:hover,.up-item:hover{background:#444}
  .achievement{background:#2a2a00;padding:.5rem;margin:.3rem 0;border-left:4px solid #ffa;border-radius:4px;font-size:.9rem}
  .achievement.unlocked{background:#002a00;border-left-color:#0f0}
  .stat-line{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #333}
  #clickBtn{font-size:1.5rem;padding:1rem 2rem;background:linear-gradient(135deg, #0af 0%, #08d 100%);margin:1rem;touch-action:manipulation;user-select:none;-webkit-user-select:none}
  .price{color:#ffa}
  .count{color:#0f0;font-weight:bold}
  .progress-bar{background:#333;height:20px;border-radius:10px;overflow:hidden;margin:.5rem 0}
  .progress-fill{background:linear-gradient(90deg, #0af, #0cf);height:100%;transition:width 0.3s}
  .buy-btn{padding:.5rem 1rem;font-size:1rem}
  .locked{opacity:0.5;filter:grayscale(1)}
  .new-content{animation:glow 1s infinite}
  @keyframes glow{0%,100%{box-shadow:0 0 5px #0af}50%{box-shadow:0 0 20px #0af}}
  *{-webkit-touch-callout:none;-webkit-text-size-adjust:none}
</style>
</head>
<body>

<h1>ğŸ’° PiÃ¨ces : <span id="coins">0</span></h1>
<div id="cpsDisp">PiÃ¨ces/sec : <span id="cps">0</span></div>

<div id="log"></div>

<button id="clickBtn">ğŸ‘† Clic +<span id="clickValue">1</span></button>

<div class="row">
  <div class="card">
    <h3>ğŸ¤– GÃ©nÃ©rateurs</h3>
    <div id="gens"></div>
  </div>
  
  <div class="card">
    <h3>âš¡ Upgrades</h3>
    <div id="ups"></div>
  </div>
  
  <div class="card">
    <h3>âœ¨ Shop Ã‰toiles</h3>
    <div>Ã‰toiles : <span class="count" id="starsAvailable">0</span> â­</div>
    <div id="starShop" style="max-height:300px;overflow-y:auto;margin-top:.5rem"></div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>â­ Prestige</h3>
    <div class="stat-line">
      <span>Ã‰toiles</span>
      <span class="count" id="stars">0</span>
    </div>
    <div class="stat-line" id="galaxyLine" style="display:none">
      <span>Galaxies ğŸŒ€</span>
      <span class="count" id="galaxies">0</span>
    </div>
    <div class="stat-line">
      <span>Bonus</span>
      <span class="count">Ã—<span id="bonus">1</span></span>
    </div>
    <div class="stat-line">
      <span>CoÃ»t</span>
      <span class="price" id="prestigeCost">1000</span> ğŸ’°
    </div>
    <div class="stat-line" id="skillLine" style="display:none">
      <span>Points compÃ©tence</span>
      <span class="count" id="skillPoints">0</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="prestigeProgress" style="width:0%"></div>
    </div>
    <button id="prestigeBtn" disabled>Prestige +<span id="prestigeGain">0</span> â­</button>
    <button id="prestigeMaxBtn" disabled>MAX</button>
    <button id="superPrestigeBtn" style="display:none;background:#f0a">Super Prestige</button>
  </div>

  <div class="card">
    <h3>ğŸ“Š Trading</h3>
    <div id="tradeTabs" style="display:flex;gap:.3rem;margin-bottom:.5rem">
      <button onclick="switchTab('iron')" id="tab-iron" class="buy-btn" style="flex:1;font-size:.9rem">Fer</button>
      <button onclick="switchTab('gold')" id="tab-gold" class="buy-btn" style="flex:1;font-size:.9rem;display:none">Or</button>
      <button onclick="switchTab('platinum')" id="tab-platinum" class="buy-btn" style="flex:1;font-size:.9rem;display:none">Platine</button>
      <button onclick="switchTab('crypto')" id="tab-crypto" class="buy-btn" style="flex:1;font-size:.9rem;display:none">Crypto</button>
    </div>
    <div id="tradeContent"></div>
  </div>

  <div class="card">
    <h3>ğŸ† SuccÃ¨s</h3>
    <div id="achievements" style="max-height:200px;overflow-y:auto"></div>
  </div>
</div>

<!-- MILESTONES -->
<div class="row" id="milestonesSection" style="display:none">
  <div class="card" style="flex:1 1 100%">
    <h3>ğŸ¯ Milestones</h3>
    <div id="milestones"></div>
  </div>
</div>

<!-- SKILLS -->
<div class="row" id="skillsSection" style="display:none">
  <div class="card" style="flex:1 1 100%">
    <h3>ğŸŒ³ CompÃ©tences</h3>
    <div>Points : <span class="count" id="skillPointsDisp">0</span></div>
    <div style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap">
      <div style="flex:1;min-width:200px">
        <h4 style="color:#0f0">Production</h4>
        <div id="skillsProd"></div>
      </div>
      <div style="flex:1;min-width:200px">
        <h4 style="color:#f0a">Clics</h4>
        <div id="skillsClick"></div>
      </div>
      <div style="flex:1;min-width:200px">
        <h4 style="color:#0af">Trading</h4>
        <div id="skillsTrade"></div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="card">
    <h3>ğŸ“ˆ Stats</h3>
    <div class="stat-line">
      <span>Total</span>
      <span class="count" id="totalCoins">0</span>
    </div>
    <div class="stat-line">
      <span>Clics</span>
      <span class="count" id="totalClicks">0</span>
    </div>
    <div class="stat-line">
      <span>Temps</span>
      <span class="count" id="playTime">0s</span>
    </div>
    <div class="stat-line">
      <span>Prestiges</span>
      <span class="count" id="prestigeCount">0</span>
    </div>
  </div>
</div>

<div class="card" style="max-width:1200px">
  <h3>ğŸ’¾ Sauvegarde</h3>
  <button id="exportBtn">ğŸ“¤ Exporter</button>
  <button id="importBtn">ğŸ“¥ Importer</button>
  <button id="resetBtn" style="background:#c33">ğŸ—‘ï¸ Reset</button>
  <input id="importInput" type="file" accept=".txt" style="display:none">
</div>

<script>
const SAVE_KEY = "idleTrade_v3";
const FPS = 20;

let state = {
  coins: 0,
  totalCoins: 0,
  stars: 0,
  galaxies: 0,
  totalClicks: 0,
  prestigeCount: 0,
  playTime: 0,
  prestigeCost: 1000,
  skillPoints: 0,
  unlockedFeatures: ["basic"],
  logMessages: [],
  milestones: [
    {id:"m1", name:"Premier Million", goal:1e6, type:"totalCoins", reward:"Ã—1.5 prod", unlocked:false, claimed:false},
    {id:"m2", name:"10 GÃ©nÃ©rateurs", goal:10, type:"genTotal", reward:"Ã—2 clics", unlocked:false, claimed:false},
    {id:"m3", name:"Trader Pro", goal:100, type:"trades", reward:"-2% frais", unlocked:false, claimed:false},
    {id:"m4", name:"10 Millions", goal:10e6, type:"totalCoins", reward:"Ã—2 prod", unlocked:false, claimed:false},
    {id:"m5", name:"50 GÃ©nÃ©rateurs", goal:50, type:"genTotal", reward:"Ã—3 prod", unlocked:false, claimed:false}
  ],
  generators: [
    {id:"robot", name:"Robot", base:0.1, count:0, price:15, mult:1.15},
    {id:"usine", name:"Usine", base:0.8, count:0, price:250, mult:1.15},
    {id:"port", name:"Port", base:4, count:0, price:3500, mult:1.15},
    {id:"labo", name:"Labo", base:20, count:0, price:50000, mult:1.15},
    {id:"satellite", name:"Satellite", base:100, count:0, price:750000, mult:1.15},
    {id:"station", name:"Station", base:500, count:0, price:15e6, mult:1.15},
    {id:"dyson", name:"Dyson", base:3000, count:0, price:500e6, mult:1.15},
    {id:"blackhole", name:"Trou Noir", base:15000, count:0, price:50e9, mult:1.15, unlock:"advanced"},
    {id:"multiverse", name:"Multivers", base:100000, count:0, price:5e12, mult:1.15, unlock:"advanced"}
  ],
  upgrades: [
    {id:"click2", name:"Clic Ã—2", price:500, effect:2, bought:false, type:"click"},
    {id:"click5", name:"Clic Ã—5", price:25000, effect:5, bought:false, type:"click", requires:"click2"},
    {id:"click10", name:"Clic Ã—10", price:500000, effect:10, bought:false, type:"click", requires:"click5"},
    {id:"gen2", name:"Gen Ã—2", price:15000, effect:2, bought:false, type:"gen"},
    {id:"gen3", name:"Gen Ã—3", price:250000, effect:3, bought:false, type:"gen", requires:"gen2"},
    {id:"gen5", name:"Gen Ã—5", price:5e6, effect:5, bought:false, type:"gen", requires:"gen3"},
    {id:"robot10", name:"Robot Ã—10", price:5000, effect:10, bought:false, type:"robot"},
    {id:"usine10", name:"Usine Ã—10", price:75000, effect:10, bought:false, type:"usine"},
    {id:"port10", name:"Port Ã—10", price:1e6, effect:10, bought:false, type:"port"},
    {id:"labo10", name:"Labo Ã—10", price:5e6, effect:10, bought:false, type:"labo", unlock:"midgame"},
    {id:"autosave", name:"Sauvegarde auto", price:2000, bought:false, type:"feature"}
  ],
  starUpgrades: [
    {id:"star_prod1", name:"Prod Ã—2", cost:10, bought:false, effect:2, type:"production"},
    {id:"star_prod2", name:"Prod Ã—5", cost:35, bought:false, effect:5, type:"production", requires:"star_prod1"},
    {id:"star_prod3", name:"Prod Ã—10", cost:100, bought:false, effect:10, type:"production", requires:"star_prod2"},
    {id:"star_click1", name:"Clic Ã—3", cost:20, bought:false, effect:3, type:"starclick"},
    {id:"star_click2", name:"Clic Ã—10", cost:60, bought:false, effect:10, type:"starclick", requires:"star_click1"},
    {id:"star_gen1", name:"Robot Ã—50", cost:25, bought:false, effect:50, type:"robot"},
    {id:"star_gen2", name:"Usine Ã—50", cost:50, bought:false, effect:50, type:"usine"},
    {id:"star_auto1", name:"Auto-clic", cost:75, bought:false, type:"autoclick"},
    {id:"star_autobuy", name:"Auto-achat gen", cost:200, bought:false, type:"autobuy", unlock:"advanced"},
    {id:"star_market", name:"MarchÃ© rapide", cost:120, bought:false, type:"fastmarket", unlock:"advanced"}
  ],
  skills: {
    production: [
      {id:"prod1", name:"EfficacitÃ© I", cost:1, bought:false, effect:1.5, desc:"Ã—1.5 prod"},
      {id:"prod2", name:"EfficacitÃ© II", cost:3, bought:false, effect:2, desc:"Ã—2 prod", requires:"prod1"},
      {id:"prod3", name:"EfficacitÃ© III", cost:5, bought:false, effect:3, desc:"Ã—3 prod", requires:"prod2"}
    ],
    clicks: [
      {id:"click1", name:"Doigts I", cost:1, bought:false, effect:2, desc:"Ã—2 clics"},
      {id:"click2", name:"Doigts II", cost:3, bought:false, effect:5, desc:"Ã—5 clics", requires:"click1"}
    ],
    trading: [
      {id:"trade1", name:"Trader I", cost:2, bought:false, effect:0.02, desc:"-2% frais"},
      {id:"trade2", name:"Trader II", cost:4, bought:false, effect:0.04, desc:"-4% frais", requires:"trade1"}
    ]
  },
  autoSettings: {
    autoBuyGens: false
  },
  achievements: [
    {id:"first_coin", name:"PremiÃ¨re piÃ¨ce", desc:"Gagner 1 piÃ¨ce", unlocked:false},
    {id:"hundred", name:"Capitaliste", desc:"100 piÃ¨ces", unlocked:false},
    {id:"thousand", name:"Millionnaire", desc:"1000 piÃ¨ces", unlocked:false},
    {id:"first_gen", name:"Automatisation", desc:"1er gÃ©nÃ©rateur", unlocked:false},
    {id:"first_prestige", name:"Renaissance", desc:"1er prestige", unlocked:false},
    {id:"ten_gens", name:"Industriel", desc:"10 gÃ©nÃ©rateurs", unlocked:false},
    {id:"clicker", name:"Clickeur", desc:"100 clics", unlocked:false},
    {id:"trader", name:"Trader", desc:"Acheter du fer", unlocked:false}
  ]
};

let trade = {
  iron: 0,
  gold: 0,
  platinum: 0,
  crypto: 0,
  prices: {iron: 10, gold: 50, platinum: 200, crypto: 1000},
  history: {
    iron: [10],
    gold: [50],
    platinum: [200],
    crypto: [1000]
  },
  botActive: {iron: false, gold: false, platinum: false, crypto: false},
  totalTrades: 0,
  currentTab: 'iron'
};

const $ = id => document.getElementById(id);

function log(txt, type = "normal") {
  const timestamp = new Date().toLocaleTimeString();
  const logEl = $("log");
  
  let cssClass = "";
  if (type === "success") cssClass = "log-success";
  if (type === "unlock") cssClass = "log-unlock";
  if (type === "event") cssClass = "log-event";
  
  state.logMessages.unshift({text: txt, time: timestamp, type: cssClass});
  if (state.logMessages.length > 5) state.logMessages.pop();
  
  logEl.innerHTML = state.logMessages.map(msg => 
    `<div class="log-message ${msg.type}">[${msg.time}] ${msg.text}</div>`
  ).join("");
}

function formatNum(n) {
  if (n < 1000) return n.toFixed(2);
  if (n < 1e6) return (n / 1e3).toFixed(2) + "K";
  if (n < 1e9) return (n / 1e6).toFixed(2) + "M";
  if (n < 1e12) return (n / 1e9).toFixed(2) + "B";
  return (n / 1e12).toFixed(2) + "T";
}

function price(gen) {
  return Math.floor(gen.price * Math.pow(gen.mult, gen.count));
}

function cps() {
  const genMult = state.upgrades.filter(u => u.type === "gen" && u.bought).reduce((a, u) => a * u.effect, 1);
  const starMult = state.starUpgrades.filter(u => u.type === "production" && u.bought).reduce((a, u) => a * u.effect, 1);
  const skillMult = state.skills.production.filter(s => s.bought).reduce((a, s) => a * s.effect, 1);
  const milestoneMult = state.milestones.filter(m => m.claimed && m.reward.includes("prod")).reduce((a, m) => {
    const match = m.reward.match(/Ã—(\d+\.?\d*)/);
    return match ? a * parseFloat(match[1]) : a;
  }, 1);
  
  let total = 0;
  state.generators.forEach(g => {
    if (!isUnlocked(g.unlock)) return;
    let eff = genMult * starMult * skillMult * milestoneMult;
    const spec = state.upgrades.find(u => u.type === g.id && u.bought);
    if (spec) eff *= spec.effect;
    const star = state.starUpgrades.find(u => u.type === g.id && u.bought);
    if (star) eff *= star.effect;
    total += g.count * g.base * eff;
  });
  
  const galaxyMult = Math.pow(3, state.galaxies);
  return total * Math.pow(1.5, state.stars) * galaxyMult;
}

function clickVal() {
  const clickMult = state.upgrades.filter(u => u.type === "click" && u.bought).reduce((a, u) => a * u.effect, 1);
  const starMult = state.starUpgrades.filter(u => u.type === "starclick" && u.bought).reduce((a, u) => a * u.effect, 1);
  const skillMult = state.skills.clicks.filter(s => s.bought).reduce((a, s) => a * s.effect, 1);
  const milestoneMult = state.milestones.filter(m => m.claimed && m.reward.includes("clic")).reduce((a, m) => {
    const match = m.reward.match(/Ã—(\d+)/);
    return match ? a * parseFloat(match[1]) : a;
  }, 1);
  const galaxyMult = Math.pow(3, state.galaxies);
  return clickMult * starMult * skillMult * milestoneMult * Math.pow(1.5, state.stars) * galaxyMult;
}

function clickBtn() {
  const val = clickVal();
  state.coins += val;
  state.totalCoins += val;
  state.totalClicks++;
  checkAchievements();
}

function buyGen(genId) {
  const gen = state.generators.find(g => g.id === genId);
  if (!gen) return;
  const cost = price(gen);
  if (state.coins < cost) return;
  state.coins -= cost;
  gen.count++;
  state.totalCoins += cost * 0.1;
  checkAchievements();
  updateUI();
  save();
}

function buyUp(upId) {
  const up = state.upgrades.find(u => u.id === upId);
  if (!up || up.bought || state.coins < up.price) return;
  if (up.requires) {
    const req = state.upgrades.find(u => u.id === up.requires);
    if (!req || !req.bought) return;
  }
  state.coins -= up.price;
  up.bought = true;
  log(`âœ… ${up.name}`, "success");
  checkAchievements();
  updateUI();
  save();
}

function buyStarUpgrade(id) {
  const up = state.starUpgrades.find(u => u.id === id);
  if (!up || up.bought || state.stars < up.cost) return;
  if (!isUnlocked(up.unlock)) return;
  if (up.requires) {
    const req = state.starUpgrades.find(u => u.id === up.requires);
    if (!req || !req.bought) return;
  }
  state.stars -= up.cost;
  up.bought = true;
  
  if (up.id === "star_autobuy") {
    state.autoSettings.autoBuyGens = true;
    log("ğŸ¤– Auto-achat activÃ© !", "event");
  }
  
  log(`âœ¨ ${up.name}`, "success");
  updateUI();
  save();
}

function prestige() {
  const gain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  if (gain < 1 || state.totalCoins < state.prestigeCost) return;
  state.stars += gain;
  state.prestigeCount++;
  state.skillPoints += 1;
  state.prestigeCost = 1000;
  resetCore();
  log(`â­ +${gain} Ã©toiles (Total: ${state.stars}) +1 pt compÃ©tence`, "success");
  checkAchievements();
  updateUI();
  save();
}

function prestigeMax() {
  let totalGain = 0;
  let done = 0;
  while (state.totalCoins >= state.prestigeCost) {
    const gain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
    if (gain < 1) break;
    totalGain += gain;
    done++;
    state.totalCoins = 0;
    state.coins = 0;
  }
  if (totalGain < 1) return;
  state.stars += totalGain;
  state.prestigeCount += done;
  state.prestigeCost = 1000;
  resetCore();
  log(`â­ MULTI ! +${totalGain} Ã©toiles`, "success");
  checkAchievements();
  updateUI();
  save();
}

function resetCore() {
  state.coins = 0;
  state.totalCoins = 0;
  state.generators.forEach(g => g.count = 0);
  state.upgrades.forEach(u => {
    if (u.id !== "autosave") u.bought = false;
  });
  trade.iron = 0;
  trade.price = 10;
  trade.history = [10];
  trade.botActive = false;
}

function buyIron() {
  buyResource('iron');
}

function sellIron() {
  sellResource('iron');
}

function toggleBot() {
  toggleBotResource(trade.currentTab);
}

function buyResource(resource) {
  let feeReduction = 0;
  feeReduction += state.skills.trading.filter(s => s.bought && s.effect < 1).reduce((a, s) => a + s.effect, 0);
  const finalFee = Math.max(0.01, 0.05 - feeReduction);
  
  const cost = trade.prices[resource] * (1 + finalFee);
  const qty = Math.max(1, Math.floor(state.coins / cost));
  const total = qty * cost;
  if (state.coins < total) return;
  state.coins -= total;
  trade[resource] += qty;
  trade.totalTrades++;
  checkAchievements();
  updateUI();
  save();
}

function sellResource(resource) {
  if (trade[resource] < 1) return;
  let feeReduction = 0;
  feeReduction += state.skills.trading.filter(s => s.bought && s.effect < 1).reduce((a, s) => a + s.effect, 0);
  const finalFee = Math.max(0.01, 0.05 - feeReduction);
  
  const gain = trade[resource] * trade.prices[resource] * (1 - finalFee);
  state.coins += gain;
  state.totalCoins += gain * 0.5;
  trade[resource] = 0;
  trade.totalTrades++;
  updateUI();
  save();
}

function toggleBotResource(resource) {
  trade.botActive[resource] = !trade.botActive[resource];
  log(trade.botActive[resource] ? `ğŸ¤– Bot ${resource} ON` : `ğŸ¤– Bot ${resource} OFF`, "event");
  updateUI();
}

function botTrade(resource) {
  if (trade.history[resource].length < 3) return;
  const avg = trade.history[resource].reduce((a, b) => a + b, 0) / trade.history[resource].length;
  if (trade.prices[resource] < avg * 0.88 && state.coins > trade.prices[resource] * 10) buyResource(resource);
  if (trade.prices[resource] > avg * 1.18 && trade[resource] > 0) sellResource(resource);
}

function tickMarket() {
  // Iron
  const ironChange = (Math.random() - 0.48) * 0.08;
  trade.prices.iron = Math.max(2, Math.floor(trade.prices.iron * (1 + ironChange)));
  trade.history.iron.push(trade.prices.iron);
  if (trade.history.iron.length > 20) trade.history.iron.shift();
  if (trade.botActive.iron) botTrade('iron');
  
  // Advanced trading
  if (isUnlocked("advanced")) {
    const goldChange = (Math.random() - 0.49) * 0.04;
    trade.prices.gold = Math.max(10, Math.floor(trade.prices.gold * (1 + goldChange)));
    trade.history.gold.push(trade.prices.gold);
    if (trade.history.gold.length > 20) trade.history.gold.shift();
    if (trade.botActive.gold) botTrade('gold');
    
    const platChange = (Math.random() - 0.47) * 0.15;
    trade.prices.platinum = Math.max(50, Math.floor(trade.prices.platinum * (1 + platChange)));
    trade.history.platinum.push(trade.prices.platinum);
    if (trade.history.platinum.length > 20) trade.history.platinum.shift();
    if (trade.botActive.platinum) botTrade('platinum');
    
    const cryptoChange = (Math.random() - 0.46) * 0.25;
    trade.prices.crypto = Math.max(100, Math.floor(trade.prices.crypto * (1 + cryptoChange)));
    trade.history.crypto.push(trade.prices.crypto);
    if (trade.history.crypto.length > 20) trade.history.crypto.shift();
    if (trade.botActive.crypto) botTrade('crypto');
  }
  
  updateUI();
}

function isUnlocked(feature) {
  if (!feature) return true;
  return state.unlockedFeatures.includes(feature);
}

function checkUnlocks() {
  const p = state.prestigeCount;
  
  if (p >= 5 && !state.unlockedFeatures.includes("midgame")) {
    state.unlockedFeatures.push("midgame");
    log("ğŸ‰ NOUVEAU : Milestones dÃ©bloquÃ©s !", "unlock");
  }
  
  if (p >= 15 && !state.unlockedFeatures.includes("advanced")) {
    state.unlockedFeatures.push("advanced");
    log("ğŸ‰ NOUVEAU : Trading avancÃ© + Auto-achat !", "unlock");
  }
  
  if (p >= 30 && !state.unlockedFeatures.includes("lategame")) {
    state.unlockedFeatures.push("lategame");
    log("ğŸ‰ NOUVEAU : Super Prestige (Galaxies) !", "unlock");
  }
}

function checkMilestones() {
  if (!isUnlocked("midgame")) return;
  
  state.milestones.forEach(m => {
    if (m.unlocked) return;
    
    let current = 0;
    if (m.type === "totalCoins") current = state.totalCoins;
    if (m.type === "genTotal") current = state.generators.reduce((a, g) => a + g.count, 0);
    if (m.type === "trades") current = trade.totalTrades;
    
    if (current >= m.goal) {
      m.unlocked = true;
      log(`ğŸ¯ Milestone : ${m.name}`, "unlock");
    }
  });
}

function claimMilestone(id) {
  const m = state.milestones.find(x => x.id === id);
  if (!m || !m.unlocked || m.claimed) return;
  m.claimed = true;
  log(`âœ… RÃ©compense : ${m.reward}`, "success");
  updateUI();
  save();
}

function buySkill(tree, skillId) {
  const skill = state.skills[tree].find(s => s.id === skillId);
  if (!skill || skill.bought || state.skillPoints < skill.cost) return;
  
  if (skill.requires) {
    const req = state.skills[tree].find(s => s.id === skill.requires);
    if (!req || !req.bought) return;
  }
  
  state.skillPoints -= skill.cost;
  skill.bought = true;
  log(`ğŸŒ³ CompÃ©tence : ${skill.name}`, "success");
  updateUI();
  save();
}

function superPrestige() {
  const cost = Math.floor(100 * Math.pow(10, state.galaxies));
  if (state.stars < cost) return;
  
  if (!confirm(`Super Prestige ?\n\nCoÃ»t: ${cost} â­\nRESET tout (mÃªme Ã©toiles)\nGain: 1 Galaxie (Ã—3 Ã  TOUT)`)) return;
  
  state.galaxies++;
  state.stars = 0;
  state.prestigeCount = 0;
  state.skillPoints = 0;
  state.prestigeCost = 1000;
  
  Object.values(state.skills).forEach(tree => tree.forEach(s => s.bought = false));
  state.starUpgrades.forEach(u => u.bought = false);
  
  resetCore();
  log(`ğŸŒ€ GALAXIE ${state.galaxies} ! (Ã—${Math.pow(3, state.galaxies)} TOTAL)`, "unlock");
  updateUI();
  save();
}
  const checks = {
    first_coin: s => s.totalCoins >= 1,
    hundred: s => s.coins >= 100,
    thousand: s => s.coins >= 1000,
    first_gen: s => s.generators.some(g => g.count > 0),
    first_prestige: s => s.prestigeCount >= 1
  };
  
  state.achievements.forEach(ach => {
    if (!ach.unlocked && checks[ach.id] && checks[ach.id](state)) {
      ach.unlocked = true;
      log(`ğŸ† ${ach.name}`, "success");
    }
  });
}

function updateUI() {
  $("coins").textContent = formatNum(state.coins);
  $("cps").textContent = formatNum(cps());
  $("clickValue").textContent = formatNum(clickVal());
  
  const totalBonus = Math.pow(1.5, state.stars) * Math.pow(3, state.galaxies);
  $("bonus").textContent = formatNum(totalBonus);
  $("stars").textContent = state.stars;
  $("starsAvailable").textContent = state.stars;
  
  // Show/hide sections
  if (state.galaxies > 0 || isUnlocked("lategame")) {
    $("galaxyLine").style.display = "";
    $("galaxies").textContent = state.galaxies;
    $("superPrestigeBtn").style.display = "";
  }
  
  if (isUnlocked("lategame")) {
    $("skillLine").style.display = "";
    $("skillPoints").textContent = state.skillPoints;
    $("skillPointsDisp").textContent = state.skillPoints;
    $("skillsSection").style.display = "";
  } else {
    $("skillsSection").style.display = "none";
  }
  
  $("milestonesSection").style.display = isUnlocked("midgame") ? "" : "none";
  
  // Advanced trading tabs
  if (isUnlocked("advanced")) {
    $("tab-gold").style.display = "";
    $("tab-platinum").style.display = "";
    $("tab-crypto").style.display = "";
  }
  
  // Tab highlighting
  ['iron', 'gold', 'platinum', 'crypto'].forEach(r => {
    const tab = $(`tab-${r}`);
    if (tab) tab.style.opacity = r === trade.currentTab ? "1" : "0.5";
  });
  
  const pGain = Math.floor(Math.sqrt(state.totalCoins / state.prestigeCost));
  $("prestigeGain").textContent = pGain;
  $("prestigeBtn").disabled = pGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeMaxBtn").disabled = pGain < 1 || state.totalCoins < state.prestigeCost;
  $("prestigeCost").textContent = formatNum(state.prestigeCost);
  
  const pProgress = Math.min(100, (state.totalCoins / state.prestigeCost) * 100);
  $("prestigeProgress").style.width = pProgress + "%";

  // Milestones
  if (isUnlocked("midgame")) {
    $("milestones").innerHTML = state.milestones.map(m => {
      let current = 0;
      if (m.type === "totalCoins") current = state.totalCoins;
      if (m.type === "genTotal") current = state.generators.reduce((a, g) => a + g.count, 0);
      if (m.type === "trades") current = trade.totalTrades;
      const progress = Math.min(100, (current / m.goal) * 100);
      const status = m.claimed ? "âœ…" : m.unlocked ? "ğŸ" : "ğŸ”’";
      return `
        <div class="up-item ${m.unlocked && !m.claimed ? 'new-content' : ''}" style="opacity:${m.claimed ? 0.5 : 1}">
          <div>
            <strong>${status} ${m.name}</strong><br>
            <small>${formatNum(current)}/${formatNum(m.goal)}</small>
            <div class="progress-bar" style="margin:.2rem 0"><div class="progress-fill" style="width:${progress}%"></div></div>
            <small style="color:#0f0">${m.reward}</small>
          </div>
          ${m.unlocked && !m.claimed ? `<button class="buy-btn" onclick="claimMilestone('${m.id}')">RÃ©clamer</button>` : ''}
        </div>
      `;
    }).join("");
  }
  
  // Skills
  if (isUnlocked("lategame")) {
    ['production', 'clicks', 'trading'].forEach(tree => {
      const el = tree === 'production' ? 'skillsProd' : tree === 'clicks' ? 'skillsClick' : 'skillsTrade';
      $(el).innerHTML = state.skills[tree].map(s => {
        const canBuy = state.skillPoints >= s.cost && !s.bought;
        const reqMet = !s.requires || state.skills[tree].find(x => x.id === s.requires)?.bought;
        return `
          <div class="up-item" style="opacity:${s.bought ? 0.5 : 1}">
            <div>
              <strong>${s.bought ? 'âœ…' : 'ğŸŒ³'} ${s.name}</strong><br>
              <small>${s.desc}</small>
            </div>
            ${!s.bought && reqMet ? `<button class="buy-btn" onclick="buySkill('${tree}','${s.id}')" ${!canBuy ? 'disabled' : ''}>${s.cost} pts</button>` : ''}
          </div>
        `;
      }).join("");
    });
  }

  // Gens
  $("gens").innerHTML = state.generators.filter(g => isUnlocked(g.unlock)).map(g => {
    const cost = price(g);
    const canBuy = state.coins >= cost;
    const isNew = g.unlock && state.unlockedFeatures.includes(g.unlock) && g.count === 0;
    return `
      <div class="gen-item ${isNew ? 'new-content' : ''}">
        <div>
          <strong>${g.name}</strong> ${isNew ? 'âœ¨' : ''} <span class="count">Ã—${g.count}</span><br>
          <small>${formatNum(g.base * g.count * totalBonus)}/s</small>
        </div>
        <button class="buy-btn" onclick="buyGen('${g.id}')" ${!canBuy ? "disabled" : ""}>
          ${formatNum(cost)}ğŸ’°
        </button>
      </div>
    `;
  }).join("");

  // Ups
  const availUps = state.upgrades.filter(u => {
    if (u.bought) return false;
    if (!isUnlocked(u.unlock)) return false;
    if (u.requires) {
      const req = state.upgrades.find(r => r.id === u.requires);
      return req && req.bought;
    }
    return true;
  });
  
  $("ups").innerHTML = availUps.length > 0 ? availUps.map(u => {
    const canBuy = state.coins >= u.price;
    const isNew = u.unlock && state.unlockedFeatures.includes(u.unlock);
    return `
      <div class="up-item ${isNew ? 'new-content' : ''}">
        <div><strong>${u.name}</strong> ${isNew ? 'âœ¨' : ''}</div>
        <button class="buy-btn" onclick="buyUp('${u.id}')" ${!canBuy ? "disabled" : ""}>
          ${formatNum(u.price)}ğŸ’°
        </button>
      </div>
    `;
  }).join("") : "<div style='color:#888;text-align:center'>Tout achetÃ©!</div>";

  // Star ups
  const availStar = state.starUpgrades.filter(u => {
    if (u.bought) return false;
    if (!isUnlocked(u.unlock)) return false;
    if (u.requires) {
      const req = state.starUpgrades.find(r => r.id === u.requires);
      return req && req.bought;
    }
    return true;
  });
  
  $("starShop").innerHTML = availStar.length > 0 ? availStar.map(u => {
    const canBuy = state.stars >= u.cost;
    const isNew = u.unlock && state.unlockedFeatures.includes(u.unlock);
    return `
      <div class="up-item ${isNew ? 'new-content' : ''}">
        <div><strong>${u.name}</strong> ${isNew ? 'âœ¨' : ''}</div>
        <button class="buy-btn" onclick="buyStarUpgrade('${u.id}')" ${!canBuy ? "disabled" : ""}>
          ${u.cost}â­
        </button>
      </div>
    `;
  }).join("") : "<div style='color:#888;text-align:center'>Tout achetÃ©!</div>";

  // Trading
  const res = trade.currentTab;
  const avg = trade.history[res].reduce((a, b) => a + b, 0) / trade.history[res].length;
  $("tradeContent").innerHTML = `
    <div class="stat-line">
      <span>${res.charAt(0).toUpperCase() + res.slice(1)}</span>
      <span class="count">${trade[res]}</span>
    </div>
    <div class="stat-line">
      <span>Prix</span>
      <span class="price">${trade.prices[res]}</span> ğŸ’°
    </div>
    <div class="stat-line">
      <span>Moyenne</span>
      <span>${avg.toFixed(1)}</span>
    </div>
    <button onclick="buyResource('${res}')">Acheter</button>
    <button onclick="sellResource('${res}')">Vendre</button>
    <button onclick="toggleBotResource('${res}')" style="background:${trade.botActive[res] ? '#0a0' : '#0af'}">
      ğŸ¤– ${trade.botActive[res] ? 'ON' : 'OFF'}
    </button>
  `;

  // Achievements
  $("achievements").innerHTML = state.achievements.map(ach => `
    <div class="achievement ${ach.unlocked ? 'unlocked' : ''}">
      ${ach.unlocked ? 'âœ…' : 'ğŸ”’'} <strong>${ach.name}</strong><br>
      <small>${ach.desc}</small>
    </div>
  `).join("");

  // Stats
  $("totalCoins").textContent = formatNum(state.totalCoins);
  $("totalClicks").textContent = state.totalClicks;
  $("playTime").textContent = state.playTime < 60 ? state.playTime + "s" : 
    state.playTime < 3600 ? Math.floor(state.playTime / 60) + "m" :
    (state.playTime / 3600).toFixed(1) + "h";
  $("prestigeCount").textContent = state.prestigeCount;
}

function save() {
  try {
    const saveData = {state: {...state, logMessages: []}, trade: trade, v: 3, t: Date.now()};
    localStorage.setItem(SAVE_KEY, btoa(JSON.stringify(saveData)));
  } catch (e) {
    console.error("Save error:", e);
  }
}

function switchTab(resource) {
  trade.currentTab = resource;
  updateUI();
}

function load() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      const data = JSON.parse(atob(raw));
      state = {...state, ...data.state};
      trade = {...trade, ...data.trade};
      if (!state.logMessages) state.logMessages = [];
      if (!state.unlockedFeatures) state.unlockedFeatures = ["basic"];
      if (!state.skillPoints) state.skillPoints = 0;
      if (!state.galaxies) state.galaxies = 0;
      if (!trade.currentTab) trade.currentTab = 'iron';
      
      // Force unlock check
      const p = state.prestigeCount;
      if (p >= 5 && !state.unlockedFeatures.includes("midgame")) {
        state.unlockedFeatures.push("midgame");
        log("ğŸ‰ Milestones dÃ©bloquÃ©s !", "unlock");
      }
      if (p >= 15 && !state.unlockedFeatures.includes("advanced")) {
        state.unlockedFeatures.push("advanced");
        log("ğŸ‰ Trading avancÃ© dÃ©bloquÃ© !", "unlock");
      }
      if (p >= 30 && !state.unlockedFeatures.includes("lategame")) {
        state.unlockedFeatures.push("lategame");
        log("ğŸ‰ Super Prestige dÃ©bloquÃ© !", "unlock");
      }
      
      log("ğŸ’¾ ChargÃ©", "success");
    }
  } catch (e) {
    log("âŒ Erreur chargement");
  }
  updateUI();
}

function exportSave() {
  try {
    const saveData = {state: {...state, logMessages: []}, trade: trade, v: 3};
    const blob = new Blob([btoa(JSON.stringify(saveData))], {type: "text/plain"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `save_${Date.now()}.txt`;
    a.click();
    log("ğŸ“¤ ExportÃ©", "success");
  } catch (e) {
    log("âŒ Erreur export");
  }
}

function importSave() {
  $("importInput").click();
}

function resetGame() {
  if (confirm("Reset total ?")) {
    localStorage.removeItem(SAVE_KEY);
    location.reload();
  }
}

function init() {
  $("clickBtn").addEventListener("click", clickBtn);
  $("prestigeBtn").addEventListener("click", prestige);
  $("prestigeMaxBtn").addEventListener("click", prestigeMax);
  $("superPrestigeBtn").addEventListener("click", superPrestige);
  $("buyIronBtn").addEventListener("click", buyIron);
  $("sellIronBtn").addEventListener("click", sellIron);
  $("botBtn").addEventListener("click", toggleBot);
  $("exportBtn").addEventListener("click", exportSave);
  $("importBtn").addEventListener("click", importSave);
  $("resetBtn").addEventListener("click", resetGame);
  
  $("importInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    file.text().then(txt => {
      try {
        const data = JSON.parse(atob(txt));
        state = data.state;
        trade = data.trade;
        save();
        updateUI();
        log("ğŸ“¥ ImportÃ©", "success");
      } catch (x) {
        log("âŒ Fichier invalide");
      }
    });
  });

  load();
  
  let updateCounter = 0;
  setInterval(() => {
    const gain = cps() / FPS;
    state.coins += gain;
    state.totalCoins += gain;
    
    const autoClick = state.starUpgrades.find(u => u.id === "star_auto1");
    if (autoClick && autoClick.bought) {
      const autoGain = clickVal() / FPS;
      state.coins += autoGain;
      state.totalCoins += autoGain;
    }
    
    // Auto-buy
    if (state.autoSettings.autoBuyGens && isUnlocked("advanced")) {
      state.generators.forEach(g => {
        if (isUnlocked(g.unlock) && state.coins >= price(g)) {
          const cost = price(g);
          state.coins -= cost;
          g.count++;
        }
      });
    }
    
    updateCounter++;
    
    $("coins").textContent = formatNum(state.coins);
    $("totalCoins").textContent = formatNum(state.totalCoins);
    
    if (updateCounter % 10 === 0) {
      checkAchievements();
      updateUI();
    }
  }, 1000 / FPS);

  setInterval(() => tickMarket(), 30000);

  setInterval(() => {
    if (state.upgrades.find(u => u.id === "autosave")?.bought) {
      save();
    }
  }, 10000);

  setInterval(() => {
    state.playTime++;
  }, 1000);

  window.addEventListener("beforeunload", save);
  
  log("ğŸ® Bienvenue !", "unlock");
}

init();
</script>
</body>
</html>
